# =============================================================================
# Skillancer - Hetzner Production Docker Compose
# =============================================================================
# Simpler alternative to K8s for running the full Skillancer stack on a single
# Hetzner VM or small cluster. Useful for:
#   - Small-scale production deployments
#   - Staging environments
#   - Cost-optimized single-server setups
#
# Prerequisites:
#   - Docker & Docker Compose v2
#   - .env file with all required variables
#   - GHCR auth: docker login ghcr.io -u <user> -p <token>
#
# Usage:
#   docker compose -f docker-compose.hetzner.yml up -d
#   docker compose -f docker-compose.hetzner.yml logs -f
#   docker compose -f docker-compose.hetzner.yml down
# =============================================================================

x-common-env: &common-env
  NODE_ENV: production
  DATABASE_URL: postgresql://${DB_USER:-skillancer}:${DB_PASSWORD}@postgres:5432/${DB_NAME:-skillancer}?schema=public
  REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379
  S3_BUCKET: ${S3_BUCKET:-skillancer-uploads}
  S3_ENDPOINT: ${S3_ENDPOINT:-http://minio:9000}
  S3_FORCE_PATH_STYLE: 'true'
  AWS_ACCESS_KEY_ID: ${S3_ACCESS_KEY:-minioadmin}
  AWS_SECRET_ACCESS_KEY: ${S3_SECRET_KEY:-minioadmin}
  AWS_REGION: ${S3_REGION:-us-east-1}
  LOG_LEVEL: info

x-service-defaults: &service-defaults
  restart: unless-stopped
  logging:
    driver: json-file
    options:
      max-size: '10m'
      max-file: '3'
  deploy:
    resources:
      limits:
        memory: 512M
      reservations:
        memory: 256M
  networks:
    - skillancer
  healthcheck:
    interval: 30s
    timeout: 10s
    retries: 3
    start_period: 40s

services:
  # ============================================================
  # Infrastructure
  # ============================================================
  postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${DB_USER:-skillancer}
      POSTGRES_PASSWORD: ${DB_PASSWORD:?DB_PASSWORD is required}
      POSTGRES_DB: ${DB_NAME:-skillancer}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - '127.0.0.1:5432:5432'
    networks:
      - skillancer
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${DB_USER:-skillancer}']
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M
    command: >
      postgres
        -c shared_buffers=512MB
        -c effective_cache_size=1536MB
        -c work_mem=16MB
        -c maintenance_work_mem=128MB
        -c max_connections=200
        -c log_min_duration_statement=1000

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    command: >
      redis-server
        --requirepass ${REDIS_PASSWORD:?REDIS_PASSWORD is required}
        --maxmemory 512mb
        --maxmemory-policy allkeys-lru
        --appendonly yes
        --appendfsync everysec
    volumes:
      - redis_data:/data
    ports:
      - '127.0.0.1:6379:6379'
    networks:
      - skillancer
    healthcheck:
      test: ['CMD', 'redis-cli', '-a', '${REDIS_PASSWORD}', 'ping']
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 768M
        reservations:
          memory: 256M

  minio:
    image: minio/minio:latest
    restart: unless-stopped
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${S3_ACCESS_KEY:-minioadmin}
      MINIO_ROOT_PASSWORD: ${S3_SECRET_KEY:-minioadmin}
    volumes:
      - minio_data:/data
    ports:
      - '127.0.0.1:9000:9000'
      - '127.0.0.1:9001:9001'
    networks:
      - skillancer
    healthcheck:
      test: ['CMD', 'mc', 'ready', 'local']
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================================
  # Application Services
  # ============================================================
  api-gateway:
    <<: *service-defaults
    image: ghcr.io/artpromedia/api-gateway:${VERSION:-latest}
    ports:
      - '${API_PORT:-4000}:4000'
    environment:
      <<: *common-env
      PORT: '4000'
      AUTH_SERVICE_URL: http://auth-svc:3001
      MARKET_SERVICE_URL: http://market-svc:3002
      SKILLPOD_SERVICE_URL: http://skillpod-svc:3003
      COCKPIT_SERVICE_URL: http://cockpit-svc:3004
      BILLING_SERVICE_URL: http://billing-svc:3005
      NOTIFICATION_SERVICE_URL: http://notification-svc:4006
    depends_on:
      auth-svc:
        condition: service_healthy
    healthcheck:
      test: ['CMD', 'wget', '-q', '--spider', 'http://localhost:4000/health']

  auth-svc:
    <<: *service-defaults
    image: ghcr.io/artpromedia/auth-svc:${VERSION:-latest}
    environment:
      <<: *common-env
      PORT: '3001'
      JWT_SECRET: ${JWT_SECRET:?JWT_SECRET is required}
      SESSION_SECRET: ${SESSION_SECRET:?SESSION_SECRET is required}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ['CMD', 'wget', '-q', '--spider', 'http://localhost:3001/health']

  market-svc:
    <<: *service-defaults
    image: ghcr.io/artpromedia/market-svc:${VERSION:-latest}
    environment:
      <<: *common-env
      PORT: '3002'
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ['CMD', 'wget', '-q', '--spider', 'http://localhost:3002/health']

  skillpod-svc:
    <<: *service-defaults
    image: ghcr.io/artpromedia/skillpod-svc:${VERSION:-latest}
    environment:
      <<: *common-env
      PORT: '3003'
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ['CMD', 'wget', '-q', '--spider', 'http://localhost:3003/health']
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M

  cockpit-svc:
    <<: *service-defaults
    image: ghcr.io/artpromedia/cockpit-svc:${VERSION:-latest}
    environment:
      <<: *common-env
      PORT: '3004'
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ['CMD', 'wget', '-q', '--spider', 'http://localhost:3004/health']

  billing-svc:
    <<: *service-defaults
    image: ghcr.io/artpromedia/billing-svc:${VERSION:-latest}
    environment:
      <<: *common-env
      PORT: '3005'
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ['CMD', 'wget', '-q', '--spider', 'http://localhost:3005/health']

  notification-svc:
    <<: *service-defaults
    image: ghcr.io/artpromedia/notification-svc:${VERSION:-latest}
    environment:
      <<: *common-env
      PORT: '4006'
      SMTP_HOST: ${SMTP_HOST}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER}
      SMTP_PASSWORD: ${SMTP_PASSWORD}
      EMAIL_FROM: ${EMAIL_FROM:-noreply@skillancer.com}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ['CMD', 'wget', '-q', '--spider', 'http://localhost:4006/health']

  audit-svc:
    <<: *service-defaults
    image: ghcr.io/artpromedia/audit-svc:${VERSION:-latest}
    environment:
      <<: *common-env
      PORT: '3012'
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ['CMD', 'wget', '-q', '--spider', 'http://localhost:3012/health']

  # ============================================================
  # Reverse Proxy (Caddy - auto HTTPS)
  # ============================================================
  caddy:
    image: caddy:2-alpine
    restart: unless-stopped
    ports:
      - '80:80'
      - '443:443'
    volumes:
      - ./infrastructure/hetzner/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    networks:
      - skillancer
    depends_on:
      - api-gateway

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  minio_data:
    driver: local
  caddy_data:
    driver: local
  caddy_config:
    driver: local

networks:
  skillancer:
    driver: bridge
