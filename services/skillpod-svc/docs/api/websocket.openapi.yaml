openapi: 3.0.3
info:
  title: SkillPod WebSocket Policy Enforcement API
  description: |
    Real-time WebSocket API for SkillPod policy enforcement.

    ## Connection
    Connect to `/ws/policy-enforcement/:sessionId` with a valid JWT token.

    ## Message Format
    All messages are JSON with the following structure:
    ```json
    {
      "type": "message_type",
      "requestId": "optional-request-id",
      "data": { ... }
    }
    ```

    ## Message Types

    ### Client to Server
    - `policy_check` - Request policy evaluation for an action
    - `screen_capture` - Report detected screen capture attempt
    - `heartbeat` - Keep-alive and metrics update
    - `activity` - Report user activity

    ### Server to Client
    - `init` - Initial connection with session info and policy
    - `policy_check_result` - Result of policy check
    - `screen_capture_result` - Result of screen capture report
    - `heartbeat_ack` - Heartbeat acknowledgment
    - `policy_update` - Policy has been updated
    - `alert` - Security alert notification
    - `error` - Error response

  version: 1.0.0
  contact:
    name: Skillancer Platform Team
    email: platform@skillancer.com

servers:
  - url: wss://api.skillancer.com/api/v1/skillpod
    description: Production WebSocket Server
  - url: ws://localhost:3006/api/v1/skillpod
    description: Local Development Server

paths:
  /ws/policy-enforcement/{sessionId}:
    get:
      summary: WebSocket connection for policy enforcement
      description: |
        Establishes a WebSocket connection for real-time policy enforcement.

        ## Connection Flow
        1. Client connects with JWT in Authorization header or query param
        2. Server validates session and sends `init` message with policy
        3. Client sends policy checks for each action
        4. Server responds with allow/block decisions
        5. Client sends heartbeats every 30 seconds

        ## Closing Codes
        - 4401: Unauthorized - invalid or missing token
        - 4403: Forbidden - no access to session
        - 4404: Session not found
        - 4500: Internal server error

      tags:
        - WebSocket
      parameters:
        - name: sessionId
          in: path
          required: true
          description: The session ID to connect to
          schema:
            type: string
            format: uuid
        - name: token
          in: query
          description: JWT token (alternative to Authorization header)
          schema:
            type: string
      responses:
        '101':
          description: WebSocket connection established
        '401':
          description: Unauthorized
        '404':
          description: Session not found

components:
  schemas:
    # ===========================================================================
    # Base Message Structure
    # ===========================================================================

    WebSocketMessage:
      type: object
      required:
        - type
      properties:
        type:
          type: string
          description: Message type identifier
        requestId:
          type: string
          description: Optional request ID for correlating responses
        data:
          type: object
          description: Message payload

    # ===========================================================================
    # Client to Server Messages
    # ===========================================================================

    PolicyCheckRequest:
      type: object
      description: Request policy evaluation for an action
      required:
        - type
        - data
      properties:
        type:
          type: string
          enum: [policy_check]
        requestId:
          type: string
        data:
          type: object
          required:
            - action
          properties:
            action:
              type: string
              enum:
                - clipboard_copy
                - clipboard_paste
                - file_download
                - file_upload
                - print
                - usb_access
              description: The action to evaluate
            content:
              type: string
              description: Content for DLP scanning (clipboard/small files)
            fileName:
              type: string
              description: File name for file operations
            fileSize:
              type: integer
              description: File size in bytes
            mimeType:
              type: string
              description: MIME type of content
            metadata:
              type: object
              additionalProperties: true
              description: Additional metadata (e.g., USB device type)

    ScreenCaptureReport:
      type: object
      description: Report a detected screen capture attempt
      required:
        - type
        - data
      properties:
        type:
          type: string
          enum: [screen_capture]
        requestId:
          type: string
        data:
          type: object
          required:
            - captureType
            - detectionMethod
          properties:
            captureType:
              type: string
              enum:
                - SCREENSHOT
                - SCREEN_RECORDING
                - WINDOW_CAPTURE
                - REMOTE_ACCESS
            detectionMethod:
              type: string
              description: How the capture was detected (e.g., hotkey, process)
            processInfo:
              type: object
              properties:
                name:
                  type: string
                pid:
                  type: integer
            activeApplication:
              type: string
              description: Current active application
            activeWindow:
              type: string
              description: Current window title

    HeartbeatMessage:
      type: object
      description: Keep-alive and optional metrics update
      required:
        - type
        - data
      properties:
        type:
          type: string
          enum: [heartbeat]
        requestId:
          type: string
        data:
          type: object
          required:
            - clientTime
          properties:
            clientTime:
              type: integer
              description: Client timestamp in milliseconds
            metrics:
              type: object
              properties:
                cpu:
                  type: number
                  description: CPU usage percentage
                memory:
                  type: number
                  description: Memory usage percentage
                networkRx:
                  type: integer
                  description: Network bytes received
                networkTx:
                  type: integer
                  description: Network bytes transmitted

    ActivityMessage:
      type: object
      description: Report user activity for logging
      required:
        - type
        - data
      properties:
        type:
          type: string
          enum: [activity]
        data:
          type: object
          required:
            - activityType
          properties:
            activityType:
              type: string
              enum: [keyboard, mouse, clipboard, file_access, network]
            details:
              type: object
              additionalProperties: true

    # ===========================================================================
    # Server to Client Messages
    # ===========================================================================

    InitMessage:
      type: object
      description: Initial connection response with session and policy info
      properties:
        type:
          type: string
          enum: [init]
        data:
          type: object
          properties:
            sessionId:
              type: string
              format: uuid
            policy:
              type: object
              nullable: true
              properties:
                id:
                  type: string
                  format: uuid
                name:
                  type: string
                clipboardPolicy:
                  type: string
                  enum: [BLOCKED, TEXT_ONLY, INBOUND_ONLY, OUTBOUND_ONLY, BIDIRECTIONAL]
                fileDownloadAllowed:
                  type: boolean
                fileUploadAllowed:
                  type: boolean
                screenCaptureBlocked:
                  type: boolean
                printingPolicy:
                  type: string
                  enum: [BLOCKED, VIRTUAL_ONLY, PDF_ONLY, ALLOWED]
                usbPolicy:
                  type: string
                  enum: [BLOCKED, STORAGE_BLOCKED, WHITELIST_ONLY, ALLOWED]

    PolicyCheckResult:
      type: object
      description: Result of policy evaluation
      properties:
        type:
          type: string
          enum: [policy_check_result]
        requestId:
          type: string
        data:
          type: object
          properties:
            action:
              type: string
              description: The action that was evaluated
            allowed:
              type: boolean
              description: Whether the action is allowed
            reason:
              type: string
              nullable: true
              description: Reason for blocking (if blocked)
            sensitiveDataDetected:
              type: boolean
              description: Whether DLP detected sensitive data

    ScreenCaptureResult:
      type: object
      description: Result of screen capture report
      properties:
        type:
          type: string
          enum: [screen_capture_result]
        requestId:
          type: string
        data:
          type: object
          properties:
            blocked:
              type: boolean
              description: Whether screen capture is blocked by policy
            logged:
              type: boolean
              description: Whether the attempt was logged
            captureType:
              type: string

    HeartbeatAck:
      type: object
      description: Acknowledgment of heartbeat
      properties:
        type:
          type: string
          enum: [heartbeat_ack]
        requestId:
          type: string
        data:
          type: object
          properties:
            serverTime:
              type: integer
              description: Server timestamp in milliseconds
            latency:
              type: integer
              description: Round-trip latency in milliseconds

    PolicyUpdateNotification:
      type: object
      description: Notification that policy has been updated
      properties:
        type:
          type: string
          enum: [policy_update]
        data:
          type: object
          properties:
            policyId:
              type: string
              format: uuid
            changes:
              type: object
              additionalProperties: true
              description: Changed policy fields

    AlertNotification:
      type: object
      description: Security alert from server
      properties:
        type:
          type: string
          enum: [alert]
        data:
          type: object
          properties:
            alertType:
              type: string
              enum: [RESOURCE_ALERT, SECURITY_ALERT, SESSION_TIMEOUT, POLICY_VIOLATION]
            message:
              type: string
            severity:
              type: string
              enum: [info, warning, error, critical]

    ErrorMessage:
      type: object
      description: Error response
      properties:
        type:
          type: string
          enum: [error]
        requestId:
          type: string
        data:
          type: object
          properties:
            message:
              type: string
            code:
              type: string

  examples:
    # ===========================================================================
    # Usage Examples
    # ===========================================================================

    InitExample:
      summary: Initial connection response
      value:
        type: init
        data:
          sessionId: '550e8400-e29b-41d4-a716-446655440000'
          policy:
            id: '660e8400-e29b-41d4-a716-446655440001'
            name: 'High Security'
            clipboardPolicy: 'BLOCKED'
            fileDownloadAllowed: false
            fileUploadAllowed: true
            screenCaptureBlocked: true
            printingPolicy: 'BLOCKED'
            usbPolicy: 'BLOCKED'

    PolicyCheckExample:
      summary: Clipboard copy policy check
      value:
        type: policy_check
        requestId: 'req-123'
        data:
          action: 'clipboard_copy'
          content: 'Some text to copy'
          mimeType: 'text/plain'

    PolicyCheckResultAllowed:
      summary: Policy check allowed
      value:
        type: policy_check_result
        requestId: 'req-123'
        data:
          action: 'clipboard_copy'
          allowed: true
          sensitiveDataDetected: false

    PolicyCheckResultBlocked:
      summary: Policy check blocked - DLP detection
      value:
        type: policy_check_result
        requestId: 'req-124'
        data:
          action: 'clipboard_copy'
          allowed: false
          reason: 'Sensitive data detected: credit card number'
          sensitiveDataDetected: true

    ScreenCaptureExample:
      summary: Screen capture detection report
      value:
        type: screen_capture
        requestId: 'req-125'
        data:
          captureType: 'SCREENSHOT'
          detectionMethod: 'hotkey'
          processInfo:
            name: 'snipping_tool.exe'
            pid: 1234
          activeApplication: 'code.exe'
          activeWindow: 'skillpod.service.ts - Visual Studio Code'

    HeartbeatExample:
      summary: Heartbeat with metrics
      value:
        type: heartbeat
        requestId: 'hb-001'
        data:
          clientTime: 1699574400000
          metrics:
            cpu: 45.2
            memory: 62.8
            networkRx: 1048576
            networkTx: 524288
