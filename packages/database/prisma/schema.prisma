// ============================================================================
// Skillancer Database Schema
// Multi-tenant SaaS platform for freelancers and clients
// ============================================================================

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearch", "postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [uuid_ossp(map: "uuid-ossp"), pg_trgm]
}

// ============================================================================
// USER & AUTHENTICATION
// ============================================================================

model User {
  id                String            @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  email             String            @unique @db.VarChar(255)
  passwordHash      String?           @map("password_hash") @db.VarChar(255)
  firstName         String            @map("first_name") @db.VarChar(100)
  lastName          String            @map("last_name") @db.VarChar(100)
  displayName       String?           @map("display_name") @db.VarChar(200)
  avatarUrl         String?           @map("avatar_url") @db.VarChar(500)
  bio               String?           @db.Text
  status            UserStatus        @default(PENDING_VERIFICATION)
  verificationLevel VerificationLevel @default(NONE)
  timezone          String            @default("UTC") @db.VarChar(50)
  locale            String            @default("en") @db.VarChar(10)

  // OAuth fields
  oauthProvider String? @map("oauth_provider") @db.VarChar(50)
  oauthId       String? @map("oauth_id") @db.VarChar(255)

  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")
  lastLoginAt DateTime? @map("last_login_at")

  // Relations
  tenantMemberships     TenantMember[]
  jobsPosted            Job[]                      @relation("ClientJobs")
  bids                  Bid[]
  contractsAsClient     Contract[]                 @relation("ClientContracts")
  contractsAsFreelancer Contract[]                 @relation("FreelancerContracts")
  services              Service[]
  sessions              Session[]
  messagesSent          Message[]                  @relation("SenderMessages")
  messagesReceived      Message[]                  @relation("ReceiverMessages")
  reviewsGiven          Review[]                   @relation("ReviewerReviews")
  reviewsReceived       Review[]                   @relation("RevieweeReviews")
  reviewHelpfulVotes    ReviewHelpfulVote[]
  reviewReports         ReviewReport[]
  reviewInvitations     ReviewInvitation[]
  ratingAggregation     UserRatingAggregation?
  trustScore            TrustScore?
  complianceRecords     SkillPodComplianceRecord[]
  skills                UserSkill[]
  portfolioItems        PortfolioItem[]
  paymentMethods        PaymentMethod[]
  subscriptions         Subscription[]
  stripeCustomer        StripeCustomer?
  notifications         Notification[]
  notificationPreferences NotificationPreference[]
  notificationDigests     NotificationDigest[]
  emailUnsubscribes       EmailUnsubscribe[]
  refreshTokens         RefreshToken[]
  auditLogs             AuditLog[]                 @relation("UserAuditLogs")
  mfa                   UserMfa?
  profile               UserProfile?
  UserBadge             UserBadge[]
  payoutAccount         PayoutAccount?
  paymentTransactions   PaymentTransaction[]
  phiAccessLogs         PhiAccessLog[]
  hipaaTrainings        HipaaTraining[]
  dataTransferAttempts  DataTransferAttempt[]
  screenCaptureAttempts ScreenCaptureAttempt[]
  
  // Session recording
  recordings            SessionRecording[]
  recordingAccessLogs   RecordingAccessLog[]
  
  // Environment management
  pods                  Pod[]
  templateRatings       TemplateRating[]
  
  // Project invitations
  invitationsSent       ProjectInvitation[]        @relation("InvitationsSent")
  invitationsReceived   ProjectInvitation[]        @relation("InvitationsReceived")
  
  // Project questions
  questionsAsked        ProjectQuestion[]          @relation("QuestionAsker")
  
  // Service catalog
  serviceOrdersAsBuyer  ServiceOrder[]             @relation("ServiceBuyer")
  serviceOrdersAsSeller ServiceOrder[]             @relation("ServiceSeller")
  serviceReviewsGiven   ServiceReview[]            @relation("ServiceReviewer")
  serviceOrderMessages  ServiceOrderMessage[]      @relation("ServiceOrderMessageSender")
  
  // Compliance
  freelancerCompliances             FreelancerCompliance[]
  securityClearances                SecurityClearance[]
  freelancerComplianceAttestations  FreelancerComplianceAttestation[]
  
  // SmartMatch
  workPattern                       FreelancerWorkPattern?
  skillEndorsementsReceived         FreelancerSkillEndorsement[] @relation("SkillEndorsements")
  skillEndorsementsGiven            FreelancerSkillEndorsement[] @relation("GivenEndorsements")
  matchingEventsAsClient            MatchingEvent[] @relation("ClientMatchingEvents")
  matchingEventsAsFreelancer        MatchingEvent[] @relation("FreelancerMatchingEvents")
  
  // Rate Intelligence
  rateHistory                       FreelancerRateHistory[]
  rateRecommendations               RateRecommendation[]
  
  // Contract Management V2
  contractsAsClientV2               ContractV2[]              @relation("ClientContractsV2")
  contractsAsFreelancerV2           ContractV2[]              @relation("FreelancerContractsV2")
  timeEntriesAsFreelancer           TimeEntryV2[]             @relation("FreelancerTimeEntries")
  amendmentsProposed                ContractAmendment[]       @relation("AmendmentProposer")
  contractActivities                ContractActivity[]        @relation("ContractActivityActor")
  contractSignatures                ContractSignature[]       @relation("UserContractSignatures")
  disputesRaised                    ContractDispute[]         @relation("DisputeRaiser")
  disputeMessages                   ContractDisputeMessage[]  @relation("DisputeMessageSender")
  invoicesAsClient                  ContractInvoice[]         @relation("ClientInvoices")
  invoicesAsFreelancer              ContractInvoice[]         @relation("FreelancerInvoices")

  // Real-time Messaging
  conversationParticipants          ConversationParticipant[] @relation("UserConversationParticipants")
  conversationMessages              ConversationMessage[]     @relation("UserConversationMessages")
  messageReactions                  ConversationMessageReaction[] @relation("UserMessageReactions")
  messageReadReceipts               ConversationMessageReadReceipt[] @relation("UserMessageReadReceipts")
  messageAttachments                MessageAttachment[]       @relation("UserMessageAttachments")
  presence                          UserPresence?             @relation("UserPresenceInfo")
  blockedUsers                      UserBlocklist[]           @relation("BlockedByUser")
  blockedByUsers                    UserBlocklist[]           @relation("BlockedUser")

  // CRM - Client Relationship Management
  crmClients                        Client[]                  @relation("FreelancerClients")
  crmPlatformClients                Client[]                  @relation("PlatformClients")

  // Cockpit - Project Management
  cockpitProjects                   CockpitProject[]          @relation("FreelancerProjects")

  // Time Tracking
  cockpitTimeEntries                CockpitTimeEntry[]        @relation("FreelancerTimeEntries")
  timeTrackingSettings              TimeTrackingSettings?     @relation("TimeTrackingSettings")
  activeTimer                       ActiveTimer?              @relation("ActiveTimer")
  timesheets                        Timesheet[]               @relation("FreelancerTimesheets")
  timeCategories                    TimeCategory[]            @relation("FreelancerTimeCategories")

  // Calendar Integration
  calendarConnections               CalendarConnection[]      @relation("UserCalendarConnections")
  calendarEvents                    CalendarEvent[]           @relation("UserCalendarEvents")
  availabilitySchedules             AvailabilitySchedule[]    @relation("UserAvailabilitySchedules")
  bookingLinks                      BookingLink[]             @relation("UserBookingLinks")
  bookings                          Booking[]                 @relation("UserBookings")

  // Financial Tracking
  financialAccounts                 FinancialAccount[]        @relation("UserFinancialAccounts")
  financialTransactions             FinancialTransaction[]    @relation("UserFinancialTransactions")
  recurringTransactions             RecurringTransaction[]    @relation("UserRecurringTransactions")
  transactionCategories             TransactionCategory[]     @relation("UserTransactionCategories")
  financialGoals                    FinancialGoal[]           @relation("UserFinancialGoals")
  mileageLogs                       MileageLog[]              @relation("UserMileageLogs")
  taxProfile                        TaxProfile?               @relation("UserTaxProfile")

  // Unified Financial Reporting
  unifiedTransactions               UnifiedTransaction[]      @relation("UserUnifiedTransactions")
  financialSummaryReports           FinancialSummaryReport[]  @relation("UserFinancialSummaryReports")
  clientProfitabilityReports        ClientProfitabilityReport[] @relation("UserClientProfitabilityReports")
  platformPerformanceReports        PlatformPerformanceReport[] @relation("UserPlatformPerformanceReports")
  taxSummaryReports                 TaxSummaryReport[]        @relation("UserTaxSummaryReports")
  savedFinancialReports             SavedFinancialReport[]    @relation("UserSavedFinancialReports")

  // Learning Time Tracking
  learningTimeEntries               LearningTimeEntry[]       @relation("UserLearningTimeEntries")
  learningGoals                     LearningGoal[]            @relation("UserLearningGoals")
  learningInvestments               LearningInvestment[]      @relation("UserLearningInvestments")
  learningTimeSummaries             LearningTimeSummary[]     @relation("UserLearningSummaries")
  skillLearningProgress             SkillLearningProgress[]   @relation("UserSkillProgress")

  // Invoicing
  invoices                          Invoice[]                 @relation("FreelancerInvoices")
  invoiceTemplates                  InvoiceTemplate[]         @relation("FreelancerInvoiceTemplates")
  recurringInvoices                 RecurringInvoice[]        @relation("FreelancerRecurringInvoices")
  invoiceSettings                   InvoiceSettings?          @relation("UserInvoiceSettings")

  // Integration Platform
  integrations                      Integration[]             @relation("UserIntegrations")

  // SkillPod Credential Integration
  verifiedCredentials               VerifiedCredential[]
  skillVerifications                SkillVerification[]
  skillConfidences                  SkillConfidence[]
  learningActivity                  LearningActivity?

  // Learning Recommendation System
  learningProfile                   UserLearningProfile?      @relation("UserLearningProfile")

  // Skill-Based Pricing Recommendations
  skillRates                        SkillRate[]
  pricingRecommendations            PricingRecommendation[]
  rateHistoryEntries                RateHistory[]
  revenueProjections                RevenueProjection[]

  @@unique([oauthProvider, oauthId])


  @@index([email])
  @@index([status])
  @@index([deletedAt])
  @@index([createdAt])
  @@map("users")
}

enum UserStatus {
  PENDING_VERIFICATION
  ACTIVE
  INACTIVE
  SUSPENDED
  BANNED
}

enum VerificationLevel {
  NONE
  EMAIL
  BASIC
  ENHANCED
  PREMIUM
}

// ============================================================================
// MULTI-FACTOR AUTHENTICATION
// ============================================================================

enum MfaMethod {
  TOTP
  SMS
  EMAIL
  RECOVERY_CODE
}

model UserMfa {
  id            String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId        String    @unique @map("user_id") @db.Uuid
  enabled       Boolean   @default(false)
  primaryMethod MfaMethod @default(TOTP) @map("primary_method")

  // TOTP
  totpSecret   String? @map("totp_secret") @db.VarChar(500) // Encrypted
  totpVerified Boolean @default(false) @map("totp_verified")

  // SMS
  phoneNumber   String? @map("phone_number") @db.VarChar(20)
  phoneVerified Boolean @default(false) @map("phone_verified")

  // Recovery codes (hashed)
  recoveryCodes            String[]  @map("recovery_codes")
  recoveryCodesGeneratedAt DateTime? @map("recovery_codes_generated_at")
  recoveryCodesUsedCount   Int       @default(0) @map("recovery_codes_used_count")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_mfa")
}

model MfaChallenge {
  id        String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  sessionId String    @map("session_id") @db.VarChar(100)
  method    MfaMethod
  code      String?   @db.VarChar(100) // Hashed, for email/SMS codes
  attempts  Int       @default(0)
  verified  Boolean   @default(false)
  expiresAt DateTime  @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")

  @@index([userId, sessionId])
  @@index([expiresAt])
  @@map("mfa_challenges")
}

// ============================================================================
// USER PROFILE
// ============================================================================

model UserProfile {
  id       String  @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId   String  @unique @map("user_id") @db.Uuid
  username String? @unique @db.VarChar(30) // For public URL (skillancer.com/@username)

  // Professional
  title           String?  @db.VarChar(200)
  bio             String?  @db.Text
  hourlyRate      Decimal? @map("hourly_rate") @db.Decimal(10, 2)
  currency        String   @default("USD") @db.VarChar(3)
  yearsExperience Int?     @map("years_experience")

  // Avatar (multiple sizes for performance)
  avatarOriginal  String? @map("avatar_original") @db.VarChar(500)
  avatarThumbnail String? @map("avatar_thumbnail") @db.VarChar(500) // 64x64
  avatarSmall     String? @map("avatar_small") @db.VarChar(500) // 128x128
  avatarMedium    String? @map("avatar_medium") @db.VarChar(500) // 256x256
  avatarLarge     String? @map("avatar_large") @db.VarChar(500) // 512x512

  // Social Links
  linkedinUrl  String? @map("linkedin_url") @db.VarChar(500)
  githubUrl    String? @map("github_url") @db.VarChar(500)
  portfolioUrl String? @map("portfolio_url") @db.VarChar(500)
  twitterUrl   String? @map("twitter_url") @db.VarChar(500)

  // Location
  country String? @db.VarChar(2) // ISO 3166-1 alpha-2
  city    String? @db.VarChar(100)

  // Visibility Settings
  isPublic     Boolean @default(false) @map("is_public")
  showEmail    Boolean @default(false) @map("show_email")
  showRate     Boolean @default(true) @map("show_rate")
  showLocation Boolean @default(true) @map("show_location")

  // Completeness tracking
  completenessScore Int @default(0) @map("completeness_score")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([username])
  @@index([isPublic])
  @@index([country])
  @@index([hourlyRate])
  @@map("user_profiles")
}

model RefreshToken {
  id        String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  token     String    @unique @db.VarChar(500)
  userId    String    @map("user_id") @db.Uuid
  expiresAt DateTime  @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")
  revokedAt DateTime? @map("revoked_at")
  userAgent String?   @map("user_agent") @db.VarChar(500)
  ipAddress String?   @map("ip_address") @db.VarChar(45)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model UserSkill {
  id        String     @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId    String     @map("user_id") @db.Uuid
  skillId   String     @map("skill_id") @db.Uuid
  level     SkillLevel @default(INTERMEDIATE)
  yearsExp  Int?       @map("years_exp")
  verified  Boolean    @default(false)
  isPrimary Boolean    @default(false) @map("is_primary")
  sortOrder Int        @default(0) @map("sort_order")
  createdAt DateTime   @default(now()) @map("created_at")

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  skill Skill @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@unique([userId, skillId])
  @@index([userId, sortOrder])
  @@map("user_skills")
}

enum SkillLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

model Skill {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name        String   @unique @db.VarChar(100)
  slug        String   @unique @db.VarChar(100)
  category    String   @db.VarChar(100)
  description String?  @db.Text
  isCustom    Boolean  @default(false) @map("is_custom")
  createdById String?  @map("created_by_id") @db.Uuid
  isApproved  Boolean  @default(true) @map("is_approved")
  createdAt   DateTime @default(now()) @map("created_at")

  // External mappings for cross-service integration
  externalMappings Json? @map("external_mappings") // { skillpod: "skill-id", ... }

  userSkills         UserSkill[]
  jobSkills          JobSkill[]
  serviceSkills      ServiceSkill[]
  skillVerifications SkillVerification[]
  skillConfidences   SkillConfidence[]
  
  // Learning Recommendation System
  skillGaps                    SkillGap[]                @relation("SkillGaps")
  marketTrends                 MarketTrend[]             @relation("SkillMarketTrends")
  primaryRecommendations       LearningRecommendation[]  @relation("RecommendationPrimarySkill")

  @@index([category])
  @@index([slug])
  @@index([isCustom])
  @@map("skills")
}

model PortfolioItem {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  title       String   @db.VarChar(200)
  description String?  @db.Text
  imageUrl    String?  @map("image_url") @db.VarChar(500)
  projectUrl  String?  @map("project_url") @db.VarChar(500)
  tags        String[] @default([])
  featured    Boolean  @default(false)
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("portfolio_items")
}

// ============================================================================
// MULTI-TENANCY
// ============================================================================

model Tenant {
  id          String     @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name        String     @db.VarChar(200)
  slug        String     @unique @db.VarChar(100)
  description String?    @db.Text
  logoUrl     String?    @map("logo_url") @db.VarChar(500)
  website     String?    @db.VarChar(500)
  plan        TenantPlan @default(FREE)
  settings    Json       @default("{}")
  metadata    Json       @default("{}")

  // Billing
  stripeCustomerId     String? @unique @map("stripe_customer_id") @db.VarChar(100)
  stripeSubscriptionId String? @map("stripe_subscription_id") @db.VarChar(100)

  // Timestamps
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  members         TenantMember[]
  jobs            Job[]
  sessions        Session[]
  tenantBillingInvoices        TenantBillingInvoice[]
  subscriptions   Subscription[]
  hipaaCompliance HipaaCompliance?
  breachIncidents BreachIncident[]
  
  // Data containment relations
  podSecurityPolicies      PodSecurityPolicy[]
  securityViolations       SecurityViolation[]
  fileTransferRequests     FileTransferRequest[]
  containmentAuditLogs     ContainmentAuditLog[]
  dataTransferAttempts     DataTransferAttempt[]
  screenCaptureAttempts    ScreenCaptureAttempt[]
  transferOverrideRequests TransferOverrideRequest[]
  
  // Session recording
  recordings               SessionRecording[]
  retentionPolicies        RecordingRetentionPolicy[]
  
  // Watermarking
  watermarkConfigurations  WatermarkConfiguration[]
  
  // Environment management
  podTemplates             PodTemplate[]
  pods                     Pod[]
  resourcePools            ResourcePool[]
  resourceQuota            TenantResourceQuota?
  
  // Compliance
  tenantComplianceRequirements TenantComplianceRequirement[]
  
  // Contract Management
  contractTemplates            ContractTemplate[]
  contractsV2                  ContractV2[]       @relation("TenantContractsV2")

  @@index([slug])
  @@index([plan])
  @@index([deletedAt])
  @@map("tenants")
}

model TenantMember {
  id        String     @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId  String     @map("tenant_id") @db.Uuid
  userId    String     @map("user_id") @db.Uuid
  role      TenantRole @default(MEMBER)
  invitedBy String?    @map("invited_by") @db.Uuid
  joinedAt  DateTime   @default(now()) @map("joined_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tenantId, userId])
  @@index([userId])
  @@map("tenant_members")
}

enum TenantPlan {
  FREE
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

enum TenantRole {
  OWNER
  ADMIN
  MANAGER
  MEMBER
}

// ============================================================================
// COMPLIANCE & CERTIFICATIONS
// ============================================================================

model FreelancerCompliance {
  id                String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId            String   @map("user_id") @db.Uuid
  
  // Compliance type
  complianceType    ComplianceType @map("compliance_type")
  
  // Certification details
  certificationName String?   @map("certification_name") @db.VarChar(200)
  certificationId   String?  @map("certification_id") @db.VarChar(100)
  issuingOrganization String?  @map("issuing_organization") @db.VarChar(200)
  
  // Validity
  issuedAt          DateTime?  @map("issued_at")
  expiresAt         DateTime?  @map("expires_at")
  
  // Verification
  verificationStatus ComplianceVerificationStatus @default(PENDING) @map("verification_status")
  verifiedAt        DateTime? @map("verified_at")
  verifiedBy        String?  @map("verified_by") @db.VarChar(100) // 'SYSTEM', 'MANUAL', provider name
  verificationDetails Json?  @map("verification_details")
  
  // Documentation
  documentUrl       String?  @map("document_url") @db.VarChar(500)
  documentHash      String?  @map("document_hash") @db.VarChar(64) // SHA-256 hash for integrity
  
  // Self-attestation (for some compliance types)
  selfAttested      Boolean  @default(false) @map("self_attested")
  attestedAt        DateTime? @map("attested_at")
  
  // Training completion (for training-based compliance)
  trainingCompleted Boolean  @default(false) @map("training_completed")
  trainingCompletedAt DateTime? @map("training_completed_at")
  trainingProvider  String?  @map("training_provider") @db.VarChar(200)
  
  // Status
  isActive          Boolean  @default(true) @map("is_active")
  
  // Renewal tracking
  renewalReminderSent Boolean @default(false) @map("renewal_reminder_sent")
  renewalReminderSentAt DateTime? @map("renewal_reminder_sent_at")
  
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  verificationLogs  ComplianceVerificationLog[]
  
  @@map("freelancer_compliance")
  @@unique([userId, complianceType])
  @@index([userId])
  @@index([complianceType])
  @@index([verificationStatus])
  @@index([expiresAt])
}

model SecurityClearance {
  id                String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId            String   @map("user_id") @db.Uuid
  
  // Clearance details
  clearanceLevel    ClearanceLevel @map("clearance_level")
  grantedBy         String   @map("granted_by") @db.VarChar(200) // Agency/Organization
  
  // Investigation
  investigationType String?   @map("investigation_type") @db.VarChar(50) // 'NACLC', 'SSBI', etc.
  investigationDate DateTime?  @map("investigation_date")
  
  // Validity
  grantedAt         DateTime @map("granted_at")
  expiresAt         DateTime?  @map("expires_at")
  lastReinvestigation DateTime? @map("last_reinvestigation")
  
  // Verification
  verificationStatus ComplianceVerificationStatus @default(PENDING) @map("verification_status")
  verifiedAt        DateTime? @map("verified_at")
  verificationMethod String?  @map("verification_method") @db.VarChar(100)
  
  // Polygraph (if applicable)
  polygraphCompleted Boolean @default(false) @map("polygraph_completed")
  polygraphDate     DateTime? @map("polygraph_date")
  
  // Status
  isActive          Boolean  @default(true) @map("is_active")
  
  // Notes (for internal use only)
  internalNotes     String?  @map("internal_notes") @db.Text
  
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("security_clearances")
  @@unique([userId, clearanceLevel])
  @@index([userId])
  @@index([clearanceLevel])
  @@index([verificationStatus])
}

model ComplianceRequirement {
  id                String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  
  // Requirement definition
  code              String   @unique @db.VarChar(50) // 'HIPAA', 'SOC2', 'PCI_DSS', etc.
  name              String   @db.VarChar(200)
  description       String   @db.Text
  category          ComplianceCategory
  
  // Requirements
  requiresCertification Boolean @default(false) @map("requires_certification")
  requiresTraining  Boolean  @default(false) @map("requires_training")
  requiresAttestation Boolean @default(false) @map("requires_attestation")
  requiresBackgroundCheck Boolean @default(false) @map("requires_background_check")
  
  // Validity period
  validityPeriodDays Int?     @map("validity_period_days")
  
  // Verification
  verificationRequired Boolean @default(true) @map("verification_required")
  verificationProviders String[] @map("verification_providers")
  
  // Training resources
  trainingUrl       String?  @map("training_url") @db.VarChar(500)
  trainingDurationHours Int?  @map("training_duration_hours")
  
  // Certification resources
  certificationUrl  String?  @map("certification_url") @db.VarChar(500)
  certificationCost Decimal? @map("certification_cost") @db.Decimal(10, 2)
  
  // Status
  isActive          Boolean  @default(true) @map("is_active")
  
  // Metadata
  regulatoryBody    String?  @map("regulatory_body") @db.VarChar(200)
  jurisdiction      String[] @default([]) // ['US', 'EU', 'GLOBAL']
  
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  @@map("compliance_requirements")
  @@index([category])
  @@index([isActive])
}

model TenantComplianceRequirement {
  id                String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId          String   @map("tenant_id") @db.Uuid
  
  // Custom requirement
  code              String   @db.VarChar(50)
  name              String   @db.VarChar(200)
  description       String?   @db.Text
  
  // Requirements
  requiresCertification Boolean @default(false) @map("requires_certification")
  requiresTraining  Boolean  @default(false) @map("requires_training")
  requiresAttestation Boolean @default(true) @map("requires_attestation")
  
  // Attestation questions
  attestationQuestions Json?  @map("attestation_questions")
  // [{ question: string, type: 'YES_NO' | 'TEXT', requiredAnswer?: string }]
  
  // Validity
  validityPeriodDays Int?    @map("validity_period_days")
  
  // Status
  isActive          Boolean  @default(true) @map("is_active")
  
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@map("tenant_compliance_requirements")
  @@unique([tenantId, code])
  @@index([tenantId])
}

model FreelancerComplianceAttestation {
  id                String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId            String   @map("user_id") @db.Uuid
  requirementCode   String   @map("requirement_code") @db.VarChar(50)
  
  // For tenant-specific requirements
  tenantRequirementId String?  @map("tenant_requirement_id") @db.Uuid
  
  // Attestation details
  attestedAt        DateTime @map("attested_at")
  answers           Json     @default("{}") // Answers to attestation questions
  
  // IP and signature
  ipAddress         String   @map("ip_address") @db.VarChar(45)
  userAgent         String?   @map("user_agent") @db.VarChar(500)
  digitalSignature  String?  @map("digital_signature") @db.VarChar(500)
  
  // Validity
  expiresAt         DateTime?  @map("expires_at")
  isActive          Boolean  @default(true) @map("is_active")
  
  // Revocation
  revokedAt         DateTime? @map("revoked_at")
  revocationReason  String?  @map("revocation_reason") @db.Text
  
  createdAt         DateTime @default(now()) @map("created_at")
  
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("freelancer_compliance_attestations")
  @@index([userId])
  @@index([requirementCode])
  @@index([isActive])
}

model ComplianceVerificationLog {
  id                String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  complianceId      String   @map("compliance_id") @db.Uuid
  
  // Verification attempt
  verificationMethod String  @map("verification_method") @db.VarChar(50)
  verificationProvider String?  @map("verification_provider") @db.VarChar(100)
  
  // Result
  status            ComplianceVerificationStatus
  failureReason     String?  @map("failure_reason") @db.Text
  
  // Response data
  responseData      Json?    @map("response_data")
  
  // Timing
  attemptedAt       DateTime @map("attempted_at")
  completedAt       DateTime? @map("completed_at")
  
  createdAt         DateTime @default(now()) @map("created_at")
  
  compliance        FreelancerCompliance @relation(fields: [complianceId], references: [id], onDelete: Cascade)
  
  @@map("compliance_verification_logs")
  @@index([complianceId])
  @@index([attemptedAt])
}

enum ComplianceType {
  HIPAA
  SOC2
  PCI_DSS
  GDPR
  ISO_27001
  FEDRAMP
  NIST
  CCPA
  FERPA
  GLBA
  CUSTOM
}

enum ComplianceCategory {
  HEALTHCARE
  FINANCE
  GOVERNMENT
  PRIVACY
  SECURITY
  INDUSTRY_SPECIFIC
  CUSTOM
}

enum ClearanceLevel {
  PUBLIC_TRUST
  CONFIDENTIAL
  SECRET
  TOP_SECRET
  TOP_SECRET_SCI
}

enum ComplianceVerificationStatus {
  PENDING
  IN_PROGRESS
  VERIFIED
  FAILED
  EXPIRED
  REVOKED
}

// ============================================================================
// JOBS & MARKETPLACE
// ============================================================================

model Job {
  id          String        @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  clientId    String        @map("client_id") @db.Uuid
  tenantId    String?       @map("tenant_id") @db.Uuid
  title       String        @db.VarChar(200)
  description String        @db.Text
  slug        String        @unique @db.VarChar(250)
  status      JobStatus     @default(DRAFT)
  visibility  JobVisibility @default(PUBLIC)

  // Budget
  budgetType BudgetType @default(FIXED) @map("budget_type")
  budgetMin  Decimal?   @map("budget_min") @db.Decimal(12, 2)
  budgetMax  Decimal?   @map("budget_max") @db.Decimal(12, 2)
  currency   String     @default("USD") @db.VarChar(3)

  // Duration & Location
  duration        JobDuration?
  experienceLevel ExperienceLevel @default(INTERMEDIATE) @map("experience_level")
  location        String?         @db.VarChar(200)
  isRemote        Boolean         @default(true) @map("is_remote")

  // Content
  attachments Json     @default("[]")
  tags        String[] @default([])

  // Timestamps
  publishedAt DateTime? @map("published_at")
  expiresAt   DateTime? @map("expires_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  // Relations
  client        User               @relation("ClientJobs", fields: [clientId], references: [id])
  tenant        Tenant?            @relation(fields: [tenantId], references: [id])
  bids          Bid[]
  contracts     Contract[]
  contractsV2   ContractV2[]       @relation("JobContractsV2")
  skills        JobSkill[]
  messages      Message[]          @relation("JobMessages")
  invitations   ProjectInvitation[]
  questions     ProjectQuestion[]
  conversations Conversation[]     @relation("JobConversations")

  @@index([clientId])
  @@index([tenantId])
  @@index([status])
  @@index([publishedAt])
  @@index([deletedAt])
  @@index([slug])
  @@map("jobs")
}

model JobSkill {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  jobId     String   @map("job_id") @db.Uuid
  skillId   String   @map("skill_id") @db.Uuid
  required  Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")

  job   Job   @relation(fields: [jobId], references: [id], onDelete: Cascade)
  skill Skill @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@unique([jobId, skillId])
  @@map("job_skills")
}

enum JobStatus {
  DRAFT
  PENDING_REVIEW
  PUBLISHED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  EXPIRED
}

enum JobVisibility {
  PUBLIC
  PRIVATE
  INVITE_ONLY
}

enum BudgetType {
  FIXED
  HOURLY
  MONTHLY
}

enum JobDuration {
  LESS_THAN_WEEK
  ONE_TO_TWO_WEEKS
  TWO_TO_FOUR_WEEKS
  ONE_TO_THREE_MONTHS
  THREE_TO_SIX_MONTHS
  MORE_THAN_SIX_MONTHS
}

enum ExperienceLevel {
  ENTRY
  INTERMEDIATE
  EXPERT
}

// ============================================================================
// BIDS & PROJECT BIDDING SYSTEM
// ============================================================================

model Bid {
  id           String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  jobId        String    @map("job_id") @db.Uuid
  freelancerId String    @map("freelancer_id") @db.Uuid
  status       BidStatus @default(PENDING)
  bidType      BidType   @default(STANDARD) @map("bid_type")

  // Proposal
  coverLetter  String     @map("cover_letter") @db.Text
  proposedRate Decimal    @map("proposed_rate") @db.Decimal(12, 2)
  rateType     BudgetType @default(FIXED) @map("rate_type")
  deliveryDays Int?       @map("delivery_days")
  attachments  Json       @default("[]")

  // Milestones proposal
  proposedMilestones Json? @map("proposed_milestones")
  // [{ title: string, description: string, amount: number, deliveryDays: number }]

  // Bid quality scoring (anti-spam)
  qualityScore       Int?      @map("quality_score") // 0-100
  qualityFactors     Json?     @map("quality_factors")
  // { relevance: 85, completeness: 90, uniqueness: 70, profileStrength: 95 }
  isSpam             Boolean   @default(false) @map("is_spam")
  spamReason         String?   @map("spam_reason") @db.VarChar(500)

  // Visibility & boosting
  isBoosted          Boolean   @default(false) @map("is_boosted")
  boostedAt          DateTime? @map("boosted_at")
  boostExpiresAt     DateTime? @map("boost_expires_at")

  // Client interaction tracking
  viewedByClientAt   DateTime? @map("viewed_by_client_at")
  shortlistedAt      DateTime? @map("shortlisted_at")
  interviewRequestedAt DateTime? @map("interview_requested_at")
  rejectedAt         DateTime? @map("rejected_at")
  rejectionReason    String?   @map("rejection_reason") @db.Text

  // Interview scheduling
  interviewScheduledAt DateTime? @map("interview_scheduled_at")
  interviewNotes     String?   @map("interview_notes") @db.Text

  // Timestamps
  submittedAt DateTime  @default(now()) @map("submitted_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  withdrawnAt DateTime? @map("withdrawn_at")

  // Relations
  job           Job            @relation(fields: [jobId], references: [id], onDelete: Cascade)
  freelancer    User           @relation(fields: [freelancerId], references: [id])
  contract      Contract?
  contractsV2   ContractV2[]   @relation("BidContractsV2")
  messages      BidMessage[]
  conversations Conversation[] @relation("BidConversations")

  @@unique([jobId, freelancerId])
  @@index([freelancerId])
  @@index([status])
  @@index([submittedAt])
  @@index([qualityScore])
  @@index([isSpam])
  @@map("bids")
}

model BidMessage {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  bidId     String   @map("bid_id") @db.Uuid
  senderId  String   @map("sender_id") @db.Uuid
  
  // Message content
  content   String   @db.Text
  attachments Json   @default("[]")
  
  // Message type
  messageType BidMessageType @default(MESSAGE) @map("message_type")
  
  // Read tracking
  readAt    DateTime? @map("read_at")
  
  createdAt DateTime @default(now()) @map("created_at")
  
  bid       Bid      @relation(fields: [bidId], references: [id], onDelete: Cascade)
  
  @@map("bid_messages")
  @@index([bidId])
  @@index([senderId])
  @@index([createdAt])
}

model ProjectInvitation {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  jobId     String   @map("job_id") @db.Uuid
  inviterId String   @map("inviter_id") @db.Uuid // Client who sent invitation
  inviteeId String   @map("invitee_id") @db.Uuid // Freelancer being invited
  
  // Invitation details
  message   String?  @db.Text
  
  // Status
  status    InvitationStatus @default(PENDING)
  
  // Response
  responseMessage String? @map("response_message") @db.Text
  respondedAt DateTime?   @map("responded_at")
  
  // Timestamps
  sentAt    DateTime @default(now()) @map("sent_at")
  expiresAt DateTime @map("expires_at")
  viewedAt  DateTime? @map("viewed_at")
  
  createdAt DateTime @default(now()) @map("created_at")
  
  job       Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  inviter   User     @relation("InvitationsSent", fields: [inviterId], references: [id])
  invitee   User     @relation("InvitationsReceived", fields: [inviteeId], references: [id])
  
  @@map("project_invitations")
  @@unique([jobId, inviteeId])
  @@index([jobId])
  @@index([inviterId])
  @@index([inviteeId])
  @@index([status])
}

model ProjectQuestion {
  id         String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  jobId      String   @map("job_id") @db.Uuid
  askerId    String   @map("asker_id") @db.Uuid
  
  // Question content
  question   String   @db.Text
  isPublic   Boolean  @default(true) @map("is_public")
  isPinned   Boolean  @default(false) @map("is_pinned")
  
  // Answer (from client)
  answer     String?  @db.Text
  answeredAt DateTime? @map("answered_at")
  answeredBy String?  @map("answered_by") @db.Uuid
  
  // Moderation
  isHidden   Boolean  @default(false) @map("is_hidden")
  hiddenReason String? @map("hidden_reason") @db.VarChar(500)
  
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")
  
  job        Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  asker      User     @relation("QuestionAsker", fields: [askerId], references: [id])
  
  @@map("project_questions")
  @@index([jobId])
  @@index([askerId])
  @@index([isPublic])
}

enum BidStatus {
  PENDING
  SHORTLISTED
  INTERVIEW_REQUESTED
  INTERVIEW_SCHEDULED
  ACCEPTED
  REJECTED
  WITHDRAWN
}

enum BidType {
  STANDARD        // Regular bid
  INVITED         // Response to project invitation
  FEATURED        // Paid featured placement
}

enum BidMessageType {
  MESSAGE          // Regular message
  INTERVIEW_REQUEST // Client requests interview
  INTERVIEW_SCHEDULED // Interview scheduled
  CLARIFICATION   // Clarification request
  COUNTER_OFFER   // Counter offer from client
  SYSTEM          // System message
}

enum InvitationStatus {
  PENDING
  VIEWED
  ACCEPTED    // Freelancer submitted bid
  DECLINED
  EXPIRED
  CANCELLED
}

// ============================================================================
// CONTRACTS
// ============================================================================

model Contract {
  id           String         @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  jobId        String         @map("job_id") @db.Uuid
  bidId        String?        @unique @map("bid_id") @db.Uuid
  clientId     String         @map("client_id") @db.Uuid
  freelancerId String         @map("freelancer_id") @db.Uuid
  status       ContractStatus @default(PENDING)

  // Terms
  title       String     @db.VarChar(200)
  description String     @db.Text
  agreedRate  Decimal    @map("agreed_rate") @db.Decimal(12, 2)
  rateType    BudgetType @default(FIXED) @map("rate_type")
  currency    String     @default("USD") @db.VarChar(3)
  totalAmount Decimal?   @map("total_amount") @db.Decimal(12, 2)

  // Escrow fees
  platformFeePercent   Decimal @default(10) @map("platform_fee_percent") @db.Decimal(5, 2)
  secureModeFeePercent Decimal? @map("secure_mode_fee_percent") @db.Decimal(5, 2)

  // SkillPod integration
  secureMode  Boolean @default(false) @map("secure_mode")
  skillpodId  String? @map("skillpod_id") @db.Uuid

  // Timeline
  startDate  DateTime? @map("start_date")
  endDate    DateTime? @map("end_date")
  deadlineAt DateTime? @map("deadline_at")

  // Contract terms and attachments
  terms       Json?    @default("{}")
  attachments String[] @default([])

  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  signedAt    DateTime? @map("signed_at")
  completedAt DateTime? @map("completed_at")
  cancelledAt DateTime? @map("cancelled_at")

  // Relations
  job                 Job                  @relation(fields: [jobId], references: [id])
  bid                 Bid?                 @relation(fields: [bidId], references: [id])
  client              User                 @relation("ClientContracts", fields: [clientId], references: [id])
  freelancer          User                 @relation("FreelancerContracts", fields: [freelancerId], references: [id])
  milestones          Milestone[]
  payments            Payment[]
  reviews             Review[]
  reviewInvitations   ReviewInvitation[]
  messages            Message[]            @relation("ContractMessages")
  escrowTransactions  EscrowTransaction[]
  escrowBalance       EscrowBalance?
  timeLogs            TimeLog[]
  disputes            Dispute[]

  @@index([clientId])
  @@index([freelancerId])
  @@index([status])
  @@index([createdAt])
  @@map("contracts")
}

enum ContractStatus {
  PENDING
  PENDING_FUNDING  // Waiting for client to fund escrow
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
  DISPUTED
}

model Milestone {
  id          String          @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  contractId  String          @map("contract_id") @db.Uuid
  title       String          @db.VarChar(200)
  description String?         @db.Text
  amount      Decimal         @db.Decimal(12, 2)
  status      MilestoneStatus @default(PENDING)
  sortOrder   Int             @default(0) @map("sort_order")

  // Deliverables
  deliverables    String?  @db.Text
  deliverableUrls String[] @default([]) @map("deliverable_urls")

  // Escrow tracking
  escrowFunded     Boolean   @default(false) @map("escrow_funded")
  escrowFundedAt   DateTime? @map("escrow_funded_at")
  escrowReleasedAt DateTime? @map("escrow_released_at")

  // Revision tracking
  revisionCount Int @default(0) @map("revision_count")
  maxRevisions  Int @default(2) @map("max_revisions")

  // Timestamps
  dueDate     DateTime? @map("due_date")
  startedAt   DateTime? @map("started_at")
  submittedAt DateTime? @map("submitted_at")
  completedAt DateTime? @map("completed_at")
  approvedAt  DateTime? @map("approved_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  contract           Contract            @relation(fields: [contractId], references: [id], onDelete: Cascade)
  payments           Payment[]
  escrowTransactions EscrowTransaction[]

  @@index([contractId])
  @@index([status])
  @@map("milestones")
}

enum MilestoneStatus {
  PENDING
  IN_PROGRESS
  SUBMITTED
  REVISION_REQUESTED
  APPROVED
  RELEASED   // Funds released
  PAID
  DISPUTED
  CANCELLED
}

// ============================================================================
// SERVICES (Productized Offerings)
// ============================================================================

model Service {
  id               String          @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  freelancerId     String          @map("freelancer_id") @db.Uuid
  title            String          @db.VarChar(200)
  slug             String          @db.VarChar(250)
  description      String          @db.Text
  shortDescription String          @map("short_description") @db.VarChar(500)
  status           ServiceStatus   @default(DRAFT)

  // Categorization
  category    ServiceCategory
  subcategory String?         @db.VarChar(100)
  tags        String[]        @default([])

  // Pricing
  basePrice Decimal @map("base_price") @db.Decimal(12, 2)
  currency  String  @default("USD") @db.VarChar(3)

  // Delivery
  deliveryDays      Int @map("delivery_days")
  revisionsIncluded Int @default(1) @map("revisions_included")

  // Deliverables & Requirements
  deliverables Json  // [{title, description}]
  requirements Json? // [{question, type, required, options}]

  // Media
  thumbnailUrl String?  @map("thumbnail_url") @db.VarChar(500)
  galleryUrls  String[] @default([]) @map("gallery_urls")
  videoUrl     String?  @map("video_url") @db.VarChar(500)

  // FAQ
  faqs Json? // [{question, answer}]

  // Visibility
  isActive   Boolean @default(true) @map("is_active")
  isFeatured Boolean @default(false) @map("is_featured")

  // Stats
  viewCount      Int      @default(0) @map("view_count")
  orderCount     Int      @default(0) @map("order_count")
  completedCount Int      @default(0) @map("completed_count")
  avgRating      Decimal? @map("avg_rating") @db.Decimal(3, 2)
  ratingCount    Int      @default(0) @map("rating_count")

  // Response time
  avgResponseHours Int? @map("avg_response_hours")

  // Timestamps
  publishedAt DateTime? @map("published_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  // Relations
  freelancer User                 @relation(fields: [freelancerId], references: [id])
  skills     ServiceSkill[]
  packages   ServicePackage[]
  addOns     ServiceAddOn[]
  orders     ServiceOrder[]
  reviews    ServiceReview[]
  legacyReviews Review[]         // Legacy reviews from old system

  @@unique([freelancerId, slug])
  @@index([freelancerId])
  @@index([status])
  @@index([category])
  @@index([isActive, isFeatured])
  @@index([deletedAt])
  @@map("services")
}

model ServicePackage {
  id        String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  serviceId String @map("service_id") @db.Uuid

  // Package details
  name        String      @db.VarChar(100)
  tier        PackageTier
  description String?     @db.Text

  // Pricing
  price Decimal @db.Decimal(12, 2)

  // Delivery
  deliveryDays      Int @map("delivery_days")
  revisionsIncluded Int @map("revisions_included")

  // What's included
  features     Json // [{feature, included: boolean}]
  deliverables Json // [{title, description, quantity}]

  // Limits
  maxRevisions Int? @map("max_revisions")

  // Status
  isActive Boolean @default(true) @map("is_active")

  sortOrder Int @default(0) @map("sort_order")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  service    Service            @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  orderItems ServiceOrderItem[]

  @@index([serviceId])
  @@map("service_packages")
}

model ServiceAddOn {
  id        String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  serviceId String @map("service_id") @db.Uuid

  // Add-on details
  title       String  @db.VarChar(200)
  description String? @db.Text

  // Pricing
  price Decimal @db.Decimal(12, 2)

  // Impact on delivery
  additionalDays Int @default(0) @map("additional_days")

  // Quantity settings
  allowQuantity Boolean @default(false) @map("allow_quantity")
  maxQuantity   Int?    @map("max_quantity")

  // Status
  isActive Boolean @default(true) @map("is_active")

  sortOrder Int @default(0) @map("sort_order")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  service   Service             @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  orderAddOns ServiceOrderAddOn[]

  @@index([serviceId])
  @@map("service_add_ons")
}

model ServiceOrder {
  id          String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  orderNumber String @unique @map("order_number") @db.VarChar(20)
  serviceId   String @map("service_id") @db.Uuid
  buyerId     String @map("buyer_id") @db.Uuid
  sellerId    String @map("seller_id") @db.Uuid

  // Order details
  status ServiceOrderStatus @default(PENDING_REQUIREMENTS)

  // Pricing breakdown
  subtotal    Decimal @db.Decimal(12, 2)
  addOnsTotal Decimal @default(0) @map("add_ons_total") @db.Decimal(12, 2)
  discount    Decimal @default(0) @db.Decimal(12, 2)
  platformFee Decimal @map("platform_fee") @db.Decimal(12, 2)
  total       Decimal @db.Decimal(12, 2)
  currency    String  @default("USD") @db.VarChar(3)

  // Payment
  paymentStatus   ServicePaymentStatus @default(PENDING) @map("payment_status")
  paymentIntentId String?              @map("payment_intent_id") @db.VarChar(100)
  paidAt          DateTime?            @map("paid_at")

  // Escrow
  escrowStatus     ServiceEscrowStatus @default(NOT_FUNDED) @map("escrow_status")
  escrowReleasedAt DateTime?           @map("escrow_released_at")

  // Timeline
  deliveryDays       Int       @map("delivery_days")
  expectedDeliveryAt DateTime? @map("expected_delivery_at")
  deliveredAt        DateTime? @map("delivered_at")

  // Revisions
  revisionsIncluded Int @map("revisions_included")
  revisionsUsed     Int @default(0) @map("revisions_used")

  // Requirements (buyer's answers)
  requirementAnswers      Json?     @map("requirement_answers")
  requirementsSubmittedAt DateTime? @map("requirements_submitted_at")

  // SkillPod integration
  skillpodEnabled Boolean @default(false) @map("skillpod_enabled")
  podId           String? @map("pod_id") @db.Uuid

  // Completion
  completedAt     DateTime? @map("completed_at")
  autoCompletesAt DateTime? @map("auto_completes_at")

  // Cancellation
  cancelledAt        DateTime? @map("cancelled_at")
  cancellationReason String?   @map("cancellation_reason") @db.Text
  cancelledBy        String?   @map("cancelled_by") @db.Uuid

  // Dispute
  disputeId String? @map("dispute_id") @db.Uuid

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  service          Service              @relation(fields: [serviceId], references: [id])
  buyer            User                 @relation("ServiceBuyer", fields: [buyerId], references: [id])
  seller           User                 @relation("ServiceSeller", fields: [sellerId], references: [id])
  items            ServiceOrderItem[]
  addOns           ServiceOrderAddOn[]
  deliveries       ServiceDelivery[]
  revisionRequests ServiceRevisionRequest[]
  messages         ServiceOrderMessage[]
  review           ServiceReview?
  conversations    Conversation[]       @relation("ServiceOrderConversations")

  @@index([serviceId])
  @@index([buyerId])
  @@index([sellerId])
  @@index([status])
  @@index([orderNumber])
  @@map("service_orders")
}

model ServiceOrderItem {
  id        String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  orderId   String @map("order_id") @db.Uuid
  packageId String @map("package_id") @db.Uuid

  // Snapshot of package at order time
  packageName       String      @map("package_name") @db.VarChar(100)
  packageTier       PackageTier @map("package_tier")
  price             Decimal     @db.Decimal(12, 2)
  deliveryDays      Int         @map("delivery_days")
  revisionsIncluded Int         @map("revisions_included")
  features          Json
  deliverables      Json

  quantity Int @default(1)

  createdAt DateTime @default(now()) @map("created_at")

  order   ServiceOrder   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  package ServicePackage @relation(fields: [packageId], references: [id])

  @@index([orderId])
  @@map("service_order_items")
}

model ServiceOrderAddOn {
  id      String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  orderId String @map("order_id") @db.Uuid
  addOnId String @map("add_on_id") @db.Uuid

  // Snapshot of add-on at order time
  title          String  @db.VarChar(200)
  price          Decimal @db.Decimal(12, 2)
  additionalDays Int     @map("additional_days")

  quantity Int @default(1)

  createdAt DateTime @default(now()) @map("created_at")

  order ServiceOrder  @relation(fields: [orderId], references: [id], onDelete: Cascade)
  addOn ServiceAddOn @relation(fields: [addOnId], references: [id])

  @@index([orderId])
  @@map("service_order_add_ons")
}

model ServiceDelivery {
  id      String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  orderId String @map("order_id") @db.Uuid

  // Delivery details
  deliveryNumber Int     @map("delivery_number")
  message        String? @db.Text

  // Files
  files Json // [{name, url, size, type}]

  // Status
  status ServiceDeliveryStatus @default(PENDING_REVIEW)

  // Buyer response
  acceptedAt          DateTime? @map("accepted_at")
  revisionRequestedAt DateTime? @map("revision_requested_at")

  createdAt DateTime @default(now()) @map("created_at")

  order ServiceOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@map("service_deliveries")
}

model ServiceRevisionRequest {
  id         String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  orderId    String @map("order_id") @db.Uuid
  deliveryId String @map("delivery_id") @db.Uuid

  // Request details
  revisionNumber Int    @map("revision_number")
  description    String @db.Text
  attachments    Json?

  // Response
  respondedAt DateTime? @map("responded_at")
  response    String?   @db.Text

  createdAt DateTime @default(now()) @map("created_at")

  order ServiceOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@map("service_revision_requests")
}

model ServiceReview {
  id         String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  orderId    String @unique @map("order_id") @db.Uuid
  serviceId  String @map("service_id") @db.Uuid
  reviewerId String @map("reviewer_id") @db.Uuid

  // Ratings
  overallRating       Int  @map("overall_rating")
  communicationRating Int? @map("communication_rating")
  qualityRating       Int? @map("quality_rating")
  deliveryRating      Int? @map("delivery_rating")
  valueRating         Int? @map("value_rating")

  // Review content
  title   String? @db.VarChar(200)
  content String? @db.Text

  // Seller response
  sellerResponse    String?   @map("seller_response") @db.Text
  sellerRespondedAt DateTime? @map("seller_responded_at")

  // Moderation
  isPublic           Boolean @default(true) @map("is_public")
  isVerifiedPurchase Boolean @default(true) @map("is_verified_purchase")

  // Helpful votes
  helpfulCount Int @default(0) @map("helpful_count")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  order    ServiceOrder @relation(fields: [orderId], references: [id])
  service  Service      @relation(fields: [serviceId], references: [id])
  reviewer User         @relation("ServiceReviewer", fields: [reviewerId], references: [id])

  @@index([serviceId])
  @@index([reviewerId])
  @@map("service_reviews")
}

model ServiceOrderMessage {
  id       String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  orderId  String @map("order_id") @db.Uuid
  senderId String @map("sender_id") @db.Uuid

  content     String @db.Text
  attachments Json?

  // Message type
  messageType ServiceMessageType @default(TEXT) @map("message_type")

  // Read status
  isRead Boolean   @default(false) @map("is_read")
  readAt DateTime? @map("read_at")

  createdAt DateTime @default(now()) @map("created_at")

  order  ServiceOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  sender User         @relation("ServiceOrderMessageSender", fields: [senderId], references: [id])

  @@index([orderId])
  @@index([senderId])
  @@map("service_order_messages")
}

model ServiceSkill {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  serviceId String   @map("service_id") @db.Uuid
  skillId   String   @map("skill_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")

  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  skill   Skill   @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@unique([serviceId, skillId])
  @@map("service_skills")
}

enum ServiceStatus {
  DRAFT
  PENDING_REVIEW
  ACTIVE
  PAUSED
  REJECTED
  ARCHIVED
}

enum ServiceCategory {
  DEVELOPMENT
  DESIGN
  WRITING
  MARKETING
  VIDEO
  MUSIC
  BUSINESS
  DATA
  LIFESTYLE
  OTHER
}

enum PackageTier {
  BASIC
  STANDARD
  PREMIUM
}

enum ServiceOrderStatus {
  PENDING_REQUIREMENTS
  PENDING_PAYMENT
  IN_PROGRESS
  DELIVERED
  REVISION_REQUESTED
  COMPLETED
  CANCELLED
  DISPUTED
}

enum ServicePaymentStatus {
  PENDING
  PROCESSING
  PAID
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum ServiceEscrowStatus {
  NOT_FUNDED
  FUNDED
  RELEASED
  REFUNDED
  DISPUTED
}

enum ServiceDeliveryStatus {
  PENDING_REVIEW
  ACCEPTED
  REVISION_REQUESTED
}

enum ServiceMessageType {
  TEXT
  DELIVERY
  REVISION_REQUEST
  SYSTEM
}

// ============================================================================
// SKILLPOD SESSIONS (VDI)
// ============================================================================

model Session {
  id       String        @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId   String        @map("user_id") @db.Uuid
  tenantId String?       @map("tenant_id") @db.Uuid
  status   SessionStatus @default(PENDING)
  type     SessionType   @default(DEVELOPMENT)

  // Session Config
  instanceType String @map("instance_type") @db.VarChar(50)
  region       String @db.VarChar(50)
  image        String @db.VarChar(200)
  config       Json   @default("{}")

  // Connection
  connectionUrl String? @map("connection_url") @db.VarChar(500)
  publicIp      String? @map("public_ip") @db.VarChar(45)
  privateIp     String? @map("private_ip") @db.VarChar(45)

  // Usage
  startedAt    DateTime? @map("started_at")
  endedAt      DateTime? @map("ended_at")
  terminatedAt DateTime? @map("terminated_at")
  terminationReason String? @map("termination_reason") @db.Text
  durationMins Int       @default(0) @map("duration_mins")
  costCredits  Decimal   @default(0) @map("cost_credits") @db.Decimal(10, 2)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user   User    @relation(fields: [userId], references: [id])
  tenant Tenant? @relation(fields: [tenantId], references: [id])
  securityPolicy PodSecurityPolicy? @relation(fields: [securityPolicyId], references: [id])
  securityPolicyId String? @map("security_policy_id") @db.Uuid
  
  // Data containment relations
  securityViolations    SecurityViolation[]
  fileTransferRequests  FileTransferRequest[]
  containmentAuditLogs  ContainmentAuditLog[]
  dataTransferAttempts  DataTransferAttempt[]
  screenCaptureAttempts ScreenCaptureAttempt[]
  
  // Session recording
  recordings            SessionRecording[]
  
  // Watermarking
  watermarkInstances    WatermarkInstance[]

  @@index([userId])
  @@index([tenantId])
  @@index([status])
  @@index([startedAt])
  @@index([securityPolicyId])
  @@map("sessions")
}

enum SessionStatus {
  PENDING
  PROVISIONING
  RUNNING
  PAUSED
  STOPPING
  STOPPED
  FAILED
  TERMINATED
}

enum SessionType {
  DEVELOPMENT
  TESTING
  PRODUCTION
  TRAINING
}

// ============================================================================
// DATA CONTAINMENT & SECURITY POLICIES
// ============================================================================

model PodSecurityPolicy {
  id          String  @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId    String  @map("tenant_id") @db.Uuid
  
  // Policy identification
  name        String  @db.VarChar(100)
  description String? @db.Text
  isDefault   Boolean @default(false) @map("is_default")
  
  // Clipboard controls
  clipboardPolicy     ClipboardPolicy @default(BLOCKED) @map("clipboard_policy")
  clipboardInbound    Boolean @default(false) @map("clipboard_inbound")  // Local -> Pod
  clipboardOutbound   Boolean @default(false) @map("clipboard_outbound") // Pod -> Local
  clipboardMaxSize    Int?    @map("clipboard_max_size") // Bytes
  clipboardAllowedTypes String[] @map("clipboard_allowed_types") // ['text/plain']
  
  // File transfer controls
  fileDownloadPolicy  FileTransferPolicy @default(BLOCKED) @map("file_download_policy")
  fileUploadPolicy    FileTransferPolicy @default(ALLOWED) @map("file_upload_policy")
  allowedFileTypes    String[] @map("allowed_file_types") // ['.pdf', '.docx']
  blockedFileTypes    String[] @map("blocked_file_types") // ['.exe', '.zip']
  maxFileSize         Int?     @map("max_file_size") // Bytes
  
  // Printing controls
  printingPolicy      PrintingPolicy @default(BLOCKED) @map("printing_policy")
  allowLocalPrinting  Boolean @default(false) @map("allow_local_printing")
  allowPdfExport      Boolean @default(false) @map("allow_pdf_export")
  
  // Peripheral controls
  usbPolicy           UsbPolicy @default(BLOCKED) @map("usb_policy")
  allowedUsbDevices   String[] @map("allowed_usb_devices") // Device class IDs
  webcamPolicy        PeripheralPolicy @default(ALLOWED) @map("webcam_policy")
  microphonePolicy    PeripheralPolicy @default(ALLOWED) @map("microphone_policy")
  
  // Screen capture controls
  screenCaptureBlocking Boolean @default(true) @map("screen_capture_blocking")
  watermarkEnabled    Boolean @default(true) @map("watermark_enabled")
  watermarkConfig     Json?   @map("watermark_config")
  
  // Network controls
  networkPolicy       NetworkPolicy @default(RESTRICTED) @map("network_policy")
  allowedDomains      String[] @map("allowed_domains")
  blockedDomains      String[] @map("blocked_domains")
  allowInternet       Boolean @default(false) @map("allow_internet")
  
  // Session controls
  idleTimeout         Int     @default(15) @map("idle_timeout") // Minutes
  maxSessionDuration  Int?    @map("max_session_duration") // Minutes
  requireMfa          Boolean @default(true) @map("require_mfa")
  
  // Audit settings
  recordSession       Boolean @default(true) @map("record_session")
  logKeystrokes       Boolean @default(false) @map("log_keystrokes")
  logClipboard        Boolean @default(true) @map("log_clipboard")
  logFileAccess       Boolean @default(true) @map("log_file_access")
  
  // Status
  isActive            Boolean @default(true) @map("is_active")
  
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  
  // Relations
  tenant              Tenant    @relation(fields: [tenantId], references: [id])
  sessions            Session[]
  exceptions          PolicyException[]
  dataTransferAttempts DataTransferAttempt[]
  pods                Pod[]
  
  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([isDefault])
  @@map("pod_security_policies")
}

model SecurityViolation {
  id            String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  sessionId     String   @map("session_id") @db.Uuid
  tenantId      String   @map("tenant_id") @db.Uuid
  
  // Violation details
  violationType ViolationType @map("violation_type")
  severity      ViolationSeverity @default(MEDIUM)
  description   String   @db.Text
  details       Json     @default("{}")
  
  // Context
  sourceIp      String?  @map("source_ip") @db.VarChar(45)
  userAgent     String?  @map("user_agent") @db.Text
  
  // Response taken
  action        ViolationAction @default(LOGGED)
  actionDetails Json?    @map("action_details")
  
  // Review status
  reviewed      Boolean  @default(false)
  reviewedBy    String?  @map("reviewed_by") @db.Uuid
  reviewedAt    DateTime? @map("reviewed_at")
  reviewNotes   String?  @map("review_notes") @db.Text
  
  createdAt     DateTime @default(now()) @map("created_at")
  
  // Relations
  session       Session  @relation(fields: [sessionId], references: [id])
  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  
  @@index([sessionId])
  @@index([tenantId])
  @@index([violationType])
  @@index([severity])
  @@index([createdAt])
  @@map("security_violations")
}

model FileTransferRequest {
  id            String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  sessionId     String   @map("session_id") @db.Uuid
  tenantId      String   @map("tenant_id") @db.Uuid
  requestedBy   String   @map("requested_by") @db.Uuid
  
  // File details
  fileName      String   @map("file_name") @db.VarChar(255)
  fileType      String   @map("file_type") @db.VarChar(100)
  fileSize      Int      @map("file_size") // Bytes
  fileHash      String?  @map("file_hash") @db.VarChar(128)
  direction     TransferDirection
  
  // Request details
  purpose       String   @db.Text
  expiresAt     DateTime @map("expires_at")
  
  // Approval workflow
  status        TransferRequestStatus @default(PENDING)
  approvedBy    String?  @map("approved_by") @db.Uuid
  approvedAt    DateTime? @map("approved_at")
  rejectedBy    String?  @map("rejected_by") @db.Uuid
  rejectedAt    DateTime? @map("rejected_at")
  rejectionReason String? @map("rejection_reason") @db.Text
  
  // Transfer tracking
  transferStartedAt  DateTime? @map("transfer_started_at")
  transferCompletedAt DateTime? @map("transfer_completed_at")
  downloadCount  Int     @default(0) @map("download_count")
  maxDownloads   Int     @default(1) @map("max_downloads")
  
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  // Relations
  session       Session  @relation(fields: [sessionId], references: [id])
  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  
  @@index([sessionId])
  @@index([tenantId])
  @@index([requestedBy])
  @@index([status])
  @@index([createdAt])
  @@map("file_transfer_requests")
}

model ContainmentAuditLog {
  id            String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  sessionId     String   @map("session_id") @db.Uuid
  tenantId      String   @map("tenant_id") @db.Uuid
  userId        String   @map("user_id") @db.Uuid
  
  // Event details
  eventType     ContainmentEventType @map("event_type")
  eventCategory ContainmentEventCategory @map("event_category")
  description   String   @db.Text
  details       Json     @default("{}")
  
  // Context
  sourceIp      String?  @map("source_ip") @db.VarChar(45)
  targetResource String? @map("target_resource") @db.VarChar(500)
  
  // Outcome
  allowed       Boolean
  blockedReason String?  @map("blocked_reason") @db.Text
  policyId      String?  @map("policy_id") @db.Uuid
  
  createdAt     DateTime @default(now()) @map("created_at")
  
  // Relations
  session       Session  @relation(fields: [sessionId], references: [id])
  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  
  @@index([sessionId])
  @@index([tenantId])
  @@index([userId])
  @@index([eventType])
  @@index([eventCategory])
  @@index([createdAt])
  @@map("containment_audit_logs")
}

// Data Containment Enums
enum ClipboardPolicy {
  BLOCKED
  READ_ONLY      // Can paste into pod, not copy out
  WRITE_ONLY     // Can copy out of pod, not paste in
  BIDIRECTIONAL  // Full clipboard access
  APPROVAL_REQUIRED
}

enum FileTransferPolicy {
  BLOCKED
  ALLOWED
  APPROVAL_REQUIRED
  LOGGED_ONLY    // Allowed but heavily logged
}

enum PrintingPolicy {
  BLOCKED
  LOCAL_ONLY     // Print to local printer
  PDF_ONLY       // Export as PDF only
  ALLOWED
  APPROVAL_REQUIRED
}

enum UsbPolicy {
  BLOCKED
  STORAGE_BLOCKED // Block storage devices, allow others
  WHITELIST_ONLY
  ALLOWED
}

enum PeripheralPolicy {
  BLOCKED
  ALLOWED
  SESSION_PROMPT  // Ask user each session
}

enum NetworkPolicy {
  BLOCKED        // No network access
  RESTRICTED     // Whitelist only
  MONITORED      // Full access but logged
  UNRESTRICTED
}

enum ViolationType {
  CLIPBOARD_COPY_ATTEMPT
  CLIPBOARD_PASTE_BLOCKED
  FILE_DOWNLOAD_BLOCKED
  FILE_UPLOAD_BLOCKED
  SCREEN_CAPTURE_ATTEMPT
  USB_DEVICE_BLOCKED
  NETWORK_ACCESS_BLOCKED
  PRINT_BLOCKED
  SESSION_TIMEOUT
  IDLE_TIMEOUT
  UNAUTHORIZED_PERIPHERAL
  POLICY_BYPASS_ATTEMPT
  SUSPICIOUS_ACTIVITY
}

enum ViolationSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ViolationAction {
  LOGGED
  WARNED
  BLOCKED
  SESSION_TERMINATED
  USER_SUSPENDED
  INCIDENT_CREATED
}

enum TransferDirection {
  UPLOAD   // Local to Pod
  DOWNLOAD // Pod to Local
}

enum TransferRequestStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
  COMPLETED
  CANCELLED
}

enum ContainmentEventType {
  CLIPBOARD_COPY
  CLIPBOARD_PASTE
  FILE_DOWNLOAD
  FILE_UPLOAD
  PRINT_REQUEST
  USB_CONNECT
  USB_DISCONNECT
  NETWORK_REQUEST
  SCREEN_CAPTURE
  PERIPHERAL_ACCESS
  SESSION_START
  SESSION_END
  POLICY_CHANGE
  WATERMARK_DISPLAYED
}

enum ContainmentEventCategory {
  DATA_TRANSFER
  DEVICE_ACCESS
  NETWORK
  SESSION
  SECURITY
  CONFIGURATION
}

// ============================================================================
// DATA TRANSFER ATTEMPTS (Extended Logging)
// ============================================================================

model DataTransferAttempt {
  id            String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  sessionId     String   @map("session_id") @db.Uuid
  userId        String   @map("user_id") @db.Uuid
  tenantId      String   @map("tenant_id") @db.Uuid
  
  // Transfer details
  transferType  TransferType @map("transfer_type")
  direction     TransferAttemptDirection
  
  // Content info (no actual content stored for security)
  contentType   String?  @map("content_type") @db.VarChar(100)
  contentSize   Int?     @map("content_size") // Bytes
  contentHash   String?  @map("content_hash") @db.VarChar(128) // SHA-256 hash
  fileName      String?  @map("file_name") @db.VarChar(500)
  
  // Outcome
  action        TransferAction
  reason        String?  @db.Text
  
  // Policy reference
  policyId      String?  @map("policy_id") @db.Uuid
  policyRule    String?  @map("policy_rule") @db.VarChar(200)
  
  // Admin override workflow
  overrideApproved   Boolean  @default(false) @map("override_approved")
  overrideBy         String?  @map("override_by") @db.Uuid
  overrideReason     String?  @map("override_reason") @db.Text
  overrideRequestId  String?  @map("override_request_id") @db.Uuid
  
  // Context
  sourceApplication String?  @map("source_application") @db.VarChar(200)
  targetApplication String?  @map("target_application") @db.VarChar(200)
  ipAddress        String?  @map("ip_address") @db.VarChar(45)
  
  createdAt     DateTime @default(now()) @map("created_at")
  
  // Relations
  session       Session  @relation(fields: [sessionId], references: [id])
  user          User     @relation(fields: [userId], references: [id])
  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  policy        PodSecurityPolicy? @relation(fields: [policyId], references: [id])
  overrideRequest TransferOverrideRequest? @relation(fields: [overrideRequestId], references: [id])
  
  @@index([sessionId])
  @@index([userId])
  @@index([tenantId])
  @@index([policyId])
  @@index([createdAt])
  @@index([transferType, action])
  @@map("data_transfer_attempts")
}

model ScreenCaptureAttempt {
  id            String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  sessionId     String   @map("session_id") @db.Uuid
  userId        String   @map("user_id") @db.Uuid
  tenantId      String   @map("tenant_id") @db.Uuid
  
  // Capture details
  captureType      CaptureType @map("capture_type")
  detectionMethod  String   @map("detection_method") @db.VarChar(100)
  
  // Action taken
  blocked          Boolean
  notificationSent Boolean  @default(false) @map("notification_sent")
  
  // Context
  activeApplication String?  @map("active_application") @db.VarChar(200)
  activeWindow      String?  @map("active_window") @db.VarChar(500)
  
  // Forensics
  processName      String?  @map("process_name") @db.VarChar(200)
  processId        Int?     @map("process_id")
  
  createdAt        DateTime @default(now()) @map("created_at")
  
  // Relations
  session          Session  @relation(fields: [sessionId], references: [id])
  user             User     @relation(fields: [userId], references: [id])
  tenant           Tenant   @relation(fields: [tenantId], references: [id])
  
  @@index([sessionId])
  @@index([userId])
  @@index([tenantId])
  @@index([createdAt])
  @@index([captureType])
  @@map("screen_capture_attempts")
}

model PolicyException {
  id            String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  policyId      String   @map("policy_id") @db.Uuid
  
  // Exception identification
  name          String   @db.VarChar(100)
  description   String?  @db.Text
  
  // Exception scope
  scope         ExceptionScope
  scopeValue    String?  @map("scope_value") @db.VarChar(500) // userId, fileType, domain, etc.
  
  // Exception type
  exceptionType ExceptionType @map("exception_type")
  
  // Allowed actions
  allowedTransferTypes TransferType[] @map("allowed_transfer_types")
  allowedDirections TransferAttemptDirection[] @map("allowed_directions")
  
  // Constraints
  maxFileSize       Int?     @map("max_file_size") // Bytes
  allowedFileTypes  String[] @map("allowed_file_types")
  allowedDomains    String[] @map("allowed_domains")
  
  // Time constraints
  validFrom         DateTime? @map("valid_from")
  validUntil        DateTime? @map("valid_until")
  
  // Approval workflow
  requiresApproval  Boolean  @default(false) @map("requires_approval")
  approvalWorkflow  String?  @map("approval_workflow") @db.VarChar(100)
  
  // Status
  isActive          Boolean  @default(true) @map("is_active")
  
  // Audit
  reason            String   @db.Text
  createdBy         String   @map("created_by") @db.Uuid
  approvedBy        String?  @map("approved_by") @db.Uuid
  
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  // Relations
  policy            PodSecurityPolicy @relation(fields: [policyId], references: [id])
  
  @@index([policyId])
  @@index([scope])
  @@index([exceptionType])
  @@index([isActive])
  @@map("policy_exceptions")
}

model TransferOverrideRequest {
  id            String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId      String   @map("tenant_id") @db.Uuid
  
  // Request details
  attemptId     String?  @map("attempt_id") @db.Uuid // Original blocked attempt
  requestedBy   String   @map("requested_by") @db.Uuid
  reason        String   @db.Text
  
  // Transfer details (copy from original attempt for context)
  transferType  TransferType @map("transfer_type")
  direction     TransferAttemptDirection
  fileName      String?  @map("file_name") @db.VarChar(500)
  contentSize   Int?     @map("content_size")
  
  // Workflow
  status        OverrideRequestStatus @default(PENDING)
  
  // Approval
  approvedBy    String?  @map("approved_by") @db.Uuid
  approvalNotes String?  @map("approval_notes") @db.Text
  processedAt   DateTime? @map("processed_at")
  
  // Expiration
  expiresAt     DateTime @map("expires_at")
  
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  // Relations
  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  attempts      DataTransferAttempt[]
  
  @@index([tenantId])
  @@index([requestedBy])
  @@index([status])
  @@index([createdAt])
  @@map("transfer_override_requests")
}

// Additional Transfer Enums
enum TransferType {
  CLIPBOARD_TEXT
  CLIPBOARD_IMAGE
  CLIPBOARD_FILE
  FILE_DOWNLOAD
  FILE_UPLOAD
  USB_TRANSFER
  PRINT
  SCREEN_SHARE
}

enum TransferAttemptDirection {
  INBOUND    // Into the pod
  OUTBOUND   // Out of the pod
  INTERNAL   // Within the pod
}

enum TransferAction {
  ALLOWED
  BLOCKED
  LOGGED              // Allowed but logged
  QUARANTINED         // Held for review
  OVERRIDE_APPROVED   // Blocked but admin approved
}

enum CaptureType {
  SCREENSHOT
  SCREEN_RECORDING
  REMOTE_DESKTOP
  PRINT_SCREEN_KEY
  SNIPPING_TOOL
  THIRD_PARTY_APP
  BROWSER_EXTENSION
  OS_NATIVE
}

enum ExceptionScope {
  USER
  GROUP
  FILE_TYPE
  DOMAIN
  APPLICATION
  TIME_WINDOW
  IP_ADDRESS
}

enum ExceptionType {
  CLIPBOARD
  FILE_TRANSFER
  USB
  PRINT
  SCREEN_CAPTURE
  NETWORK
}

enum OverrideRequestStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
  CANCELLED
}

// ============================================================================
// MESSAGING
// ============================================================================

model Message {
  id         String  @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  senderId   String  @map("sender_id") @db.Uuid
  receiverId String  @map("receiver_id") @db.Uuid
  jobId      String? @map("job_id") @db.Uuid
  contractId String? @map("contract_id") @db.Uuid
  threadId   String? @map("thread_id") @db.Uuid

  content     String      @db.Text
  type        MessageType @default(TEXT)
  attachments Json        @default("[]")
  metadata    Json        @default("{}")

  // Status
  readAt    DateTime? @map("read_at")
  deletedAt DateTime? @map("deleted_at")
  createdAt DateTime  @default(now()) @map("created_at")

  // Relations
  sender   User      @relation("SenderMessages", fields: [senderId], references: [id])
  receiver User      @relation("ReceiverMessages", fields: [receiverId], references: [id])
  job      Job?      @relation("JobMessages", fields: [jobId], references: [id])
  contract Contract? @relation("ContractMessages", fields: [contractId], references: [id])
  thread   Message?  @relation("MessageThread", fields: [threadId], references: [id])
  replies  Message[] @relation("MessageThread")

  @@index([senderId])
  @@index([receiverId])
  @@index([jobId])
  @@index([contractId])
  @@index([threadId])
  @@index([createdAt])
  @@map("messages")
}

enum MessageType {
  TEXT
  FILE
  IMAGE
  SYSTEM
  OFFER
}

// ============================================================================
// PAYMENTS & BILLING
// ============================================================================

model Payment {
  id              String  @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  contractId      String  @map("contract_id") @db.Uuid
  milestoneId     String? @map("milestone_id") @db.Uuid
  payerId         String  @map("payer_id") @db.Uuid
  payeeId         String  @map("payee_id") @db.Uuid
  paymentMethodId String? @map("payment_method_id") @db.Uuid

  amount    Decimal @db.Decimal(12, 2)
  currency  String  @default("USD") @db.VarChar(3)
  fee       Decimal @default(0) @db.Decimal(12, 2)
  netAmount Decimal @map("net_amount") @db.Decimal(12, 2)

  status PaymentStatus @default(PENDING)
  type   PaymentType   @default(MILESTONE)

  // External references
  stripePaymentIntentId String? @unique @map("stripe_payment_intent_id") @db.VarChar(100)
  stripeTransferId      String? @map("stripe_transfer_id") @db.VarChar(100)

  // Escrow
  escrowedAt DateTime? @map("escrowed_at")
  releasedAt DateTime? @map("released_at")
  refundedAt DateTime? @map("refunded_at")

  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  completedAt DateTime? @map("completed_at")

  contract      Contract       @relation(fields: [contractId], references: [id])
  milestone     Milestone?     @relation(fields: [milestoneId], references: [id])
  paymentMethod PaymentMethod? @relation(fields: [paymentMethodId], references: [id])

  @@index([contractId])
  @@index([milestoneId])
  @@index([payerId])
  @@index([payeeId])
  @@index([paymentMethodId])
  @@index([status])
  @@index([createdAt])
  @@map("payments")
}

// ============================================================================
// STRIPE CUSTOMER
// ============================================================================

model StripeCustomer {
  id               String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId           String @unique @map("user_id") @db.Uuid
  stripeCustomerId String @unique @map("stripe_customer_id") @db.VarChar(100)

  // Metadata
  currency String @default("USD") @db.VarChar(3)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("stripe_customers")
}

// ============================================================================
// PAYMENT METHOD
// ============================================================================

model PaymentMethod {
  id                    String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId                String @map("user_id") @db.Uuid
  stripePaymentMethodId String @unique @map("stripe_payment_method_id") @db.VarChar(100)
  stripeCustomerId      String @map("stripe_customer_id") @db.VarChar(100)

  type      PaymentMethodType
  isDefault Boolean             @default(false) @map("is_default")
  status    PaymentMethodStatus @default(ACTIVE)

  // Card details (for display only - PCI compliant)
  cardBrand    String? @map("card_brand") @db.VarChar(20)
  cardLast4    String? @map("card_last4") @db.VarChar(4)
  cardExpMonth Int?    @map("card_exp_month")
  cardExpYear  Int?    @map("card_exp_year")
  cardFunding  String? @map("card_funding") @db.VarChar(20) // credit, debit, prepaid

  // Bank account details (for display only - PCI compliant)
  bankName         String? @map("bank_name") @db.VarChar(100)
  bankLast4        String? @map("bank_last4") @db.VarChar(4)
  bankAccountType  String? @map("bank_account_type") @db.VarChar(20) // checking, savings
  bankRoutingLast4 String? @map("bank_routing_last4") @db.VarChar(4)

  // SEPA details
  sepaCountry  String? @map("sepa_country") @db.VarChar(2)
  sepaBankCode String? @map("sepa_bank_code") @db.VarChar(20)

  // Billing address (for verification)
  billingName       String? @map("billing_name") @db.VarChar(200)
  billingEmail      String? @map("billing_email") @db.VarChar(255)
  billingCountry    String? @map("billing_country") @db.VarChar(2)
  billingPostalCode String? @map("billing_postal_code") @db.VarChar(20)

  // Expiration handling
  expirationWarningAt DateTime? @map("expiration_warning_at")

  // Metadata
  fingerprint String? @db.VarChar(100) // Stripe fingerprint for dedup

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user         User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  payments     Payment[]
  transactions PaymentTransaction[]

  @@index([userId])
  @@index([stripeCustomerId])
  @@index([status])
  @@index([cardExpYear, cardExpMonth])
  @@map("payment_methods")
}

// ============================================================================
// PAYOUT ACCOUNT (Stripe Connect)
// ============================================================================

model PayoutAccount {
  id                     String              @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId                 String              @unique @map("user_id") @db.Uuid
  stripeConnectAccountId String?             @unique @map("stripe_connect_account_id") @db.VarChar(100)

  // Account type
  accountType PayoutAccountType @default(EXPRESS) @map("account_type")

  // Status
  status PayoutAccountStatus @default(PENDING)

  // Verification
  detailsSubmitted Boolean @default(false) @map("details_submitted")
  chargesEnabled   Boolean @default(false) @map("charges_enabled")
  payoutsEnabled   Boolean @default(false) @map("payouts_enabled")

  // Requirements (JSON arrays)
  currentlyDue  String[] @default([]) @map("currently_due")
  eventuallyDue String[] @default([]) @map("eventually_due")
  pastDue       String[] @default([]) @map("past_due")

  // Payout settings
  defaultCurrency String @default("USD") @map("default_currency") @db.VarChar(3)
  payoutSchedule  Json?  @map("payout_schedule")

  // Business info
  country      String? @db.VarChar(2)
  businessType String? @map("business_type") @db.VarChar(50)

  // External account (bank) info for display
  externalAccountType   String? @map("external_account_type") @db.VarChar(20)
  externalAccountLast4  String? @map("external_account_last4") @db.VarChar(4)
  externalAccountBank   String? @map("external_account_bank") @db.VarChar(100)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  payouts Payout[]

  @@index([userId])
  @@index([status])
  @@map("payout_accounts")
}

enum PayoutAccountType {
  EXPRESS  // Stripe-hosted onboarding
  STANDARD // Full Stripe dashboard access
  CUSTOM   // Full API control
}

enum PayoutAccountStatus {
  PENDING     // Not yet onboarded
  ONBOARDING  // In progress
  ACTIVE      // Can receive payouts
  RESTRICTED  // Action required
  DISABLED    // Cannot receive payouts
}

// ============================================================================
// PAYOUT (Transfer to Connect Account)
// ============================================================================

model Payout {
  id              String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  payoutAccountId String @map("payout_account_id") @db.Uuid

  // Stripe references
  stripeTransferId String? @unique @map("stripe_transfer_id") @db.VarChar(100)
  stripePayoutId   String? @map("stripe_payout_id") @db.VarChar(100)

  // Amount
  amount   Decimal      @db.Decimal(12, 2)
  currency String       @default("USD") @db.VarChar(3)
  status   PayoutStatus @default(PENDING)

  // Reference to what this payout is for
  referenceType String? @map("reference_type") @db.VarChar(50)
  referenceId   String? @map("reference_id") @db.Uuid

  // Description
  description String? @db.VarChar(500)

  // Error info
  failureCode    String? @map("failure_code") @db.VarChar(50)
  failureMessage String? @map("failure_message") @db.VarChar(500)

  // Timestamps
  processedAt DateTime? @map("processed_at")
  arrivedAt   DateTime? @map("arrived_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  payoutAccount PayoutAccount @relation(fields: [payoutAccountId], references: [id])

  @@index([payoutAccountId])
  @@index([status])
  @@index([referenceType, referenceId])
  @@map("payouts")
}

enum PayoutStatus {
  PENDING
  IN_TRANSIT
  PAID
  FAILED
  CANCELED
}

// ============================================================================
// PAYMENT TRANSACTION
// ============================================================================

model PaymentTransaction {
  id     String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId String @map("user_id") @db.Uuid

  // Stripe references
  stripePaymentIntentId String? @unique @map("stripe_payment_intent_id") @db.VarChar(100)
  stripeChargeId        String? @map("stripe_charge_id") @db.VarChar(100)
  paymentMethodId       String? @map("payment_method_id") @db.Uuid

  // Transaction details
  type   TransactionType   @default(PAYMENT)
  status TransactionStatus @default(PENDING)

  // Amounts (in smallest currency unit stored as decimal)
  amount      Decimal  @db.Decimal(12, 2)
  currency    String   @default("USD") @db.VarChar(3)
  platformFee Decimal? @map("platform_fee") @db.Decimal(12, 2)
  stripeFee   Decimal? @map("stripe_fee") @db.Decimal(12, 2)
  netAmount   Decimal? @map("net_amount") @db.Decimal(12, 2)

  // Reference to what this payment is for
  referenceType String? @map("reference_type") @db.VarChar(50) // 'subscription', 'contract', 'escrow'
  referenceId   String? @map("reference_id") @db.Uuid

  // Description and metadata
  description String? @db.VarChar(500)
  metadata    Json?

  // Error handling
  failureCode    String? @map("failure_code") @db.VarChar(50)
  failureMessage String? @map("failure_message") @db.VarChar(500)

  // Timestamps
  processedAt DateTime? @map("processed_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  user          User           @relation(fields: [userId], references: [id])
  paymentMethod PaymentMethod? @relation(fields: [paymentMethodId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([type])
  @@index([referenceType, referenceId])
  @@map("payment_transactions")
}

enum TransactionType {
  PAYMENT
  REFUND
  ESCROW_HOLD
  ESCROW_RELEASE
  SUBSCRIPTION
  PAYOUT
}

enum TransactionStatus {
  PENDING
  PROCESSING
  REQUIRES_ACTION
  SUCCEEDED
  FAILED
  CANCELLED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum PaymentMethodStatus {
  ACTIVE
  EXPIRING_SOON
  EXPIRED
  VERIFICATION_PENDING
  VERIFICATION_FAILED
  REMOVED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  ESCROWED
  RELEASED
  COMPLETED
  FAILED
  REFUNDED
  DISPUTED
}

enum PaymentType {
  MILESTONE
  HOURLY
  BONUS
  REFUND
  SUBSCRIPTION
}

enum PaymentMethodType {
  CARD
  ACH_DEBIT
  SEPA_DEBIT
  WIRE
}

model TenantBillingInvoice {
  id       String        @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId String?       @map("tenant_id") @db.Uuid
  number   String        @unique @db.VarChar(50)
  status   TenantBillingInvoiceStatus @default(DRAFT)

  // Amounts
  subtotal Decimal @db.Decimal(12, 2)
  tax      Decimal @default(0) @db.Decimal(12, 2)
  total    Decimal @db.Decimal(12, 2)
  currency String  @default("USD") @db.VarChar(3)

  // Dates
  issuedAt DateTime? @map("issued_at")
  dueAt    DateTime? @map("due_at")
  paidAt   DateTime? @map("paid_at")

  // Line items
  lineItems Json @default("[]") @map("line_items")

  // External
  stripeInvoiceId String? @unique @map("stripe_invoice_id") @db.VarChar(100)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant Tenant? @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@index([status])
  @@index([number])
  @@map("tenant_billing_invoices")
}

enum TenantBillingInvoiceStatus {
  DRAFT
  ISSUED
  PAID
  OVERDUE
  CANCELLED
  REFUNDED
}

// ============================================================================
// REVIEWS & TRUST
// ============================================================================

model Review {
  id String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid

  // Contract reference (for contract-based reviews)
  contractId String? @map("contract_id") @db.Uuid

  // Service reference (for service-based reviews)
  serviceId String? @map("service_id") @db.Uuid

  // Reviewer and reviewee
  reviewerId String @map("reviewer_id") @db.Uuid
  revieweeId String @map("reviewee_id") @db.Uuid

  // Review direction
  reviewType ReviewType @map("review_type")

  // Overall rating
  overallRating Int @map("overall_rating") @db.SmallInt // 1-5

  // Category ratings (JSON to support different categories per type)
  // Client reviewing freelancer: { quality: 5, communication: 4, expertise: 5, professionalism: 4, wouldHireAgain: true }
  // Freelancer reviewing client: { clarity: 4, responsiveness: 5, payment: 5, professionalism: 4, wouldWorkAgain: true }
  categoryRatings Json @map("category_ratings")

  // Review content
  title   String? @db.VarChar(200)
  content String? @db.Text

  // Private feedback (only visible to Skillancer)
  privateFeedback String? @map("private_feedback") @db.Text

  // Visibility
  isPublic Boolean @default(true) @map("is_public")

  // Reveal status (for simultaneous reveal)
  status     ReviewStatus @default(PENDING)
  revealedAt DateTime?    @map("revealed_at")

  // Response from reviewee
  responseId String? @unique @map("response_id") @db.Uuid

  // Moderation
  isModerated      Boolean   @default(false) @map("is_moderated")
  moderatedAt      DateTime? @map("moderated_at")
  moderatedBy      String?   @map("moderated_by") @db.Uuid
  moderationReason String?   @map("moderation_reason") @db.VarChar(500)
  originalContent  String?   @map("original_content") @db.Text

  // Helpfulness
  helpfulCount    Int @default(0) @map("helpful_count")
  notHelpfulCount Int @default(0) @map("not_helpful_count")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  contract     Contract?           @relation(fields: [contractId], references: [id])
  service      Service?            @relation(fields: [serviceId], references: [id])
  reviewer     User                @relation("ReviewerReviews", fields: [reviewerId], references: [id])
  reviewee     User                @relation("RevieweeReviews", fields: [revieweeId], references: [id])
  response     ReviewResponse?     @relation(fields: [responseId], references: [id])
  helpfulVotes ReviewHelpfulVote[]
  reports      ReviewReport[]

  @@unique([contractId, reviewType])
  @@index([reviewerId])
  @@index([revieweeId])
  @@index([serviceId])
  @@index([status])
  @@index([createdAt])
  @@index([overallRating])
  @@map("reviews")
}

model ReviewResponse {
  id String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid

  // Response content
  content String @db.Text

  // Moderation
  isModerated     Boolean   @default(false) @map("is_moderated")
  moderatedAt     DateTime? @map("moderated_at")
  originalContent String?   @map("original_content") @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  review Review?

  @@map("review_responses")
}

model ReviewHelpfulVote {
  id       String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  reviewId String @map("review_id") @db.Uuid
  userId   String @map("user_id") @db.Uuid

  isHelpful Boolean @map("is_helpful")

  createdAt DateTime @default(now()) @map("created_at")

  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([reviewId, userId])
  @@index([reviewId])
  @@index([userId])
  @@map("review_helpful_votes")
}

model ReviewReport {
  id         String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  reviewId   String @map("review_id") @db.Uuid
  reporterId String @map("reporter_id") @db.Uuid

  reason      ReviewReportReason
  description String?            @db.Text

  status ReportStatus @default(PENDING)

  // Resolution
  resolvedBy String?   @map("resolved_by") @db.Uuid
  resolvedAt DateTime? @map("resolved_at")
  resolution String?   @db.VarChar(500)

  createdAt DateTime @default(now()) @map("created_at")

  review   Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  reporter User   @relation(fields: [reporterId], references: [id])

  @@index([reviewId])
  @@index([status])
  @@index([reporterId])
  @@map("review_reports")
}

model UserRatingAggregation {
  id     String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId String @unique @map("user_id") @db.Uuid

  // As freelancer (receiving reviews from clients)
  freelancerTotalReviews    Int     @default(0) @map("freelancer_total_reviews")
  freelancerAverageRating   Decimal @default(0) @map("freelancer_average_rating") @db.Decimal(3, 2)
  freelancerRatingBreakdown Json    @default("{}") @map("freelancer_rating_breakdown") // { "5": 10, "4": 5, "3": 2, "2": 0, "1": 1 }

  // Category averages (freelancer)
  freelancerQualityAvg         Decimal? @map("freelancer_quality_avg") @db.Decimal(3, 2)
  freelancerCommunicationAvg   Decimal? @map("freelancer_communication_avg") @db.Decimal(3, 2)
  freelancerExpertiseAvg       Decimal? @map("freelancer_expertise_avg") @db.Decimal(3, 2)
  freelancerProfessionalismAvg Decimal? @map("freelancer_professionalism_avg") @db.Decimal(3, 2)
  freelancerRepeatRate         Decimal? @map("freelancer_repeat_rate") @db.Decimal(5, 2) // % of clients who would hire again

  // As client (receiving reviews from freelancers)
  clientTotalReviews    Int     @default(0) @map("client_total_reviews")
  clientAverageRating   Decimal @default(0) @map("client_average_rating") @db.Decimal(3, 2)
  clientRatingBreakdown Json    @default("{}") @map("client_rating_breakdown")

  // Category averages (client)
  clientClarityAvg         Decimal? @map("client_clarity_avg") @db.Decimal(3, 2)
  clientResponsivenessAvg  Decimal? @map("client_responsiveness_avg") @db.Decimal(3, 2)
  clientPaymentAvg         Decimal? @map("client_payment_avg") @db.Decimal(3, 2)
  clientProfessionalismAvg Decimal? @map("client_professionalism_avg") @db.Decimal(3, 2)
  clientRepeatRate         Decimal? @map("client_repeat_rate") @db.Decimal(5, 2)

  // Last calculation
  lastCalculatedAt DateTime @default(now()) @map("last_calculated_at")

  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_rating_aggregations")
}

model ReviewInvitation {
  id         String     @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  contractId String     @map("contract_id") @db.Uuid
  userId     String     @map("user_id") @db.Uuid
  reviewType ReviewType @map("review_type")

  // Status
  status ReviewInvitationStatus @default(PENDING)

  // Timing
  sentAt      DateTime  @default(now()) @map("sent_at")
  expiresAt   DateTime  @map("expires_at")
  completedAt DateTime? @map("completed_at")

  // Reminders
  reminderCount  Int       @default(0) @map("reminder_count")
  lastReminderAt DateTime? @map("last_reminder_at")

  createdAt DateTime @default(now()) @map("created_at")

  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id])

  @@unique([contractId, reviewType])
  @@index([userId])
  @@index([status])
  @@index([expiresAt])
  @@map("review_invitations")
}

enum ReviewType {
  CLIENT_TO_FREELANCER
  FREELANCER_TO_CLIENT
}

enum ReviewStatus {
  PENDING // Submitted but not yet revealed
  REVEALED // Both parties submitted or window closed
  HIDDEN // Hidden due to moderation
}

enum ReviewReportReason {
  INAPPROPRIATE_CONTENT
  FALSE_INFORMATION
  HARASSMENT
  SPAM
  CONFLICT_OF_INTEREST
  OTHER
}

enum ReportStatus {
  PENDING
  UNDER_REVIEW
  RESOLVED
  DISMISSED
}

enum ReviewInvitationStatus {
  PENDING
  COMPLETED
  EXPIRED
  SKIPPED
}

model TrustScore {
  id     String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId String @unique @map("user_id") @db.Uuid

  // Overall score (0-100)
  overallScore Int @default(50) @map("overall_score")

  // Component scores (0-100 each)
  reviewScore       Int @default(50) @map("review_score")
  complianceScore   Int @default(70) @map("compliance_score")
  verificationScore Int @default(0) @map("verification_score")
  tenureScore       Int @default(20) @map("tenure_score")
  activityScore     Int @default(50) @map("activity_score")

  // Component weights (should sum to 100)
  reviewWeight       Int @default(40) @map("review_weight")
  complianceWeight   Int @default(25) @map("compliance_weight")
  verificationWeight Int @default(20) @map("verification_weight")
  tenureWeight       Int @default(10) @map("tenure_weight")
  activityWeight     Int @default(5) @map("activity_weight")

  // Trust tier
  tier TrustTier @default(EMERGING)

  // Trend
  trend             TrustTrend @default(STABLE)
  previousScore     Int?       @map("previous_score")
  scoreChangeAmount Int?       @map("score_change_amount")

  // Calculation metadata
  lastCalculatedAt   DateTime @default(now()) @map("last_calculated_at")
  calculationVersion Int      @default(1) @map("calculation_version")

  // Factors contributing to score (detailed breakdown)
  factors Json @default("{}") @map("factors")

  // Legacy fields (for backward compatibility)
  totalJobs     Int     @default(0) @map("total_jobs")
  completedJobs Int     @default(0) @map("completed_jobs")
  totalEarnings Decimal @default(0) @map("total_earnings") @db.Decimal(12, 2)
  repeatClients Int     @default(0) @map("repeat_clients")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user    User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  history TrustScoreHistory[]

  @@map("trust_scores")
}

model TrustScoreHistory {
  id           String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  trustScoreId String @map("trust_score_id") @db.Uuid

  // Snapshot
  overallScore      Int @map("overall_score")
  reviewScore       Int @map("review_score")
  complianceScore   Int @map("compliance_score")
  verificationScore Int @map("verification_score")
  tenureScore       Int @map("tenure_score")
  activityScore     Int @map("activity_score")

  tier TrustTier

  // What triggered the recalculation
  triggerEvent String @map("trigger_event") @db.VarChar(100)

  createdAt DateTime @default(now()) @map("created_at")

  trustScore TrustScore @relation(fields: [trustScoreId], references: [id], onDelete: Cascade)

  @@index([trustScoreId])
  @@index([createdAt])
  @@map("trust_score_history")
}

model SkillPodComplianceRecord {
  id     String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId String @map("user_id") @db.Uuid

  // Session reference
  sessionId String @map("session_id") @db.Uuid

  // Compliance event
  eventType ComplianceEventType @map("event_type")
  severity  ComplianceSeverity

  // Details
  description String @db.Text
  metadata    Json   @default("{}")

  // Resolution
  isResolved      Boolean   @default(false) @map("is_resolved")
  resolvedAt      DateTime? @map("resolved_at")
  resolvedBy      String?   @map("resolved_by") @db.Uuid
  resolutionNotes String?   @map("resolution_notes") @db.Text

  // Impact on score
  scoreImpact Int @map("score_impact") // Negative value

  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([eventType])
  @@index([createdAt])
  @@map("skillpod_compliance_records")
}

model TrustScoreThreshold {
  id String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid

  // Context
  contextType ThresholdContextType @map("context_type")
  contextId   String?              @map("context_id") @db.Uuid // Job ID, Tenant ID, etc.

  // Threshold
  minimumScore Int        @map("minimum_score")
  minimumTier  TrustTier? @map("minimum_tier")

  // Required verifications
  requireVerification      Boolean            @default(false) @map("require_verification")
  minimumVerificationLevel VerificationLevel? @map("minimum_verification_level")

  // Additional requirements
  requireMfa           Boolean @default(false) @map("require_mfa")
  minimumReviews       Int?    @map("minimum_reviews")
  minimumCompletedJobs Int?    @map("minimum_completed_jobs")

  // Metadata
  createdBy String @map("created_by") @db.Uuid

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([contextType, contextId])
  @@map("trust_score_thresholds")
}

model UserBadge {
  id        String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  badgeId   String    @map("badge_id") @db.VarChar(50)
  earnedAt  DateTime  @default(now()) @map("earned_at")
  revokedAt DateTime? @map("revoked_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
  @@index([userId])
  @@index([badgeId])
  @@map("user_badges")
}

enum TrustTier {
  EMERGING // 0-39:  New or low activity
  ESTABLISHED // 40-59: Building reputation
  TRUSTED // 60-79: Solid track record
  HIGHLY_TRUSTED // 80-94: Excellent reputation
  ELITE // 95-100: Top performers
}

enum TrustTrend {
  RISING
  STABLE
  DECLINING
}

enum ComplianceEventType {
  DATA_TRANSFER_ATTEMPT // Tried to copy data
  UNAUTHORIZED_APP // Ran unauthorized application
  POLICY_VIOLATION // General policy violation
  SESSION_ANOMALY // Unusual session behavior
  SCREENSHOT_ATTEMPT // Screenshot blocked
  SCREEN_SHARE_ATTEMPT // Unauthorized screen share
}

enum ComplianceSeverity {
  LOW // Minor, educational
  MEDIUM // Concerning, warning
  HIGH // Serious, investigation needed
  CRITICAL // Immediate action required
}

enum ThresholdContextType {
  JOB // Specific job requirement
  TENANT // Tenant-wide requirement
  POD_TEMPLATE // SkillPod template requirement
  GLOBAL // Platform-wide minimum
}

// ============================================================================
// NOTIFICATIONS - Unified Notification System
// ============================================================================

model Notification {
  id       String               @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId   String               @map("user_id") @db.Uuid
  
  // Notification details
  type     String               @db.VarChar(100) // 'NEW_MESSAGE', 'BID_RECEIVED', etc.
  category NotificationCategory
  priority NotificationPriority @default(NORMAL)
  
  // Content
  title    String               @db.VarChar(200)
  body     String               @db.Text
  iconUrl  String?              @map("icon_url") @db.VarChar(500)
  imageUrl String?              @map("image_url") @db.VarChar(500)
  
  // Action
  actionUrl   String? @map("action_url") @db.VarChar(500)
  actionLabel String? @map("action_label") @db.VarChar(100)
  
  // Data payload
  data Json? @default("{}")
  
  // Grouping
  groupKey   String? @map("group_key") @db.VarChar(255)
  groupCount Int     @default(1) @map("group_count")
  
  // Status
  isRead      Boolean   @default(false) @map("is_read")
  readAt      DateTime? @map("read_at")
  isDismissed Boolean   @default(false) @map("is_dismissed")
  dismissedAt DateTime? @map("dismissed_at")
  
  // Delivery tracking
  channels       String[] // ['IN_APP', 'EMAIL', 'PUSH']
  deliveryStatus Json?    @map("delivery_status") // {channel: status}
  
  // Expiration
  expiresAt DateTime? @map("expires_at")
  
  createdAt DateTime @default(now()) @map("created_at")
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("notifications")
  @@index([userId])
  @@index([userId, isRead])
  @@index([userId, category])
  @@index([type])
  @@index([createdAt])
  @@index([groupKey])
  @@index([expiresAt])
}

model NotificationPreference {
  id               String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId           String @map("user_id") @db.Uuid
  notificationType String @map("notification_type") @db.VarChar(100)
  
  // Channel preferences
  inAppEnabled Boolean @default(true) @map("in_app_enabled")
  emailEnabled Boolean @default(true) @map("email_enabled")
  pushEnabled  Boolean @default(true) @map("push_enabled")
  smsEnabled   Boolean @default(false) @map("sms_enabled")
  
  // Email preferences
  emailFrequency EmailFrequency @default(IMMEDIATE) @map("email_frequency")
  
  // Quiet hours
  quietHoursEnabled  Boolean @default(false) @map("quiet_hours_enabled")
  quietHoursStart    String? @map("quiet_hours_start") @db.VarChar(5) // "22:00"
  quietHoursEnd      String? @map("quiet_hours_end") @db.VarChar(5)   // "08:00"
  quietHoursTimezone String? @map("quiet_hours_timezone") @db.VarChar(50)
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("notification_preferences")
  @@unique([userId, notificationType])
  @@index([userId])
}

model NotificationTemplate {
  id          String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  type        String @unique @db.VarChar(100)
  name        String @db.VarChar(200)
  description String? @db.Text
  
  // Category
  category NotificationCategory
  
  // Channel templates
  inAppTitle String  @map("in_app_title") @db.VarChar(200)
  inAppBody  String  @map("in_app_body") @db.Text
  
  emailSubject      String? @map("email_subject") @db.VarChar(200)
  emailHtmlTemplate String? @map("email_html_template") @db.Text
  emailTextTemplate String? @map("email_text_template") @db.Text
  
  pushTitle String? @map("push_title") @db.VarChar(200)
  pushBody  String? @map("push_body") @db.VarChar(500)
  
  smsTemplate String? @map("sms_template") @db.VarChar(500)
  
  // Default settings
  defaultPriority NotificationPriority @default(NORMAL) @map("default_priority")
  defaultChannels String[]             @map("default_channels")
  
  // Groupable
  isGroupable      Boolean @default(false) @map("is_groupable")
  groupKeyTemplate String? @map("group_key_template") @db.VarChar(255) // e.g., "messages:{{conversationId}}"
  
  // Status
  isActive Boolean @default(true) @map("is_active")
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  @@map("notification_templates")
  @@index([category])
  @@index([isActive])
}

model NotificationDigest {
  id     String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId String @map("user_id") @db.Uuid
  
  // Digest type
  digestType DigestType @map("digest_type")
  
  // Period
  periodStart DateTime @map("period_start")
  periodEnd   DateTime @map("period_end")
  
  // Content
  notificationIds String[] @map("notification_ids")
  summary         Json     // Aggregated summary
  
  // Delivery
  status       DigestStatus @default(PENDING)
  scheduledFor DateTime     @map("scheduled_for")
  sentAt       DateTime?    @map("sent_at")
  
  // Email tracking
  emailId String? @map("email_id") @db.VarChar(255)
  
  createdAt DateTime @default(now()) @map("created_at")
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("notification_digests")
  @@index([userId])
  @@index([status])
  @@index([scheduledFor])
}

model EmailUnsubscribe {
  id     String  @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId String? @map("user_id") @db.Uuid
  email  String  @db.VarChar(255)
  
  // Unsubscribe type
  unsubscribeType  UnsubscribeType       @map("unsubscribe_type")
  category         NotificationCategory?
  notificationType String?               @map("notification_type") @db.VarChar(100)
  
  // Source
  source String @db.VarChar(50) // 'EMAIL_LINK', 'PREFERENCES', 'ADMIN'
  
  createdAt DateTime @default(now()) @map("created_at")
  
  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("email_unsubscribes")
  @@unique([email, unsubscribeType, category, notificationType])
  @@index([email])
  @@index([userId])
}

// Notification Enums
enum NotificationCategory {
  MESSAGES
  PROJECTS
  CONTRACTS
  PAYMENTS
  ACCOUNT
  MARKETING
  SYSTEM
}

enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum EmailFrequency {
  IMMEDIATE
  HOURLY
  DAILY
  WEEKLY
  NEVER
}

enum DigestType {
  HOURLY
  DAILY
  WEEKLY
}

enum DigestStatus {
  PENDING
  PROCESSING
  SENT
  FAILED
}

enum UnsubscribeType {
  ALL
  CATEGORY
  TYPE
}

// ============================================================================
// AUDIT LOG
// ============================================================================

model AuditLog {
  id         String  @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId     String? @map("user_id") @db.Uuid
  action     String  @db.VarChar(100)
  entityType String  @map("entity_type") @db.VarChar(100)
  entityId   String? @map("entity_id") @db.Uuid

  // Change data
  oldValues Json? @map("old_values")
  newValues Json? @map("new_values")

  // Context
  ipAddress String? @map("ip_address") @db.VarChar(45)
  userAgent String? @map("user_agent") @db.VarChar(500)
  metadata  Json    @default("{}")

  createdAt DateTime @default(now()) @map("created_at")

  user User? @relation("UserAuditLogs", fields: [userId], references: [id])

  @@index([userId])
  @@index([entityType, entityId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================================================
// PRODUCTS & PRICING
// ============================================================================

model Product {
  id              String      @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  stripeProductId String      @unique @map("stripe_product_id") @db.VarChar(100)

  // Product details
  name        String      @db.VarChar(200)
  slug        String      @unique @db.VarChar(100)
  description String?     @db.Text
  productType ProductType @map("product_type")

  // Features (list of features for display)
  features Json? @default("[]")

  // Limits (plan-specific limits like hours, clients, etc.)
  limits Json? @default("{}")

  // Status
  isActive Boolean @default(true) @map("is_active")
  sortOrder Int     @default(0) @map("sort_order")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  prices        Price[]
  subscriptions Subscription[]

  @@index([productType])
  @@index([isActive])
  @@index([slug])
  @@map("products")
}

model Price {
  id            String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  productId     String @map("product_id") @db.Uuid
  stripePriceId String @unique @map("stripe_price_id") @db.VarChar(100)

  // Pricing details
  nickname   String?           @db.VarChar(100) // "Pro Monthly", "Enterprise Annual"
  unitAmount Decimal           @map("unit_amount") @db.Decimal(10, 2)
  currency   String            @default("USD") @db.VarChar(3)

  // Billing cycle
  billingInterval     PriceBillingInterval @map("billing_interval")
  intervalCount       Int                  @default(1) @map("interval_count")

  // Tier information
  tier PriceTier

  // Trial
  trialPeriodDays Int? @map("trial_period_days")

  // Usage-based pricing
  usageType     PriceUsageType? @map("usage_type")
  tieredPricing Json?           @map("tiered_pricing") // For usage tiers

  // Seat-based pricing
  isPerSeat           Boolean  @default(false) @map("is_per_seat")
  includedSeats       Int?     @map("included_seats")
  maxSeats            Int?     @map("max_seats")
  additionalSeatPrice Decimal? @map("additional_seat_price") @db.Decimal(10, 2)

  // Features specific to this price tier
  features Json? @default("[]")

  // Limits specific to this price tier
  limits Json? @default("{}")

  // Display
  isPopular     Boolean @default(false) @map("is_popular")
  isRecommended Boolean @default(false) @map("is_recommended")

  // Status
  isActive  Boolean @default(true) @map("is_active")
  sortOrder Int     @default(0) @map("sort_order")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  product       Product        @relation(fields: [productId], references: [id])
  subscriptions Subscription[]

  @@index([productId])
  @@index([tier])
  @@index([isActive])
  @@map("prices")
}

enum ProductType {
  SKILLPOD
  COCKPIT
  MARKET_PREMIUM
}

enum PriceBillingInterval {
  MONTH
  YEAR
}

enum PriceTier {
  FREE
  STARTER
  BASIC
  PRO
  PROFESSIONAL
  ENTERPRISE
}

enum PriceUsageType {
  METERED    // Pay for what you use
  LICENSED   // Fixed quantity
}

// ============================================================================
// COUPONS & DISCOUNTS
// ============================================================================

model Coupon {
  id             String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  stripeCouponId String @unique @map("stripe_coupon_id") @db.VarChar(100)

  // Coupon details
  code        String     @unique @db.VarChar(50)
  name        String     @db.VarChar(200)
  description String?    @db.Text

  // Discount type
  discountType CouponDiscountType @map("discount_type")
  amountOff    Decimal?           @map("amount_off") @db.Decimal(10, 2)
  percentOff   Decimal?           @map("percent_off") @db.Decimal(5, 2)
  currency     String?            @db.VarChar(3)

  // Duration
  duration       CouponDuration
  durationMonths Int?           @map("duration_months")

  // Restrictions
  maxRedemptions    Int?      @map("max_redemptions")
  currentRedemptions Int      @default(0) @map("current_redemptions")
  validProductTypes  String[] @default([]) @map("valid_product_types") // Restrict to specific products
  minimumAmount     Decimal?  @map("minimum_amount") @db.Decimal(10, 2)

  // Validity
  validFrom DateTime  @default(now()) @map("valid_from")
  validUntil DateTime? @map("valid_until")
  isActive  Boolean   @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  redemptions CouponRedemption[]

  @@index([code])
  @@index([isActive])
  @@index([validUntil])
  @@map("coupons")
}

model CouponRedemption {
  id       String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  couponId String @map("coupon_id") @db.Uuid
  userId   String @map("user_id") @db.Uuid

  // Redemption context
  subscriptionId String? @map("subscription_id") @db.Uuid

  // Discount applied
  discountAmount Decimal @map("discount_amount") @db.Decimal(10, 2)
  currency       String  @db.VarChar(3)

  redeemedAt DateTime @default(now()) @map("redeemed_at")

  coupon Coupon @relation(fields: [couponId], references: [id])

  @@unique([couponId, userId, subscriptionId])
  @@index([userId])
  @@index([subscriptionId])
  @@map("coupon_redemptions")
}

enum CouponDiscountType {
  PERCENT
  AMOUNT
}

enum CouponDuration {
  ONCE
  REPEATING
  FOREVER
}

// ============================================================================
// SUBSCRIPTIONS
// ============================================================================

model Subscription {
  id       String  @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId   String  @map("user_id") @db.Uuid
  tenantId String? @map("tenant_id") @db.Uuid

  // Product reference (new - links to Product/Price catalog)
  productId String? @map("product_id") @db.Uuid
  priceId   String? @map("price_id") @db.Uuid

  // Stripe references
  stripeSubscriptionId String  @unique @map("stripe_subscription_id") @db.VarChar(100)
  stripeCustomerId     String  @map("stripe_customer_id") @db.VarChar(100)
  stripePriceId        String  @map("stripe_price_id") @db.VarChar(100)
  stripeProductId      String? @map("stripe_product_id") @db.VarChar(100)

  // Plan details
  product         SubscriptionProduct
  plan            String              @db.VarChar(50) // 'starter', 'professional', 'enterprise'
  billingInterval BillingInterval     @map("billing_interval")

  // Status
  status             SubscriptionStatus
  trialStart         DateTime?          @map("trial_start")
  trialEndsAt        DateTime?          @map("trial_ends_at")
  currentPeriodStart DateTime           @map("current_period_start")
  currentPeriodEnd   DateTime           @map("current_period_end")
  cancelAt           DateTime?          @map("cancel_at")
  canceledAt         DateTime?          @map("canceled_at")
  cancellationReason String?            @map("cancellation_reason") @db.VarChar(500)
  endedAt            DateTime?          @map("ended_at")

  // Seats (for team subscriptions)
  quantity Int @default(1)

  // Pause support
  pausedAt DateTime? @map("paused_at")
  resumeAt DateTime? @map("resume_at")

  // Pending changes (for scheduled downgrades)
  pendingPlan     String?   @map("pending_plan") @db.VarChar(50)
  pendingPriceId  String?   @map("pending_price_id") @db.VarChar(100)
  pendingChangeAt DateTime? @map("pending_change_at")

  // Usage tracking (for SkillPod)
  usageThisPeriod Int  @default(0) @map("usage_this_period") // minutes
  usageLimit      Int? @map("usage_limit") // minutes per period, null = unlimited

  // Pricing info (for display/history)
  unitAmount Int?   @map("unit_amount") // cents
  currency   String @default("usd") @db.VarChar(3)

  // Metadata
  metadata Json @default("{}")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user                 User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant               Tenant?               @relation(fields: [tenantId], references: [id])
  productRef           Product?              @relation(fields: [productId], references: [id])
  priceRef             Price?                @relation(fields: [priceId], references: [id])
  subscriptionInvoices SubscriptionInvoice[]
  usageRecords         UsageRecord[]

  @@index([userId])
  @@index([tenantId])
  @@index([productId])
  @@index([priceId])
  @@index([stripeSubscriptionId])
  @@index([stripeCustomerId])
  @@index([status])
  @@index([product])
  @@index([currentPeriodEnd])
  @@map("subscriptions")
}

model SubscriptionInvoice {
  id              String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  subscriptionId  String @map("subscription_id") @db.Uuid
  stripeInvoiceId String @unique @map("stripe_invoice_id") @db.VarChar(100)

  // Invoice details
  number          String?                   @db.VarChar(100)
  amountDue       Int                       @map("amount_due") // cents
  amountPaid      Int                       @default(0) @map("amount_paid") // cents
  amountRemaining Int                       @default(0) @map("amount_remaining") // cents
  subtotal        Int                       @default(0) // cents
  tax             Int                       @default(0) // cents
  total           Int                       @default(0) // cents
  currency        String                    @default("usd") @db.VarChar(3)
  status          SubscriptionInvoiceStatus

  // Billing period
  periodStart DateTime @map("period_start")
  periodEnd   DateTime @map("period_end")

  // URLs for customer access
  pdfUrl           String? @map("pdf_url") @db.VarChar(500)
  hostedInvoiceUrl String? @map("hosted_invoice_url") @db.VarChar(500)

  // Line items (for detailed breakdown)
  lineItems Json @default("[]") @map("line_items")

  // Payment info
  attemptCount       Int       @default(0) @map("attempt_count")
  nextPaymentAttempt DateTime? @map("next_payment_attempt")

  // Timestamps
  paidAt    DateTime? @map("paid_at")
  voidedAt  DateTime? @map("voided_at")
  dueDate   DateTime? @map("due_date")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([stripeInvoiceId])
  @@index([status])
  @@index([paidAt])
  @@map("subscription_invoices")
}

model UsageRecord {
  id             String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  subscriptionId String @map("subscription_id") @db.Uuid

  // Usage details
  quantity  Int // minutes used
  action    UsageAction // 'increment' or 'set'
  timestamp DateTime

  // Metadata for tracking source
  sessionId   String? @map("session_id") @db.VarChar(100)
  podId       String? @map("pod_id") @db.VarChar(100)
  description String? @db.VarChar(500)

  // Stripe metered billing reference
  stripeUsageRecordId String? @map("stripe_usage_record_id") @db.VarChar(100)

  createdAt DateTime @default(now()) @map("created_at")

  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([subscriptionId, timestamp])
  @@index([timestamp])
  @@map("usage_records")
}

enum SubscriptionProduct {
  SKILLPOD
  COCKPIT
}

enum BillingInterval {
  MONTHLY
  ANNUAL
}

enum SubscriptionStatus {
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
  UNPAID
  INCOMPLETE
  INCOMPLETE_EXPIRED
  PAUSED
}

enum SubscriptionInvoiceStatus {
  DRAFT
  OPEN
  PAID
  VOID
  UNCOLLECTIBLE
}

enum UsageAction {
  INCREMENT
  SET
}

// ============================================================================
// AUDIT LOGGING (Analytics & Export tracked in PostgreSQL)
// ============================================================================

model AuditAnalytics {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  periodStart DateTime @map("period_start")
  periodEnd   DateTime @map("period_end")
  metricType  String   @map("metric_type") @db.VarChar(100)
  dimensions  Json     @default("{}")
  value       Decimal  @db.Decimal(20, 4)
  metadata    Json     @default("{}")
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([metricType])
  @@index([periodStart, periodEnd])
  @@index([metricType, periodStart])
  @@map("audit_analytics")
}

model AuditExport {
  id            String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  status        String    @db.VarChar(50)
  requestedBy   String    @map("requested_by") @db.VarChar(100)
  filters       Json      @default("{}")
  format        String    @db.VarChar(20)
  includeFields String[]  @map("include_fields")
  fileUrl       String?   @map("file_url") @db.VarChar(500)
  fileSize      Int?      @map("file_size")
  recordCount   Int?      @map("record_count")
  errorMessage  String?   @map("error_message") @db.Text
  startedAt     DateTime? @map("started_at")
  completedAt   DateTime? @map("completed_at")
  expiresAt     DateTime? @map("expires_at")
  createdAt     DateTime  @default(now()) @map("created_at")

  @@index([status])
  @@index([requestedBy])
  @@index([createdAt])
  @@map("audit_exports")
}

model AuditBaseline {
  id           String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  actorId      String   @map("actor_id") @db.VarChar(100)
  eventType    String   @map("event_type") @db.VarChar(100)
  avgCount     Decimal  @map("avg_count") @db.Decimal(10, 2)
  stdDev       Decimal  @map("std_dev") @db.Decimal(10, 2)
  minCount     Int      @map("min_count")
  maxCount     Int      @map("max_count")
  sampleSize   Int      @map("sample_size")
  calculatedAt DateTime @default(now()) @map("calculated_at")

  @@unique([actorId, eventType])
  @@index([actorId])
  @@index([eventType])
  @@map("audit_baselines")
}

// ============================================================================
// ESCROW SYSTEM
// ============================================================================

model EscrowTransaction {
  id          String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  contractId  String @map("contract_id") @db.Uuid
  milestoneId String? @map("milestone_id") @db.Uuid

  // Transaction type
  type   EscrowTransactionType
  status EscrowTransactionStatus @default(PENDING)

  // Amounts
  grossAmount   Decimal @map("gross_amount") @db.Decimal(12, 2)
  platformFee   Decimal @map("platform_fee") @db.Decimal(12, 2)
  processingFee Decimal @map("processing_fee") @db.Decimal(12, 2)
  netAmount     Decimal @map("net_amount") @db.Decimal(12, 2)
  currency      String  @default("USD") @db.VarChar(3)

  // Stripe references
  stripePaymentIntentId String? @map("stripe_payment_intent_id") @db.VarChar(100)
  stripeTransferId      String? @map("stripe_transfer_id") @db.VarChar(100)
  stripeChargeId        String? @map("stripe_charge_id") @db.VarChar(100)
  stripeRefundId        String? @map("stripe_refund_id") @db.VarChar(100)

  // User references
  fromUserId String  @map("from_user_id") @db.Uuid
  toUserId   String? @map("to_user_id") @db.Uuid

  // Metadata
  description    String? @db.VarChar(500)
  metadata       Json?
  failureCode    String? @map("failure_code") @db.VarChar(50)
  failureMessage String? @map("failure_message") @db.Text

  // Timestamps
  processedAt DateTime? @map("processed_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  contract  Contract   @relation(fields: [contractId], references: [id])
  milestone Milestone? @relation(fields: [milestoneId], references: [id])

  @@index([contractId])
  @@index([milestoneId])
  @@index([status])
  @@index([type])
  @@index([fromUserId])
  @@index([toUserId])
  @@map("escrow_transactions")
}

model EscrowBalance {
  id         String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  contractId String @unique @map("contract_id") @db.Uuid

  // Balance tracking
  totalFunded    Decimal @default(0) @map("total_funded") @db.Decimal(12, 2)
  totalReleased  Decimal @default(0) @map("total_released") @db.Decimal(12, 2)
  totalRefunded  Decimal @default(0) @map("total_refunded") @db.Decimal(12, 2)
  currentBalance Decimal @default(0) @map("current_balance") @db.Decimal(12, 2)
  frozenAmount   Decimal @default(0) @map("frozen_amount") @db.Decimal(12, 2)
  currency       String  @default("USD") @db.VarChar(3)

  // Status
  status EscrowBalanceStatus @default(ACTIVE)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  contract Contract @relation(fields: [contractId], references: [id])

  @@map("escrow_balances")
}

model TimeLog {
  id         String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  contractId String @map("contract_id") @db.Uuid

  // Time entry
  description String?  @db.VarChar(500)
  startTime   DateTime @map("start_time")
  endTime     DateTime? @map("end_time")
  duration    Int?     // Minutes

  // Billing
  hourlyRate Decimal  @map("hourly_rate") @db.Decimal(10, 2)
  amount     Decimal? @db.Decimal(10, 2)

  // Status
  status TimeLogStatus @default(PENDING)

  // Approval
  approvedAt DateTime? @map("approved_at")
  approvedBy String?   @map("approved_by") @db.Uuid
  rejectedAt DateTime? @map("rejected_at")
  rejectionReason String? @map("rejection_reason") @db.VarChar(500)

  // SkillPod tracking
  skillpodSessionId String?  @map("skillpod_session_id") @db.Uuid
  isVerified        Boolean  @default(false) @map("is_verified")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  contract Contract @relation(fields: [contractId], references: [id])

  @@index([contractId])
  @@index([status])
  @@index([startTime])
  @@map("time_logs")
}

model Dispute {
  id          String  @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  contractId  String  @map("contract_id") @db.Uuid
  milestoneId String? @map("milestone_id") @db.Uuid

  // Dispute details
  raisedBy     String        @map("raised_by") @db.Uuid
  reason       DisputeReason
  description  String        @db.Text
  evidenceUrls String[]      @default([]) @map("evidence_urls")

  // Amounts in dispute
  disputedAmount Decimal @map("disputed_amount") @db.Decimal(12, 2)
  currency       String  @default("USD") @db.VarChar(3)

  // Status
  status DisputeStatus @default(OPEN)

  // Resolution
  resolvedBy             String?            @map("resolved_by") @db.Uuid
  resolution             DisputeResolution?
  resolutionNotes        String?            @map("resolution_notes") @db.Text
  clientRefundAmount     Decimal?           @map("client_refund_amount") @db.Decimal(12, 2)
  freelancerPayoutAmount Decimal?           @map("freelancer_payout_amount") @db.Decimal(12, 2)

  // Timeline
  respondBy   DateTime? @map("respond_by")
  respondedAt DateTime? @map("responded_at")
  escalatedAt DateTime? @map("escalated_at")
  resolvedAt  DateTime? @map("resolved_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  contract Contract         @relation(fields: [contractId], references: [id])
  messages DisputeMessage[]

  @@index([contractId])
  @@index([milestoneId])
  @@index([status])
  @@index([raisedBy])
  @@map("disputes")
}

model DisputeMessage {
  id        String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  disputeId String @map("dispute_id") @db.Uuid

  senderId   String      @map("sender_id") @db.Uuid
  senderRole DisputeRole @map("sender_role")

  message        String   @db.Text
  attachmentUrls String[] @default([]) @map("attachment_urls")

  // Proposed resolution (optional)
  proposedResolution     DisputeResolution? @map("proposed_resolution")
  proposedClientAmount   Decimal?           @map("proposed_client_amount") @db.Decimal(12, 2)
  proposedFreelancerAmount Decimal?         @map("proposed_freelancer_amount") @db.Decimal(12, 2)

  createdAt DateTime @default(now()) @map("created_at")

  dispute Dispute @relation(fields: [disputeId], references: [id])

  @@index([disputeId])
  @@index([senderId])
  @@map("dispute_messages")
}

enum EscrowTransactionType {
  FUND            // Client funds escrow
  RELEASE         // Release to freelancer
  REFUND          // Refund to client
  PARTIAL_RELEASE // Partial release (dispute resolution)
  PARTIAL_REFUND  // Partial refund (dispute resolution)
  FEE_DEDUCTION   // Platform fee deduction
}

enum EscrowTransactionStatus {
  PENDING
  PROCESSING
  REQUIRES_CAPTURE
  COMPLETED
  FAILED
  CANCELLED
}

enum EscrowBalanceStatus {
  ACTIVE
  FROZEN   // Dispute in progress
  CLOSED
}

enum TimeLogStatus {
  PENDING
  APPROVED
  REJECTED
  BILLED
  DISPUTED
}

enum DisputeReason {
  QUALITY_ISSUES
  MISSED_DEADLINE
  SCOPE_DISAGREEMENT
  COMMUNICATION_ISSUES
  NON_DELIVERY
  PAYMENT_ISSUE
  WORK_NOT_AS_DESCRIBED
  OTHER
}

enum DisputeStatus {
  OPEN
  RESPONDED
  UNDER_REVIEW
  ESCALATED
  RESOLVED
  CLOSED
}

enum DisputeResolution {
  FULL_REFUND
  PARTIAL_REFUND
  FULL_RELEASE
  PARTIAL_RELEASE
  SPLIT
  CANCELLED
}

enum DisputeRole {
  CLIENT
  FREELANCER
  MEDIATOR
  SYSTEM
}

// ============================================================================
// HIPAA COMPLIANCE
// ============================================================================

model HipaaCompliance {
  id       String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId String @unique @map("tenant_id") @db.Uuid

  // Compliance status
  hipaaEnabled    Boolean              @default(false) @map("hipaa_enabled")
  complianceLevel HipaaComplianceLevel @default(NONE) @map("compliance_level")

  // BAA (Business Associate Agreement)
  baaStatus      BaaStatus @default(NOT_REQUESTED) @map("baa_status")
  baaSignedAt    DateTime? @map("baa_signed_at")
  baaExpiresAt   DateTime? @map("baa_expires_at")
  baaDocumentUrl String?   @map("baa_document_url")

  // Security controls
  encryptionEnabled Boolean @default(true) @map("encryption_enabled")
  encryptionKeyId   String? @map("encryption_key_id")

  // Access controls
  mfaRequired    Boolean  @default(true) @map("mfa_required")
  sessionTimeout Int      @default(15) @map("session_timeout") // Minutes
  ipWhitelist    String[] @map("ip_whitelist")

  // Audit settings
  enhancedAuditEnabled Boolean @default(true) @map("enhanced_audit_enabled")
  auditRetentionYears  Int     @default(6) @map("audit_retention_years")

  // Training
  trainingRequired Boolean @default(true) @map("training_required")

  // Assessment
  lastAssessmentAt  DateTime? @map("last_assessment_at")
  nextAssessmentDue DateTime? @map("next_assessment_due")
  assessmentScore   Int?      @map("assessment_score")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant        Tenant         @relation(fields: [tenantId], references: [id])
  phiAccessLogs PhiAccessLog[]

  @@map("hipaa_compliance")
}

model PhiAccessLog {
  id                String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  hipaaComplianceId String @map("hipaa_compliance_id") @db.Uuid

  // Access details
  userId     String        @map("user_id") @db.Uuid
  accessType PhiAccessType @map("access_type")

  // PHI details (no actual PHI stored)
  phiCategory PhiCategory @map("phi_category")
  recordCount Int         @map("record_count")
  purpose     String      // Business justification

  // Context
  resourceType String  @map("resource_type")
  resourceId   String? @map("resource_id")

  // Location
  ipAddress String? @map("ip_address")
  location  String?

  // SkillPod context
  skillpodSessionId String? @map("skillpod_session_id") @db.Uuid

  timestamp DateTime @default(now())

  hipaaCompliance HipaaCompliance @relation(fields: [hipaaComplianceId], references: [id])
  user            User            @relation(fields: [userId], references: [id])

  @@index([hipaaComplianceId])
  @@index([userId])
  @@index([timestamp])
  @@map("phi_access_logs")
}

model HipaaTraining {
  id       String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId   String @map("user_id") @db.Uuid
  tenantId String @map("tenant_id") @db.Uuid

  // Training details
  trainingType    HipaaTrainingType @map("training_type")
  trainingVersion String            @map("training_version")

  // Completion
  status      TrainingStatus @default(NOT_STARTED)
  startedAt   DateTime?      @map("started_at")
  completedAt DateTime?      @map("completed_at")

  // Assessment
  quizScore    Int?    @map("quiz_score")
  passingScore Int     @default(80) @map("passing_score")
  passed       Boolean @default(false)

  // Certificate
  certificateUrl String?   @map("certificate_url")
  expiresAt      DateTime? @map("expires_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, tenantId, trainingType])
  @@index([userId])
  @@index([tenantId])
  @@map("hipaa_training")
}

model BreachIncident {
  id       String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId String @map("tenant_id") @db.Uuid

  // Incident details
  incidentType BreachIncidentType @map("incident_type")
  severity     BreachSeverity
  description  String             @db.Text

  // Discovery
  discoveredAt DateTime @map("discovered_at")
  discoveredBy String   @map("discovered_by") @db.Uuid

  // Scope
  affectedRecords Int?          @map("affected_records")
  affectedUsers   Int?          @map("affected_users")
  phiInvolved     Boolean       @default(false) @map("phi_involved")
  phiCategories   PhiCategory[] @map("phi_categories")

  // Response
  status      BreachStatus @default(INVESTIGATING)
  containedAt DateTime?    @map("contained_at")
  resolvedAt  DateTime?    @map("resolved_at")

  // Notifications
  hhsNotified        Boolean   @default(false) @map("hhs_notified")
  hhsNotifiedAt      DateTime? @map("hhs_notified_at")
  affectedNotified   Boolean   @default(false) @map("affected_notified")
  affectedNotifiedAt DateTime? @map("affected_notified_at")

  // Investigation
  rootCause          String? @map("root_cause") @db.Text
  remediation        String? @db.Text
  preventiveMeasures String? @map("preventive_measures") @db.Text

  // Documentation
  reportUrl String? @map("report_url")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant   Tenant            @relation(fields: [tenantId], references: [id])
  timeline BreachTimeline[]

  @@index([tenantId])
  @@index([status])
  @@map("breach_incidents")
}

model BreachTimeline {
  id               String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  breachIncidentId String @map("breach_incident_id") @db.Uuid

  action      String
  description String?  @db.Text
  performedBy String   @map("performed_by") @db.Uuid
  timestamp   DateTime @default(now())

  breachIncident BreachIncident @relation(fields: [breachIncidentId], references: [id])

  @@index([breachIncidentId])
  @@map("breach_timeline")
}

model PhiToken {
  id       String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId String @map("tenant_id") @db.Uuid

  token          String       @unique
  valueHash      String       @map("value_hash")
  encryptedValue Json         @map("encrypted_value")
  type           PhiFieldType
  resourceType   String?      @map("resource_type")
  resourceId     String?      @map("resource_id")

  createdAt DateTime @default(now()) @map("created_at")
  expiresAt DateTime? @map("expires_at")

  @@index([tenantId])
  @@index([valueHash])
  @@map("phi_tokens")
}

enum HipaaComplianceLevel {
  NONE
  BASIC // Awareness training completed
  STANDARD // BAA signed, controls implemented
  ENHANCED // Full compliance, audited
}

enum BaaStatus {
  NOT_REQUESTED
  REQUESTED
  UNDER_REVIEW
  SIGNED
  EXPIRED
  TERMINATED
}

enum PhiAccessType {
  VIEW
  CREATE
  UPDATE
  DELETE
  EXPORT
  SHARE
}

enum PhiCategory {
  DEMOGRAPHIC // Name, address, DOB
  MEDICAL_RECORD // Diagnoses, treatments
  BILLING // Insurance, payment info
  GENETIC // Genetic test results
  MENTAL_HEALTH // Mental health records
  SUBSTANCE_ABUSE // Substance abuse records
  HIV_AIDS // HIV/AIDS information
  OTHER
}

enum HipaaTrainingType {
  AWARENESS // Basic HIPAA awareness
  SECURITY // Security rule training
  PRIVACY // Privacy rule training
  BREACH // Breach notification
  ANNUAL_REFRESH // Annual refresher
}

enum TrainingStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  EXPIRED
}

enum BreachIncidentType {
  UNAUTHORIZED_ACCESS
  DATA_THEFT
  LOST_DEVICE
  HACKING
  IMPROPER_DISPOSAL
  UNAUTHORIZED_DISCLOSURE
  OTHER
}

enum BreachSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum BreachStatus {
  INVESTIGATING
  CONTAINED
  NOTIFYING
  RESOLVED
  CLOSED
}

enum PhiFieldType {
  SSN
  DOB
  PHONE
  EMAIL
  NAME
  ADDRESS
  MEDICAL_RECORD
  INSURANCE_ID
  OTHER
}

// ============================================================================
// KILL SWITCH SYSTEM
// ============================================================================

model KillSwitchEvent {
  id String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid

  // Scope
  scope     KillSwitchScope
  tenantId  String?         @map("tenant_id") @db.Uuid
  userId    String?         @map("user_id") @db.Uuid
  podId     String?         @map("pod_id") @db.Uuid
  sessionId String?         @map("session_id") @db.Uuid

  // Trigger info
  triggeredBy    String           @map("triggered_by") @db.Uuid
  triggerReason  KillSwitchReason @map("trigger_reason")
  triggerDetails String?          @map("trigger_details") @db.Text

  // Execution status
  status KillSwitchStatus @default(PENDING)

  // Timing
  initiatedAt     DateTime  @default(now()) @map("initiated_at")
  completedAt     DateTime? @map("completed_at")
  executionTimeMs Int?      @map("execution_time_ms")

  // Results
  sessionsTerminated  Int     @default(0) @map("sessions_terminated")
  tokensRevoked       Int     @default(0) @map("tokens_revoked")
  cachePurged         Boolean @default(false) @map("cache_purged")
  recordingsPreserved Boolean @default(false) @map("recordings_preserved")

  // Error tracking
  errors Json?

  // Metadata
  metadata Json?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  actions     KillSwitchAction[]
  revocations AccessRevocation[]

  @@index([tenantId])
  @@index([userId])
  @@index([status])
  @@index([initiatedAt])
  @@map("kill_switch_events")
}

model KillSwitchAction {
  id                String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  killSwitchEventId String @map("kill_switch_event_id") @db.Uuid

  // Action details
  actionType KillSwitchActionType @map("action_type")
  target     String // Session ID, Pod ID, etc.
  targetType String               @map("target_type")

  // Status
  status KillSwitchActionStatus @default(PENDING)

  // Timing
  startedAt   DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")

  // Error handling
  errorMessage String? @map("error_message")
  retryCount   Int     @default(0) @map("retry_count")

  createdAt DateTime @default(now()) @map("created_at")

  killSwitchEvent KillSwitchEvent @relation(fields: [killSwitchEventId], references: [id])

  @@index([killSwitchEventId])
  @@map("kill_switch_actions")
}

model AccessRevocation {
  id String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid

  // Target
  tenantId String? @map("tenant_id") @db.Uuid
  userId   String  @map("user_id") @db.Uuid

  // Revocation details
  revokedBy String @map("revoked_by") @db.Uuid
  reason    String

  // Scope
  scope RevocationScope

  // Status
  isActive  Boolean   @default(true) @map("is_active")
  expiresAt DateTime? @map("expires_at")

  // Reinstatement
  reinstatedBy    String?   @map("reinstated_by") @db.Uuid
  reinstatedAt    DateTime? @map("reinstated_at")
  reinstateReason String?   @map("reinstate_reason")

  // Related kill switch
  killSwitchEventId String? @map("kill_switch_event_id") @db.Uuid

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  killSwitchEvent KillSwitchEvent? @relation(fields: [killSwitchEventId], references: [id])

  @@index([userId])
  @@index([tenantId])
  @@index([isActive])
  @@map("access_revocations")
}

enum KillSwitchScope {
  TENANT // All users in a tenant
  USER // Specific user across all pods
  POD // Specific pod
  SESSION // Specific session
}

enum KillSwitchReason {
  CONTRACT_TERMINATION
  SECURITY_INCIDENT
  POLICY_VIOLATION
  DATA_BREACH_SUSPECTED
  UNAUTHORIZED_ACCESS
  MANUAL_TERMINATION
  SCHEDULED_END
  COMPLIANCE_REQUIREMENT
}

enum KillSwitchStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  PARTIAL_FAILURE
  FAILED
}

enum KillSwitchActionType {
  TERMINATE_SESSION
  TERMINATE_POD
  REVOKE_TOKENS
  PURGE_CACHE
  PRESERVE_RECORDINGS
  NOTIFY_USER
  NOTIFY_ADMIN
  BLOCK_RECONNECTION
}

enum KillSwitchActionStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
  SKIPPED
}

enum RevocationScope {
  SKILLPOD_ONLY
  ALL_PRODUCTS
  TENANT_WIDE
}

// ============================================================================
// SESSION RECORDING SYSTEM
// ============================================================================

model SessionRecording {
  id                String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  sessionId         String   @map("session_id") @db.Uuid
  tenantId          String   @map("tenant_id") @db.Uuid
  userId            String   @map("user_id") @db.Uuid
  
  // Recording status
  status            RecordingStatus @default(RECORDING)
  
  // Storage
  storageLocation   String?  @map("storage_location") // S3 URI
  storageBucket     String?  @map("storage_bucket")
  storageKey        String?  @map("storage_key")
  encryptionKeyId   String?  @map("encryption_key_id") // KMS key ID
  
  // Recording details
  format            String   @default("webm")
  codec             String   @default("vp9")
  resolution        String?  // "1920x1080"
  frameRate         Int?     @map("frame_rate") // fps
  
  // Duration and size
  durationSeconds   Int?     @map("duration_seconds")
  fileSizeBytes     BigInt?  @map("file_size_bytes")
  
  // Timeline markers
  startedAt         DateTime @map("started_at")
  endedAt           DateTime? @map("ended_at")
  
  // Processing
  processingStatus  ProcessingStatus @default(PENDING) @map("processing_status")
  processedAt       DateTime? @map("processed_at")
  thumbnailUrl      String?  @map("thumbnail_url")
  
  // OCR/Search
  ocrStatus         OcrStatus @default(PENDING) @map("ocr_status")
  ocrCompletedAt    DateTime? @map("ocr_completed_at")
  
  // Retention
  retentionPolicy   String?  @map("retention_policy")
  expiresAt         DateTime? @map("expires_at")
  deletedAt         DateTime? @map("deleted_at")
  
  // Access tracking
  viewCount         Int      @default(0) @map("view_count")
  lastViewedAt      DateTime? @map("last_viewed_at")
  lastViewedBy      String?  @map("last_viewed_by") @db.Uuid
  
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  // Relations
  session           Session  @relation(fields: [sessionId], references: [id])
  tenant            Tenant   @relation(fields: [tenantId], references: [id])
  user              User     @relation(fields: [userId], references: [id])
  chunks            RecordingChunk[]
  markers           RecordingMarker[]
  accessLogs        RecordingAccessLog[]
  ocrFrames         RecordingOcrFrame[]
  
  @@map("session_recordings")
  @@index([sessionId])
  @@index([tenantId])
  @@index([userId])
  @@index([status])
  @@index([expiresAt])
}

model RecordingChunk {
  id                String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  recordingId       String   @map("recording_id") @db.Uuid
  
  // Chunk details
  chunkIndex        Int      @map("chunk_index")
  startOffset       Int      @map("start_offset") // seconds from recording start
  durationSeconds   Int      @map("duration_seconds")
  
  // Storage
  storageKey        String   @map("storage_key")
  fileSizeBytes     Int      @map("file_size_bytes")
  
  // Status
  uploadedAt        DateTime @map("uploaded_at")
  
  createdAt         DateTime @default(now()) @map("created_at")
  
  recording         SessionRecording @relation(fields: [recordingId], references: [id])
  
  @@map("recording_chunks")
  @@unique([recordingId, chunkIndex])
  @@index([recordingId])
}

model RecordingMarker {
  id                String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  recordingId       String   @map("recording_id") @db.Uuid
  
  // Marker details
  markerType        MarkerType @map("marker_type")
  timestamp         Int      // seconds from recording start
  
  // Metadata
  label             String? 
  description       String?
  metadata          Json?
  
  // Auto-detected markers
  isAutoDetected    Boolean  @default(false) @map("is_auto_detected")
  detectionSource   String?  @map("detection_source")
  confidence        Decimal? @db.Decimal(3, 2)
  
  // User-added markers
  createdBy         String?  @map("created_by") @db.Uuid
  
  createdAt         DateTime @default(now()) @map("created_at")
  
  recording         SessionRecording @relation(fields: [recordingId], references: [id])
  
  @@map("recording_markers")
  @@index([recordingId])
  @@index([markerType])
  @@index([timestamp])
}

model RecordingOcrFrame {
  id                String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  recordingId       String   @map("recording_id") @db.Uuid
  
  // Frame details
  timestamp         Int      // seconds from recording start
  frameNumber       Int      @map("frame_number")
  
  // OCR results
  extractedText     String   @map("extracted_text") @db.Text
  textConfidence    Decimal  @map("text_confidence") @db.Decimal(3, 2)
  
  // Regions of interest
  textRegions       Json?    @map("text_regions") // [{x, y, width, height, text}]
  
  // Indexing
  elasticsearchId   String?  @map("elasticsearch_id")
  indexedAt         DateTime? @map("indexed_at")
  
  createdAt         DateTime @default(now()) @map("created_at")
  
  recording         SessionRecording @relation(fields: [recordingId], references: [id])
  
  @@map("recording_ocr_frames")
  @@index([recordingId])
  @@index([timestamp])
}

model RecordingAccessLog {
  id                String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  recordingId       String   @map("recording_id") @db.Uuid
  
  // Access details
  accessType        RecordingAccessType @map("access_type")
  accessedBy        String   @map("accessed_by") @db.Uuid
  
  // Context
  ipAddress         String?  @map("ip_address")
  userAgent         String?  @map("user_agent")
  
  // Playback details
  playbackStartTime Int?     @map("playback_start_time") // seconds
  playbackEndTime   Int?     @map("playback_end_time")
  playbackDuration  Int?     @map("playback_duration")
  
  // Purpose
  accessReason      String?  @map("access_reason")
  
  createdAt         DateTime @default(now()) @map("created_at")
  
  recording         SessionRecording @relation(fields: [recordingId], references: [id])
  accessedByUser    User     @relation(fields: [accessedBy], references: [id])
  
  @@map("recording_access_logs")
  @@index([recordingId])
  @@index([accessedBy])
  @@index([createdAt])
}

model RecordingRetentionPolicy {
  id                String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId          String   @map("tenant_id") @db.Uuid
  
  // Policy details
  name              String
  description       String?
  isDefault         Boolean  @default(false) @map("is_default")
  
  // Retention settings
  retentionDays     Int      @map("retention_days")
  
  // Compliance tags
  complianceTags    String[] @map("compliance_tags") // ['SOC2', 'HIPAA']
  
  // Auto-delete
  autoDeleteEnabled Boolean  @default(true) @map("auto_delete_enabled")
  
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  tenant            Tenant   @relation(fields: [tenantId], references: [id])
  
  @@map("recording_retention_policies")
  @@unique([tenantId, name])
  @@index([tenantId])
}

enum RecordingStatus {
  RECORDING
  STOPPED
  PROCESSING
  COMPLETED
  FAILED
  DELETED
}

enum ProcessingStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum OcrStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  SKIPPED
}

enum MarkerType {
  SESSION_START
  SESSION_END
  APPLICATION_OPEN
  APPLICATION_CLOSE
  FILE_ACCESS
  CLIPBOARD_ACTIVITY
  IDLE_START
  IDLE_END
  SECURITY_EVENT
  USER_ADDED
  ERROR
}

enum RecordingAccessType {
  VIEW
  DOWNLOAD
  SHARE
  EXPORT
  DELETE
}

// ============================================================================
// DYNAMIC WATERMARKING SYSTEM
// ============================================================================

model WatermarkConfiguration {
  id                   String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId             String   @map("tenant_id") @db.Uuid
  
  // Configuration name
  name                 String   @db.VarChar(100)
  description          String?  @db.Text
  isDefault            Boolean  @default(false) @map("is_default")
  
  // Visible watermark settings
  visibleEnabled       Boolean  @default(true) @map("visible_enabled")
  visibleConfig        Json     @map("visible_config")
  // {
  //   pattern: 'TILED' | 'CORNER' | 'CENTER' | 'BORDER',
  //   content: ['USER_EMAIL', 'SESSION_ID', 'TIMESTAMP', 'CUSTOM_TEXT'],
  //   customText?: string,
  //   opacity: 0.15,
  //   fontSize: 14,
  //   fontFamily: 'Arial',
  //   fontColor: '#000000',
  //   backgroundColor?: string,
  //   rotation: -30,
  //   spacing: 200,
  //   margin: 20,
  //   includeCompanyLogo: boolean,
  //   logoUrl?: string
  // }
  
  // Invisible watermark settings
  invisibleEnabled     Boolean  @default(true) @map("invisible_enabled")
  invisibleConfig      Json     @map("invisible_config")
  // {
  //   method: 'LSB' | 'DCT' | 'DWT',
  //   strength: 'LOW' | 'MEDIUM' | 'HIGH',
  //   redundancy: 3,
  //   encodeFields: ['USER_ID', 'SESSION_ID', 'TENANT_ID', 'TIMESTAMP']
  // }
  
  // Application settings
  applyToScreenShare   Boolean  @default(true) @map("apply_to_screen_share")
  applyToRecordings    Boolean  @default(true) @map("apply_to_recordings")
  applyToExports       Boolean  @default(true) @map("apply_to_exports")
  
  // Exclusions
  excludedApplications String[] @map("excluded_applications")
  excludedUrls         String[] @map("excluded_urls")
  
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")
  
  // Relations
  tenant               Tenant   @relation(fields: [tenantId], references: [id])
  instances            WatermarkInstance[]
  
  @@map("watermark_configurations")
  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([isDefault])
}

model WatermarkInstance {
  id                String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  configurationId   String   @map("configuration_id") @db.Uuid
  sessionId         String   @map("session_id") @db.Uuid
  
  // Watermark payload
  payload           Json     // The actual data encoded in watermark
  // {
  //   userId: string,
  //   userEmail: string,
  //   sessionId: string,
  //   tenantId: string,
  //   podId: string,
  //   timestamp: string,
  //   sequenceNumber: number,
  //   ipAddress?: string
  // }
  
  // Encoding details
  visibleHash       String?  @map("visible_hash") @db.VarChar(64) // SHA-256 hash
  invisibleKey      String   @map("invisible_key") @db.VarChar(64) // Encryption key
  
  // Timestamps
  generatedAt       DateTime @map("generated_at")
  expiresAt         DateTime? @map("expires_at")
  
  // Status
  isActive          Boolean  @default(true) @map("is_active")
  
  createdAt         DateTime @default(now()) @map("created_at")
  
  // Relations
  configuration     WatermarkConfiguration @relation(fields: [configurationId], references: [id])
  session           Session @relation(fields: [sessionId], references: [id])
  detections        WatermarkDetection[]
  
  @@map("watermark_instances")
  @@index([sessionId])
  @@index([configurationId])
  @@index([invisibleKey])
  @@index([isActive])
}

model WatermarkDetection {
  id                   String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  
  // Detection source
  sourceType           DetectionSourceType @map("source_type")
  sourceUrl            String?  @map("source_url") @db.VarChar(2000)
  sourceDescription    String?  @map("source_description") @db.Text
  
  // Detected watermark
  watermarkInstanceId  String?  @map("watermark_instance_id") @db.Uuid
  detectedPayload      Json?    @map("detected_payload")
  
  // Detection confidence
  confidence           Decimal  @db.Decimal(5, 4) // 0.0000 to 1.0000
  detectionMethod      String   @map("detection_method") @db.VarChar(50)
  
  // Extracted information
  extractedUserId      String?  @map("extracted_user_id") @db.Uuid
  extractedSessionId   String?  @map("extracted_session_id") @db.Uuid
  extractedTimestamp   DateTime? @map("extracted_timestamp")
  
  // Image analysis
  imageHash            String?  @map("image_hash") @db.VarChar(64)
  imageDimensions      String?  @map("image_dimensions") @db.VarChar(20)
  manipulationDetected Boolean  @default(false) @map("manipulation_detected")
  manipulationTypes    String[] @map("manipulation_types")
  
  // Investigation
  investigationStatus  InvestigationStatus @default(PENDING) @map("investigation_status")
  investigatedBy       String?  @map("investigated_by") @db.Uuid
  investigationNotes   String?  @map("investigation_notes") @db.Text
  
  // Reporting
  reportedBy           String?  @map("reported_by") @db.Uuid
  reportedAt           DateTime? @map("reported_at")
  
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")
  
  // Relations
  watermarkInstance    WatermarkInstance? @relation(fields: [watermarkInstanceId], references: [id])
  
  @@map("watermark_detections")
  @@index([watermarkInstanceId])
  @@index([extractedUserId])
  @@index([extractedSessionId])
  @@index([investigationStatus])
  @@index([createdAt])
  @@index([sourceType])
}

enum DetectionSourceType {
  UPLOADED_IMAGE
  WEB_CRAWL
  MANUAL_REPORT
  AUTOMATED_SCAN
  THIRD_PARTY
}

enum InvestigationStatus {
  PENDING
  IN_PROGRESS
  CONFIRMED_LEAK
  FALSE_POSITIVE
  INCONCLUSIVE
  RESOLVED
}

// ============================================================================
// ENVIRONMENT MANAGEMENT - POD TEMPLATES & RESOURCE POOLS
// ============================================================================

model PodTemplate {
  id                     String           @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId               String?          @map("tenant_id") @db.Uuid // null = global template

  // Template identification
  name                   String           @db.VarChar(200)
  slug                   String           @db.VarChar(100)
  description            String?          @db.Text
  shortDescription       String?          @map("short_description") @db.VarChar(500)

  // Categorization
  category               TemplateCategory
  tags                   String[]

  // Base image
  baseImageId            String           @map("base_image_id") @db.Uuid
  kasmImageId            String?          @map("kasm_image_id") @db.VarChar(100) // Kasm registry ID
  ecrImageUri            String?          @map("ecr_image_uri") @db.VarChar(500) // ECR URI

  // Tools and software
  installedTools         Json             @map("installed_tools")
  // [{ name: 'VS Code', version: '1.85', category: 'IDE' }]

  // Configuration
  defaultConfig          Json             @default("{}") @map("default_config")
  // { theme: 'dark', extensions: [], settings: {} }

  // Resource defaults
  defaultResources       Json             @map("default_resources")
  // { cpu: 2, memory: 4096, storage: 50, gpu: false }

  // Constraints
  minResources           Json             @map("min_resources")
  maxResources           Json             @map("max_resources")

  // Startup configuration
  startupScript          String?          @map("startup_script") @db.Text
  environmentVars        Json?            @map("environment_vars")

  // Display
  iconUrl                String?          @map("icon_url") @db.VarChar(500)
  screenshotUrls         String[]         @map("screenshot_urls")
  documentationUrl       String?          @map("documentation_url") @db.VarChar(500)

  // Availability
  isPublic               Boolean          @default(false) @map("is_public")
  isActive               Boolean          @default(true) @map("is_active")
  isFeatured             Boolean          @default(false) @map("is_featured")

  // Versioning
  version                String           @default("1.0.0") @db.VarChar(20)
  changelog              String?          @db.Text

  // Usage tracking
  usageCount             Int              @default(0) @map("usage_count")
  avgRating              Decimal?         @map("avg_rating") @db.Decimal(3, 2)
  ratingCount            Int              @default(0) @map("rating_count")

  // Estimated launch time
  estimatedLaunchSeconds Int              @default(120) @map("estimated_launch_seconds")

  createdAt              DateTime         @default(now()) @map("created_at")
  updatedAt              DateTime         @updatedAt @map("updated_at")

  tenant                 Tenant?          @relation(fields: [tenantId], references: [id])
  baseImage              BaseImage        @relation(fields: [baseImageId], references: [id])
  pods                   Pod[]
  ratings                TemplateRating[]

  @@map("pod_templates")
  @@unique([tenantId, slug])
  @@index([tenantId])
  @@index([category])
  @@index([isPublic, isActive])
  @@index([isFeatured])
}

model BaseImage {
  id                String       @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid

  // Image identification
  name              String       @db.VarChar(200)
  osType            OsType       @map("os_type")
  osVersion         String       @map("os_version") @db.VarChar(50)

  // Registry information
  registryType      RegistryType @map("registry_type")
  registryUri       String       @map("registry_uri") @db.VarChar(500)
  imageTag          String       @map("image_tag") @db.VarChar(100)
  imageDigest       String?      @map("image_digest") @db.VarChar(100)

  // Image details
  sizeBytes         BigInt       @map("size_bytes")
  architecture      String       @default("amd64") @db.VarChar(20)

  // Kasm compatibility
  kasmCompatible    Boolean      @default(true) @map("kasm_compatible")
  kasmImageId       String?      @map("kasm_image_id") @db.VarChar(100)

  // Pre-installed software
  preInstalledTools Json         @map("pre_installed_tools")

  // Status
  isActive          Boolean      @default(true) @map("is_active")
  lastPulledAt      DateTime?    @map("last_pulled_at")
  lastVerifiedAt    DateTime?    @map("last_verified_at")

  createdAt         DateTime     @default(now()) @map("created_at")
  updatedAt         DateTime     @updatedAt @map("updated_at")

  templates         PodTemplate[]

  @@map("base_images")
  @@index([osType])
  @@index([isActive])
}

model Pod {
  id                 String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId           String    @map("tenant_id") @db.Uuid
  ownerId            String    @map("owner_id") @db.Uuid
  templateId         String?   @map("template_id") @db.Uuid

  // Pod identification
  name               String    @db.VarChar(200)
  description        String?   @db.Text

  // Kasm workspace
  kasmId             String?   @unique @map("kasm_id") @db.VarChar(100)
  kasmStatus         String?   @map("kasm_status") @db.VarChar(50)

  // Status
  status             PodStatus @default(PENDING)

  // Resources (current allocation)
  currentResources   Json      @map("current_resources")
  // { cpu: 2, memory: 4096, storage: 50, gpu: false }

  // Resource limits
  resourceLimits     Json      @map("resource_limits")

  // Auto-scaling configuration
  autoScalingEnabled Boolean   @default(false) @map("auto_scaling_enabled")
  autoScalingConfig  Json?     @map("auto_scaling_config")

  // Security
  securityPolicyId   String?   @map("security_policy_id") @db.Uuid
  watermarkConfigId  String?   @map("watermark_config_id") @db.Uuid

  // Persistence
  persistentStorage  Boolean   @default(true) @map("persistent_storage")
  storageVolumeId    String?   @map("storage_volume_id") @db.VarChar(100)

  // Connection
  connectionUrl      String?   @map("connection_url") @db.VarChar(500)
  connectionToken    String?   @map("connection_token") @db.VarChar(1000)

  // Lifecycle
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")
  lastAccessedAt     DateTime? @map("last_accessed_at")
  expiresAt          DateTime? @map("expires_at")
  terminatedAt       DateTime? @map("terminated_at")

  // Cost tracking
  totalCostCents     Int       @default(0) @map("total_cost_cents")

  tenant             Tenant    @relation(fields: [tenantId], references: [id])
  owner              User      @relation(fields: [ownerId], references: [id])
  template           PodTemplate? @relation(fields: [templateId], references: [id])
  securityPolicy     PodSecurityPolicy? @relation(fields: [securityPolicyId], references: [id])
  podSessions        PodSession[]
  resourceHistory    PodResourceHistory[]

  @@map("pods")
  @@index([tenantId])
  @@index([ownerId])
  @@index([status])
  @@index([kasmId])
}

model PodSession {
  id            String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  podId         String    @map("pod_id") @db.Uuid
  userId        String    @map("user_id") @db.Uuid

  // Session details
  startedAt     DateTime  @map("started_at")
  endedAt       DateTime? @map("ended_at")
  durationMins  Int       @default(0) @map("duration_mins")

  // Connection info
  ipAddress     String?   @map("ip_address") @db.VarChar(45)
  userAgent     String?   @map("user_agent") @db.Text

  // Cost
  costCents     Int       @default(0) @map("cost_cents")

  createdAt     DateTime  @default(now()) @map("created_at")

  pod           Pod       @relation(fields: [podId], references: [id])

  @@map("pod_sessions")
  @@index([podId])
  @@index([userId])
  @@index([startedAt])
}

model PodResourceHistory {
  id              String            @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  podId           String            @map("pod_id") @db.Uuid

  // Resource snapshot
  resources       Json
  // { cpu: 2, memory: 4096, storage: 50, gpu: false }

  // Utilization at time of snapshot
  utilization     Json?
  // { cpuPercent: 75, memoryPercent: 60, storagePercent: 40 }

  // Scaling event
  scalingEvent    ScalingEventType? @map("scaling_event")
  scalingReason   String?           @map("scaling_reason") @db.Text

  // Cost
  hourlyRateCents Int               @map("hourly_rate_cents")

  recordedAt      DateTime          @default(now()) @map("recorded_at")

  pod             Pod               @relation(fields: [podId], references: [id])

  @@map("pod_resource_history")
  @@index([podId])
  @@index([recordedAt])
}

model TemplateRating {
  id         String      @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  templateId String      @map("template_id") @db.Uuid
  userId     String      @map("user_id") @db.Uuid

  rating     Int         // 1-5
  review     String?     @db.Text

  createdAt  DateTime    @default(now()) @map("created_at")
  updatedAt  DateTime    @updatedAt @map("updated_at")

  template   PodTemplate @relation(fields: [templateId], references: [id])
  user       User        @relation(fields: [userId], references: [id])

  @@map("template_ratings")
  @@unique([templateId, userId])
  @@index([templateId])
}

model ResourcePool {
  id                 String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId           String?  @map("tenant_id") @db.Uuid // null = shared pool

  // Pool configuration
  name               String   @db.VarChar(200)
  description        String?  @db.Text

  // Instance type
  instanceType       String   @map("instance_type") @db.VarChar(50) // e.g., 'c5.xlarge'

  // Capacity
  minInstances       Int      @map("min_instances")
  maxInstances       Int      @map("max_instances")
  currentInstances   Int      @default(0) @map("current_instances")

  // Warm pool (pre-provisioned instances)
  warmPoolSize       Int      @default(0) @map("warm_pool_size")
  warmInstances      Int      @default(0) @map("warm_instances")

  // Auto-scaling
  scaleUpThreshold   Int      @default(70) @map("scale_up_threshold") // CPU %
  scaleDownThreshold Int      @default(30) @map("scale_down_threshold")
  scaleUpCooldown    Int      @default(300) @map("scale_up_cooldown") // seconds
  scaleDownCooldown  Int      @default(600) @map("scale_down_cooldown")

  // Cost
  hourlyRateCents    Int      @map("hourly_rate_cents")

  // Status
  isActive           Boolean  @default(true) @map("is_active")

  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  tenant             Tenant?  @relation(fields: [tenantId], references: [id])

  @@map("resource_pools")
  @@index([tenantId])
  @@index([isActive])
}

model TenantResourceQuota {
  id           String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId     String   @unique @map("tenant_id") @db.Uuid

  // Relation to Tenant
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // CPU quota
  maxCpu       Int      @map("max_cpu") // Total vCPUs allowed
  usedCpu      Int      @default(0) @map("used_cpu")

  // Memory quota
  maxMemory    Int      @map("max_memory") // Total MB allowed
  usedMemory   Int      @default(0) @map("used_memory")

  // Storage quota
  maxStorage   Int      @map("max_storage") // Total GB allowed
  usedStorage  Int      @default(0) @map("used_storage")

  // Pod count quota
  maxPods      Int      @map("max_pods")
  activePods   Int      @default(0) @map("active_pods")

  // GPU quota
  maxGpus      Int      @default(0) @map("max_gpus")
  usedGpus     Int      @default(0) @map("used_gpus")

  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("tenant_resource_quotas")
  @@index([tenantId])
}

enum TemplateCategory {
  DEVELOPMENT
  FINANCE
  DESIGN
  DATA_SCIENCE
  GENERAL
  SECURITY
  DEVOPS
  CUSTOM
}

enum OsType {
  UBUNTU
  DEBIAN
  CENTOS
  AMAZON_LINUX
  WINDOWS_SERVER
  WINDOWS_DESKTOP
}

enum RegistryType {
  ECR
  DOCKER_HUB
  KASM
  CUSTOM
}

enum PodStatus {
  PENDING
  PROVISIONING
  STARTING
  RUNNING
  STOPPING
  STOPPED
  HIBERNATING
  TERMINATED
  ERROR
}

enum ScalingEventType {
  SCALE_UP
  SCALE_DOWN
  MANUAL_CHANGE
  AUTO_SCALE
  INITIAL_PROVISION
}

// ============================================================================
// SMARTMATCH - INTELLIGENT MATCHING SYSTEM
// ============================================================================

model FreelancerWorkPattern {
  id                    String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId                String   @unique @map("user_id") @db.Uuid
  
  // Availability
  weeklyHoursAvailable  Int?     @map("weekly_hours_available")
  preferredHoursPerWeek Int?     @map("preferred_hours_per_week")
  
  // Schedule
  workingDays           String[] @map("working_days") // ['MONDAY', 'TUESDAY', ...]
  workingHoursStart     String?  @map("working_hours_start") // '09:00'
  workingHoursEnd       String?  @map("working_hours_end") // '17:00'
  timezone              String?
  
  // Response patterns (calculated from history)
  avgResponseTimeMinutes Int?    @map("avg_response_time_minutes")
  avgFirstBidTimeHours   Int?    @map("avg_first_bid_time_hours")
  
  // Work preferences
  preferredProjectDuration String[] @map("preferred_project_duration")
  preferredBudgetMin       Decimal? @map("preferred_budget_min") @db.Decimal(12, 2)
  preferredBudgetMax       Decimal? @map("preferred_budget_max") @db.Decimal(12, 2)
  preferredLocationType    String[] @map("preferred_location_type")
  
  // Capacity
  currentActiveProjects Int @default(0) @map("current_active_projects")
  maxConcurrentProjects Int @default(3) @map("max_concurrent_projects")
  
  // Not available periods
  unavailablePeriods    Json?    @map("unavailable_periods")
  // [{ startDate, endDate, reason }]
  
  // Last activity
  lastActiveAt          DateTime? @map("last_active_at")
  lastBidAt             DateTime? @map("last_bid_at")
  lastProjectCompletedAt DateTime? @map("last_project_completed_at")
  
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")
  
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("freelancer_work_patterns")
  @@index([timezone])
  @@index([lastActiveAt])
}

model MatchingEvent {
  id                String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  
  // Context
  eventType         MatchingEventType @map("event_type")
  projectId         String?  @map("project_id") @db.Uuid
  serviceId         String?  @map("service_id") @db.Uuid
  
  // Participants
  clientUserId      String   @map("client_user_id") @db.Uuid
  freelancerUserId  String   @map("freelancer_user_id") @db.Uuid
  
  // Matching context
  matchScore        Int?     @map("match_score")
  matchRank         Int?     @map("match_rank")
  matchFactors      Json?    @map("match_factors")
  // { compliance: 0.95, skills: 0.85, trust: 0.78, rate: 0.90, ... }
  
  // Outcome
  outcome           MatchingOutcome?
  outcomeAt         DateTime? @map("outcome_at")
  
  // For learning
  wasHired          Boolean?  @map("was_hired")
  projectSuccessful Boolean?  @map("project_successful")
  clientSatisfactionScore Int? @map("client_satisfaction_score")
  
  // Metadata
  searchCriteria    Json?    @map("search_criteria")
  
  createdAt         DateTime @default(now()) @map("created_at")
  
  client            User     @relation("ClientMatchingEvents", fields: [clientUserId], references: [id], onDelete: Cascade)
  freelancer        User     @relation("FreelancerMatchingEvents", fields: [freelancerUserId], references: [id], onDelete: Cascade)
  
  @@map("matching_events")
  @@index([projectId])
  @@index([freelancerUserId])
  @@index([clientUserId])
  @@index([eventType])
  @@index([createdAt])
}

model RateIntelligence {
  id                  String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  
  // Segmentation
  skillCategory       String   @map("skill_category")
  primarySkill        String?  @map("primary_skill")
  experienceLevel     ExperienceLevel @map("experience_level")
  region              String?  // 'US', 'EU', 'ASIA', 'GLOBAL'
  
  // Rate statistics
  sampleSize          Int      @map("sample_size")
  avgHourlyRate       Decimal  @map("avg_hourly_rate") @db.Decimal(10, 2)
  medianHourlyRate    Decimal  @map("median_hourly_rate") @db.Decimal(10, 2)
  minHourlyRate       Decimal  @map("min_hourly_rate") @db.Decimal(10, 2)
  maxHourlyRate       Decimal  @map("max_hourly_rate") @db.Decimal(10, 2)
  percentile25        Decimal  @db.Decimal(10, 2)
  percentile75        Decimal  @db.Decimal(10, 2)
  percentile90        Decimal  @db.Decimal(10, 2)
  
  // Fixed project rates
  avgFixedProjectRate Decimal? @map("avg_fixed_project_rate") @db.Decimal(12, 2)
  
  // Trends
  rateChangePct30d    Decimal? @map("rate_change_pct_30d") @db.Decimal(5, 2)
  rateChangePct90d    Decimal? @map("rate_change_pct_90d") @db.Decimal(5, 2)
  
  // Period
  periodStart         DateTime @map("period_start")
  periodEnd           DateTime @map("period_end")
  
  createdAt           DateTime @default(now()) @map("created_at")
  
  @@map("rate_intelligence")
  @@unique([skillCategory, primarySkill, experienceLevel, region, periodStart])
  @@index([skillCategory])
  @@index([primarySkill])
}

model SkillRelationship {
  id                String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  
  // Skills
  skill1            String
  skill2            String
  
  // Relationship type
  relationshipType  SkillRelationType @map("relationship_type")
  
  // Strength (0-1)
  strength          Decimal  @db.Decimal(3, 2)
  
  // Bidirectional flag
  bidirectional     Boolean  @default(true)
  
  // Source
  source            String   // 'MANUAL', 'INFERRED', 'ML_MODEL'
  
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  @@map("skill_relationships")
  @@unique([skill1, skill2])
  @@index([skill1])
  @@index([skill2])
}

model FreelancerSkillEndorsement {
  id                String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId            String   @map("user_id") @db.Uuid
  skill             String
  
  // Endorsement details
  endorsedByUserId  String   @map("endorsed_by_user_id") @db.Uuid
  endorsementType   EndorsementType @map("endorsement_type")
  
  // Context
  projectId         String?  @map("project_id") @db.Uuid
  comment           String?
  
  createdAt         DateTime @default(now()) @map("created_at")
  
  user              User     @relation("SkillEndorsements", fields: [userId], references: [id], onDelete: Cascade)
  endorsedBy        User     @relation("GivenEndorsements", fields: [endorsedByUserId], references: [id], onDelete: Cascade)
  
  @@map("freelancer_skill_endorsements")
  @@unique([userId, skill, endorsedByUserId])
  @@index([userId, skill])
}

enum MatchingEventType {
  SEARCH_RESULT
  RECOMMENDATION
  INVITATION_SENT
  BID_SUBMITTED
  BID_VIEWED
  BID_SHORTLISTED
  INTERVIEW_SCHEDULED
  HIRED
  PROJECT_COMPLETED
}

enum MatchingOutcome {
  IGNORED
  VIEWED
  SHORTLISTED
  INTERVIEWED
  HIRED
  REJECTED
  WITHDRAWN
}

enum SkillRelationType {
  PARENT_CHILD      // React -> JavaScript
  SIBLING           // React <-> Vue
  COMPLEMENTARY     // Frontend -> UX Design
  PREREQUISITE      // Kubernetes requires Docker
}

enum EndorsementType {
  WORKED_WITH       // Endorsed based on working together
  VERIFIED_SKILL    // Endorsed after seeing work
  RECOMMENDATION    // General recommendation
}

// ============================================================================
// RATE INTELLIGENCE SYSTEM
// ============================================================================

model RateDataPoint {
  id                  String         @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  
  // Source
  sourceType          RateSourceType @map("source_type")
  sourceId            String         @map("source_id") @db.Uuid // contractId, bidId, serviceOrderId
  
  // Categorization
  primarySkill        String         @map("primary_skill")
  secondarySkills     String[]       @map("secondary_skills")
  skillCategory       String         @map("skill_category")
  
  // Rate details
  rateType            RateType       @map("rate_type")
  hourlyRate          Decimal?       @map("hourly_rate") @db.Decimal(10, 2)
  fixedRate           Decimal?       @map("fixed_rate") @db.Decimal(12, 2)
  projectDurationDays Int?           @map("project_duration_days")
  effectiveHourlyRate Decimal?       @map("effective_hourly_rate") @db.Decimal(10, 2)
  
  // Context
  experienceLevel     ExperienceLevel @map("experience_level")
  freelancerUserId    String         @map("freelancer_user_id") @db.Uuid
  clientUserId        String         @map("client_user_id") @db.Uuid
  
  // Geography
  freelancerCountry   String?        @map("freelancer_country")
  freelancerRegion    String?        @map("freelancer_region") // 'US', 'EU', 'ASIA', etc.
  clientCountry       String?        @map("client_country")
  
  // Outcome
  wasAccepted         Boolean        @map("was_accepted")
  projectCompleted    Boolean?       @map("project_completed")
  clientRating        Int?           @map("client_rating") // 1-5
  
  // Compliance premium
  complianceRequired  String[]       @map("compliance_required")
  hasCompliancePremium Boolean       @default(false) @map("has_compliance_premium")
  
  // Timestamp
  occurredAt          DateTime       @map("occurred_at")
  
  createdAt           DateTime       @default(now()) @map("created_at")
  
  @@map("rate_data_points")
  @@index([primarySkill])
  @@index([skillCategory])
  @@index([experienceLevel])
  @@index([freelancerRegion])
  @@index([occurredAt])
  @@index([wasAccepted])
  @@index([sourceType, sourceId])
}

model RateAggregate {
  id                   String          @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  
  // Segmentation
  skillCategory        String          @map("skill_category")
  primarySkill         String?         @map("primary_skill")
  experienceLevel      ExperienceLevel @map("experience_level")
  region               String          // 'US', 'EU', 'ASIA', 'GLOBAL'
  
  // Period
  periodType           PeriodType      @map("period_type")
  periodStart          DateTime        @map("period_start")
  periodEnd            DateTime        @map("period_end")
  
  // Sample info
  sampleSize           Int             @map("sample_size")
  acceptedCount        Int             @map("accepted_count")
  completedCount       Int             @map("completed_count")
  
  // Hourly rate statistics
  hourlyRateMin        Decimal         @map("hourly_rate_min") @db.Decimal(10, 2)
  hourlyRateMax        Decimal         @map("hourly_rate_max") @db.Decimal(10, 2)
  hourlyRateAvg        Decimal         @map("hourly_rate_avg") @db.Decimal(10, 2)
  hourlyRateMedian     Decimal         @map("hourly_rate_median") @db.Decimal(10, 2)
  hourlyRateStdDev     Decimal         @map("hourly_rate_std_dev") @db.Decimal(10, 2)
  
  // Percentiles
  hourlyRateP10        Decimal         @map("hourly_rate_p10") @db.Decimal(10, 2)
  hourlyRateP25        Decimal         @map("hourly_rate_p25") @db.Decimal(10, 2)
  hourlyRateP75        Decimal         @map("hourly_rate_p75") @db.Decimal(10, 2)
  hourlyRateP90        Decimal         @map("hourly_rate_p90") @db.Decimal(10, 2)
  
  // Fixed rate statistics (for project-based)
  fixedRateMin         Decimal?        @map("fixed_rate_min") @db.Decimal(12, 2)
  fixedRateMax         Decimal?        @map("fixed_rate_max") @db.Decimal(12, 2)
  fixedRateAvg         Decimal?        @map("fixed_rate_avg") @db.Decimal(12, 2)
  fixedRateMedian      Decimal?        @map("fixed_rate_median") @db.Decimal(12, 2)
  
  // Acceptance rate by price tier
  acceptanceRateLow    Decimal?        @map("acceptance_rate_low") @db.Decimal(5, 4) // < P25
  acceptanceRateMid    Decimal?        @map("acceptance_rate_mid") @db.Decimal(5, 4) // P25-P75
  acceptanceRateHigh   Decimal?        @map("acceptance_rate_high") @db.Decimal(5, 4) // > P75
  
  // Success correlation
  avgRatingLowPrice    Decimal?        @map("avg_rating_low_price") @db.Decimal(3, 2)
  avgRatingMidPrice    Decimal?        @map("avg_rating_mid_price") @db.Decimal(3, 2)
  avgRatingHighPrice   Decimal?        @map("avg_rating_high_price") @db.Decimal(3, 2)
  
  // Compliance premium analysis
  compliancePremiumPct Decimal?        @map("compliance_premium_pct") @db.Decimal(5, 2)
  
  // Trend
  rateChangeFromPrevious Decimal?      @map("rate_change_from_previous") @db.Decimal(5, 2)
  
  createdAt            DateTime        @default(now()) @map("created_at")
  
  @@map("rate_aggregates")
  @@unique([skillCategory, primarySkill, experienceLevel, region, periodType, periodStart])
  @@index([skillCategory])
  @@index([primarySkill])
  @@index([experienceLevel])
  @@index([region])
  @@index([periodStart])
}

model FreelancerRateHistory {
  id                   String           @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId               String           @map("user_id") @db.Uuid
  
  // Rate change
  previousHourlyRate   Decimal?         @map("previous_hourly_rate") @db.Decimal(10, 2)
  newHourlyRate        Decimal          @map("new_hourly_rate") @db.Decimal(10, 2)
  changeReason         RateChangeReason @map("change_reason")
  
  // Context
  marketPosition       String?          @map("market_position") // 'BELOW_MARKET', 'AT_MARKET', 'ABOVE_MARKET'
  percentileAtChange   Int?             @map("percentile_at_change")
  
  // Impact tracking
  bidsBeforeChange     Int?             @map("bids_before_change")
  bidsAfterChange      Int?             @map("bids_after_change")
  winRateBeforeChange  Decimal?         @map("win_rate_before_change") @db.Decimal(5, 4)
  winRateAfterChange   Decimal?         @map("win_rate_after_change") @db.Decimal(5, 4)
  
  changedAt            DateTime         @map("changed_at")
  createdAt            DateTime         @default(now()) @map("created_at")
  
  user                 User             @relation(fields: [userId], references: [id])
  
  @@map("freelancer_rate_history")
  @@index([userId])
  @@index([changedAt])
}

model RateRecommendation {
  id                      String               @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId                  String               @map("user_id") @db.Uuid
  
  // Recommendation type
  recommendationType      RecommendationType   @map("recommendation_type")
  
  // Current state
  currentRate             Decimal              @map("current_rate") @db.Decimal(10, 2)
  currentPercentile       Int                  @map("current_percentile")
  
  // Recommendation
  recommendedRateMin      Decimal              @map("recommended_rate_min") @db.Decimal(10, 2)
  recommendedRateMax      Decimal              @map("recommended_rate_max") @db.Decimal(10, 2)
  recommendedPercentile   Int                  @map("recommended_percentile")
  
  // Reasoning
  reasons                 Json                 // [{ factor, description, impact }]
  
  // Projected impact
  projectedWinRateChange  Decimal?             @map("projected_win_rate_change") @db.Decimal(5, 4)
  projectedEarningsChange Decimal?             @map("projected_earnings_change") @db.Decimal(5, 2)
  
  // Status
  status                  RecommendationStatus @default(PENDING)
  viewedAt                DateTime?            @map("viewed_at")
  actionTaken             String?              @map("action_taken")
  actionTakenAt           DateTime?            @map("action_taken_at")
  
  // Validity
  validUntil              DateTime             @map("valid_until")
  
  createdAt               DateTime             @default(now()) @map("created_at")
  
  user                    User                 @relation(fields: [userId], references: [id])
  
  @@map("rate_recommendations")
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model SkillDemandTrend {
  id                       String      @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  
  // Skill
  skill                    String
  skillCategory            String      @map("skill_category")
  
  // Period
  periodStart              DateTime    @map("period_start")
  periodEnd                DateTime    @map("period_end")
  
  // Demand metrics
  projectCount             Int         @map("project_count")
  totalBudget              Decimal     @map("total_budget") @db.Decimal(14, 2)
  avgBudget                Decimal     @map("avg_budget") @db.Decimal(12, 2)
  
  // Supply metrics
  activeFreelancers        Int         @map("active_freelancers")
  totalBids                Int         @map("total_bids")
  avgBidsPerProject        Decimal     @map("avg_bids_per_project") @db.Decimal(5, 2)
  
  // Supply/demand ratio
  demandSupplyRatio        Decimal     @map("demand_supply_ratio") @db.Decimal(5, 2)
  
  // Trend
  demandChangeFromPrevious Decimal?    @map("demand_change_from_previous") @db.Decimal(5, 2)
  rateChangeFromPrevious   Decimal?    @map("rate_change_from_previous") @db.Decimal(5, 2)
  
  // Categorization
  demandLevel              DemandLevel @map("demand_level")
  
  createdAt                DateTime    @default(now()) @map("created_at")
  
  @@map("skill_demand_trends")
  @@unique([skill, periodStart])
  @@index([skill])
  @@index([skillCategory])
  @@index([demandLevel])
  @@index([periodStart])
}

enum RateSourceType {
  CONTRACT
  BID
  SERVICE_ORDER
  PROFILE_RATE
}

enum RateType {
  HOURLY
  FIXED
  MILESTONE
}

enum PeriodType {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
}

enum RateChangeReason {
  MARKET_ADJUSTMENT
  EXPERIENCE_INCREASE
  SKILL_ADDITION
  DEMAND_BASED
  RECOMMENDATION_FOLLOWED
  MANUAL_CHANGE
}

enum RecommendationType {
  RATE_INCREASE
  RATE_DECREASE
  RATE_OPTIMIZATION
  SKILL_BASED_ADJUSTMENT
  DEMAND_BASED_ADJUSTMENT
}

enum RecommendationStatus {
  PENDING
  VIEWED
  ACCEPTED
  REJECTED
  EXPIRED
}

enum DemandLevel {
  VERY_LOW
  LOW
  MODERATE
  HIGH
  VERY_HIGH
}

// ============================================================================
// ENHANCED CONTRACT MANAGEMENT SYSTEM
// ============================================================================

model ContractTemplate {
  id        String  @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId  String? @map("tenant_id") @db.Uuid // null = platform template

  // Template details
  name        String  @db.VarChar(200)
  description String? @db.Text

  // Contract type
  contractType ContractTypeV2 @map("contract_type")
  rateType     RateTypeV2     @map("rate_type")

  // Template content
  templateContent String @map("template_content") @db.Text // Markdown/HTML with variables

  // Variables
  variables Json // [{name, description, required, defaultValue}]

  // Clauses
  clauses Json // [{id, title, content, required, order}]

  // Settings
  defaultPaymentTermsDays Int @default(7) @map("default_payment_terms_days")
  defaultNoticePeriodDays Int @default(14) @map("default_notice_period_days")

  // Legal
  includesNda          Boolean @default(false) @map("includes_nda")
  includesIpAssignment Boolean @default(true) @map("includes_ip_assignment")
  includesNonCompete   Boolean @default(false) @map("includes_non_compete")

  // Compliance
  complianceTags String[] @map("compliance_tags")

  // Status
  isActive  Boolean @default(true) @map("is_active")
  isDefault Boolean @default(false) @map("is_default")

  // Version
  version String @default("1.0")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant Tenant? @relation(fields: [tenantId], references: [id])

  @@map("contract_templates")
  @@index([tenantId])
  @@index([contractType])
  @@index([isActive])
}

model ContractV2 {
  id             String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  contractNumber String @unique @map("contract_number") @db.VarChar(30)

  // Parties
  clientUserId     String  @map("client_user_id") @db.Uuid
  freelancerUserId String  @map("freelancer_user_id") @db.Uuid
  tenantId         String? @map("tenant_id") @db.Uuid

  // Source
  sourceType     ContractSourceType @map("source_type")
  projectId      String?            @map("project_id") @db.Uuid
  bidId          String?            @map("bid_id") @db.Uuid
  serviceOrderId String?            @map("service_order_id") @db.Uuid

  // Contract details
  title       String  @db.VarChar(200)
  description String? @db.Text
  scope       String  @db.Text

  // Contract type
  contractType ContractTypeV2 @map("contract_type")

  // Pricing
  rateType       RateTypeV2 @map("rate_type")
  hourlyRate     Decimal?   @map("hourly_rate") @db.Decimal(10, 2)
  fixedAmount    Decimal?   @map("fixed_amount") @db.Decimal(12, 2)
  retainerAmount Decimal?   @map("retainer_amount") @db.Decimal(12, 2)
  currency       String     @default("USD") @db.VarChar(3)

  // Estimates (for hourly)
  estimatedHours   Int? @map("estimated_hours")
  weeklyHourLimit  Int? @map("weekly_hour_limit")

  // Budget cap
  budgetCap            Decimal? @map("budget_cap") @db.Decimal(12, 2)
  budgetAlertThreshold Decimal? @map("budget_alert_threshold") @db.Decimal(5, 2) // percentage

  // Timeline
  startDate             DateTime  @map("start_date")
  endDate               DateTime? @map("end_date")
  estimatedDurationDays Int?      @map("estimated_duration_days")

  // Terms
  paymentTermsDays Int @default(7) @map("payment_terms_days")
  noticePeriodDays Int @default(14) @map("notice_period_days")

  // Legal
  includesNda          Boolean @default(false) @map("includes_nda")
  includesIpAssignment Boolean @default(true) @map("includes_ip_assignment")
  includesNonCompete   Boolean @default(false) @map("includes_non_compete")
  customTerms          String? @map("custom_terms") @db.Text

  // Compliance
  complianceRequirements String[] @map("compliance_requirements")

  // SkillPod
  skillpodRequired Boolean @default(false) @map("skillpod_required")
  skillpodPodId    String? @map("skillpod_pod_id") @db.Uuid

  // Status
  status ContractStatusV2 @default(DRAFT)

  // Signatures
  clientSignedAt        DateTime? @map("client_signed_at")
  clientSignatureId     String?   @map("client_signature_id") @db.Uuid
  freelancerSignedAt    DateTime? @map("freelancer_signed_at")
  freelancerSignatureId String?   @map("freelancer_signature_id") @db.Uuid

  // Document
  documentUrl     String? @map("document_url") @db.VarChar(500)
  documentVersion Int     @default(1) @map("document_version")

  // Financials (running totals)
  totalBilled   Decimal @default(0) @map("total_billed") @db.Decimal(12, 2)
  totalPaid     Decimal @default(0) @map("total_paid") @db.Decimal(12, 2)
  totalInEscrow Decimal @default(0) @map("total_in_escrow") @db.Decimal(12, 2)
  totalDisputed Decimal @default(0) @map("total_disputed") @db.Decimal(12, 2)

  // Termination
  terminatedAt      DateTime?        @map("terminated_at")
  terminatedBy      String?          @map("terminated_by") @db.Uuid
  terminationReason String?          @map("termination_reason") @db.Text
  terminationType   TerminationType? @map("termination_type")

  // Completion
  completedAt DateTime? @map("completed_at")

  // Metadata
  metadata Json?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  client     User    @relation("ClientContractsV2", fields: [clientUserId], references: [id])
  freelancer User    @relation("FreelancerContractsV2", fields: [freelancerUserId], references: [id])
  tenant     Tenant? @relation("TenantContractsV2", fields: [tenantId], references: [id])
  job        Job?    @relation("JobContractsV2", fields: [projectId], references: [id])
  bid        Bid?    @relation("BidContractsV2", fields: [bidId], references: [id])

  milestones          ContractMilestoneV2[]
  timeEntries         TimeEntryV2[]
  invoices            ContractInvoice[]
  amendments          ContractAmendment[]
  disputes            ContractDispute[]
  activities          ContractActivity[]
  signatures          ContractSignature[]
  escrowAccount       EscrowAccountV2?
  escrowTransactions  EscrowTransactionV2[]

  @@map("contracts_v2")
  @@index([clientUserId])
  @@index([freelancerUserId])
  @@index([tenantId])
  @@index([status])
  @@index([contractType])
  @@index([startDate])
  @@index([contractNumber])
}

model ContractMilestoneV2 {
  id         String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  contractId String @map("contract_id") @db.Uuid

  // Milestone details
  title       String  @db.VarChar(200)
  description String? @db.Text

  // Order
  orderIndex Int @map("order_index")

  // Amount
  amount   Decimal @db.Decimal(12, 2)
  currency String  @default("USD") @db.VarChar(3)

  // Timeline
  dueDate       DateTime? @map("due_date")
  estimatedDays Int?      @map("estimated_days")

  // Deliverables
  deliverables Json? // [{title, description, required}]

  // Status
  status MilestoneStatusV2 @default(PENDING)

  // Escrow
  escrowFunded        Boolean   @default(false) @map("escrow_funded")
  escrowFundedAt      DateTime? @map("escrow_funded_at")
  escrowTransactionId String?   @map("escrow_transaction_id") @db.VarChar(100)

  // Submission
  submittedAt     DateTime? @map("submitted_at")
  submissionNote  String?   @map("submission_note") @db.Text
  submissionFiles Json?     @map("submission_files") // [{name, url, size}]

  // Review
  reviewRequestedAt DateTime? @map("review_requested_at")

  // Approval
  approvedAt DateTime? @map("approved_at")
  approvedBy String?   @map("approved_by") @db.Uuid

  // Rejection
  rejectedAt      DateTime? @map("rejected_at")
  rejectionReason String?   @map("rejection_reason") @db.Text
  rejectionCount  Int       @default(0) @map("rejection_count")

  // Revision
  revisionRequestedAt DateTime? @map("revision_requested_at")
  revisionNote        String?   @map("revision_note") @db.Text

  // Payment
  paidAt               DateTime? @map("paid_at")
  paymentTransactionId String?   @map("payment_transaction_id") @db.VarChar(100)

  // Auto-approval
  autoApproveAt DateTime? @map("auto_approve_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  contract           ContractV2            @relation(fields: [contractId], references: [id], onDelete: Cascade)
  escrowTransactions EscrowTransactionV2[]

  @@map("contract_milestones_v2")
  @@index([contractId])
  @@index([status])
  @@index([dueDate])
}

model TimeEntryV2 {
  id               String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  contractId       String @map("contract_id") @db.Uuid
  freelancerUserId String @map("freelancer_user_id") @db.Uuid

  // Time details
  date            DateTime  @db.Date
  startTime       DateTime? @map("start_time")
  endTime         DateTime? @map("end_time")
  durationMinutes Int       @map("duration_minutes")

  // Description
  description  String  @db.Text
  taskCategory String? @map("task_category") @db.VarChar(100)

  // Billing
  hourlyRate Decimal @map("hourly_rate") @db.Decimal(10, 2)
  amount     Decimal @db.Decimal(10, 2)
  currency   String  @default("USD") @db.VarChar(3)

  // Evidence (for manual tracking)
  evidenceType EvidenceType? @map("evidence_type")
  evidenceUrl  String?       @map("evidence_url") @db.VarChar(500)
  screenshots  Json?         // [{url, timestamp}]

  // SkillPod tracking
  skillpodSessionId String?  @map("skillpod_session_id") @db.Uuid
  autoTracked       Boolean  @default(false) @map("auto_tracked")

  // Status
  status TimeEntryStatusV2 @default(PENDING)

  // Approval
  approvedAt DateTime? @map("approved_at")
  approvedBy String?   @map("approved_by") @db.Uuid

  // Rejection
  rejectedAt      DateTime? @map("rejected_at")
  rejectionReason String?   @map("rejection_reason") @db.VarChar(500)

  // Dispute
  disputedAt DateTime? @map("disputed_at")
  disputeId  String?   @map("dispute_id") @db.Uuid

  // Invoice
  invoiceId  String?   @map("invoice_id") @db.Uuid
  invoicedAt DateTime? @map("invoiced_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  contract   ContractV2       @relation(fields: [contractId], references: [id], onDelete: Cascade)
  freelancer User             @relation("FreelancerTimeEntries", fields: [freelancerUserId], references: [id])
  invoice    ContractInvoice? @relation(fields: [invoiceId], references: [id])

  @@map("time_entries_v2")
  @@index([contractId])
  @@index([freelancerUserId])
  @@index([date])
  @@index([status])
  @@index([invoiceId])
}

model ContractAmendment {
  id         String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  contractId String @map("contract_id") @db.Uuid

  // Amendment details
  amendmentNumber Int    @map("amendment_number")
  title           String @db.VarChar(200)
  description     String @db.Text

  // Changes
  changes Json // [{field, oldValue, newValue}]

  // Reason
  reason String @db.Text

  // Proposed by
  proposedBy String   @map("proposed_by") @db.Uuid
  proposedAt DateTime @map("proposed_at")

  // Status
  status AmendmentStatus @default(PROPOSED)

  // Client response
  clientApprovedAt DateTime? @map("client_approved_at")
  clientRejectedAt DateTime? @map("client_rejected_at")
  clientResponse   String?   @map("client_response") @db.Text

  // Freelancer response
  freelancerApprovedAt DateTime? @map("freelancer_approved_at")
  freelancerRejectedAt DateTime? @map("freelancer_rejected_at")
  freelancerResponse   String?   @map("freelancer_response") @db.Text

  // Effective date
  effectiveAt DateTime? @map("effective_at")

  // Document
  documentUrl String? @map("document_url") @db.VarChar(500)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  contract ContractV2 @relation(fields: [contractId], references: [id], onDelete: Cascade)
  proposer User       @relation("AmendmentProposer", fields: [proposedBy], references: [id])

  @@map("contract_amendments")
  @@unique([contractId, amendmentNumber])
  @@index([contractId])
  @@index([status])
}

model ContractActivity {
  id         String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  contractId String @map("contract_id") @db.Uuid

  // Activity details
  activityType ContractActivityType @map("activity_type")
  description  String               @db.VarChar(500)

  // Actor
  actorUserId String? @map("actor_user_id") @db.Uuid
  actorType   String? @map("actor_type") @db.VarChar(20) // 'CLIENT', 'FREELANCER', 'SYSTEM', 'ADMIN'

  // Related entities
  milestoneId String? @map("milestone_id") @db.Uuid
  timeEntryId String? @map("time_entry_id") @db.Uuid
  invoiceId   String? @map("invoice_id") @db.Uuid
  amendmentId String? @map("amendment_id") @db.Uuid
  disputeId   String? @map("dispute_id") @db.Uuid

  // Metadata
  metadata Json?

  // Visibility
  visibleToClient     Boolean @default(true) @map("visible_to_client")
  visibleToFreelancer Boolean @default(true) @map("visible_to_freelancer")

  createdAt DateTime @default(now()) @map("created_at")

  contract ContractV2 @relation(fields: [contractId], references: [id], onDelete: Cascade)
  actor    User?      @relation("ContractActivityActor", fields: [actorUserId], references: [id])

  @@map("contract_activities")
  @@index([contractId])
  @@index([activityType])
  @@index([createdAt])
}

model ContractSignature {
  id         String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  contractId String @map("contract_id") @db.Uuid

  // Signer
  userId     String @map("user_id") @db.Uuid
  signerRole String @map("signer_role") @db.VarChar(20) // 'CLIENT', 'FREELANCER'

  // Signature data
  signatureType  SignatureType @map("signature_type")
  signatureImage String?       @map("signature_image") @db.Text // Base64
  signatureText  String?       @map("signature_text") @db.VarChar(200)
  signatureHash  String        @map("signature_hash") @db.VarChar(64) // SHA-256

  // Legal acknowledgment
  agreedToTerms     Boolean   @default(true) @map("agreed_to_terms")
  termsVersion      String    @map("terms_version") @db.VarChar(20)
  acknowledgmentAt  DateTime  @map("acknowledgment_at")

  // Device/context info
  ipAddress String @map("ip_address") @db.VarChar(45)
  userAgent String @map("user_agent") @db.Text

  // Document reference
  documentVersion Int    @map("document_version")
  documentHash    String @map("document_hash") @db.VarChar(64)

  createdAt DateTime @default(now()) @map("created_at")

  contract ContractV2 @relation(fields: [contractId], references: [id], onDelete: Cascade)
  user     User       @relation("UserContractSignatures", fields: [userId], references: [id])

  @@map("contract_signatures")
  @@index([contractId])
  @@index([userId])
}

model ContractInvoice {
  id             String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  contractId     String @map("contract_id") @db.Uuid
  invoiceNumber  String @unique @map("invoice_number") @db.VarChar(30)

  // Parties (denormalized for quick access)
  clientUserId     String @map("client_user_id") @db.Uuid
  freelancerUserId String @map("freelancer_user_id") @db.Uuid

  // Invoice details
  periodStart DateTime? @map("period_start")
  periodEnd   DateTime? @map("period_end")

  // Amounts
  subtotal    Decimal @db.Decimal(12, 2)
  platformFee Decimal @map("platform_fee") @db.Decimal(12, 2)
  taxes       Decimal @default(0) @db.Decimal(12, 2)
  total       Decimal @db.Decimal(12, 2)
  currency    String  @default("USD") @db.VarChar(3)

  // Freelancer payout
  freelancerAmount Decimal @default(0) @map("freelancer_amount") @db.Decimal(12, 2)

  // Line items summary
  hoursLogged     Decimal? @map("hours_logged") @db.Decimal(8, 2)
  milestonesCount Int?     @map("milestones_count")

  // Status
  status ContractInvoiceStatus @default(DRAFT)

  // Dates
  issuedAt DateTime? @map("issued_at")
  dueAt    DateTime? @map("due_at")
  viewedAt DateTime? @map("viewed_at")
  paidAt   DateTime? @map("paid_at")

  // Payment
  paymentTransactionId    String? @map("payment_transaction_id") @db.VarChar(100)
  stripePaymentIntentId   String? @map("stripe_payment_intent_id") @db.VarChar(100)
  paymentMethod           String? @map("payment_method") @db.VarChar(50)

  // Payout to freelancer
  payoutId       String?   @map("payout_id") @db.Uuid
  payoutStatus   String?   @map("payout_status") @db.VarChar(30)
  paidOutAt      DateTime? @map("paid_out_at")

  // Reminders
  reminderCount     Int       @default(0) @map("reminder_count")
  lastReminderSentAt DateTime? @map("last_reminder_sent_at")

  // Document
  documentUrl String? @map("document_url") @db.VarChar(500)

  // Notes
  notes String? @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  contract           ContractV2            @relation(fields: [contractId], references: [id], onDelete: Cascade)
  client             User                  @relation("ClientInvoices", fields: [clientUserId], references: [id])
  freelancer         User                  @relation("FreelancerInvoices", fields: [freelancerUserId], references: [id])
  timeEntries        TimeEntryV2[]
  lineItems          ContractInvoiceLineItem[]
  escrowTransactions EscrowTransactionV2[]

  @@map("contract_invoices")
  @@index([contractId])
  @@index([clientUserId])
  @@index([freelancerUserId])
  @@index([status])
  @@index([issuedAt])
  @@index([dueAt])
}

model ContractDispute {
  id         String  @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  contractId String  @map("contract_id") @db.Uuid
  milestoneId String? @map("milestone_id") @db.Uuid
  timeEntryId String? @map("time_entry_id") @db.Uuid

  // Dispute details
  raisedBy     String            @map("raised_by") @db.Uuid
  reason       ContractDisputeReason
  description  String            @db.Text
  evidenceUrls String[]          @default([]) @map("evidence_urls")

  // Amount in dispute
  disputedAmount Decimal @map("disputed_amount") @db.Decimal(12, 2)
  currency       String  @default("USD") @db.VarChar(3)

  // Status
  status ContractDisputeStatus @default(OPEN)

  // Response
  respondentUserId String?   @map("respondent_user_id") @db.Uuid
  respondedAt      DateTime? @map("responded_at")
  response         String?   @db.Text
  responseEvidence String[]  @default([]) @map("response_evidence")

  // Resolution
  resolvedBy             String?                    @map("resolved_by") @db.Uuid
  resolution             ContractDisputeResolution?
  resolutionNotes        String?                    @map("resolution_notes") @db.Text
  clientRefundAmount     Decimal?                   @map("client_refund_amount") @db.Decimal(12, 2)
  freelancerPayoutAmount Decimal?                   @map("freelancer_payout_amount") @db.Decimal(12, 2)

  // Timeline
  respondBy   DateTime? @map("respond_by")
  escalatedAt DateTime? @map("escalated_at")
  resolvedAt  DateTime? @map("resolved_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  contract           ContractV2               @relation(fields: [contractId], references: [id], onDelete: Cascade)
  raiser             User                     @relation("DisputeRaiser", fields: [raisedBy], references: [id])
  messages           ContractDisputeMessage[]
  escrowTransactions EscrowTransactionV2[]
  conversations      Conversation[]           @relation("DisputeConversations")

  @@map("contract_disputes")
  @@index([contractId])
  @@index([status])
  @@index([raisedBy])
}

model ContractDisputeMessage {
  id        String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  disputeId String @map("dispute_id") @db.Uuid
  senderId  String @map("sender_id") @db.Uuid

  // Message content
  content     String   @db.Text
  attachments String[] @default([])

  // Sender type
  senderType String @map("sender_type") @db.VarChar(20) // 'CLIENT', 'FREELANCER', 'MEDIATOR', 'SYSTEM'

  createdAt DateTime @default(now()) @map("created_at")

  dispute ContractDispute @relation(fields: [disputeId], references: [id], onDelete: Cascade)
  sender  User            @relation("DisputeMessageSender", fields: [senderId], references: [id])

  @@map("contract_dispute_messages")
  @@index([disputeId])
  @@index([createdAt])
}

// Contract Management Enums
enum ContractSourceType {
  PROJECT_BID
  SERVICE_ORDER
  DIRECT_HIRE
  RETAINER
}

enum ContractTypeV2 {
  STANDARD
  ENTERPRISE
  SERVICE
  RETAINER
}

enum RateTypeV2 {
  HOURLY
  FIXED
  MILESTONE
  RETAINER
}

enum ContractStatusV2 {
  DRAFT
  PENDING_CLIENT_SIGNATURE
  PENDING_FREELANCER_SIGNATURE
  ACTIVE
  PAUSED
  COMPLETED
  TERMINATED
  DISPUTED
}

enum MilestoneStatusV2 {
  PENDING
  FUNDED
  IN_PROGRESS
  SUBMITTED
  REVISION_REQUESTED
  APPROVED
  PAID
  CANCELLED
  DISPUTED
}

enum TimeEntryStatusV2 {
  PENDING
  APPROVED
  REJECTED
  DISPUTED
  INVOICED
  PAID
}

enum EvidenceType {
  SCREENSHOT
  SCREEN_RECORDING
  SKILLPOD_SESSION
  MANUAL_LOG
  ACTIVITY_LOG
}

enum AmendmentStatus {
  PROPOSED
  PENDING_CLIENT
  PENDING_FREELANCER
  APPROVED
  REJECTED
  WITHDRAWN
}

enum TerminationType {
  COMPLETED
  MUTUAL_AGREEMENT
  CLIENT_TERMINATED
  FREELANCER_TERMINATED
  BREACH
  DISPUTE_RESOLUTION
}

enum ContractActivityType {
  CONTRACT_CREATED
  CONTRACT_SENT
  CONTRACT_SIGNED
  CONTRACT_ACTIVATED
  CONTRACT_PAUSED
  CONTRACT_RESUMED
  CONTRACT_TERMINATED
  CONTRACT_COMPLETED
  MILESTONE_CREATED
  MILESTONE_FUNDED
  MILESTONE_STARTED
  MILESTONE_SUBMITTED
  MILESTONE_APPROVED
  MILESTONE_REJECTED
  MILESTONE_REVISION_REQUESTED
  MILESTONE_PAID
  MILESTONE_CANCELLED
  TIME_LOGGED
  TIME_APPROVED
  TIME_REJECTED
  TIME_DISPUTED
  INVOICE_CREATED
  INVOICE_SENT
  INVOICE_PAID
  AMENDMENT_PROPOSED
  AMENDMENT_APPROVED
  AMENDMENT_REJECTED
  AMENDMENT_WITHDRAWN
  DISPUTE_OPENED
  DISPUTE_RESPONDED
  DISPUTE_ESCALATED
  DISPUTE_RESOLVED
  MESSAGE_SENT
  FILE_SHARED
  BUDGET_ALERT
}

enum SignatureType {
  DRAWN
  TYPED
  UPLOADED
}

enum ContractInvoiceStatus {
  DRAFT
  SENT
  VIEWED
  PAID
  OVERDUE
  CANCELLED
  DISPUTED
}

enum ContractDisputeReason {
  QUALITY_ISSUES
  MISSED_DEADLINE
  SCOPE_DISAGREEMENT
  PAYMENT_DISPUTE
  COMMUNICATION_ISSUES
  INCOMPLETE_WORK
  UNAUTHORIZED_CHARGES
  OTHER
}

enum ContractDisputeStatus {
  OPEN
  PENDING_RESPONSE
  UNDER_REVIEW
  ESCALATED
  RESOLVED
  CLOSED
}

enum ContractDisputeResolution {
  FULL_REFUND_TO_CLIENT
  PARTIAL_REFUND
  FULL_PAYMENT_TO_FREELANCER
  SPLIT_PAYMENT
  MUTUAL_CANCELLATION
  NO_ACTION
}

// ============================================================================
// ESCROW SYSTEM V2 (for ContractV2)
// ============================================================================

model EscrowAccountV2 {
  id         String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  contractId String @unique @map("contract_id") @db.Uuid

  // Parties
  clientUserId     String @map("client_user_id") @db.Uuid
  freelancerUserId String @map("freelancer_user_id") @db.Uuid

  // Balance tracking
  balance          Decimal @default(0) @db.Decimal(12, 2)
  pendingBalance   Decimal @default(0) @map("pending_balance") @db.Decimal(12, 2)
  releasedBalance  Decimal @default(0) @map("released_balance") @db.Decimal(12, 2)
  refundedBalance  Decimal @default(0) @map("refunded_balance") @db.Decimal(12, 2)
  disputedBalance  Decimal @default(0) @map("disputed_balance") @db.Decimal(12, 2)
  currency         String  @default("USD") @db.VarChar(3)

  // Status
  status EscrowAccountStatusV2 @default(ACTIVE)

  // Stripe references
  stripePaymentMethodId String? @map("stripe_payment_method_id") @db.VarChar(100)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  contract     ContractV2            @relation(fields: [contractId], references: [id], onDelete: Cascade)
  transactions EscrowTransactionV2[]

  @@map("escrow_accounts_v2")
  @@index([clientUserId])
  @@index([freelancerUserId])
  @@index([status])
}

model EscrowTransactionV2 {
  id              String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  escrowAccountId String @map("escrow_account_id") @db.Uuid
  contractId      String @map("contract_id") @db.Uuid

  // Transaction type and status
  transactionType EscrowTransactionTypeV2
  status          EscrowTransactionStatusV2 @default(PENDING)

  // Related entities (optional)
  milestoneId String? @map("milestone_id") @db.Uuid
  invoiceId   String? @map("invoice_id") @db.Uuid
  disputeId   String? @map("dispute_id") @db.Uuid

  // Amounts
  amount        Decimal @db.Decimal(12, 2)
  platformFee   Decimal @default(0) @map("platform_fee") @db.Decimal(12, 2)
  processingFee Decimal @default(0) @map("processing_fee") @db.Decimal(12, 2)
  netAmount     Decimal @default(0) @map("net_amount") @db.Decimal(12, 2)
  currency      String  @default("USD") @db.VarChar(3)

  // Stripe references
  stripePaymentIntentId String? @map("stripe_payment_intent_id") @db.VarChar(100)
  stripeTransferId      String? @map("stripe_transfer_id") @db.VarChar(100)
  stripeRefundId        String? @map("stripe_refund_id") @db.VarChar(100)
  stripeChargeId        String? @map("stripe_charge_id") @db.VarChar(100)

  // Error tracking
  failureCode    String? @map("failure_code") @db.VarChar(50)
  failureMessage String? @map("failure_message") @db.Text

  // Metadata
  description String? @db.VarChar(500)
  metadata    Json?

  // Timestamps
  processedAt DateTime? @map("processed_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  escrowAccount EscrowAccountV2      @relation(fields: [escrowAccountId], references: [id], onDelete: Cascade)
  contract      ContractV2           @relation(fields: [contractId], references: [id], onDelete: Cascade)
  milestone     ContractMilestoneV2? @relation(fields: [milestoneId], references: [id])
  invoice       ContractInvoice?     @relation(fields: [invoiceId], references: [id])
  dispute       ContractDispute?     @relation(fields: [disputeId], references: [id])

  @@map("escrow_transactions_v2")
  @@index([escrowAccountId])
  @@index([contractId])
  @@index([milestoneId])
  @@index([invoiceId])
  @@index([disputeId])
  @@index([transactionType])
  @@index([status])
  @@index([stripePaymentIntentId])
}

model ContractInvoiceLineItem {
  id        String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  invoiceId String @map("invoice_id") @db.Uuid

  // Item details
  type        InvoiceLineItemType
  description String              @db.VarChar(500)

  // Quantity and pricing
  quantity  Decimal @db.Decimal(10, 2)
  unitPrice Decimal @map("unit_price") @db.Decimal(12, 2)
  amount    Decimal @db.Decimal(12, 2)

  // Reference to original item
  milestoneId String? @map("milestone_id") @db.Uuid
  timeEntryId String? @map("time_entry_id") @db.Uuid

  // Order
  orderIndex Int @default(0) @map("order_index")

  createdAt DateTime @default(now()) @map("created_at")

  invoice ContractInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@map("contract_invoice_line_items")
  @@index([invoiceId])
  @@index([type])
}

// Escrow V2 Enums
enum EscrowAccountStatusV2 {
  ACTIVE
  COMPLETED
  DISPUTED
  CLOSED
  CANCELLED
}

enum EscrowTransactionTypeV2 {
  FUND              // Client funds milestone/contract
  RELEASE           // Release to freelancer after approval
  PARTIAL_RELEASE   // Partial release (dispute resolution)
  REFUND            // Refund to client
  PARTIAL_REFUND    // Partial refund (dispute resolution)
  HOLD              // Hold funds (e.g., dispute)
  UNHOLD            // Release held funds
  FEE_DEDUCTION     // Platform fee deduction
}

enum EscrowTransactionStatusV2 {
  PENDING
  PROCESSING
  REQUIRES_CAPTURE
  CAPTURED
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
}

enum InvoiceLineItemType {
  MILESTONE
  TIME_ENTRY
  EXPENSE
  ADJUSTMENT
  BONUS
  OTHER
}

// ============================================================================
// REAL-TIME MESSAGING SYSTEM
// ============================================================================

model Conversation {
  id String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid

  // Conversation type
  type ConversationType

  // Context (optional references)
  jobId          String? @map("job_id") @db.Uuid
  contractId     String? @map("contract_id") @db.Uuid
  bidId          String? @map("bid_id") @db.Uuid
  serviceOrderId String? @map("service_order_id") @db.Uuid
  disputeId      String? @map("dispute_id") @db.Uuid

  // For direct messages
  isDirectMessage Boolean @default(false) @map("is_direct_message")

  // Group conversation details
  title       String?
  description String? @db.Text
  avatarUrl   String? @map("avatar_url") @db.VarChar(500)

  // Creator (for group conversations)
  createdBy String? @map("created_by") @db.Uuid

  // Settings
  isArchived Boolean @default(false) @map("is_archived")
  isMuted    Boolean @default(false) @map("is_muted")

  // Permissions
  allowFileSharing Boolean @default(true) @map("allow_file_sharing")
  allowReactions   Boolean @default(true) @map("allow_reactions")

  // Last activity
  lastMessageId      String?   @map("last_message_id") @db.Uuid
  lastMessageAt      DateTime? @map("last_message_at")
  lastMessagePreview String?   @map("last_message_preview") @db.VarChar(200)

  // Metadata
  metadata Json?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  participants ConversationParticipant[]
  messages     ConversationMessage[]
  job          Job?                      @relation("JobConversations", fields: [jobId], references: [id])
  bid          Bid?                      @relation("BidConversations", fields: [bidId], references: [id])
  serviceOrder ServiceOrder?             @relation("ServiceOrderConversations", fields: [serviceOrderId], references: [id])
  dispute      ContractDispute?          @relation("DisputeConversations", fields: [disputeId], references: [id])

  @@map("conversations")
  @@index([jobId])
  @@index([contractId])
  @@index([bidId])
  @@index([serviceOrderId])
  @@index([disputeId])
  @@index([type])
  @@index([lastMessageAt])
  @@index([createdBy])
}

model ConversationParticipant {
  id             String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  conversationId String @map("conversation_id") @db.Uuid
  userId         String @map("user_id") @db.Uuid

  // Role in conversation
  role ParticipantRole @default(MEMBER)

  // Permissions
  canSendMessages       Boolean @default(true) @map("can_send_messages")
  canAddParticipants    Boolean @default(false) @map("can_add_participants")
  canRemoveParticipants Boolean @default(false) @map("can_remove_participants")
  canEditSettings       Boolean @default(false) @map("can_edit_settings")

  // Read tracking
  lastReadMessageId String?   @map("last_read_message_id") @db.Uuid
  lastReadAt        DateTime? @map("last_read_at")
  unreadCount       Int       @default(0) @map("unread_count")

  // Notifications
  notificationsEnabled Boolean   @default(true) @map("notifications_enabled")
  mutedUntil           DateTime? @map("muted_until")

  // Status
  isActive  Boolean   @default(true) @map("is_active")
  leftAt    DateTime? @map("left_at")
  removedAt DateTime? @map("removed_at")
  removedBy String?   @map("removed_by") @db.Uuid

  // Pinned
  isPinned Boolean   @default(false) @map("is_pinned")
  pinnedAt DateTime? @map("pinned_at")

  // Archive (per-user)
  isArchivedByUser Boolean @default(false) @map("is_archived_by_user")

  joinedAt  DateTime @default(now()) @map("joined_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User         @relation("UserConversationParticipants", fields: [userId], references: [id])

  @@unique([conversationId, userId])
  @@map("conversation_participants")
  @@index([conversationId])
  @@index([userId])
  @@index([unreadCount])
}

model ConversationMessage {
  id             String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  conversationId String @map("conversation_id") @db.Uuid
  senderUserId   String @map("sender_user_id") @db.Uuid

  // Message content
  content     String?                    @db.Text
  contentType ConversationContentType @default(TEXT) @map("content_type")

  // For rich content
  richContent Json? @map("rich_content")

  // Attachments stored as JSON array
  attachments Json? // [{id, name, url, size, type, thumbnailUrl}]

  // Threading
  parentMessageId String? @map("parent_message_id") @db.Uuid
  threadCount     Int     @default(0) @map("thread_count")

  // Mentions
  mentions         String[] // User IDs
  mentionsEveryone Boolean  @default(false) @map("mentions_everyone")

  // Message metadata
  messageType ConversationMessageType @default(USER) @map("message_type")

  // For system messages
  systemEventType SystemMessageEventType? @map("system_event_type")
  systemEventData Json?                   @map("system_event_data")

  // Edit tracking
  isEdited    Boolean   @default(false) @map("is_edited")
  editedAt    DateTime? @map("edited_at")
  editHistory Json?     @map("edit_history") // [{content, editedAt}]

  // Deletion
  isDeleted Boolean   @default(false) @map("is_deleted")
  deletedAt DateTime? @map("deleted_at")
  deletedBy String?   @map("deleted_by") @db.Uuid

  // Delivery status
  deliveredAt DateTime? @map("delivered_at")

  // Reactions stored as JSON object
  reactionCounts Json? @map("reaction_counts") // {emoji: count}

  // Pinned
  isPinned Boolean   @default(false) @map("is_pinned")
  pinnedAt DateTime? @map("pinned_at")
  pinnedBy String?   @map("pinned_by") @db.Uuid

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  conversation   Conversation                @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender         User                        @relation("UserConversationMessages", fields: [senderUserId], references: [id])
  parentMessage  ConversationMessage?        @relation("ConversationMessageThread", fields: [parentMessageId], references: [id])
  threadMessages ConversationMessage[]       @relation("ConversationMessageThread")
  reactions      ConversationMessageReaction[]
  readReceipts   ConversationMessageReadReceipt[]

  @@map("conversation_messages")
  @@index([conversationId])
  @@index([senderUserId])
  @@index([parentMessageId])
  @@index([createdAt])
  @@index([conversationId, createdAt])
}

model ConversationMessageReaction {
  id        String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  messageId String @map("message_id") @db.Uuid
  userId    String @map("user_id") @db.Uuid

  emoji String // Unicode emoji or custom emoji code

  createdAt DateTime @default(now()) @map("created_at")

  message ConversationMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    User                @relation("UserMessageReactions", fields: [userId], references: [id])

  @@unique([messageId, userId, emoji])
  @@map("conversation_message_reactions")
  @@index([messageId])
}

model ConversationMessageReadReceipt {
  id        String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  messageId String @map("message_id") @db.Uuid
  userId    String @map("user_id") @db.Uuid

  readAt DateTime @map("read_at")

  message ConversationMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    User                @relation("UserMessageReadReceipts", fields: [userId], references: [id])

  @@unique([messageId, userId])
  @@map("conversation_message_read_receipts")
  @@index([messageId])
  @@index([userId])
}

model MessageAttachment {
  id         String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  messageId  String @map("message_id") @db.Uuid
  uploadedBy String @map("uploaded_by") @db.Uuid

  // File details
  fileName String @map("file_name") @db.VarChar(255)
  fileSize Int    @map("file_size")
  mimeType String @map("mime_type") @db.VarChar(100)

  // Storage
  storageKey   String  @map("storage_key") @db.VarChar(500)
  url          String  @db.VarChar(1000)
  thumbnailUrl String? @map("thumbnail_url") @db.VarChar(1000)

  // Processing status
  processingStatus AttachmentProcessingStatus @default(PENDING) @map("processing_status")

  // Virus scan
  scanStatus ScanStatus @default(PENDING) @map("scan_status")
  scanResult String?    @map("scan_result") @db.VarChar(255)
  scannedAt  DateTime?  @map("scanned_at")

  // Metadata (width, height, duration, pages, etc.)
  metadata Json?

  createdAt DateTime @default(now()) @map("created_at")

  uploader User @relation("UserMessageAttachments", fields: [uploadedBy], references: [id])

  @@map("message_attachments")
  @@index([messageId])
  @@index([uploadedBy])
}

model UserPresence {
  id     String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId String @unique @map("user_id") @db.Uuid

  // Status
  status        PresenceStatus @default(OFFLINE)
  statusMessage String?        @map("status_message") @db.VarChar(100)

  // Activity
  lastSeenAt   DateTime  @map("last_seen_at")
  lastActiveAt DateTime? @map("last_active_at")

  // Current activity
  currentConversationId String?   @map("current_conversation_id") @db.Uuid
  isTypingIn            String?   @map("is_typing_in") @db.Uuid // Conversation ID
  typingStartedAt       DateTime? @map("typing_started_at")

  // Device info
  deviceType String? @map("device_type") @db.VarChar(50)
  deviceId   String? @map("device_id") @db.VarChar(100)

  // Push tokens stored as JSON array
  pushTokens Json? @map("push_tokens") // [{token, platform, deviceId}]

  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation("UserPresenceInfo", fields: [userId], references: [id])

  @@map("user_presence")
  @@index([status])
  @@index([lastSeenAt])
}

model UserBlocklist {
  id            String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId        String @map("user_id") @db.Uuid
  blockedUserId String @map("blocked_user_id") @db.Uuid

  reason String? @db.VarChar(500)

  createdAt DateTime @default(now()) @map("created_at")

  user        User @relation("BlockedByUser", fields: [userId], references: [id])
  blockedUser User @relation("BlockedUser", fields: [blockedUserId], references: [id])

  @@unique([userId, blockedUserId])
  @@map("user_blocklist")
  @@index([userId])
  @@index([blockedUserId])
}

// Messaging Enums
enum ConversationType {
  DIRECT        // 1:1 conversation
  PROJECT       // Project-related
  CONTRACT      // Contract-related
  BID           // Bid discussion
  SERVICE_ORDER // Service order related
  DISPUTE       // Dispute discussion
  SUPPORT       // Support thread
  GROUP         // General group chat
}

enum ParticipantRole {
  OWNER
  ADMIN
  MODERATOR
  MEMBER
  READONLY
}

enum ConversationContentType {
  TEXT
  RICH_TEXT
  IMAGE
  VIDEO
  AUDIO
  FILE
  CODE
  LINK_PREVIEW
}

enum ConversationMessageType {
  USER         // Regular user message
  SYSTEM       // System-generated
  BOT          // Bot message
  NOTIFICATION // Notification message
}

enum SystemMessageEventType {
  PARTICIPANT_JOINED
  PARTICIPANT_LEFT
  PARTICIPANT_REMOVED
  CONVERSATION_CREATED
  CONVERSATION_RENAMED
  CONTRACT_SIGNED
  MILESTONE_COMPLETED
  PAYMENT_RECEIVED
  DEADLINE_REMINDER
}

enum AttachmentProcessingStatus {
  PENDING
  PROCESSING
  READY
  FAILED
}

enum ScanStatus {
  PENDING
  SCANNING
  CLEAN
  INFECTED
  ERROR
}

enum PresenceStatus {
  ONLINE
  AWAY
  BUSY
  DO_NOT_DISTURB
  OFFLINE
}

// ============================================================================
// CRM - CLIENT RELATIONSHIP MANAGEMENT
// ============================================================================

model Client {
  id               String       @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  freelancerUserId String       @map("freelancer_user_id") @db.Uuid

  // Client type
  clientType ClientType   @default(INDIVIDUAL) @map("client_type")
  source     ClientSource @default(MANUAL)

  // Platform link (if from Skillancer Market)
  platformUserId String? @map("platform_user_id") @db.Uuid

  // Contact information
  firstName      String? @map("first_name") @db.VarChar(100)
  lastName       String? @map("last_name") @db.VarChar(100)
  email          String? @db.VarChar(255)
  phone          String? @db.VarChar(50)
  alternateEmail String? @map("alternate_email") @db.VarChar(255)
  alternatePhone String? @map("alternate_phone") @db.VarChar(50)

  // Company information
  companyName    String?      @map("company_name") @db.VarChar(200)
  companyWebsite String?      @map("company_website") @db.VarChar(500)
  companySize    CompanySize? @map("company_size")
  industry       String?      @db.VarChar(100)
  jobTitle       String?      @map("job_title") @db.VarChar(100)
  department     String?      @db.VarChar(100)

  // Address
  address  Json?   // {street, city, state, country, postalCode}
  timezone String? @db.VarChar(50)

  // Profile
  avatarUrl String? @map("avatar_url") @db.VarChar(500)
  bio       String? @db.Text

  // Social profiles
  linkedinUrl String? @map("linkedin_url") @db.VarChar(500)
  twitterUrl  String? @map("twitter_url") @db.VarChar(500)

  // Preferences
  preferredContactMethod   String? @map("preferred_contact_method") @db.VarChar(50)
  communicationPreferences Json?   @map("communication_preferences")

  // Categorization
  tags         String[] @default([])
  customFields Json?    @map("custom_fields")

  // Status
  status ClientStatus @default(ACTIVE)

  // Relationship metrics
  lifetimeValue  Decimal @default(0) @map("lifetime_value") @db.Decimal(12, 2)
  totalProjects  Int     @default(0) @map("total_projects")
  activeProjects Int     @default(0) @map("active_projects")
  avgRating      Decimal? @map("avg_rating") @db.Decimal(3, 2)

  // Health score
  healthScore          Int?      @map("health_score") // 0-100
  healthScoreUpdatedAt DateTime? @map("health_score_updated_at")

  // Engagement
  lastContactAt  DateTime? @map("last_contact_at")
  lastProjectAt  DateTime? @map("last_project_at")
  nextFollowUpAt DateTime? @map("next_follow_up_at")

  // Notes
  internalNotes String? @map("internal_notes") @db.Text

  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")
  archivedAt DateTime? @map("archived_at")

  // Relations
  freelancer   User            @relation("FreelancerClients", fields: [freelancerUserId], references: [id])
  platformUser User?           @relation("PlatformClients", fields: [platformUserId], references: [id])
  contacts     ClientContact[]
  interactions ClientInteraction[]
  opportunities Opportunity[]
  documents    ClientDocument[]
  reminders    ClientReminder[]
  projects     CockpitProject[] @relation("ProjectClient")
  timeEntries  CockpitTimeEntry[] @relation("ClientTimeEntries")
  calendarEvents CalendarEvent[] @relation("ClientCalendarEvents")

  // Financial Tracking
  transactions FinancialTransaction[] @relation("ClientFinancialTransactions")
  mileageLogs  MileageLog[]            @relation("ClientMileageLogs")

  // Unified Financial Reporting
  unifiedTransactions        UnifiedTransaction[]        @relation("ClientUnifiedTransactions")
  profitabilityReports       ClientProfitabilityReport[] @relation("ClientProfitabilityReports")

  // Invoicing
  invoices          Invoice[]          @relation("ClientInvoices")
  recurringInvoices RecurringInvoice[] @relation("ClientRecurringInvoices")

  // Market Integration
  marketContractLinks MarketContractLink[] @relation("MarketContractClient")

  @@unique([freelancerUserId, email])
  @@index([freelancerUserId])
  @@index([status])
  @@index([tags])
  @@index([healthScore])
  @@index([lastContactAt])
  @@map("clients")
}

model ClientContact {
  id       String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  clientId String @map("client_id") @db.Uuid

  // Contact details
  firstName  String  @map("first_name") @db.VarChar(100)
  lastName   String? @map("last_name") @db.VarChar(100)
  email      String? @db.VarChar(255)
  phone      String? @db.VarChar(50)
  jobTitle   String? @map("job_title") @db.VarChar(100)
  department String? @db.VarChar(100)

  // Role
  role      ContactRole @default(OTHER)
  isPrimary Boolean     @default(false) @map("is_primary")

  // Notes
  notes String? @db.Text

  // Status
  isActive Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@map("client_contacts")
}

model ClientInteraction {
  id               String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  clientId         String @map("client_id") @db.Uuid
  freelancerUserId String @map("freelancer_user_id") @db.Uuid

  // Interaction details
  interactionType InteractionType @map("interaction_type")
  subject         String?         @db.VarChar(255)
  description     String          @db.Text

  // Timing
  occurredAt DateTime @map("occurred_at")
  duration   Int?     // minutes

  // Related entities
  opportunityId String? @map("opportunity_id") @db.Uuid
  projectId     String? @map("project_id") @db.Uuid

  // Outcome
  outcome   String? @db.VarChar(500)
  nextSteps String? @map("next_steps") @db.Text

  // Follow-up
  followUpRequired Boolean   @default(false) @map("follow_up_required")
  followUpDate     DateTime? @map("follow_up_date")

  // Attachments
  attachments Json? // [{name, url, type}]

  // Sentiment
  sentiment Sentiment?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  client      Client       @relation(fields: [clientId], references: [id], onDelete: Cascade)
  opportunity Opportunity? @relation(fields: [opportunityId], references: [id])

  @@index([clientId])
  @@index([freelancerUserId])
  @@index([occurredAt])
  @@index([interactionType])
  @@map("client_interactions")
}

model Opportunity {
  id               String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  freelancerUserId String @map("freelancer_user_id") @db.Uuid
  clientId         String? @map("client_id") @db.Uuid

  // Opportunity details
  title       String  @db.VarChar(255)
  description String? @db.Text

  // Source
  source        OpportunitySource
  sourceDetails String?           @map("source_details") @db.VarChar(500)
  externalUrl   String?           @map("external_url") @db.VarChar(500)

  // Value
  estimatedValue Decimal? @map("estimated_value") @db.Decimal(12, 2)
  currency       String   @default("USD") @db.VarChar(3)

  // Timeline
  expectedCloseDate DateTime? @map("expected_close_date")
  actualCloseDate   DateTime? @map("actual_close_date")

  // Pipeline
  stage       OpportunityStage @default(LEAD)
  probability Int              @default(10) // 0-100

  // Categorization
  tags        String[] @default([])
  serviceType String?  @map("service_type") @db.VarChar(100)

  // Status
  status        OpportunityStatus @default(OPEN)
  lostReason    String?           @map("lost_reason") @db.Text
  wonContractId String?           @map("won_contract_id") @db.Uuid

  // Priority
  priority CrmPriority @default(MEDIUM)

  // Notes
  notes String? @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  client       Client?               @relation(fields: [clientId], references: [id])
  interactions ClientInteraction[]
  activities   OpportunityActivity[]

  @@index([freelancerUserId])
  @@index([clientId])
  @@index([stage])
  @@index([status])
  @@index([expectedCloseDate])
  @@map("opportunities")
}

model OpportunityActivity {
  id            String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  opportunityId String @map("opportunity_id") @db.Uuid

  // Activity details
  activityType String @map("activity_type") @db.VarChar(50)
  description  String @db.Text

  // Stage change
  fromStage OpportunityStage? @map("from_stage")
  toStage   OpportunityStage? @map("to_stage")

  // Metadata
  metadata Json?

  createdAt DateTime @default(now()) @map("created_at")

  opportunity Opportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)

  @@index([opportunityId])
  @@index([createdAt])
  @@map("opportunity_activities")
}

model ClientDocument {
  id               String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  clientId         String @map("client_id") @db.Uuid
  freelancerUserId String @map("freelancer_user_id") @db.Uuid

  // Document details
  name         String            @db.VarChar(255)
  description  String?           @db.VarChar(500)
  documentType CrmDocumentType @map("document_type")

  // File
  fileUrl  String @map("file_url") @db.VarChar(500)
  fileName String @map("file_name") @db.VarChar(255)
  fileSize Int    @map("file_size")
  mimeType String @map("mime_type") @db.VarChar(100)

  // Categorization
  tags String[] @default([])

  // Related entities
  projectId  String? @map("project_id") @db.Uuid
  contractId String? @map("contract_id") @db.Uuid

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([documentType])
  @@map("client_documents")
}

model ClientReminder {
  id               String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  clientId         String @map("client_id") @db.Uuid
  freelancerUserId String @map("freelancer_user_id") @db.Uuid

  // Reminder details
  title        String       @db.VarChar(255)
  description  String?      @db.Text
  reminderType ReminderType @map("reminder_type")

  // Timing
  dueAt DateTime @map("due_at")

  // Recurrence
  isRecurring    Boolean @default(false) @map("is_recurring")
  recurrenceRule String? @map("recurrence_rule") @db.VarChar(255) // RRULE format

  // Status
  status       ReminderStatus @default(PENDING)
  completedAt  DateTime?      @map("completed_at")
  snoozedUntil DateTime?      @map("snoozed_until")

  // Notification
  notifyBefore     Int?    @map("notify_before") // minutes
  notificationSent Boolean @default(false) @map("notification_sent")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([freelancerUserId])
  @@index([dueAt])
  @@index([status])
  @@map("client_reminders")
}

model CrmCustomField {
  id               String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  freelancerUserId String @map("freelancer_user_id") @db.Uuid

  // Field definition
  entityType CrmEntityType @map("entity_type")
  fieldName  String        @map("field_name") @db.VarChar(50)
  fieldLabel String        @map("field_label") @db.VarChar(100)
  fieldType  CustomFieldType @map("field_type")

  // Options (for SELECT, MULTI_SELECT)
  options String[] @default([])

  // Validation
  isRequired   Boolean @default(false) @map("is_required")
  defaultValue String? @map("default_value") @db.VarChar(500)

  // Display
  displayOrder Int     @default(0) @map("display_order")
  isVisible    Boolean @default(true) @map("is_visible")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([freelancerUserId, entityType, fieldName])
  @@index([freelancerUserId])
  @@index([entityType])
  @@map("crm_custom_fields")
}

// CRM Enums

enum ClientType {
  INDIVIDUAL
  COMPANY
  AGENCY
}

enum ClientSource {
  SKILLANCER_MARKET
  REFERRAL
  WEBSITE
  SOCIAL_MEDIA
  COLD_OUTREACH
  REPEAT_CLIENT
  OTHER
  MANUAL
  UPWORK
  FIVERR
  TOPTAL
  FREELANCER
}

enum ClientStatus {
  LEAD
  PROSPECT
  ACTIVE
  INACTIVE
  CHURNED
  ARCHIVED
}

enum CompanySize {
  SOLO
  SMALL      // 2-10
  MEDIUM     // 11-50
  LARGE      // 51-200
  ENTERPRISE // 200+
}

enum ContactRole {
  DECISION_MAKER
  INFLUENCER
  TECHNICAL
  BILLING
  PROJECT_MANAGER
  OTHER
}

enum InteractionType {
  EMAIL
  CALL
  VIDEO_CALL
  MEETING
  MESSAGE
  NOTE
  TASK
  OTHER
}

enum Sentiment {
  POSITIVE
  NEUTRAL
  NEGATIVE
}

enum OpportunitySource {
  SKILLANCER_PROJECT
  SKILLANCER_SERVICE
  REFERRAL
  INBOUND
  OUTBOUND
  REPEAT_CLIENT
  UPSELL
  OTHER
}

enum OpportunityStage {
  LEAD
  QUALIFIED
  PROPOSAL
  NEGOTIATION
  WON
  LOST
}

enum OpportunityStatus {
  OPEN
  WON
  LOST
  ON_HOLD
}

enum CrmPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum CrmDocumentType {
  CONTRACT
  PROPOSAL
  INVOICE
  BRIEF
  DELIVERABLE
  REFERENCE
  OTHER
}

enum ReminderType {
  FOLLOW_UP
  CHECK_IN
  DEADLINE
  MEETING
  BIRTHDAY
  ANNIVERSARY
  CUSTOM
}

enum ReminderStatus {
  PENDING
  COMPLETED
  SNOOZED
  CANCELLED
}

enum CustomFieldType {
  TEXT
  NUMBER
  DATE
  BOOLEAN
  SELECT
  MULTI_SELECT
  URL
  EMAIL
  PHONE
}

enum CrmEntityType {
  CLIENT
  PROJECT
  OPPORTUNITY
}

// ============================================================================
// COCKPIT - PROJECT MANAGEMENT
// ============================================================================

model CockpitProject {
  id               String        @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  freelancerUserId String        @map("freelancer_user_id") @db.Uuid
  clientId         String?       @map("client_id") @db.Uuid

  // Source integration
  source           ProjectSource @default(MANUAL)
  marketContractId String?       @unique @map("market_contract_id") @db.Uuid
  externalId       String?       @map("external_id") @db.VarChar(255)
  externalPlatform String?       @map("external_platform") @db.VarChar(100)
  externalUrl      String?       @map("external_url") @db.VarChar(500)

  // Project details
  name        String  @db.VarChar(255)
  description String? @db.Text
  projectType CockpitProjectType @default(CLIENT_WORK) @map("project_type")

  // Categorization
  category String?  @db.VarChar(100)
  tags     String[] @default([])

  // Status
  status   CockpitProjectStatus @default(NOT_STARTED)
  priority CrmPriority   @default(MEDIUM)

  // Timeline
  startDate   DateTime? @map("start_date")
  dueDate     DateTime? @map("due_date")
  completedAt DateTime? @map("completed_at")

  // Budget and billing
  budgetType   CockpitBudgetType? @map("budget_type")
  budgetAmount Decimal?    @map("budget_amount") @db.Decimal(12, 2)
  hourlyRate   Decimal?    @map("hourly_rate") @db.Decimal(10, 2)
  currency     String      @default("USD") @db.VarChar(3)

  // Progress
  progressPercent Int @default(0) @map("progress_percent")

  // Time tracking
  estimatedHours Decimal? @map("estimated_hours") @db.Decimal(8, 2)
  trackedHours   Decimal  @default(0) @map("tracked_hours") @db.Decimal(8, 2)
  billableHours  Decimal  @default(0) @map("billable_hours") @db.Decimal(8, 2)

  // Financials
  totalBilled Decimal @default(0) @map("total_billed") @db.Decimal(12, 2)
  totalPaid   Decimal @default(0) @map("total_paid") @db.Decimal(12, 2)

  // Settings
  isArchived Boolean @default(false) @map("is_archived")
  isFavorite Boolean @default(false) @map("is_favorite")
  color      String? @db.VarChar(20) // For UI display

  // Notes
  notes String? @db.Text

  // Custom fields
  customFields Json? @map("custom_fields")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  freelancer     User                @relation("FreelancerProjects", fields: [freelancerUserId], references: [id])
  client         Client?             @relation("ProjectClient", fields: [clientId], references: [id])
  tasks          ProjectTask[]
  milestones     ProjectMilestone[]
  timeEntries    CockpitTimeEntry[]
  files          ProjectFile[]
  activities     ProjectActivity[]
  activeTimers   ActiveTimer[]       @relation("ActiveTimerProject")
  calendarEvents CalendarEvent[]     @relation("ProjectCalendarEvents")

  // Financial Tracking
  transactions   FinancialTransaction[] @relation("ProjectFinancialTransactions")
  mileageLogs    MileageLog[]           @relation("ProjectMileageLogs")

  // Unified Financial Reporting
  unifiedTransactions UnifiedTransaction[] @relation("ProjectUnifiedTransactions")

  // Invoicing
  invoices       Invoice[]              @relation("ProjectInvoices")

  // Market Integration
  marketContractLinks MarketContractLink[] @relation("MarketContractProject")

  @@map("cockpit_projects")
  @@index([freelancerUserId])
  @@index([clientId])
  @@index([status])
  @@index([dueDate])
  @@index([isArchived])
  @@index([isFavorite])
  @@index([marketContractId])
}

model ProjectTask {
  id        String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  projectId String @map("project_id") @db.Uuid

  // Task details
  title       String  @db.VarChar(255)
  description String? @db.Text

  // Hierarchy
  parentTaskId String? @map("parent_task_id") @db.Uuid
  orderIndex   Int     @default(0) @map("order_index")

  // Status
  status   CockpitTaskStatus  @default(TODO)
  priority CrmPriority @default(MEDIUM)

  // Timeline
  startDate   DateTime? @map("start_date")
  dueDate     DateTime? @map("due_date")
  completedAt DateTime? @map("completed_at")

  // Time tracking
  estimatedMinutes Int @default(0) @map("estimated_minutes")
  trackedMinutes   Int @default(0) @map("tracked_minutes")

  // Milestone
  milestoneId String? @map("milestone_id") @db.Uuid

  // Tags
  tags String[] @default([])

  // Recurring
  isRecurring    Boolean @default(false) @map("is_recurring")
  recurrenceRule String? @map("recurrence_rule") @db.VarChar(255)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  project      CockpitProject     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  parentTask   ProjectTask?       @relation("TaskHierarchy", fields: [parentTaskId], references: [id])
  subtasks     ProjectTask[]      @relation("TaskHierarchy")
  milestone    ProjectMilestone?  @relation(fields: [milestoneId], references: [id])
  timeEntries  CockpitTimeEntry[]
  activeTimers ActiveTimer[]      @relation("ActiveTimerTask")

  @@map("project_tasks")
  @@index([projectId])
  @@index([parentTaskId])
  @@index([status])
  @@index([dueDate])
  @@index([milestoneId])
  @@index([orderIndex])
}

model ProjectMilestone {
  id        String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  projectId String @map("project_id") @db.Uuid

  // Milestone details
  title       String  @db.VarChar(255)
  description String? @db.Text

  // Order
  orderIndex Int @default(0) @map("order_index")

  // Timeline
  dueDate     DateTime? @map("due_date")
  completedAt DateTime? @map("completed_at")

  // Status
  status CockpitMilestoneStatus @default(PENDING)

  // Payment (if linked to Market milestone)
  marketMilestoneId String?  @map("market_milestone_id") @db.Uuid
  amount            Decimal? @db.Decimal(12, 2)
  isPaid            Boolean  @default(false) @map("is_paid")

  // Deliverables
  deliverables Json? // [{title, description, completed, orderIndex}]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  project CockpitProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks   ProjectTask[]

  // Market Integration
  marketMilestoneLinks MarketMilestoneLink[] @relation("MarketMilestoneProjectLink")

  @@map("project_milestones")
  @@index([projectId])
  @@index([status])
  @@index([dueDate])
  @@index([marketMilestoneId])
}

model CockpitTimeEntry {
  id               String  @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  freelancerUserId String  @map("freelancer_user_id") @db.Uuid
  projectId        String? @map("project_id") @db.Uuid
  taskId           String? @map("task_id") @db.Uuid
  clientId         String? @map("client_id") @db.Uuid

  // Market integration
  marketContractId  String? @map("market_contract_id") @db.Uuid
  marketTimeEntryId String? @unique @map("market_time_entry_id") @db.Uuid

  // Entry details
  description String? @db.Text
  date        DateTime @db.Date

  // Duration
  startTime       DateTime? @map("start_time")
  endTime         DateTime? @map("end_time")
  durationMinutes Int       @map("duration_minutes")

  // Categorization
  category String?  @db.VarChar(100)
  tags     String[] @default([])

  // Billing
  isBillable Boolean  @default(true) @map("is_billable")
  hourlyRate Decimal? @map("hourly_rate") @db.Decimal(10, 2)
  amount     Decimal? @db.Decimal(12, 2)
  currency   String   @default("USD") @db.VarChar(3)

  // Invoice status
  isInvoiced Boolean   @default(false) @map("is_invoiced")
  invoiceId  String?   @map("invoice_id") @db.Uuid
  invoicedAt DateTime? @map("invoiced_at")

  // Tracking method
  trackingMethod TrackingMethod @default(MANUAL) @map("tracking_method")

  // Timer tracking (for TIMER method)
  timerStartedAt      DateTime? @map("timer_started_at")
  timerPausedAt       DateTime? @map("timer_paused_at")
  timerPausedDuration Int       @default(0) @map("timer_paused_duration")

  // Evidence (for SkillPod/screenshots)
  hasEvidence   Boolean       @default(false) @map("has_evidence")
  evidenceType  EvidenceType? @map("evidence_type")
  evidenceUrl   String?       @map("evidence_url") @db.VarChar(500)
  activityLevel Int?          @map("activity_level")

  // Approval (for Market entries)
  approvalStatus  TimeApprovalStatus? @map("approval_status")
  approvedAt      DateTime?           @map("approved_at")
  approvedBy      String?             @map("approved_by") @db.Uuid
  rejectedAt      DateTime?           @map("rejected_at")
  rejectionReason String?             @map("rejection_reason") @db.Text

  // Source
  source TimeEntrySource @default(COCKPIT)

  // Sync status
  syncedToMarket Boolean   @default(false) @map("synced_to_market")
  syncedAt       DateTime? @map("synced_at")
  syncError      String?   @map("sync_error") @db.Text

  // Locks
  isLocked     Boolean   @default(false) @map("is_locked")
  lockedAt     DateTime? @map("locked_at")
  lockedReason String?   @map("locked_reason") @db.VarChar(255)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  freelancer User            @relation("FreelancerTimeEntries", fields: [freelancerUserId], references: [id])
  project    CockpitProject? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  task       ProjectTask?    @relation(fields: [taskId], references: [id], onDelete: SetNull)
  client     Client?         @relation("ClientTimeEntries", fields: [clientId], references: [id], onDelete: SetNull)

  // Market Integration
  marketTimeLinks MarketTimeLink[] @relation("MarketTimeEntryLink")

  @@map("cockpit_time_entries")
  @@index([freelancerUserId])
  @@index([projectId])
  @@index([taskId])
  @@index([clientId])
  @@index([date])
  @@index([marketContractId])
  @@index([isInvoiced])
  @@index([isBillable])
  @@index([source])
}

model ProjectFile {
  id        String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  projectId String @map("project_id") @db.Uuid

  // File details
  name        String           @db.VarChar(255)
  description String?          @db.VarChar(500)
  fileType    ProjectFileType  @map("file_type")

  // Storage
  fileUrl  String @map("file_url") @db.VarChar(500)
  fileName String @map("file_name") @db.VarChar(255)
  fileSize Int    @map("file_size")
  mimeType String @map("mime_type") @db.VarChar(100)

  // Organization
  folder String?  @db.VarChar(255)
  tags   String[] @default([])

  // Version control
  version           Int     @default(1)
  previousVersionId String? @map("previous_version_id") @db.Uuid

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  project CockpitProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("project_files")
  @@index([projectId])
  @@index([fileType])
  @@index([folder])
}

model ProjectActivity {
  id        String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  projectId String @map("project_id") @db.Uuid

  // Activity details
  activityType ProjectActivityType @map("activity_type")
  description  String              @db.Text

  // Related entities
  taskId      String? @map("task_id") @db.Uuid
  milestoneId String? @map("milestone_id") @db.Uuid

  // Metadata
  metadata Json?

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  project CockpitProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("project_activities")
  @@index([projectId])
  @@index([createdAt])
  @@index([activityType])
}

model ProjectTemplate {
  id               String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  freelancerUserId String @map("freelancer_user_id") @db.Uuid

  // Template details
  name        String  @db.VarChar(255)
  description String? @db.Text
  category    String? @db.VarChar(100)

  // Project defaults
  projectType       CockpitProjectType? @map("project_type")
  budgetType        CockpitBudgetType?  @map("budget_type")
  defaultHourlyRate Decimal?            @map("default_hourly_rate") @db.Decimal(10, 2)
  estimatedHours    Decimal?            @map("estimated_hours") @db.Decimal(8, 2)

  // Structure
  taskStructure      Json? @map("task_structure") // [{title, description, estimatedMinutes, orderIndex, subtasks}]
  milestoneStructure Json? @map("milestone_structure") // [{title, description, daysFromStart, orderIndex, deliverables}]

  // Defaults
  tags String[] @default([])

  // Usage
  useCount Int @default(0) @map("use_count")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("project_templates")
  @@index([freelancerUserId])
  @@index([category])
}

// ============================================================================
// MARKET CONTRACT INTEGRATION
// ============================================================================

model MarketContractLink {
  id               String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  freelancerUserId String @map("freelancer_user_id") @db.Uuid

  // Market references
  marketContractId String  @unique @map("market_contract_id")
  marketJobId      String? @map("market_job_id")
  marketClientId   String  @map("market_client_id")

  // Cockpit references
  projectId String? @map("project_id") @db.Uuid
  clientId  String? @map("client_id") @db.Uuid

  // Contract info (cached from Market)
  contractTitle  String                    @map("contract_title") @db.VarChar(255)
  contractType   MarketContractType        @map("contract_type")
  contractStatus MarketContractLinkStatus  @map("contract_status")

  // Financial terms
  currency   String   @default("USD") @db.VarChar(3)
  hourlyRate Decimal? @map("hourly_rate") @db.Decimal(10, 2)
  fixedPrice Decimal? @map("fixed_price") @db.Decimal(14, 2)
  budgetCap  Decimal? @map("budget_cap") @db.Decimal(14, 2)

  // Timeline
  startDate DateTime  @map("start_date")
  endDate   DateTime? @map("end_date")

  // Sync state
  lastSyncedAt DateTime               @map("last_synced_at")
  syncStatus   MarketContractSyncStatus @default(SYNCED) @map("sync_status")
  syncError    String?                @map("sync_error") @db.Text

  // Settings
  autoCreateProject  Boolean @default(true) @map("auto_create_project")
  autoSyncTime       Boolean @default(true) @map("auto_sync_time")
  autoRecordPayments Boolean @default(true) @map("auto_record_payments")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  project        CockpitProject?       @relation("MarketContractProject", fields: [projectId], references: [id])
  client         Client?               @relation("MarketContractClient", fields: [clientId], references: [id])
  milestoneLinks MarketMilestoneLink[]
  timeLinks      MarketTimeLink[]
  paymentLinks   MarketPaymentLink[]

  @@map("market_contract_links")
  @@index([freelancerUserId])
  @@index([projectId])
  @@index([contractStatus])
}

model MarketMilestoneLink {
  id             String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  contractLinkId String @map("contract_link_id") @db.Uuid

  // Market reference
  marketMilestoneId String @map("market_milestone_id")

  // Cockpit reference
  projectMilestoneId String? @map("project_milestone_id") @db.Uuid

  // Milestone info (cached)
  title   String                     @db.VarChar(255)
  amount  Decimal                    @db.Decimal(14, 2)
  status  MarketMilestoneLinkStatus
  dueDate DateTime?                  @map("due_date")

  // Sync
  lastSyncedAt DateTime @map("last_synced_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  contractLink     MarketContractLink @relation(fields: [contractLinkId], references: [id], onDelete: Cascade)
  projectMilestone ProjectMilestone?  @relation("MarketMilestoneProjectLink", fields: [projectMilestoneId], references: [id])

  @@unique([contractLinkId, marketMilestoneId])
  @@map("market_milestone_links")
}

model MarketTimeLink {
  id             String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  contractLinkId String @map("contract_link_id") @db.Uuid

  // Market reference
  marketTimeLogId String @unique @map("market_time_log_id")

  // Cockpit reference
  timeEntryId String? @unique @map("time_entry_id") @db.Uuid

  // Direction
  source MarketTimeSource @default(MARKET)

  // Time info
  date        DateTime               @db.Date
  hours       Decimal                @db.Decimal(6, 2)
  description String?                @db.Text
  amount      Decimal                @db.Decimal(10, 2)
  status      MarketTimeLinkStatus

  // Sync
  lastSyncedAt DateTime @map("last_synced_at")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  contractLink MarketContractLink @relation(fields: [contractLinkId], references: [id], onDelete: Cascade)
  timeEntry    CockpitTimeEntry?  @relation("MarketTimeEntryLink", fields: [timeEntryId], references: [id])

  @@map("market_time_links")
  @@index([contractLinkId])
  @@index([date])
}

model MarketPaymentLink {
  id             String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  contractLinkId String @map("contract_link_id") @db.Uuid

  // Market reference
  marketPaymentId String  @unique @map("market_payment_id")
  marketInvoiceId String? @map("market_invoice_id")

  // Cockpit reference
  transactionId    String? @unique @map("transaction_id") @db.Uuid
  invoicePaymentId String? @map("invoice_payment_id") @db.Uuid

  // Payment info
  paymentType MarketPaymentLinkType @map("payment_type")
  grossAmount Decimal               @map("gross_amount") @db.Decimal(14, 2)
  platformFee Decimal               @map("platform_fee") @db.Decimal(14, 2)
  netAmount   Decimal               @map("net_amount") @db.Decimal(14, 2)
  currency    String                @db.VarChar(3)

  // Status
  status MarketPaymentLinkStatus
  paidAt DateTime? @map("paid_at")

  // Milestone reference
  milestoneLinkId String? @map("milestone_link_id") @db.Uuid

  // Sync
  lastSyncedAt DateTime @map("last_synced_at")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  contractLink MarketContractLink    @relation(fields: [contractLinkId], references: [id], onDelete: Cascade)
  transaction  FinancialTransaction? @relation("MarketPaymentTransaction", fields: [transactionId], references: [id])

  @@map("market_payment_links")
  @@index([contractLinkId])
  @@index([paidAt])
}

model MarketClientCache {
  id String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid

  // Market reference
  marketUserId String @unique @map("market_user_id")

  // Client info
  displayName String  @map("display_name") @db.VarChar(200)
  companyName String? @map("company_name") @db.VarChar(200)
  email       String? @db.VarChar(255)
  avatarUrl   String? @map("avatar_url") @db.VarChar(500)
  country     String? @db.VarChar(100)
  timezone    String? @db.VarChar(50)

  // Stats
  totalContracts Int     @default(0) @map("total_contracts")
  totalSpent     Decimal @default(0) @map("total_spent") @db.Decimal(14, 2)
  avgRating      Decimal? @map("avg_rating") @db.Decimal(3, 2)

  // Linked Cockpit client
  cockpitClientId String? @map("cockpit_client_id") @db.Uuid

  lastSyncedAt DateTime @map("last_synced_at")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("market_client_cache")
}

// Market Contract Integration Enums

enum MarketContractType {
  HOURLY
  FIXED_PRICE
  RETAINER
}

enum MarketContractLinkStatus {
  PENDING
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
  DISPUTED
}

enum MarketMilestoneLinkStatus {
  PENDING
  IN_PROGRESS
  SUBMITTED
  APPROVED
  PAID
  DISPUTED
}

enum MarketTimeLinkStatus {
  PENDING
  APPROVED
  DISPUTED
  PAID
}

enum MarketTimeSource {
  MARKET
  COCKPIT
}

enum MarketPaymentLinkType {
  MILESTONE
  HOURLY
  BONUS
  RETAINER
  REFUND
}

enum MarketPaymentLinkStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

enum MarketContractSyncStatus {
  SYNCED
  PENDING
  ERROR
  CONFLICT
}

// Project Management Enums

enum ProjectSource {
  MANUAL
  SKILLANCER_MARKET
  UPWORK
  FIVERR
  TOPTAL
  FREELANCER
  OTHER_PLATFORM
}

enum CockpitProjectType {
  CLIENT_WORK
  INTERNAL
  PERSONAL
  RETAINER
  MAINTENANCE
}

enum CockpitProjectStatus {
  NOT_STARTED
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum CockpitBudgetType {
  HOURLY
  FIXED
  RETAINER
  NO_BUDGET
}

enum CockpitTaskStatus {
  TODO
  IN_PROGRESS
  IN_REVIEW
  BLOCKED
  COMPLETED
  CANCELLED
}

enum CockpitMilestoneStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ProjectFileType {
  DELIVERABLE
  ASSET
  REFERENCE
  CONTRACT
  BRIEF
  OTHER
}

enum ProjectActivityType {
  PROJECT_CREATED
  PROJECT_UPDATED
  STATUS_CHANGED
  TASK_CREATED
  TASK_UPDATED
  TASK_COMPLETED
  TASK_DELETED
  MILESTONE_CREATED
  MILESTONE_UPDATED
  MILESTONE_COMPLETED
  TIME_LOGGED
  FILE_UPLOADED
  FILE_DELETED
  NOTE_ADDED
  PROGRESS_UPDATED
}

enum TimeEntrySource {
  MANUAL
  TIMER
  IMPORT
  COCKPIT
  MARKET
  SKILLPOD
  CALENDAR
}

enum TrackingMethod {
  TIMER
  MANUAL
  CALENDAR
  SKILLPOD
  IMPORTED
}

enum TimeApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum RoundingMethod {
  NONE
  UP
  DOWN
  NEAREST
}

enum TimerStatus {
  RUNNING
  PAUSED
  STOPPED
}

enum TimesheetStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
}

// ============================================================================
// TIME TRACKING SETTINGS & TIMERS
// ============================================================================

model TimeTrackingSettings {
  id     String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId String @unique @map("user_id") @db.Uuid

  // Default rates
  defaultHourlyRate Decimal? @map("default_hourly_rate") @db.Decimal(10, 2)
  defaultCurrency   String   @default("USD") @map("default_currency") @db.VarChar(3)

  // Timer settings
  autoStopAfterMinutes Int?    @map("auto_stop_after_minutes")
  idleDetectionMinutes Int     @default(5) @map("idle_detection_minutes")
  reminderEnabled      Boolean @default(true) @map("reminder_enabled")
  reminderTime         String? @map("reminder_time") @db.VarChar(5)

  // Rounding
  roundingMethod  RoundingMethod @default(NONE) @map("rounding_method")
  roundingMinutes Int            @default(15) @map("rounding_minutes")

  // Work hours
  workdayStartTime   String  @default("09:00") @map("workday_start_time") @db.VarChar(5)
  workdayEndTime     String  @default("17:00") @map("workday_end_time") @db.VarChar(5)
  workDays           Int[]   @default([1, 2, 3, 4, 5]) @map("work_days")
  targetHoursPerDay  Decimal @default(8) @map("target_hours_per_day") @db.Decimal(4, 2)
  targetHoursPerWeek Decimal @default(40) @map("target_hours_per_week") @db.Decimal(5, 2)

  // Categories
  customCategories String[] @map("custom_categories")

  // Auto-sync
  autoSyncToMarket Boolean @default(true) @map("auto_sync_to_market")

  // Timesheet
  weekStartDay       Int     @default(1) @map("week_start_day")
  requireDescription Boolean @default(true) @map("require_description")
  requireProject     Boolean @default(false) @map("require_project")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation("TimeTrackingSettings", fields: [userId], references: [id], onDelete: Cascade)

  @@map("time_tracking_settings")
}

model ActiveTimer {
  id     String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId String @unique @map("user_id") @db.Uuid

  // Timer details
  projectId   String? @map("project_id") @db.Uuid
  taskId      String? @map("task_id") @db.Uuid
  description String? @db.Text

  // Timing
  startedAt          DateTime @map("started_at")
  pausedAt           DateTime? @map("paused_at")
  totalPausedMinutes Int      @default(0) @map("total_paused_minutes")

  // Billing
  isBillable Boolean  @default(true) @map("is_billable")
  hourlyRate Decimal? @map("hourly_rate") @db.Decimal(10, 2)

  // Status
  status TimerStatus @default(RUNNING)

  // Metadata
  metadata Json?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user    User            @relation("ActiveTimer", fields: [userId], references: [id], onDelete: Cascade)
  project CockpitProject? @relation("ActiveTimerProject", fields: [projectId], references: [id], onDelete: SetNull)
  task    ProjectTask?    @relation("ActiveTimerTask", fields: [taskId], references: [id], onDelete: SetNull)

  @@map("active_timers")
  @@index([userId])
  @@index([projectId])
  @@index([status])
}

model Timesheet {
  id               String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  freelancerUserId String @map("freelancer_user_id") @db.Uuid

  // Period
  weekStartDate DateTime @map("week_start_date") @db.Date
  weekEndDate   DateTime @map("week_end_date") @db.Date

  // Totals
  totalMinutes    Int     @map("total_minutes")
  billableMinutes Int     @map("billable_minutes")
  totalAmount     Decimal @map("total_amount") @db.Decimal(12, 2)

  // Status
  status TimesheetStatus @default(DRAFT)

  // Submission
  submittedAt DateTime? @map("submitted_at")

  // Approval (if needed for some clients)
  approvedAt      DateTime? @map("approved_at")
  approvedBy      String?   @map("approved_by") @db.Uuid
  rejectedAt      DateTime? @map("rejected_at")
  rejectionReason String?   @map("rejection_reason") @db.Text

  // Lock
  isLocked Boolean   @default(false) @map("is_locked")
  lockedAt DateTime? @map("locked_at")

  // Notes
  notes String? @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  freelancer User @relation("FreelancerTimesheets", fields: [freelancerUserId], references: [id], onDelete: Cascade)

  @@unique([freelancerUserId, weekStartDate])
  @@map("timesheets")
  @@index([freelancerUserId])
  @@index([status])
  @@index([weekStartDate])
}

model TimeCategory {
  id               String  @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  freelancerUserId String? @map("freelancer_user_id") @db.Uuid

  name  String  @db.VarChar(100)
  color String? @db.VarChar(7)
  icon  String? @db.VarChar(50)

  // Billing default
  defaultBillable Boolean @default(true) @map("default_billable")

  // Order
  orderIndex Int @default(0) @map("order_index")

  // Status
  isActive Boolean @default(true) @map("is_active")
  isSystem Boolean @default(false) @map("is_system")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  freelancer User? @relation("FreelancerTimeCategories", fields: [freelancerUserId], references: [id], onDelete: Cascade)

  @@unique([freelancerUserId, name])
  @@map("time_categories")
  @@index([freelancerUserId])
  @@index([isActive])
}

// ============================================================================
// CALENDAR INTEGRATION
// ============================================================================

model CalendarConnection {
  id                String           @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId            String           @map("user_id") @db.Uuid

  // Provider
  provider          CalendarProvider
  providerAccountId String           @map("provider_account_id") @db.VarChar(255)

  // OAuth tokens (encrypted in app layer)
  accessToken    String    @map("access_token") @db.Text
  refreshToken   String?   @map("refresh_token") @db.Text
  tokenExpiresAt DateTime? @map("token_expires_at")

  // Account info
  email       String  @db.VarChar(255)
  displayName String? @map("display_name") @db.VarChar(255)

  // Sync settings
  syncEnabled   Boolean       @default(true) @map("sync_enabled")
  syncDirection SyncDirection @default(BIDIRECTIONAL) @map("sync_direction")
  lastSyncAt    DateTime?     @map("last_sync_at")
  lastSyncError String?       @map("last_sync_error") @db.Text
  syncStatus    SyncStatus    @default(PENDING) @map("sync_status")

  // Calendar selection
  selectedCalendarIds String[] @map("selected_calendar_ids")
  primaryCalendarId   String?  @map("primary_calendar_id") @db.VarChar(255)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user      User               @relation("UserCalendarConnections", fields: [userId], references: [id], onDelete: Cascade)
  calendars ExternalCalendar[]

  @@unique([userId, provider, providerAccountId])
  @@map("calendar_connections")
  @@index([userId])
  @@index([syncStatus])
}

model ExternalCalendar {
  id           String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  connectionId String @map("connection_id") @db.Uuid

  // External reference
  externalId String @map("external_id") @db.VarChar(255)

  // Calendar info
  name        String  @db.VarChar(255)
  description String? @db.Text
  color       String? @db.VarChar(20)
  timezone    String? @db.VarChar(50)

  // Access level
  accessRole String? @map("access_role") @db.VarChar(50) // 'owner', 'writer', 'reader'

  // Sync settings
  syncEnabled      Boolean @default(true) @map("sync_enabled")
  syncEvents       Boolean @default(true) @map("sync_events")
  createEventsHere Boolean @default(false) @map("create_events_here")

  // Status
  isDefault Boolean @default(false) @map("is_default")
  isPrimary Boolean @default(false) @map("is_primary")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  connection CalendarConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  events     CalendarEvent[]

  @@unique([connectionId, externalId])
  @@map("external_calendars")
  @@index([connectionId])
}

model CalendarEvent {
  id     String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId String @map("user_id") @db.Uuid

  // Source
  source             EventSource @default(INTERNAL)
  externalCalendarId String?     @map("external_calendar_id") @db.Uuid
  externalEventId    String?     @map("external_event_id") @db.VarChar(255)

  // Event details
  title       String  @db.VarChar(500)
  description String? @db.Text
  location    String? @db.VarChar(500)

  // Timing
  startTime DateTime @map("start_time")
  endTime   DateTime @map("end_time")
  isAllDay  Boolean  @default(false) @map("is_all_day")
  timezone  String   @default("UTC") @db.VarChar(50)

  // Recurrence
  isRecurring       Boolean   @default(false) @map("is_recurring")
  recurrenceRule    String?   @map("recurrence_rule") @db.VarChar(500) // RRULE format
  recurrenceId      String?   @map("recurrence_id") @db.Uuid // Parent recurring event
  originalStartTime DateTime? @map("original_start_time") // For exceptions

  // Type and categorization
  eventType EventType @default(MEETING) @map("event_type")
  category  String?   @db.VarChar(100)
  color     String?   @db.VarChar(20)

  // Associations
  projectId String? @map("project_id") @db.Uuid
  clientId  String? @map("client_id") @db.Uuid
  taskId    String? @map("task_id") @db.Uuid

  // Attendees
  attendees      Json?   // [{email, name, status, organizer}]
  organizerEmail String? @map("organizer_email") @db.VarChar(255)

  // Meeting links
  meetingUrl     String? @map("meeting_url") @db.VarChar(1000)
  conferenceType String? @map("conference_type") @db.VarChar(50) // 'zoom', 'meet', 'teams'

  // Status
  status     EventStatus     @default(CONFIRMED)
  visibility EventVisibility @default(DEFAULT)

  // Time tracking
  trackTime           Boolean @default(false) @map("track_time")
  timeEntryId         String? @map("time_entry_id") @db.Uuid
  autoCreateTimeEntry Boolean @default(false) @map("auto_create_time_entry")

  // Reminders
  reminders Json? // [{minutes, method}]

  // Sync
  lastSyncAt DateTime?  @map("last_sync_at")
  syncStatus SyncStatus @default(SYNCED) @map("sync_status")
  etag       String?    @db.VarChar(255) // For conflict detection

  // Metadata
  metadata Json?

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  user             User              @relation("UserCalendarEvents", fields: [userId], references: [id], onDelete: Cascade)
  externalCalendar ExternalCalendar? @relation(fields: [externalCalendarId], references: [id])
  project          CockpitProject?   @relation("ProjectCalendarEvents", fields: [projectId], references: [id])
  client           Client?           @relation("ClientCalendarEvents", fields: [clientId], references: [id])

  @@unique([externalCalendarId, externalEventId])
  @@map("calendar_events")
  @@index([userId])
  @@index([startTime])
  @@index([endTime])
  @@index([projectId])
  @@index([clientId])
  @@index([deletedAt])
}

model AvailabilitySchedule {
  id     String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId String @map("user_id") @db.Uuid

  // Schedule name
  name      String  @db.VarChar(100)
  isDefault Boolean @default(false) @map("is_default")

  // Timezone
  timezone String @default("UTC") @db.VarChar(50)

  // Weekly schedule
  // { 0: [{start: '09:00', end: '17:00'}], 1: [...], ... }
  weeklyHours Json @map("weekly_hours")

  // Date overrides
  // { '2025-01-15': [{start: '10:00', end: '14:00'}], '2025-01-16': [] }
  dateOverrides Json? @map("date_overrides")

  // Buffer time
  bufferBefore Int @default(0) @map("buffer_before") // minutes
  bufferAfter  Int @default(0) @map("buffer_after")

  // Minimum notice
  minNoticeHours Int @default(24) @map("min_notice_hours")

  // Max advance booking
  maxAdvanceDays Int @default(60) @map("max_advance_days")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user         User          @relation("UserAvailabilitySchedules", fields: [userId], references: [id], onDelete: Cascade)
  bookingLinks BookingLink[]

  @@map("availability_schedules")
  @@index([userId])
}

model BookingLink {
  id     String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId String @map("user_id") @db.Uuid

  // Link details
  slug        String  @unique @db.VarChar(100)
  name        String  @db.VarChar(200)
  description String? @db.Text

  // Event settings
  eventTitle    String    @map("event_title") @db.VarChar(200)
  eventDuration Int       @map("event_duration") // minutes
  eventType     EventType @default(MEETING) @map("event_type")

  // Location
  locationType    LocationType @default(VIDEO_CALL) @map("location_type")
  locationDetails String?      @map("location_details") @db.VarChar(500)
  conferenceType  String?      @map("conference_type") @db.VarChar(50)

  // Availability
  scheduleId String @map("schedule_id") @db.Uuid

  // Customization
  color           String? @db.VarChar(20)
  customQuestions Json?   @map("custom_questions")
  // [{id, question, type, required}]

  // Notifications
  confirmationEmailEnabled Boolean @default(true) @map("confirmation_email_enabled")
  reminderEmailEnabled     Boolean @default(true) @map("reminder_email_enabled")
  reminderMinutes          Int[]   @default([1440, 60]) @map("reminder_minutes") // 24h, 1h

  // Limits
  maxBookingsPerDay Int? @map("max_bookings_per_day")

  // Status
  isActive Boolean @default(true) @map("is_active")

  // Analytics
  viewCount    Int @default(0) @map("view_count")
  bookingCount Int @default(0) @map("booking_count")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user     User                 @relation("UserBookingLinks", fields: [userId], references: [id], onDelete: Cascade)
  schedule AvailabilitySchedule @relation(fields: [scheduleId], references: [id])
  bookings Booking[]

  @@map("booking_links")
  @@index([userId])
  @@index([slug])
  @@index([isActive])
}

model Booking {
  id            String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  bookingLinkId String @map("booking_link_id") @db.Uuid
  userId        String @map("user_id") @db.Uuid // Freelancer

  // Booker info
  bookerName     String @map("booker_name") @db.VarChar(200)
  bookerEmail    String @map("booker_email") @db.VarChar(255)
  bookerPhone    String? @map("booker_phone") @db.VarChar(50)
  bookerTimezone String @map("booker_timezone") @db.VarChar(50)

  // Timing
  startTime DateTime @map("start_time")
  endTime   DateTime @map("end_time")

  // Custom answers
  customAnswers Json? @map("custom_answers")

  // Notes
  notes String? @db.Text

  // Status
  status BookingStatus @default(CONFIRMED)

  // Cancellation
  cancelledAt        DateTime? @map("cancelled_at")
  cancelledBy        String?   @map("cancelled_by") @db.VarChar(20) // 'booker' or 'host'
  cancellationReason String?   @map("cancellation_reason") @db.Text

  // Rescheduling
  rescheduledFrom String? @map("rescheduled_from") @db.Uuid
  rescheduledTo   String? @map("rescheduled_to") @db.Uuid

  // Event reference
  calendarEventId String? @map("calendar_event_id") @db.Uuid

  // Meeting
  meetingUrl String? @map("meeting_url") @db.VarChar(1000)

  // Client link
  clientId String? @map("client_id") @db.Uuid

  // Notifications sent
  confirmationSentAt DateTime?  @map("confirmation_sent_at")
  remindersSentAt    DateTime[] @map("reminders_sent_at")

  // Cancellation token for guest
  cancellationToken String? @map("cancellation_token") @db.VarChar(100)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  bookingLink BookingLink @relation(fields: [bookingLinkId], references: [id])
  user        User        @relation("UserBookings", fields: [userId], references: [id], onDelete: Cascade)

  @@map("bookings")
  @@index([bookingLinkId])
  @@index([userId])
  @@index([startTime])
  @@index([status])
  @@index([cancellationToken])
}

enum CalendarProvider {
  GOOGLE
  MICROSOFT
  APPLE
}

enum SyncDirection {
  INBOUND
  OUTBOUND
  BIDIRECTIONAL
}

enum SyncStatus {
  PENDING
  SYNCING
  SYNCED
  ERROR
}

// ============================================================================
// UNIFIED FINANCIAL REPORTING
// ============================================================================

model UnifiedTransaction {
  id                  String                   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId              String                   @map("user_id") @db.Uuid

  // Source identification
  source              UnifiedTransactionSource
  sourceId            String                   @map("source_id") @db.VarChar(255)
  sourceSystem        String                   @map("source_system") @db.VarChar(50)

  // Deduplication
  deduplicationKey    String                   @unique @map("deduplication_key") @db.VarChar(64)
  isDuplicate         Boolean                  @default(false) @map("is_duplicate")
  duplicateOfId       String?                  @map("duplicate_of_id") @db.Uuid
  duplicateConfidence Decimal?                 @map("duplicate_confidence") @db.Decimal(5, 2)

  // Transaction details
  transactionType     UnifiedTransactionType   @map("transaction_type")
  amount              Decimal                  @db.Decimal(14, 2)
  originalCurrency    String                   @map("original_currency") @db.VarChar(3)
  exchangeRate        Decimal?                 @map("exchange_rate") @db.Decimal(12, 6)
  amountUSD           Decimal                  @map("amount_usd") @db.Decimal(14, 2)

  // Dates
  transactionDate     DateTime                 @map("transaction_date") @db.Date
  recordedDate        DateTime                 @map("recorded_date")

  // Categorization
  category            String                   @db.VarChar(100)
  subcategory         String?                  @db.VarChar(100)
  irsCategory         String?                  @map("irs_category") @db.VarChar(100)

  // Description
  description         String                   @db.Text
  notes               String?                  @db.Text

  // Associations
  clientId            String?                  @map("client_id") @db.Uuid
  clientName          String?                  @map("client_name") @db.VarChar(255)
  projectId           String?                  @map("project_id") @db.Uuid
  projectName         String?                  @map("project_name") @db.VarChar(255)
  platformName        String?                  @map("platform_name") @db.VarChar(100)

  // For income
  grossAmount         Decimal?                 @map("gross_amount") @db.Decimal(14, 2)
  platformFee         Decimal?                 @map("platform_fee") @db.Decimal(14, 2)
  processingFee       Decimal?                 @map("processing_fee") @db.Decimal(14, 2)
  netAmount           Decimal?                 @map("net_amount") @db.Decimal(14, 2)

  // For expenses
  vendor              String?                  @db.VarChar(255)
  isDeductible        Boolean                  @default(false) @map("is_deductible")
  deductionCategory   String?                  @map("deduction_category") @db.VarChar(50)
  hasReceipt          Boolean                  @default(false) @map("has_receipt")
  receiptUrl          String?                  @map("receipt_url") @db.VarChar(500)

  // Tax info
  taxYear             Int                      @map("tax_year")
  taxQuarter          Int                      @map("tax_quarter")
  isReported          Boolean                  @default(false) @map("is_reported")

  // Metadata
  metadata            Json?
  tags                String[]                 @default([])

  // Sync tracking
  lastSyncedAt        DateTime                 @map("last_synced_at")
  syncStatus          UnifiedSyncStatus        @default(SYNCED) @map("sync_status")

  createdAt           DateTime                 @default(now()) @map("created_at")
  updatedAt           DateTime                 @updatedAt @map("updated_at")

  // Relations
  user                User                     @relation("UserUnifiedTransactions", fields: [userId], references: [id])
  duplicateOf         UnifiedTransaction?      @relation("DuplicateRelation", fields: [duplicateOfId], references: [id])
  duplicates          UnifiedTransaction[]     @relation("DuplicateRelation")
  client              Client?                  @relation("ClientUnifiedTransactions", fields: [clientId], references: [id])
  project             CockpitProject?          @relation("ProjectUnifiedTransactions", fields: [projectId], references: [id])

  @@map("unified_transactions")
  @@index([userId])
  @@index([transactionDate])
  @@index([source])
  @@index([transactionType])
  @@index([category])
  @@index([taxYear])
  @@index([clientId])
  @@index([projectId])
}

model FinancialSummaryReport {
  id                       String                @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId                   String                @map("user_id") @db.Uuid

  // Period
  periodType               FinancialPeriodType   @map("period_type")
  periodStart              DateTime              @map("period_start") @db.Date
  periodEnd                DateTime              @map("period_end") @db.Date

  // Income summary
  totalGrossIncome         Decimal               @map("total_gross_income") @db.Decimal(14, 2)
  totalFees                Decimal               @map("total_fees") @db.Decimal(14, 2)
  totalNetIncome           Decimal               @map("total_net_income") @db.Decimal(14, 2)

  // Income by source
  incomeBySource           Json                  @map("income_by_source")
  incomeByPlatform         Json                  @map("income_by_platform")
  incomeByClient           Json                  @map("income_by_client")
  incomeByProject          Json                  @map("income_by_project")

  // Expense summary
  totalExpenses            Decimal               @map("total_expenses") @db.Decimal(14, 2)
  deductibleExpenses       Decimal               @map("deductible_expenses") @db.Decimal(14, 2)
  nonDeductibleExpenses    Decimal               @map("non_deductible_expenses") @db.Decimal(14, 2)

  // Expense breakdown
  expensesByCategory       Json                  @map("expenses_by_category")
  expensesByVendor         Json                  @map("expenses_by_vendor")

  // Calculated metrics
  netProfit                Decimal               @map("net_profit") @db.Decimal(14, 2)
  profitMargin             Decimal               @map("profit_margin") @db.Decimal(5, 2)
  effectiveTaxRate         Decimal?              @map("effective_tax_rate") @db.Decimal(5, 2)

  // Tax estimates
  estimatedTaxableIncome   Decimal?              @map("estimated_taxable_income") @db.Decimal(14, 2)
  estimatedTaxOwed         Decimal?              @map("estimated_tax_owed") @db.Decimal(14, 2)

  // Transaction counts
  incomeTransactionCount   Int                   @map("income_transaction_count")
  expenseTransactionCount  Int                   @map("expense_transaction_count")

  // Currency
  baseCurrency             String                @default("USD") @map("base_currency") @db.VarChar(3)

  // Generation info
  generatedAt              DateTime              @map("generated_at")
  isStale                  Boolean               @default(false) @map("is_stale")

  createdAt                DateTime              @default(now()) @map("created_at")
  updatedAt                DateTime              @updatedAt @map("updated_at")

  // Relations
  user                     User                  @relation("UserFinancialSummaries", fields: [userId], references: [id])

  @@map("financial_summary_reports")
  @@unique([userId, periodType, periodStart])
  @@index([userId])
  @@index([periodType])
  @@index([periodStart])
}

model ClientProfitabilityReport {
  id                   String                @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId               String                @map("user_id") @db.Uuid
  clientId             String                @map("client_id") @db.Uuid

  // Period
  periodType           FinancialPeriodType   @map("period_type")
  periodStart          DateTime              @map("period_start") @db.Date
  periodEnd            DateTime              @map("period_end") @db.Date

  // Revenue
  grossRevenue         Decimal               @map("gross_revenue") @db.Decimal(14, 2)
  platformFees         Decimal               @map("platform_fees") @db.Decimal(14, 2)
  netRevenue           Decimal               @map("net_revenue") @db.Decimal(14, 2)

  // Costs
  directCosts          Decimal               @map("direct_costs") @db.Decimal(14, 2)
  allocatedOverhead    Decimal               @map("allocated_overhead") @db.Decimal(14, 2)
  totalCosts           Decimal               @map("total_costs") @db.Decimal(14, 2)

  // Time investment
  totalHours           Decimal               @map("total_hours") @db.Decimal(10, 2)
  billableHours        Decimal               @map("billable_hours") @db.Decimal(10, 2)
  nonBillableHours     Decimal               @map("non_billable_hours") @db.Decimal(10, 2)

  // Profitability metrics
  grossProfit          Decimal               @map("gross_profit") @db.Decimal(14, 2)
  netProfit            Decimal               @map("net_profit") @db.Decimal(14, 2)
  grossMargin          Decimal               @map("gross_margin") @db.Decimal(5, 2)
  netMargin            Decimal               @map("net_margin") @db.Decimal(5, 2)

  // Hourly metrics
  effectiveHourlyRate  Decimal               @map("effective_hourly_rate") @db.Decimal(10, 2)
  revenuePerHour       Decimal               @map("revenue_per_hour") @db.Decimal(10, 2)
  profitPerHour        Decimal               @map("profit_per_hour") @db.Decimal(10, 2)

  // Project count
  projectCount         Int                   @map("project_count")
  activeProjects       Int                   @map("active_projects")

  // Ranking
  profitabilityRank    Int?                  @map("profitability_rank")
  revenueRank          Int?                  @map("revenue_rank")

  generatedAt          DateTime              @map("generated_at")
  createdAt            DateTime              @default(now()) @map("created_at")

  // Relations
  user                 User                  @relation("UserClientProfitability", fields: [userId], references: [id])
  client               Client                @relation("ClientProfitabilityReports", fields: [clientId], references: [id])

  @@map("client_profitability_reports")
  @@unique([userId, clientId, periodType, periodStart])
  @@index([userId])
  @@index([clientId])
  @@index([periodStart])
}

model PlatformPerformanceReport {
  id                    String                   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId                String                   @map("user_id") @db.Uuid

  // Platform
  platformName          String                   @map("platform_name") @db.VarChar(100)
  platformSource        UnifiedTransactionSource @map("platform_source")

  // Period
  periodType            FinancialPeriodType      @map("period_type")
  periodStart           DateTime                 @map("period_start") @db.Date
  periodEnd             DateTime                 @map("period_end") @db.Date

  // Revenue
  grossRevenue          Decimal                  @map("gross_revenue") @db.Decimal(14, 2)
  platformFees          Decimal                  @map("platform_fees") @db.Decimal(14, 2)
  feePercentage         Decimal                  @map("fee_percentage") @db.Decimal(5, 2)
  netRevenue            Decimal                  @map("net_revenue") @db.Decimal(14, 2)

  // Activity
  contractCount         Int                      @map("contract_count")
  activeContracts       Int                      @map("active_contracts")
  completedContracts    Int                      @map("completed_contracts")

  // Time
  hoursWorked           Decimal                  @map("hours_worked") @db.Decimal(10, 2)
  effectiveRate         Decimal                  @map("effective_rate") @db.Decimal(10, 2)

  // Client metrics
  uniqueClients         Int                      @map("unique_clients")
  repeatClients         Int                      @map("repeat_clients")
  newClients            Int                      @map("new_clients")

  // Performance
  avgProjectValue       Decimal                  @map("avg_project_value") @db.Decimal(14, 2)
  avgContractDuration   Int?                     @map("avg_contract_duration")
  clientRetentionRate   Decimal?                 @map("client_retention_rate") @db.Decimal(5, 2)

  // Comparison
  revenueShare          Decimal                  @map("revenue_share") @db.Decimal(5, 2)
  growthRate            Decimal?                 @map("growth_rate") @db.Decimal(6, 2)

  generatedAt           DateTime                 @map("generated_at")
  createdAt             DateTime                 @default(now()) @map("created_at")

  // Relations
  user                  User                     @relation("UserPlatformPerformance", fields: [userId], references: [id])

  @@map("platform_performance_reports")
  @@unique([userId, platformName, periodType, periodStart])
  @@index([userId])
  @@index([platformName])
  @@index([periodStart])
}

model TaxSummaryReport {
  id                       String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId                   String   @map("user_id") @db.Uuid

  // Tax year
  taxYear                  Int      @map("tax_year")

  // Income
  grossIncome              Decimal  @map("gross_income") @db.Decimal(14, 2)
  incomeBySource           Json     @map("income_by_source")
  form1099Income           Decimal  @map("form_1099_income") @db.Decimal(14, 2)

  // Deductions
  totalDeductions          Decimal  @map("total_deductions") @db.Decimal(14, 2)
  deductionsByCategory     Json     @map("deductions_by_category")

  // Specific deductions
  homeOfficeDeduction      Decimal? @map("home_office_deduction") @db.Decimal(14, 2)
  mileageDeduction         Decimal? @map("mileage_deduction") @db.Decimal(14, 2)
  healthInsuranceDeduction Decimal? @map("health_insurance_deduction") @db.Decimal(14, 2)
  retirementContributions  Decimal? @map("retirement_contributions") @db.Decimal(14, 2)

  // Calculated
  netProfit                Decimal  @map("net_profit") @db.Decimal(14, 2)
  selfEmploymentTax        Decimal  @map("self_employment_tax") @db.Decimal(14, 2)
  estimatedIncomeTax       Decimal  @map("estimated_income_tax") @db.Decimal(14, 2)
  totalEstimatedTax        Decimal  @map("total_estimated_tax") @db.Decimal(14, 2)

  // Quarterly payments
  quarterlyPayments        Json     @map("quarterly_payments")
  totalQuarterlyPaid       Decimal  @map("total_quarterly_paid") @db.Decimal(14, 2)
  remainingTaxDue          Decimal  @map("remaining_tax_due") @db.Decimal(14, 2)

  // Issues
  missingReceipts          Int      @map("missing_receipts")
  uncategorizedExpenses    Decimal  @map("uncategorized_expenses") @db.Decimal(14, 2)
  warnings                 Json?

  // Status
  isFinalized              Boolean  @default(false) @map("is_finalized")
  finalizedAt              DateTime? @map("finalized_at")

  generatedAt              DateTime @map("generated_at")
  createdAt                DateTime @default(now()) @map("created_at")
  updatedAt                DateTime @updatedAt @map("updated_at")

  // Relations
  user                     User     @relation("UserTaxSummaries", fields: [userId], references: [id])

  @@map("tax_summary_reports")
  @@unique([userId, taxYear])
  @@index([userId])
  @@index([taxYear])
}

model SavedFinancialReport {
  id                String                 @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId            String                 @map("user_id") @db.Uuid

  // Report info
  reportType        FinancialReportType    @map("report_type")
  name              String                 @db.VarChar(255)
  description       String?                @db.Text

  // Parameters
  parameters        Json

  // Generated content
  reportData        Json?                  @map("report_data")
  chartData         Json?                  @map("chart_data")

  // Files
  pdfUrl            String?                @map("pdf_url") @db.VarChar(500)
  excelUrl          String?                @map("excel_url") @db.VarChar(500)
  csvUrl            String?                @map("csv_url") @db.VarChar(500)

  // Scheduling
  isScheduled       Boolean                @default(false) @map("is_scheduled")
  scheduleFrequency String?                @map("schedule_frequency") @db.VarChar(20)
  nextRunAt         DateTime?              @map("next_run_at")
  lastRunAt         DateTime?              @map("last_run_at")
  emailRecipients   String[]               @map("email_recipients") @default([])

  // Status
  status            FinancialReportStatus  @default(PENDING)
  generatedAt       DateTime?              @map("generated_at")
  expiresAt         DateTime?              @map("expires_at")

  createdAt         DateTime               @default(now()) @map("created_at")
  updatedAt         DateTime               @updatedAt @map("updated_at")

  // Relations
  user              User                   @relation("UserSavedReports", fields: [userId], references: [id])

  @@map("saved_financial_reports")
  @@index([userId])
  @@index([reportType])
  @@index([nextRunAt])
}

// ============================================================================
// LEARNING TIME TRACKING - SkillPod Integration
// ============================================================================

model LearningTimeEntry {
  id                String              @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId            String              @map("user_id") @db.Uuid
  skillPodSessionId String              @unique @map("skillpod_session_id")

  // Content info
  contentType       LearningContentType @map("content_type")
  contentId         String              @map("content_id")
  contentTitle      String              @map("content_title")
  courseId          String?             @map("course_id")
  courseTitle       String?             @map("course_title")

  // Time tracking
  date              DateTime            @db.Date
  startTime         DateTime            @map("start_time")
  endTime           DateTime            @map("end_time")
  totalMinutes      Int                 @map("total_minutes")
  activeMinutes     Int                 @map("active_minutes")

  // Skills
  skillIds          String[]            @map("skill_ids")
  skillNames        String[]            @map("skill_names")
  primarySkillId    String?             @map("primary_skill_id")
  primarySkillName  String?             @map("primary_skill_name")

  // Categorization
  category          String              @default("Professional Development")
  subcategory       String?
  difficulty        String?

  // Progress
  progressGained    Decimal             @default(0) @map("progress_gained") @db.Decimal(5, 2)
  isCompleted       Boolean             @default(false) @map("is_completed")

  // Tax/deduction info
  isDeductible      Boolean             @default(true) @map("is_deductible")
  deductionCategory String?             @map("deduction_category")

  // Associated financial transaction
  transactionId     String?             @map("transaction_id") @db.Uuid

  // Notes
  notes             String?             @db.Text

  // Sync
  syncedAt          DateTime            @map("synced_at")
  createdAt         DateTime            @default(now()) @map("created_at")

  user              User                @relation("UserLearningTimeEntries", fields: [userId], references: [id])

  @@map("learning_time_entries")
  @@index([userId])
  @@index([date])
  @@index([contentType])
  @@index([primarySkillId])
}

model LearningGoal {
  id                    String           @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId                String           @map("user_id") @db.Uuid

  // Goal definition
  goalType              LearningGoalType @map("goal_type")
  title                 String
  description           String?

  // Target
  targetValue           Decimal          @map("target_value") @db.Decimal(10, 2)
  targetUnit            String           @map("target_unit")
  targetSkillId         String?          @map("target_skill_id")
  targetSkillName       String?          @map("target_skill_name")
  targetCourseId        String?          @map("target_course_id")
  targetCertificationId String?          @map("target_certification_id")

  // Period
  periodType            GoalPeriodType   @map("period_type")
  periodStart           DateTime         @map("period_start") @db.Date
  periodEnd             DateTime         @map("period_end") @db.Date

  // Progress
  currentValue          Decimal          @default(0) @map("current_value") @db.Decimal(10, 2)
  progressPercent       Decimal          @default(0) @map("progress_percent") @db.Decimal(5, 2)

  // Status
  status                GoalStatus       @default(ACTIVE)
  achievedAt            DateTime?        @map("achieved_at")

  // Linked to Market opportunity
  linkedJobCategoryId   String?          @map("linked_job_category_id")
  linkedRateTarget      Decimal?         @map("linked_rate_target") @db.Decimal(10, 2)

  // Notifications
  reminderEnabled       Boolean          @default(true) @map("reminder_enabled")
  reminderFrequency     String?          @map("reminder_frequency")
  lastReminderAt        DateTime?        @map("last_reminder_at")

  createdAt             DateTime         @default(now()) @map("created_at")
  updatedAt             DateTime         @updatedAt @map("updated_at")

  user                  User             @relation("UserLearningGoals", fields: [userId], references: [id])

  @@map("learning_goals")
  @@index([userId])
  @@index([status])
  @@index([periodEnd])
}

model LearningInvestment {
  id                 String                 @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId             String                 @map("user_id") @db.Uuid

  // Investment type
  investmentType     LearningInvestmentType @map("investment_type")

  // Reference
  referenceId        String                 @map("reference_id")
  referenceTitle     String                 @map("reference_title")

  // Financial
  amount             Decimal                @db.Decimal(10, 2)
  currency           String                 @default("USD")
  purchaseDate       DateTime               @map("purchase_date") @db.Date

  // Linked transaction
  transactionId      String?                @unique @map("transaction_id") @db.Uuid

  // Skills gained
  skillIds           String[]               @map("skill_ids")
  skillNames         String[]               @map("skill_names")

  // Time investment
  estimatedHours     Decimal?               @map("estimated_hours") @db.Decimal(8, 2)
  actualHours        Decimal                @default(0) @map("actual_hours") @db.Decimal(8, 2)

  // Completion
  isCompleted        Boolean                @default(false) @map("is_completed")
  completedAt        DateTime?              @map("completed_at")

  // ROI tracking
  credentialsEarned  String[]               @map("credentials_earned")
  rateBeforeLearning Decimal?               @map("rate_before_learning") @db.Decimal(10, 2)
  rateAfterLearning  Decimal?               @map("rate_after_learning") @db.Decimal(10, 2)

  // Tax
  isDeductible       Boolean                @default(true) @map("is_deductible")
  taxYear            Int                    @map("tax_year")

  createdAt          DateTime               @default(now()) @map("created_at")
  updatedAt          DateTime               @updatedAt @map("updated_at")

  user               User                   @relation("UserLearningInvestments", fields: [userId], references: [id])
  transaction        FinancialTransaction?  @relation("LearningInvestmentTransaction", fields: [transactionId], references: [id])

  @@map("learning_investments")
  @@index([userId])
  @@index([investmentType])
  @@index([taxYear])
}

model LearningTimeSummary {
  id                   String     @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId               String     @map("user_id") @db.Uuid

  // Period
  periodType           PeriodType @map("period_type")
  periodStart          DateTime   @map("period_start") @db.Date
  periodEnd            DateTime   @map("period_end") @db.Date

  // Time totals
  totalMinutes         Int        @map("total_minutes")
  activeMinutes        Int        @map("active_minutes")

  // By content type
  courseMinutes        Int        @default(0) @map("course_minutes")
  assessmentMinutes    Int        @default(0) @map("assessment_minutes")
  practiceMinutes      Int        @default(0) @map("practice_minutes")
  readingMinutes       Int        @default(0) @map("reading_minutes")

  // Achievements
  lessonsCompleted     Int        @default(0) @map("lessons_completed")
  coursesCompleted     Int        @default(0) @map("courses_completed")
  assessmentsPassed    Int        @default(0) @map("assessments_passed")
  certificationsEarned Int        @default(0) @map("certifications_earned")

  // Skills breakdown
  skillBreakdown       Json       @map("skill_breakdown")

  // Financial value
  estimatedValue       Decimal?   @map("estimated_value") @db.Decimal(10, 2)
  investmentMade       Decimal    @default(0) @map("investment_made") @db.Decimal(10, 2)

  // Streak
  learningDays         Int        @default(0) @map("learning_days")
  longestStreak        Int        @default(0) @map("longest_streak")

  // Goals
  goalsAchieved        Int        @default(0) @map("goals_achieved")
  goalsInProgress      Int        @default(0) @map("goals_in_progress")

  generatedAt          DateTime   @map("generated_at")
  isStale              Boolean    @default(false) @map("is_stale")

  createdAt            DateTime   @default(now()) @map("created_at")
  updatedAt            DateTime   @updatedAt @map("updated_at")

  user                 User       @relation("UserLearningSummaries", fields: [userId], references: [id])

  @@unique([userId, periodType, periodStart])
  @@map("learning_time_summaries")
  @@index([userId])
  @@index([periodStart])
}

model SkillLearningProgress {
  id                    String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId                String    @map("user_id") @db.Uuid
  skillId               String    @map("skill_id")
  skillName             String    @map("skill_name")

  // Time invested
  totalMinutes          Int       @default(0) @map("total_minutes")
  courseMinutes         Int       @default(0) @map("course_minutes")
  assessmentMinutes     Int       @default(0) @map("assessment_minutes")
  practiceMinutes       Int       @default(0) @map("practice_minutes")

  // Progress
  currentLevel          String?   @map("current_level")
  progressToNextLevel   Decimal   @default(0) @map("progress_to_next_level") @db.Decimal(5, 2)

  // Courses
  coursesStarted        Int       @default(0) @map("courses_started")
  coursesCompleted      Int       @default(0) @map("courses_completed")

  // Assessments
  assessmentsTaken      Int       @default(0) @map("assessments_taken")
  assessmentsPassed     Int       @default(0) @map("assessments_passed")
  highestScore          Decimal?  @map("highest_score") @db.Decimal(5, 2)

  // Credentials
  credentialsEarned     String[]  @map("credentials_earned")

  // Last activity
  lastLearningDate      DateTime? @map("last_learning_date")

  // ROI tracking
  rateWhenStarted       Decimal?  @map("rate_when_started") @db.Decimal(10, 2)
  currentRate           Decimal?  @map("current_rate") @db.Decimal(10, 2)
  rateIncrease          Decimal?  @map("rate_increase") @db.Decimal(6, 2)

  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  user                  User      @relation("UserSkillProgress", fields: [userId], references: [id])

  @@unique([userId, skillId])
  @@map("skill_learning_progress")
  @@index([userId])
  @@index([totalMinutes])
}

enum LearningContentType {
  COURSE
  LESSON
  ASSESSMENT
  PROJECT
  ARTICLE
  PRACTICE
  CERTIFICATION
  LEARNING_PATH
}

enum LearningGoalType {
  WEEKLY_HOURS
  MONTHLY_HOURS
  COURSE_COMPLETION
  SKILL_LEVEL
  CERTIFICATION
  LEARNING_PATH
  CUSTOM
}

enum GoalPeriodType {
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
  CUSTOM
}

enum GoalStatus {
  ACTIVE
  ACHIEVED
  MISSED
  CANCELLED
}

enum LearningInvestmentType {
  COURSE_PURCHASE
  SUBSCRIPTION
  CERTIFICATION_FEE
  BOOK
  CONFERENCE
  WORKSHOP
  TOOL_LICENSE
  OTHER
}

enum PeriodType {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}

enum UnifiedTransactionSource {
  MARKET
  COCKPIT
  COCKPIT_INVOICE
  UPWORK
  FIVERR
  TOPTAL
  FREELANCER
  QUICKBOOKS
  XERO
  FRESHBOOKS
  PLAID
  STRIPE
  PAYPAL
  MANUAL
  OTHER
}

enum UnifiedTransactionType {
  INCOME
  EXPENSE
  TRANSFER
  REFUND
  FEE
  TAX_PAYMENT
}

enum UnifiedSyncStatus {
  SYNCED
  PENDING_SYNC
  SYNC_ERROR
  DUPLICATE
}

enum FinancialPeriodType {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
  CUSTOM
}

enum FinancialReportType {
  PROFIT_LOSS
  CASH_FLOW
  TAX_SUMMARY
  CLIENT_PROFITABILITY
  PLATFORM_COMPARISON
  INCOME_BY_SOURCE
  EXPENSE_ANALYSIS
  QUARTERLY_ESTIMATE
  ANNUAL_SUMMARY
  CUSTOM
}

enum FinancialReportStatus {
  PENDING
  GENERATING
  COMPLETED
  FAILED
  EXPIRED
}

enum EventSource {
  INTERNAL
  GOOGLE
  MICROSOFT
  APPLE
  BOOKING
}

enum EventType {
  MEETING
  CALL
  FOCUS_TIME
  DEADLINE
  REMINDER
  BLOCKED
  OUT_OF_OFFICE
  OTHER
}

enum EventStatus {
  CONFIRMED
  TENTATIVE
  CANCELLED
}

enum EventVisibility {
  DEFAULT
  PUBLIC
  PRIVATE
  CONFIDENTIAL
}

enum LocationType {
  VIDEO_CALL
  PHONE
  IN_PERSON
  CUSTOM
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  NO_SHOW
}

// ============================================================================
// FINANCIAL TRACKING - Income & Expense Management
// ============================================================================

model FinancialAccount {
  id               String               @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId           String               @map("user_id") @db.Uuid

  // Account details
  name             String               @db.VarChar(255)
  accountType      FinancialAccountType @map("account_type")

  // For connected accounts (Plaid)
  isConnected      Boolean              @default(false) @map("is_connected")
  plaidItemId      String?              @map("plaid_item_id") @db.VarChar(255)
  plaidAccountId   String?              @map("plaid_account_id") @db.VarChar(255)
  plaidAccessToken String?              @map("plaid_access_token") @db.Text

  // Account info
  institutionName  String?              @map("institution_name") @db.VarChar(255)
  institutionLogo  String?              @map("institution_logo") @db.VarChar(500)
  accountNumber    String?              @map("account_number") @db.VarChar(20) // Last 4 digits

  // Balance
  currentBalance   Decimal?             @map("current_balance") @db.Decimal(14, 2)
  availableBalance Decimal?             @map("available_balance") @db.Decimal(14, 2)
  balanceUpdatedAt DateTime?            @map("balance_updated_at")

  // Currency
  currency         String               @default("USD") @db.VarChar(3)

  // Status
  isActive         Boolean              @default(true) @map("is_active")
  isPrimary        Boolean              @default(false) @map("is_primary")

  // Sync
  lastSyncAt       DateTime?            @map("last_sync_at")
  syncStatus       SyncStatus           @default(PENDING) @map("sync_status")
  syncError        String?              @map("sync_error") @db.Text

  // Settings
  autoImportTransactions Boolean        @default(true) @map("auto_import_transactions")
  defaultCategory  String?              @map("default_category") @db.VarChar(100)

  createdAt        DateTime             @default(now()) @map("created_at")
  updatedAt        DateTime             @updatedAt @map("updated_at")

  // Relations
  user             User                 @relation("UserFinancialAccounts", fields: [userId], references: [id])
  transactions     FinancialTransaction[]

  @@map("financial_accounts")
  @@index([userId])
  @@index([plaidItemId])
  @@index([isActive])
}

model FinancialTransaction {
  id                  String             @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId              String             @map("user_id") @db.Uuid
  accountId           String?            @map("account_id") @db.Uuid

  // Transaction type
  type                FinancialTransactionType

  // Amount (always positive)
  amount              Decimal            @db.Decimal(14, 2)
  currency            String             @default("USD") @db.VarChar(3)

  // Exchange rate (if different from account currency)
  originalAmount      Decimal?           @map("original_amount") @db.Decimal(14, 2)
  originalCurrency    String?            @map("original_currency") @db.VarChar(3)
  exchangeRate        Decimal?           @map("exchange_rate") @db.Decimal(10, 6)

  // Transaction details
  date                DateTime           @db.Date
  description         String             @db.VarChar(500)
  notes               String?            @db.Text

  // Categorization
  category            String             @db.VarChar(100)
  subcategory         String?            @db.VarChar(100)
  tags                String[]           @default([])

  // Source
  source              FinancialTransactionSource @default(MANUAL)

  // External references
  marketPaymentId     String?            @unique @map("market_payment_id") @db.Uuid
  marketInvoiceId     String?            @map("market_invoice_id") @db.Uuid
  invoiceId           String?            @map("invoice_id") @db.Uuid
  plaidTransactionId  String?            @unique @map("plaid_transaction_id") @db.VarChar(255)

  // Client/Project association
  clientId            String?            @map("client_id") @db.Uuid
  projectId           String?            @map("project_id") @db.Uuid

  // For income
  paymentMethod       String?            @map("payment_method") @db.VarChar(50)

  // For expenses
  vendor              String?            @db.VarChar(255)
  isDeductible        Boolean            @default(true) @map("is_deductible")
  deductionCategory   String?            @map("deduction_category") @db.VarChar(50) // IRS category

  // Receipt
  hasReceipt          Boolean            @default(false) @map("has_receipt")
  receiptUrl          String?            @map("receipt_url") @db.VarChar(500)
  receiptFileName     String?            @map("receipt_file_name") @db.VarChar(255)

  // Recurring
  isRecurring         Boolean            @default(false) @map("is_recurring")
  recurringRuleId     String?            @map("recurring_rule_id") @db.Uuid

  // Reconciliation
  isReconciled        Boolean            @default(false) @map("is_reconciled")
  reconciledAt        DateTime?          @map("reconciled_at")

  // Tax
  taxYear             Int?               @map("tax_year")
  includedInTaxReport Boolean            @default(false) @map("included_in_tax_report")

  // Status
  status              FinancialTransactionStatus @default(CONFIRMED)
  isPending           Boolean            @default(false) @map("is_pending")

  // Splits (for split transactions)
  isSplit             Boolean            @default(false) @map("is_split")
  parentTransactionId String?            @map("parent_transaction_id") @db.Uuid

  createdAt           DateTime           @default(now()) @map("created_at")
  updatedAt           DateTime           @updatedAt @map("updated_at")

  // Relations
  user                User               @relation("UserFinancialTransactions", fields: [userId], references: [id])
  account             FinancialAccount?  @relation(fields: [accountId], references: [id])
  client              Client?            @relation("ClientFinancialTransactions", fields: [clientId], references: [id])
  project             CockpitProject?    @relation("ProjectFinancialTransactions", fields: [projectId], references: [id])
  parentTransaction   FinancialTransaction? @relation("TransactionSplits", fields: [parentTransactionId], references: [id])
  splitTransactions   FinancialTransaction[] @relation("TransactionSplits")
  recurringRule       RecurringTransaction? @relation(fields: [recurringRuleId], references: [id])

  // Market Integration
  marketPaymentLinks  MarketPaymentLink[] @relation("MarketPaymentTransaction")

  // Learning Investment
  learningInvestment  LearningInvestment? @relation("LearningInvestmentTransaction")

  @@map("financial_transactions")
  @@index([userId])
  @@index([accountId])
  @@index([type])
  @@index([date])
  @@index([category])
  @@index([clientId])
  @@index([projectId])
  @@index([taxYear])
  @@index([status])
  @@index([isReconciled])
}

model RecurringTransaction {
  id                   String              @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId               String              @map("user_id") @db.Uuid

  // Template
  type                 FinancialTransactionType
  amount               Decimal             @db.Decimal(14, 2)
  currency             String              @default("USD") @db.VarChar(3)
  description          String              @db.VarChar(500)
  category             String              @db.VarChar(100)
  subcategory          String?             @db.VarChar(100)
  vendor               String?             @db.VarChar(255)
  isDeductible         Boolean             @default(true) @map("is_deductible")

  // Account
  accountId            String?             @map("account_id") @db.Uuid

  // Client/Project
  clientId             String?             @map("client_id") @db.Uuid
  projectId            String?             @map("project_id") @db.Uuid

  // Recurrence
  frequency            RecurrenceFrequency
  interval             Int                 @default(1)
  dayOfMonth           Int?                @map("day_of_month")
  dayOfWeek            Int?                @map("day_of_week")

  // Schedule
  startDate            DateTime            @map("start_date") @db.Date
  endDate              DateTime?           @map("end_date") @db.Date
  nextOccurrence       DateTime?           @map("next_occurrence") @db.Date

  // Tracking
  occurrenceCount      Int                 @default(0) @map("occurrence_count")
  maxOccurrences       Int?                @map("max_occurrences")
  lastOccurrence       DateTime?           @map("last_occurrence") @db.Date

  // Status
  isActive             Boolean             @default(true) @map("is_active")
  isPaused             Boolean             @default(false) @map("is_paused")

  // Auto-create
  autoCreate           Boolean             @default(true) @map("auto_create")
  requiresConfirmation Boolean             @default(false) @map("requires_confirmation")

  createdAt            DateTime            @default(now()) @map("created_at")
  updatedAt            DateTime            @updatedAt @map("updated_at")

  // Relations
  user                 User                @relation("UserRecurringTransactions", fields: [userId], references: [id])
  transactions         FinancialTransaction[]

  @@map("recurring_transactions")
  @@index([userId])
  @@index([nextOccurrence])
  @@index([isActive])
}

model TransactionCategory {
  id           String                   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId       String?                  @map("user_id") @db.Uuid // null = system default

  // Category details
  name         String                   @db.VarChar(100)
  type         FinancialTransactionType
  parentId     String?                  @map("parent_id") @db.Uuid

  // Display
  icon         String?                  @db.VarChar(50)
  color        String?                  @db.VarChar(20)
  orderIndex   Int                      @default(0) @map("order_index")

  // Tax mapping
  irsCategory  String?                  @map("irs_category") @db.VarChar(50) // Schedule C line
  isDeductible Boolean                  @default(true) @map("is_deductible")

  // Status
  isActive     Boolean                  @default(true) @map("is_active")
  isSystem     Boolean                  @default(false) @map("is_system")

  createdAt    DateTime                 @default(now()) @map("created_at")

  // Relations
  user         User?                    @relation("UserTransactionCategories", fields: [userId], references: [id])
  parent       TransactionCategory?     @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children     TransactionCategory[]    @relation("CategoryHierarchy")

  @@map("transaction_categories")
  @@unique([userId, name, type])
  @@index([userId])
  @@index([type])
}

model FinancialGoal {
  id               String           @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId           String           @map("user_id") @db.Uuid

  // Goal details
  name             String           @db.VarChar(255)
  description      String?          @db.Text
  goalType         FinancialGoalType @map("goal_type")

  // Target
  targetAmount     Decimal          @map("target_amount") @db.Decimal(14, 2)
  currentAmount    Decimal          @default(0) @map("current_amount") @db.Decimal(14, 2)
  currency         String           @default("USD") @db.VarChar(3)

  // Period
  periodType       FinancialPeriodType? @map("period_type")
  startDate        DateTime?        @map("start_date") @db.Date
  endDate          DateTime?        @map("end_date") @db.Date

  // Category filter (for expense goals)
  categoryFilter   String[]         @default([]) @map("category_filter")

  // Status
  status           FinancialGoalStatus @default(IN_PROGRESS)
  achievedAt       DateTime?        @map("achieved_at")

  // Notifications
  notifyAtPercent  Int[]            @default([50, 75, 90, 100]) @map("notify_at_percent")
  notifiedPercents Int[]            @default([]) @map("notified_percents")

  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")

  // Relations
  user             User             @relation("UserFinancialGoals", fields: [userId], references: [id])

  @@map("financial_goals")
  @@index([userId])
  @@index([goalType])
  @@index([status])
}

model MileageLog {
  id              String         @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId          String         @map("user_id") @db.Uuid

  // Trip details
  date            DateTime       @db.Date
  description     String         @db.VarChar(500)
  purpose         MileagePurpose

  // Distance
  miles           Decimal        @db.Decimal(8, 2)

  // Rate
  ratePerMile     Decimal        @map("rate_per_mile") @db.Decimal(6, 4)
  deductionAmount Decimal        @map("deduction_amount") @db.Decimal(10, 2)

  // Route
  startLocation   String?        @map("start_location") @db.VarChar(255)
  endLocation     String?        @map("end_location") @db.VarChar(255)
  roundTrip       Boolean        @default(false) @map("round_trip")

  // Association
  clientId        String?        @map("client_id") @db.Uuid
  projectId       String?        @map("project_id") @db.Uuid

  // Vehicle
  vehicleId       String?        @map("vehicle_id") @db.Uuid

  // Tax
  taxYear         Int            @map("tax_year")

  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  // Relations
  user            User           @relation("UserMileageLogs", fields: [userId], references: [id])
  client          Client?        @relation("ClientMileageLogs", fields: [clientId], references: [id])
  project         CockpitProject? @relation("ProjectMileageLogs", fields: [projectId], references: [id])

  @@map("mileage_logs")
  @@index([userId])
  @@index([date])
  @@index([taxYear])
  @@index([clientId])
  @@index([projectId])
}

model TaxProfile {
  id                   String          @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId               String          @unique @map("user_id") @db.Uuid

  // Business info
  businessType         BusinessType    @map("business_type")
  businessName         String?         @map("business_name") @db.VarChar(255)
  ein                  String?         @db.VarChar(255) // Encrypted

  // Filing status
  filingStatus         FilingStatus    @map("filing_status")

  // Estimated tax
  estimatedTaxRate     Decimal?        @map("estimated_tax_rate") @db.Decimal(5, 2)
  quarterlyPayments    Boolean         @default(true) @map("quarterly_payments")

  // State
  stateOfResidence     String?         @map("state_of_residence") @db.VarChar(2)
  stateIncomeTaxRate   Decimal?        @map("state_income_tax_rate") @db.Decimal(5, 2)

  // Settings
  fiscalYearEnd        String          @default("12-31") @map("fiscal_year_end") @db.VarChar(5)
  accountingMethod     AccountingMethod @default(CASH) @map("accounting_method")

  // Home office
  hasHomeOffice        Boolean         @default(false) @map("has_home_office")
  homeOfficeSquareFeet Int?            @map("home_office_square_feet")
  totalHomeSquareFeet  Int?            @map("total_home_square_feet")

  // Vehicle
  hasBusinessVehicle   Boolean         @default(false) @map("has_business_vehicle")
  vehicleInfo          Json?           @map("vehicle_info")

  // IRS mileage rate by year
  mileageRates         Json            @default("{}") @map("mileage_rates")

  createdAt            DateTime        @default(now()) @map("created_at")
  updatedAt            DateTime        @updatedAt @map("updated_at")

  // Relations
  user                 User            @relation("UserTaxProfile", fields: [userId], references: [id])

  @@map("tax_profiles")
}

// Financial Enums
enum FinancialAccountType {
  CHECKING
  SAVINGS
  CREDIT_CARD
  CASH
  PAYPAL
  STRIPE
  OTHER
}

enum FinancialTransactionType {
  INCOME
  EXPENSE
  TRANSFER
}

enum FinancialTransactionSource {
  MANUAL
  MARKET
  BANK_IMPORT
  RECURRING
  INVOICE
}

enum FinancialTransactionStatus {
  PENDING
  CONFIRMED
  VOIDED
}

enum RecurrenceFrequency {
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}

enum FinancialGoalType {
  INCOME
  SAVINGS
  EXPENSE_LIMIT
  PROFIT
}

enum FinancialGoalStatus {
  IN_PROGRESS
  ACHIEVED
  FAILED
  CANCELLED
}

enum FinancialPeriodType {
  MONTHLY
  QUARTERLY
  YEARLY
  CUSTOM
}

enum MileagePurpose {
  CLIENT_MEETING
  BUSINESS_ERRAND
  TRAVEL
  OTHER
}

enum BusinessType {
  SOLE_PROPRIETOR
  LLC_SINGLE
  LLC_MULTI
  S_CORP
  C_CORP
  PARTNERSHIP
}

enum FilingStatus {
  SINGLE
  MARRIED_FILING_JOINTLY
  MARRIED_FILING_SEPARATELY
  HEAD_OF_HOUSEHOLD
  QUALIFYING_WIDOW
}

enum AccountingMethod {
  CASH
  ACCRUAL
}

// ============================================================================
// INVOICING SYSTEM
// Professional invoicing, payments, templates, recurring billing
// ============================================================================

model Invoice {
  id               String  @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  freelancerUserId String  @map("freelancer_user_id") @db.Uuid
  clientId         String  @map("client_id") @db.Uuid

  // Invoice identification
  invoiceNumber   String  @unique @map("invoice_number") @db.VarChar(50)
  referenceNumber String? @map("reference_number") @db.VarChar(100)

  // Project association
  projectId  String? @map("project_id") @db.Uuid
  contractId String? @map("contract_id") @db.Uuid

  // Dates
  issueDate DateTime  @map("issue_date") @db.Date
  dueDate   DateTime  @map("due_date") @db.Date
  paidDate  DateTime? @map("paid_date") @db.Date

  // Status
  status InvoiceStatus @default(DRAFT)

  // Currency
  currency     String   @default("USD") @db.VarChar(3)
  exchangeRate Decimal? @map("exchange_rate") @db.Decimal(10, 6)

  // Amounts
  subtotal      Decimal      @db.Decimal(14, 2)
  discountType  DiscountType? @map("discount_type")
  discountValue Decimal?     @map("discount_value") @db.Decimal(10, 2)
  discountAmount Decimal     @default(0) @map("discount_amount") @db.Decimal(14, 2)

  // Tax
  taxEnabled Boolean  @default(false) @map("tax_enabled")
  taxRate    Decimal? @map("tax_rate") @db.Decimal(5, 2)
  taxAmount  Decimal  @default(0) @map("tax_amount") @db.Decimal(14, 2)
  taxLabel   String?  @map("tax_label") @db.VarChar(50)
  taxNumber  String?  @map("tax_number") @db.VarChar(100)

  // Totals
  total      Decimal @db.Decimal(14, 2)
  amountPaid Decimal @default(0) @map("amount_paid") @db.Decimal(14, 2)
  amountDue  Decimal @map("amount_due") @db.Decimal(14, 2)

  // Late fees
  lateFeeEnabled   Boolean     @default(false) @map("late_fee_enabled")
  lateFeeType      LateFeeType? @map("late_fee_type")
  lateFeeValue     Decimal?    @map("late_fee_value") @db.Decimal(10, 2)
  lateFeeAmount    Decimal     @default(0) @map("late_fee_amount") @db.Decimal(14, 2)
  lateFeeAppliedAt DateTime?   @map("late_fee_applied_at")

  // Content
  title      String? @db.VarChar(255)
  summary    String? @db.Text
  notes      String? @db.Text
  terms      String? @db.Text
  footerText String? @map("footer_text") @db.Text

  // Branding
  templateId  String? @map("template_id") @db.Uuid
  logoUrl     String? @map("logo_url") @db.VarChar(500)
  accentColor String? @map("accent_color") @db.VarChar(7)

  // Payment
  paymentInstructions    String?  @map("payment_instructions") @db.Text
  acceptedPaymentMethods String[] @map("accepted_payment_methods")

  // Online payment
  stripePaymentIntentId String? @map("stripe_payment_intent_id") @db.VarChar(255)
  stripeInvoiceId       String? @map("stripe_invoice_id") @db.VarChar(255)
  paypalOrderId         String? @map("paypal_order_id") @db.VarChar(255)

  // Client portal
  viewToken    String    @unique @map("view_token") @db.VarChar(64)
  viewCount    Int       @default(0) @map("view_count")
  lastViewedAt DateTime? @map("last_viewed_at")

  // PDF
  pdfUrl         String?   @map("pdf_url") @db.VarChar(500)
  pdfGeneratedAt DateTime? @map("pdf_generated_at")

  // Recurring
  isRecurring         Boolean @default(false) @map("is_recurring")
  recurringScheduleId String? @map("recurring_schedule_id") @db.Uuid

  // Reminders
  remindersSent  Int       @default(0) @map("reminders_sent")
  lastReminderAt DateTime? @map("last_reminder_at")
  nextReminderAt DateTime? @map("next_reminder_at")

  // Sent tracking
  sentAt DateTime? @map("sent_at")
  sentTo String[]  @map("sent_to")

  // Voiding
  voidedAt   DateTime? @map("voided_at")
  voidReason String?   @map("void_reason") @db.Text

  // Metadata
  metadata Json?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  freelancer        User              @relation("FreelancerInvoices", fields: [freelancerUserId], references: [id])
  client            Client            @relation("ClientInvoices", fields: [clientId], references: [id])
  project           CockpitProject?   @relation("ProjectInvoices", fields: [projectId], references: [id])
  template          InvoiceTemplate?  @relation(fields: [templateId], references: [id])
  recurringSchedule RecurringInvoice? @relation("RecurringInvoiceInstances", fields: [recurringScheduleId], references: [id])
  lineItems         InvoiceLineItem[]
  payments          InvoicePayment[]
  activities        InvoiceActivity[]

  @@map("invoices")
  @@index([freelancerUserId])
  @@index([clientId])
  @@index([projectId])
  @@index([status])
  @@index([dueDate])
  @@index([issueDate])
  @@index([viewToken])
  @@index([invoiceNumber])
}

model InvoiceLineItem {
  id        String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  invoiceId String @map("invoice_id") @db.Uuid

  // Order
  orderIndex Int @default(0) @map("order_index")

  // Item details
  itemType    LineItemType @default(SERVICE) @map("item_type")
  description String       @db.Text

  // Quantity and rate
  quantity  Decimal @db.Decimal(10, 4)
  unitType  String? @map("unit_type") @db.VarChar(50)
  unitPrice Decimal @map("unit_price") @db.Decimal(14, 2)

  // Amount
  amount Decimal @db.Decimal(14, 2)

  // Tax
  isTaxable Boolean  @default(true) @map("is_taxable")
  taxRate   Decimal? @map("tax_rate") @db.Decimal(5, 2)

  // References
  timeEntryIds String[] @map("time_entry_ids")
  milestoneId  String?  @map("milestone_id") @db.Uuid
  projectId    String?  @map("project_id") @db.Uuid
  taskId       String?  @map("task_id") @db.Uuid

  // Date range (for time-based billing)
  periodStart DateTime? @map("period_start") @db.Date
  periodEnd   DateTime? @map("period_end") @db.Date

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@map("invoice_line_items")
  @@index([invoiceId])
}

model InvoicePayment {
  id        String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  invoiceId String @map("invoice_id") @db.Uuid

  // Payment details
  amount   Decimal @db.Decimal(14, 2)
  currency String  @default("USD") @db.VarChar(3)

  // Date
  paymentDate DateTime @map("payment_date") @db.Date

  // Method
  paymentMethod InvoicePaymentMethod @map("payment_method")

  // Transaction reference
  transactionId       String? @map("transaction_id") @db.VarChar(255)
  stripePaymentId     String? @map("stripe_payment_id") @db.VarChar(255)
  paypalTransactionId String? @map("paypal_transaction_id") @db.VarChar(255)

  // Notes
  notes String? @db.Text

  // Status
  status InvoicePaymentStatus @default(COMPLETED)

  // Refund
  isRefund          Boolean @default(false) @map("is_refund")
  refundedPaymentId String? @map("refunded_payment_id") @db.Uuid
  refundReason      String? @map("refund_reason") @db.Text

  // Financial transaction link
  financialTransactionId String? @map("financial_transaction_id") @db.Uuid

  createdAt DateTime @default(now()) @map("created_at")

  invoice Invoice @relation(fields: [invoiceId], references: [id])

  @@map("invoice_payments")
  @@index([invoiceId])
  @@index([paymentDate])
}

model InvoiceTemplate {
  id               String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  freelancerUserId String @map("freelancer_user_id") @db.Uuid

  // Template details
  name        String  @db.VarChar(100)
  description String? @db.VarChar(500)
  isDefault   Boolean @default(false) @map("is_default")

  // Branding
  logoUrl     String?        @map("logo_url") @db.VarChar(500)
  accentColor String         @default("#3B82F6") @map("accent_color") @db.VarChar(7)
  fontFamily  String         @default("Inter") @map("font_family") @db.VarChar(50)

  // Layout
  layout       TemplateLayout @default(CLASSIC)
  showLogo     Boolean        @default(true) @map("show_logo")
  showPaymentQR Boolean       @default(false) @map("show_payment_qr")

  // Business info
  businessName    String? @map("business_name") @db.VarChar(200)
  businessAddress Json?   @map("business_address")
  businessEmail   String? @map("business_email") @db.VarChar(255)
  businessPhone   String? @map("business_phone") @db.VarChar(50)
  businessWebsite String? @map("business_website") @db.VarChar(255)
  taxNumber       String? @map("tax_number") @db.VarChar(100)

  // Default content
  defaultNotes        String? @map("default_notes") @db.Text
  defaultTerms        String? @map("default_terms") @db.Text
  defaultFooter       String? @map("default_footer") @db.Text
  paymentInstructions String? @map("payment_instructions") @db.Text

  // Default settings
  defaultDueDays  Int      @default(30) @map("default_due_days")
  defaultTaxRate  Decimal? @map("default_tax_rate") @db.Decimal(5, 2)
  defaultTaxLabel String?  @map("default_tax_label") @db.VarChar(50)
  defaultCurrency String   @default("USD") @map("default_currency") @db.VarChar(3)
  defaultLateFee  Json?    @map("default_late_fee")

  // Payment methods
  acceptedPaymentMethods String[] @default(["bank_transfer"]) @map("accepted_payment_methods")
  stripeEnabled          Boolean  @default(false) @map("stripe_enabled")
  paypalEnabled          Boolean  @default(false) @map("paypal_enabled")

  // Custom CSS
  customCss String? @map("custom_css") @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  freelancer       User              @relation("FreelancerInvoiceTemplates", fields: [freelancerUserId], references: [id])
  invoices         Invoice[]
  recurringInvoices RecurringInvoice[]

  @@map("invoice_templates")
  @@index([freelancerUserId])
}

model RecurringInvoice {
  id               String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  freelancerUserId String @map("freelancer_user_id") @db.Uuid
  clientId         String @map("client_id") @db.Uuid

  // Schedule name
  name String @db.VarChar(200)

  // Template for generated invoices
  templateId String? @map("template_id") @db.Uuid

  // Line items template
  lineItems Json @map("line_items")

  // Amounts
  subtotal  Decimal  @db.Decimal(14, 2)
  taxRate   Decimal? @map("tax_rate") @db.Decimal(5, 2)
  taxAmount Decimal  @default(0) @map("tax_amount") @db.Decimal(14, 2)
  total     Decimal  @db.Decimal(14, 2)
  currency  String   @default("USD") @db.VarChar(3)

  // Schedule
  frequency  RecurrenceFrequency
  interval   Int                 @default(1)
  dayOfMonth Int?                @map("day_of_month")
  dayOfWeek  Int?                @map("day_of_week")

  // Dates
  startDate       DateTime  @map("start_date") @db.Date
  endDate         DateTime? @map("end_date") @db.Date
  nextInvoiceDate DateTime? @map("next_invoice_date") @db.Date
  lastInvoiceDate DateTime? @map("last_invoice_date") @db.Date

  // Tracking
  invoiceCount Int  @default(0) @map("invoice_count")
  maxInvoices  Int? @map("max_invoices")

  // Settings
  dueDays  Int     @default(30) @map("due_days")
  autoSend Boolean @default(true) @map("auto_send")

  // Status
  isActive Boolean @default(true) @map("is_active")
  isPaused Boolean @default(false) @map("is_paused")

  // Project
  projectId String? @map("project_id") @db.Uuid

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  freelancer User             @relation("FreelancerRecurringInvoices", fields: [freelancerUserId], references: [id])
  client     Client           @relation("ClientRecurringInvoices", fields: [clientId], references: [id])
  template   InvoiceTemplate? @relation(fields: [templateId], references: [id])
  invoices   Invoice[]        @relation("RecurringInvoiceInstances")

  @@map("recurring_invoices")
  @@index([freelancerUserId])
  @@index([clientId])
  @@index([nextInvoiceDate])
  @@index([isActive])
}

model InvoiceActivity {
  id        String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  invoiceId String @map("invoice_id") @db.Uuid

  // Activity details
  activityType InvoiceActivityType @map("activity_type")
  description  String              @db.VarChar(500)

  // Actor
  actorType String  @map("actor_type") @db.VarChar(50)
  actorId   String? @map("actor_id") @db.Uuid

  // Metadata
  metadata Json?

  createdAt DateTime @default(now()) @map("created_at")

  invoice Invoice @relation(fields: [invoiceId], references: [id])

  @@map("invoice_activities")
  @@index([invoiceId])
  @@index([createdAt])
}

model InvoiceSettings {
  id     String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId String @unique @map("user_id") @db.Uuid

  // Numbering
  invoicePrefix     String @default("INV") @map("invoice_prefix") @db.VarChar(20)
  nextInvoiceNumber Int    @default(1) @map("next_invoice_number")
  numberPadding     Int    @default(4) @map("number_padding")
  numberFormat      String @default("{prefix}-{year}{number}") @map("number_format") @db.VarChar(100)

  // Defaults
  defaultDueDays    Int     @default(30) @map("default_due_days")
  defaultCurrency   String  @default("USD") @map("default_currency") @db.VarChar(3)
  defaultTemplateId String? @map("default_template_id") @db.Uuid

  // Tax
  defaultTaxEnabled Boolean  @default(false) @map("default_tax_enabled")
  defaultTaxRate    Decimal? @map("default_tax_rate") @db.Decimal(5, 2)
  defaultTaxLabel   String?  @map("default_tax_label") @db.VarChar(50)
  taxNumber         String?  @map("tax_number") @db.VarChar(100)

  // Late fees
  defaultLateFeeEnabled Boolean      @default(false) @map("default_late_fee_enabled")
  defaultLateFeeType    LateFeeType? @map("default_late_fee_type")
  defaultLateFeeValue   Decimal?     @map("default_late_fee_value") @db.Decimal(10, 2)
  lateFeeGraceDays      Int          @default(0) @map("late_fee_grace_days")

  // Reminders
  autoReminders Boolean @default(true) @map("auto_reminders")
  reminderDays  Int[]   @default([7, 3, 1, 0, -3, -7]) @map("reminder_days")

  // Payment
  stripeAccountId String? @map("stripe_account_id") @db.VarChar(255)
  paypalEmail     String? @map("paypal_email") @db.VarChar(255)
  bankDetails     Json?   @map("bank_details")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation("UserInvoiceSettings", fields: [userId], references: [id])

  @@map("invoice_settings")
}

// ============================================================================
// INVOICE ENUMS
// ============================================================================

enum InvoiceStatus {
  DRAFT
  PENDING
  SENT
  VIEWED
  PARTIALLY_PAID
  PAID
  OVERDUE
  VOIDED
  CANCELLED
}

enum LineItemType {
  SERVICE
  PRODUCT
  EXPENSE
  DISCOUNT
  TIME
  MILESTONE
  RETAINER
  OTHER
}

enum DiscountType {
  PERCENTAGE
  FIXED
}

enum LateFeeType {
  PERCENTAGE
  FIXED
  DAILY_PERCENTAGE
  DAILY_FIXED
}

enum InvoicePaymentMethod {
  BANK_TRANSFER
  CREDIT_CARD
  STRIPE
  PAYPAL
  CHECK
  CASH
  CRYPTO
  OTHER
}

enum InvoicePaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum TemplateLayout {
  CLASSIC
  MODERN
  MINIMAL
  DETAILED
  COMPACT
}

enum InvoiceActivityType {
  CREATED
  UPDATED
  SENT
  VIEWED
  PAYMENT_RECEIVED
  PAYMENT_FAILED
  REMINDER_SENT
  LATE_FEE_APPLIED
  STATUS_CHANGED
  VOIDED
  DOWNLOADED
  COMMENT_ADDED
}

// ============================================================================
// INTEGRATION PLATFORM (CP-4.1)
// External service connections and synchronization
// ============================================================================

model Integration {
  id                String   @id @default(uuid()) @db.Uuid
  userId            String   @map("user_id") @db.Uuid

  // Integration type
  provider          IntegrationProvider
  providerAccountId String?  @map("provider_account_id")

  // Display info
  name              String
  description       String?

  // OAuth credentials (encrypted)
  accessToken       String?  @map("access_token") @db.Text
  refreshToken      String?  @map("refresh_token") @db.Text
  tokenExpiresAt    DateTime? @map("token_expires_at")
  tokenType         String?  @map("token_type")
  scope             String?

  // API Key auth (encrypted)
  apiKey            String?  @map("api_key") @db.Text
  apiSecret         String?  @map("api_secret") @db.Text

  // Webhook
  webhookSecret     String?  @map("webhook_secret")
  webhookUrl        String?  @map("webhook_url")

  // Account info
  accountEmail      String?  @map("account_email")
  accountName       String?  @map("account_name")
  accountAvatar     String?  @map("account_avatar")
  metadata          Json?

  // Status
  status            IntegrationStatus @default(PENDING)
  isActive          Boolean  @default(true) @map("is_active")

  // Sync settings
  syncEnabled       Boolean  @default(true) @map("sync_enabled")
  syncFrequency     SyncFrequency @default(HOURLY) @map("sync_frequency")
  lastSyncAt        DateTime? @map("last_sync_at")
  lastSyncStatus    IntegrationSyncStatus? @map("last_sync_status")
  lastSyncError     String?  @map("last_sync_error")
  nextSyncAt        DateTime? @map("next_sync_at")

  // Sync options
  syncOptions       Json?    @map("sync_options")

  // Rate limiting
  rateLimitRemaining Int?    @map("rate_limit_remaining")
  rateLimitResetAt  DateTime? @map("rate_limit_reset_at")

  // Error tracking
  consecutiveErrors Int      @default(0) @map("consecutive_errors")
  lastErrorAt       DateTime? @map("last_error_at")
  isPaused          Boolean  @default(false) @map("is_paused")
  pausedReason      String?  @map("paused_reason")

  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  user              User     @relation("UserIntegrations", fields: [userId], references: [id], onDelete: Cascade)
  syncLogs          IntegrationSyncLog[]
  mappings          IntegrationMapping[]
  webhookEvents     WebhookEvent[]

  @@map("integrations")
  @@unique([userId, provider, providerAccountId])
  @@index([userId])
  @@index([provider])
  @@index([status])
  @@index([nextSyncAt])
}

model IntegrationMapping {
  id                String   @id @default(uuid()) @db.Uuid
  integrationId     String   @map("integration_id") @db.Uuid

  // Mapping type
  entityType        MappingEntityType @map("entity_type")

  // External reference
  externalId        String   @map("external_id")
  externalType      String?  @map("external_type")
  externalName      String?  @map("external_name")
  externalData      Json?    @map("external_data")

  // Internal reference
  internalId        String   @map("internal_id") @db.Uuid
  internalType      String   @map("internal_type")

  // Sync direction
  syncDirection     IntegrationSyncDirection @default(BIDIRECTIONAL) @map("sync_direction")

  // Last sync
  lastSyncAt        DateTime? @map("last_sync_at")
  lastSyncHash      String?  @map("last_sync_hash")

  // Status
  isActive          Boolean  @default(true) @map("is_active")

  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  integration       Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@map("integration_mappings")
  @@unique([integrationId, entityType, externalId])
  @@index([integrationId])
  @@index([internalId])
}

model IntegrationSyncLog {
  id                String   @id @default(uuid()) @db.Uuid
  integrationId     String   @map("integration_id") @db.Uuid

  // Sync details
  syncType          IntegrationSyncType @map("sync_type")
  entityType        String?  @map("entity_type")

  // Timing
  startedAt         DateTime @map("started_at")
  completedAt       DateTime? @map("completed_at")
  durationMs        Int?     @map("duration_ms")

  // Results
  status            IntegrationSyncStatus
  itemsProcessed    Int      @default(0) @map("items_processed")
  itemsCreated      Int      @default(0) @map("items_created")
  itemsUpdated      Int      @default(0) @map("items_updated")
  itemsDeleted      Int      @default(0) @map("items_deleted")
  itemsFailed       Int      @default(0) @map("items_failed")

  // Pagination cursor for incremental syncs
  cursor            String?  @db.Text

  // Errors
  errorMessage      String?  @map("error_message") @db.Text
  errorDetails      Json?    @map("error_details")

  // Metadata
  metadata          Json?

  createdAt         DateTime @default(now()) @map("created_at")

  integration       Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@map("integration_sync_logs")
  @@index([integrationId])
  @@index([startedAt])
  @@index([status])
}

model WebhookEvent {
  id                String   @id @default(uuid()) @db.Uuid
  integrationId     String?  @map("integration_id") @db.Uuid

  // Event details
  provider          IntegrationProvider
  eventType         String   @map("event_type")
  eventId           String?  @map("event_id")

  // Payload
  payload           Json
  headers           Json?

  // Processing
  status            WebhookEventStatus @default(PENDING)
  processedAt       DateTime? @map("processed_at")
  processingError   String?  @map("processing_error") @db.Text
  retryCount        Int      @default(0) @map("retry_count")
  nextRetryAt       DateTime? @map("next_retry_at")

  // Signature verification
  signatureValid    Boolean? @map("signature_valid")

  createdAt         DateTime @default(now()) @map("created_at")

  integration       Integration? @relation(fields: [integrationId], references: [id])

  @@map("webhook_events")
  @@index([integrationId])
  @@index([provider])
  @@index([status])
  @@index([createdAt])
}

model IntegrationTemplate {
  id                String   @id @default(uuid()) @db.Uuid

  // Provider info
  provider          IntegrationProvider @unique
  name              String
  description       String   @db.Text
  category          IntegrationCategory

  // Display
  logoUrl           String   @map("logo_url")
  color             String

  // Capabilities
  capabilities      String[]

  // Auth config
  authType          IntegrationAuthType @map("auth_type")
  oauthConfig       Json?    @map("oauth_config")
  apiKeyConfig      Json?    @map("api_key_config")

  // Sync options schema
  syncOptionsSchema Json?    @map("sync_options_schema")

  // Documentation
  setupInstructions String?  @map("setup_instructions") @db.Text
  helpUrl           String?  @map("help_url")

  // Status
  isAvailable       Boolean  @default(true) @map("is_available")
  isBeta            Boolean  @default(false) @map("is_beta")
  isPremium         Boolean  @default(false) @map("is_premium")

  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@map("integration_templates")
}

enum IntegrationProvider {
  // Freelance Platforms
  UPWORK
  FIVERR
  TOPTAL
  FREELANCER

  // Productivity
  NOTION
  TRELLO
  ASANA
  JIRA
  MONDAY
  CLICKUP
  TODOIST

  // Communication
  SLACK
  DISCORD
  TEAMS

  // Accounting
  QUICKBOOKS
  XERO
  FRESHBOOKS
  WAVE

  // Banking
  PLAID

  // Storage
  GOOGLE_DRIVE
  DROPBOX
  ONEDRIVE

  // Development
  GITHUB
  GITLAB
  BITBUCKET

  // Calendar
  GOOGLE_CALENDAR
  OUTLOOK_CALENDAR

  // Other
  ZAPIER
  MAKE
  CUSTOM_WEBHOOK
}

enum IntegrationCategory {
  FREELANCE_PLATFORM
  PRODUCTIVITY
  COMMUNICATION
  ACCOUNTING
  BANKING
  STORAGE
  DEVELOPMENT
  CALENDAR
  AUTOMATION
}

enum IntegrationStatus {
  PENDING
  CONNECTED
  ERROR
  EXPIRED
  REVOKED
}

enum SyncFrequency {
  REALTIME
  EVERY_5_MIN
  EVERY_15_MIN
  HOURLY
  EVERY_6_HOURS
  DAILY
  WEEKLY
  MANUAL
}

enum IntegrationSyncDirection {
  INBOUND
  OUTBOUND
  BIDIRECTIONAL
}

enum IntegrationSyncType {
  FULL
  INCREMENTAL
  MANUAL
  WEBHOOK
}

enum IntegrationSyncStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  PARTIAL
  FAILED
}

enum MappingEntityType {
  CLIENT
  PROJECT
  TASK
  TIME_ENTRY
  INVOICE
  EXPENSE
  PAYMENT
  CONTRACT
  MESSAGE
  FILE
  MILESTONE
}

enum WebhookEventStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  SKIPPED
}

enum IntegrationAuthType {
  OAUTH2
  API_KEY
  BASIC
  CUSTOM
}

// ============================================================================
// SKILLPOD CREDENTIAL INTEGRATION
// ============================================================================

model VerifiedCredential {
  id                  String           @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId              String           @map("user_id") @db.Uuid
  freelancerProfileId String?          @map("freelancer_profile_id") @db.Uuid

  // Source reference
  sourceCredentialId  String           @map("source_credential_id")
  source              CredentialSource @default(SKILLPOD)

  // Credential info
  credentialType      CredentialType   @map("credential_type")
  title               String           @db.VarChar(500)
  description         String?          @db.Text

  // Skills covered
  skillIds            String[]         @map("skill_ids")

  // Dates
  issueDate           DateTime         @map("issue_date")
  expirationDate      DateTime?        @map("expiration_date")
  syncedAt            DateTime         @map("synced_at")

  // Scoring
  score               Decimal?         @db.Decimal(5, 2)
  percentile          Decimal?         @db.Decimal(5, 2)
  proficiencyLevel    ProficiencyLevel? @map("proficiency_level")

  // Verification
  verificationUrl     String           @map("verification_url") @db.VarChar(1000)
  verificationCode    String           @map("verification_code") @db.VarChar(100)
  isVerified          Boolean          @default(true) @map("is_verified")
  lastVerifiedAt      DateTime         @default(now()) @map("last_verified_at")

  // Display
  isVisible           Boolean          @default(true) @map("is_visible")
  displayOrder        Int              @default(0) @map("display_order")
  imageUrl            String?          @map("image_url") @db.VarChar(500)
  badgeUrl            String?          @map("badge_url") @db.VarChar(500)

  // Metadata
  metadata            Json?

  // Status
  status              CredentialStatus @default(ACTIVE)
  revokedAt           DateTime?        @map("revoked_at")
  revocationReason    String?          @map("revocation_reason") @db.VarChar(500)

  createdAt           DateTime         @default(now()) @map("created_at")
  updatedAt           DateTime         @updatedAt @map("updated_at")

  user                User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  skillVerifications  SkillVerification[]

  @@map("verified_credentials")
  @@unique([userId, sourceCredentialId])
  @@index([userId])
  @@index([freelancerProfileId])
  @@index([status])
  @@index([credentialType])
}

model SkillVerification {
  id                  String            @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId              String            @map("user_id") @db.Uuid
  skillId             String            @map("skill_id") @db.Uuid

  // Verification source
  verificationType    VerificationType  @map("verification_type")
  credentialId        String?           @map("credential_id") @db.Uuid

  // Score and level
  score               Decimal           @db.Decimal(5, 2)
  maxScore            Decimal           @default(100) @map("max_score") @db.Decimal(5, 2)
  percentile          Decimal?          @db.Decimal(5, 2)
  proficiencyLevel    ProficiencyLevel  @map("proficiency_level")

  // Confidence
  confidenceScore     Decimal           @map("confidence_score") @db.Decimal(5, 2)
  confidenceFactors   Json              @map("confidence_factors")

  // Assessment details
  proctored           Boolean           @default(false)
  assessmentDuration  Int?              @map("assessment_duration") // minutes
  questionBreakdown   Json?             @map("question_breakdown")

  // Validity
  verifiedAt          DateTime          @map("verified_at")
  validUntil          DateTime?         @map("valid_until")
  isActive            Boolean           @default(true) @map("is_active")

  // Visibility
  showOnProfile       Boolean           @default(true) @map("show_on_profile")
  showScore           Boolean           @default(true) @map("show_score")
  showPercentile      Boolean           @default(true) @map("show_percentile")

  createdAt           DateTime          @default(now()) @map("created_at")
  updatedAt           DateTime          @updatedAt @map("updated_at")

  user                User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  skill               Skill             @relation(fields: [skillId], references: [id], onDelete: Cascade)
  credential          VerifiedCredential? @relation(fields: [credentialId], references: [id], onDelete: SetNull)

  @@map("skill_verifications")
  @@unique([userId, skillId, verificationType])
  @@index([userId])
  @@index([skillId])
  @@index([proficiencyLevel])
  @@index([isActive])
}

model SkillConfidence {
  id                  String           @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId              String           @map("user_id") @db.Uuid
  skillId             String           @map("skill_id") @db.Uuid

  // Aggregated confidence score
  overallConfidence   Decimal          @map("overall_confidence") @db.Decimal(5, 2)

  // Component scores
  assessmentScore     Decimal?         @map("assessment_score") @db.Decimal(5, 2)
  learningScore       Decimal?         @map("learning_score") @db.Decimal(5, 2)
  experienceScore     Decimal?         @map("experience_score") @db.Decimal(5, 2)
  endorsementScore    Decimal?         @map("endorsement_score") @db.Decimal(5, 2)
  projectScore        Decimal?         @map("project_score") @db.Decimal(5, 2)

  // Factors
  assessmentsPassed   Int              @default(0) @map("assessments_passed")
  coursesCompleted    Int              @default(0) @map("courses_completed")
  hoursLearned        Decimal          @default(0) @map("hours_learned") @db.Decimal(8, 2)
  projectsCompleted   Int              @default(0) @map("projects_completed")
  endorsementCount    Int              @default(0) @map("endorsement_count")
  yearsExperience     Decimal?         @map("years_experience") @db.Decimal(4, 1)

  // Derived level
  calculatedLevel     ProficiencyLevel @map("calculated_level")
  claimedLevel        ProficiencyLevel? @map("claimed_level")
  levelMatch          Boolean          @map("level_match")

  // Trend
  confidenceTrend     Decimal          @default(0) @map("confidence_trend") @db.Decimal(5, 2)
  lastActivityDate    DateTime?        @map("last_activity_date")

  updatedAt           DateTime         @updatedAt @map("updated_at")

  user                User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  skill               Skill            @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@map("skill_confidences")
  @@unique([userId, skillId])
  @@index([userId])
  @@index([overallConfidence])
  @@index([calculatedLevel])
}

model LearningActivity {
  id                  String           @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId              String           @unique @map("user_id") @db.Uuid

  // Activity summary
  totalHoursLearned   Decimal          @map("total_hours_learned") @db.Decimal(10, 2)
  totalCourses        Int              @map("total_courses")
  completedCourses    Int              @map("completed_courses")
  totalAssessments    Int              @map("total_assessments")
  passedAssessments   Int              @map("passed_assessments")
  totalCredentials    Int              @map("total_credentials")
  activeCredentials   Int              @map("active_credentials")

  // Streak
  currentStreak       Int              @default(0) @map("current_streak")
  longestStreak       Int              @default(0) @map("longest_streak")
  lastLearningDate    DateTime?        @map("last_learning_date")

  // Activity by period
  hoursLast30Days     Decimal          @default(0) @map("hours_last_30_days") @db.Decimal(8, 2)
  hoursLast90Days     Decimal          @default(0) @map("hours_last_90_days") @db.Decimal(8, 2)
  hoursLast365Days    Decimal          @default(0) @map("hours_last_365_days") @db.Decimal(8, 2)

  // Display settings
  showOnProfile       Boolean          @default(true) @map("show_on_profile")
  showHours           Boolean          @default(true) @map("show_hours")
  showStreak          Boolean          @default(true) @map("show_streak")

  updatedAt           DateTime         @updatedAt @map("updated_at")

  user                User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("learning_activities")
}

enum CredentialSource {
  SKILLPOD
  EXTERNAL
  MANUAL
}

enum CredentialType {
  COURSE_COMPLETION
  ASSESSMENT_PASS
  CERTIFICATION
  SKILL_BADGE
  LEARNING_PATH
  EXTERNAL_CERTIFICATION
}

enum CredentialStatus {
  ACTIVE
  EXPIRED
  REVOKED
  PENDING_RENEWAL
}

enum ProficiencyLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

enum VerificationType {
  ASSESSMENT
  COURSE_COMPLETION
  CERTIFICATION
  PEER_ENDORSEMENT
  CLIENT_REVIEW
  PROJECT_COMPLETION
}

// =============================================================================
// LEARNING RECOMMENDATION SYSTEM
// Market Activity to Learning Recommendations Integration
// =============================================================================

// User's learning profile with career preferences and goals
model UserLearningProfile {
  id                      String                   @id @default(uuid()) @db.Uuid
  userId                  String                   @unique @db.Uuid
  
  // Career Information
  currentRole             String?
  targetRole              String?
  experienceLevel         ProficiencyLevel         @default(INTERMEDIATE)
  yearsOfExperience       Int                      @default(0)
  primaryIndustry         String?
  targetIndustries        String[]
  
  // Learning Preferences
  preferredContentTypes   ContentType[]
  preferredLearningStyle  LearningStyle            @default(SELF_PACED)
  weeklyLearningHours     Int                      @default(5)
  preferredSessionLength  Int                      @default(30) // in minutes
  preferredDifficulty     DifficultyPreference     @default(PROGRESSIVE)
  
  // Goals and Focus Areas
  careerGoals             String[]
  focusSkillIds           String[]                 @db.Uuid
  excludedSkillIds        String[]                 @db.Uuid
  priorityCategories      String[]
  
  // ML Model Data
  learningVelocity        Float                    @default(1.0) // How fast user learns (1.0 = average)
  engagementScore         Float                    @default(0.5) // 0-1 engagement with content
  completionRate          Float                    @default(0.0) // Course completion percentage
  lastActiveAt            DateTime?
  
  // Feature Vectors (for ML recommendations)
  skillVector             Json?                    // User's skill embedding vector
  interestVector          Json?                    // User's interest embedding vector
  learningPatternVector   Json?                    // Learning behavior patterns
  
  // Metadata
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  
  // Relations
  user                    User                     @relation("UserLearningProfile", fields: [userId], references: [id], onDelete: Cascade)
  skillGaps               SkillGap[]
  marketActivitySignals   MarketActivitySignal[]
  learningRecommendations LearningRecommendation[]
  learningPaths           UserLearningPath[]
  
  @@index([userId])
  @@index([lastActiveAt])
  @@index([experienceLevel])
  @@map("user_learning_profiles")
}

// Detected skill gaps from market activity analysis
model SkillGap {
  id                      String                   @id @default(uuid()) @db.Uuid
  learningProfileId       String                   @db.Uuid
  skillId                 String                   @db.Uuid
  
  // Gap Analysis
  gapType                 GapType
  currentLevel            ProficiencyLevel?
  requiredLevel           ProficiencyLevel
  gapScore                Float                    // 0-1 normalized gap severity
  
  // Market Context
  marketDemandScore       Float                    @default(0.0) // 0-1 how in-demand is this skill
  salaryImpact            Float?                   // Estimated salary increase potential
  competitionLevel        CompetitionLevel         @default(MEDIUM)
  jobFrequency            Int                      @default(0)   // How often seen in job searches
  
  // Priority and Status
  priority                GapPriority              @default(MEDIUM)
  priorityScore           Float                    @default(0.5) // Calculated priority score
  status                  GapStatus                @default(ACTIVE)
  
  // Source Tracking
  sourceEventIds          String[]                 @db.Uuid
  detectionMethod         String                   // 'job_match_failure', 'application_rejection', 'market_trend', etc.
  firstDetectedAt         DateTime                 @default(now())
  lastConfirmedAt         DateTime                 @default(now())
  
  // Resolution Tracking
  resolvedAt              DateTime?
  resolutionMethod        String?                  // 'course_completed', 'certification_earned', 'user_dismissed'
  
  // Metadata
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  
  // Relations
  learningProfile         UserLearningProfile      @relation(fields: [learningProfileId], references: [id], onDelete: Cascade)
  skill                   Skill                    @relation("SkillGaps", fields: [skillId], references: [id], onDelete: Cascade)
  recommendations         LearningRecommendation[] @relation("GapRecommendations")
  
  @@unique([learningProfileId, skillId])
  @@index([learningProfileId])
  @@index([skillId])
  @@index([priority])
  @@index([status])
  @@index([marketDemandScore])
  @@map("skill_gaps")
}

// Market activity signals from job views, applications, and feedback
model MarketActivitySignal {
  id                      String                   @id @default(uuid()) @db.Uuid
  learningProfileId       String                   @db.Uuid
  
  // Signal Details
  signalType              SignalType
  signalSource            String                   // 'job_view', 'job_application', 'contract', etc.
  signalStrength          Float                    @default(1.0) // Weight/importance of signal
  
  // Source References
  sourceId                String?                  @db.Uuid
  sourceType              String?                  // 'job', 'project', 'contract', 'profile'
  
  // Extracted Data
  skillIds                String[]                 @db.Uuid
  requiredLevels          Json?                    // Map of skillId -> required level
  contextData             Json?                    // Additional context from source
  
  // Analysis Results
  skillGapIndicators      Json?                    // Detected gap indicators
  competitorInsights      Json?                    // Competitor analysis data
  marketTrendData         Json?                    // Related market trends
  
  // Processing Status
  processed               Boolean                  @default(false)
  processedAt             DateTime?
  processingResult        Json?
  
  // Decay and Validity
  expiresAt               DateTime?
  decayFactor             Float                    @default(1.0) // Signal strength decay over time
  
  // Metadata
  createdAt               DateTime                 @default(now())
  
  // Relations
  learningProfile         UserLearningProfile      @relation(fields: [learningProfileId], references: [id], onDelete: Cascade)
  
  @@index([learningProfileId])
  @@index([signalType])
  @@index([processed])
  @@index([createdAt])
  @@index([expiresAt])
  @@map("market_activity_signals")
}

// Generated learning recommendations
model LearningRecommendation {
  id                      String                   @id @default(uuid()) @db.Uuid
  learningProfileId       String                   @db.Uuid
  
  // Recommendation Details
  recommendationType      LearningRecommendationType
  contentType             ContentType
  title                   String
  description             String?
  
  // Content Reference
  contentId               String?                  @db.Uuid
  contentSource           String                   // 'skillpod', 'external', 'ai_generated'
  contentUrl              String?
  contentProvider         String?
  
  // Target Skills
  primarySkillId          String?                  @db.Uuid
  relatedSkillIds         String[]                 @db.Uuid
  targetLevel             ProficiencyLevel?
  
  // Scoring
  relevanceScore          Float                    @default(0.0) // How relevant to user
  urgencyScore            Float                    @default(0.0) // Time-sensitive importance
  impactScore             Float                    @default(0.0) // Potential career impact
  confidenceScore         Float                    @default(0.0) // ML model confidence
  overallScore            Float                    @default(0.0) // Combined weighted score
  
  // Generation Context
  generationMethod        String                   // 'ml_model', 'rule_based', 'hybrid'
  generationModel         String?                  // Model version/name used
  triggerEventId          String?                  @db.Uuid
  skillGapId              String?                  @db.Uuid
  reasoningExplanation    String?                  // Human-readable explanation
  
  // Estimated Effort
  estimatedDuration       Int?                     // In minutes
  estimatedDifficulty     ProficiencyLevel?
  prerequisites           String[]                 @db.Uuid
  
  // User Interaction
  status                  LearningRecommendationStatus @default(PENDING)
  viewedAt                DateTime?
  startedAt               DateTime?
  completedAt             DateTime?
  dismissedAt             DateTime?
  dismissReason           String?
  userFeedback            Int?                     // 1-5 rating
  userFeedbackText        String?
  
  // Expiration
  expiresAt               DateTime?
  
  // Metadata
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  
  // Relations
  learningProfile         UserLearningProfile      @relation(fields: [learningProfileId], references: [id], onDelete: Cascade)
  primarySkill            Skill?                   @relation("RecommendationPrimarySkill", fields: [primarySkillId], references: [id], onDelete: SetNull)
  skillGap                SkillGap?                @relation("GapRecommendations", fields: [skillGapId], references: [id], onDelete: SetNull)
  
  @@index([learningProfileId])
  @@index([status])
  @@index([recommendationType])
  @@index([overallScore])
  @@index([createdAt])
  @@index([expiresAt])
  @@map("learning_recommendations")
}

// Personalized learning paths
model UserLearningPath {
  id                      String                   @id @default(uuid()) @db.Uuid
  learningProfileId       String                   @db.Uuid
  
  // Path Details
  title                   String
  description             String?
  pathType                LearningPathType
  
  // Target Outcome
  targetRole              String?
  targetSkillIds          String[]                 @db.Uuid
  targetLevels            Json?                    // Map of skillId -> target level
  estimatedCareerImpact   String?
  
  // Generation Info
  generatedBy             LearningPathGenerationSource
  generationContext       Json?                    // Context used for generation
  
  // Path Structure
  milestones              Json                     // Array of milestone objects
  totalDuration           Int?                     // Estimated total minutes
  totalItems              Int                      @default(0)
  
  // Progress Tracking
  status                  LearningPathStatus       @default(ACTIVE)
  currentMilestoneIndex   Int                      @default(0)
  completedItems          Int                      @default(0)
  progressPercentage      Float                    @default(0.0)
  lastActivityAt          DateTime?
  
  // Completion
  startedAt               DateTime?
  completedAt             DateTime?
  abandonedAt             DateTime?
  
  // User Interaction
  isPinned                Boolean                  @default(false)
  userNotes               String?
  
  // Metadata
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  
  // Relations
  learningProfile         UserLearningProfile      @relation(fields: [learningProfileId], references: [id], onDelete: Cascade)
  
  @@index([learningProfileId])
  @@index([status])
  @@index([pathType])
  @@index([createdAt])
  @@map("user_learning_paths")
}

// Market trend analysis for skills
model MarketTrend {
  id                      String                   @id @default(uuid()) @db.Uuid
  skillId                 String                   @db.Uuid
  
  // Trend Identification
  trendPeriod             TrendPeriod
  periodStart             DateTime
  periodEnd               DateTime
  
  // Demand Metrics
  demandScore             Float                    // 0-1 overall demand
  demandDirection         TrendDirection
  demandChangePercent     Float                    @default(0.0)
  jobPostingCount         Int                      @default(0)
  applicationCount        Int                      @default(0)
  
  // Rate Metrics
  averageRate             Float?
  rateDirection           TrendDirection?
  rateChangePercent       Float                    @default(0.0)
  ratePercentile25        Float?
  ratePercentile50        Float?
  ratePercentile75        Float?
  
  // Competition Metrics
  competitionLevel        CompetitionLevel         @default(MEDIUM)
  freelancerSupply        Int                      @default(0)
  supplyDemandRatio       Float?
  
  // Geographic Data
  region                  String?                  // null = global
  topLocations            String[]
  
  // Industry Data
  industry                String?                  // null = all industries
  topIndustries           String[]
  
  // Related Skills
  emergingCombinations    String[]                 @db.Uuid // Skills often paired with this one
  decliningCombinations   String[]                 @db.Uuid
  
  // Predictions
  predictedDemand6Mo      Float?
  predictedDemand12Mo     Float?
  predictionConfidence    Float?
  
  // Source Data
  dataPoints              Int                      @default(0)
  dataSources             String[]
  
  // Metadata
  calculatedAt            DateTime                 @default(now())
  createdAt               DateTime                 @default(now())
  
  // Relations
  skill                   Skill                    @relation("SkillMarketTrends", fields: [skillId], references: [id], onDelete: Cascade)
  
  @@unique([skillId, trendPeriod, periodStart, region, industry])
  @@index([skillId])
  @@index([trendPeriod])
  @@index([periodStart])
  @@index([demandScore])
  @@index([demandDirection])
  @@map("market_trends")
}

// =============================================================================
// LEARNING RECOMMENDATION ENUMS
// =============================================================================

enum ContentType {
  COURSE
  TUTORIAL
  VIDEO
  ARTICLE
  BOOK
  PODCAST
  PROJECT
  CERTIFICATION
  ASSESSMENT
  WORKSHOP
  BOOTCAMP
  MENTORSHIP
}

enum LearningStyle {
  SELF_PACED
  INSTRUCTOR_LED
  PROJECT_BASED
  INTERACTIVE
  MIXED
}

enum DifficultyPreference {
  EASY
  PROGRESSIVE
  CHALLENGING
}

enum GapType {
  MISSING_SKILL
  LEVEL_GAP
  OUTDATED_SKILL
  TRENDING_SKILL
  COMPETITIVE_ADVANTAGE
}

enum GapPriority {
  CRITICAL
  HIGH
  MEDIUM
  LOW
  OPTIONAL
}

enum GapStatus {
  ACTIVE
  IN_PROGRESS
  RESOLVED
  DISMISSED
  EXPIRED
}

enum SignalType {
  JOB_VIEW
  JOB_APPLICATION
  JOB_REJECTION
  JOB_ACCEPTANCE
  CONTRACT_STARTED
  CONTRACT_COMPLETED
  CLIENT_FEEDBACK
  SKILL_SEARCH
  PROFILE_GAP
  COMPETITOR_ANALYSIS
  MARKET_TREND
  CERTIFICATION_REQUIRED
}

enum LearningRecommendationType {
  SKILL_GAP_FILL
  CAREER_ADVANCEMENT
  MARKET_DEMAND
  TRENDING_SKILL
  CERTIFICATION
  REFRESH_KNOWLEDGE
  COMPETITIVE_EDGE
  PREREQUISITE
  QUICK_WIN
  DEEP_DIVE
}

enum LearningRecommendationStatus {
  PENDING
  VIEWED
  STARTED
  IN_PROGRESS
  COMPLETED
  DISMISSED
  EXPIRED
}

enum LearningPathType {
  SKILL_MASTERY
  ROLE_TRANSITION
  CERTIFICATION_TRACK
  MARKET_ALIGNMENT
  CUSTOM
}

enum LearningPathGenerationSource {
  SYSTEM_RECOMMENDED
  USER_CREATED
  ML_GENERATED
  CURATOR_CREATED
}

enum LearningPathStatus {
  ACTIVE
  PAUSED
  COMPLETED
  ABANDONED
}

enum TrendDirection {
  RISING
  STABLE
  DECLINING
}

enum TrendPeriod {
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}

enum CompetitionLevel {
  LOW
  MEDIUM
  HIGH
  VERY_HIGH
}

// ============================================================================
// SKILL-BASED PRICING RECOMMENDATIONS
// ============================================================================

model SkillRate {
  id                   String           @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId               String           @map("user_id") @db.Uuid
  skillId              String           @map("skill_id")
  skillName            String           @map("skill_name")

  // Current rate
  currentHourlyRate    Decimal?         @map("current_hourly_rate") @db.Decimal(10, 2)
  currentProjectRate   Decimal?         @map("current_project_rate") @db.Decimal(14, 2)
  currency             String           @default("USD")

  // Recommended rates
  recommendedMinRate     Decimal?       @map("recommended_min_rate") @db.Decimal(10, 2)
  recommendedOptimalRate Decimal?       @map("recommended_optimal_rate") @db.Decimal(10, 2)
  recommendedMaxRate     Decimal?       @map("recommended_max_rate") @db.Decimal(10, 2)

  // Confidence
  confidenceScore      Decimal          @map("confidence_score") @db.Decimal(5, 2) // 0-100

  // Factors
  skillLevel           String?          @map("skill_level")
  verificationScore    Decimal?         @map("verification_score") @db.Decimal(5, 2)
  experienceYears      Decimal?         @map("experience_years") @db.Decimal(4, 1)
  projectsCompleted    Int?             @map("projects_completed")
  avgClientRating      Decimal?         @map("avg_client_rating") @db.Decimal(3, 2)

  // Market context
  marketPosition       MarketPosition   @default(AVERAGE) @map("market_position")
  marketDemand         MarketDemand     @default(MODERATE) @map("market_demand")
  competitionLevel     CompetitionLevel @default(MEDIUM) @map("competition_level")

  // Last calculation
  calculatedAt         DateTime         @map("calculated_at")
  validUntil           DateTime         @map("valid_until")

  createdAt            DateTime         @default(now()) @map("created_at")
  updatedAt            DateTime         @updatedAt @map("updated_at")

  user                 User             @relation(fields: [userId], references: [id])

  @@unique([userId, skillId])
  @@index([userId])
  @@index([skillId])
  @@map("skill_rates")
}

model MarketRateBenchmark {
  id                String         @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid

  // Scope
  skillId           String         @map("skill_id")
  skillName         String         @map("skill_name")
  category          String?
  region            String?        // 'GLOBAL', 'US', 'EU', etc.

  // Rate distribution
  rateP10           Decimal        @map("rate_p10") @db.Decimal(10, 2) // 10th percentile
  rateP25           Decimal        @map("rate_p25") @db.Decimal(10, 2)
  rateP50           Decimal        @map("rate_p50") @db.Decimal(10, 2) // Median
  rateP75           Decimal        @map("rate_p75") @db.Decimal(10, 2)
  rateP90           Decimal        @map("rate_p90") @db.Decimal(10, 2)
  rateMean          Decimal        @map("rate_mean") @db.Decimal(10, 2)

  // By experience level
  beginnerRate      Decimal?       @map("beginner_rate") @db.Decimal(10, 2)
  intermediateRate  Decimal?       @map("intermediate_rate") @db.Decimal(10, 2)
  advancedRate      Decimal?       @map("advanced_rate") @db.Decimal(10, 2)
  expertRate        Decimal?       @map("expert_rate") @db.Decimal(10, 2)

  // Market metrics
  sampleSize        Int            @map("sample_size")
  jobCount          Int            @map("job_count")
  freelancerCount   Int            @map("freelancer_count")
  demandScore       Decimal        @map("demand_score") @db.Decimal(5, 2)

  // Trends
  rateChangeMonthly Decimal?       @map("rate_change_monthly") @db.Decimal(6, 2)
  rateChangeYearly  Decimal?       @map("rate_change_yearly") @db.Decimal(6, 2)
  trendDirection    TrendDirection @default(STABLE) @map("trend_direction")

  // Data sources
  sources           String[]       // ['market', 'upwork', 'fiverr', 'glassdoor']

  // Period
  periodStart       DateTime       @map("period_start") @db.Date
  periodEnd         DateTime       @map("period_end") @db.Date

  generatedAt       DateTime       @map("generated_at")

  @@unique([skillId, region, periodStart])
  @@index([skillId])
  @@index([category])
  @@index([periodStart])
  @@map("market_rate_benchmarks")
}

model PricingRecommendation {
  id                     String                    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId                 String                    @map("user_id") @db.Uuid

  // Recommendation type
  recommendationType     PricingRecommendationType @map("recommendation_type")

  // Scope
  scope                  RecommendationScope
  skillId                String?                   @map("skill_id")
  skillName              String?                   @map("skill_name")
  projectType            String?                   @map("project_type")

  // Current vs Recommended
  currentRate            Decimal?                  @map("current_rate") @db.Decimal(10, 2)
  recommendedRate        Decimal                   @map("recommended_rate") @db.Decimal(10, 2)
  rateChange             Decimal                   @map("rate_change") @db.Decimal(10, 2)
  rateChangePercent      Decimal                   @map("rate_change_percent") @db.Decimal(6, 2)

  // Impact projection
  projectedMonthlyImpact Decimal?                  @map("projected_monthly_impact") @db.Decimal(14, 2)
  projectedYearlyImpact  Decimal?                  @map("projected_yearly_impact") @db.Decimal(14, 2)

  // Confidence and reasoning
  confidenceScore        Decimal                   @map("confidence_score") @db.Decimal(5, 2)
  reasoning              Json                      // Factors that led to this recommendation

  // Supporting data
  marketPosition         MarketPosition            @map("market_position")
  competitorAnalysis     Json?                     @map("competitor_analysis")

  // Status
  status                 RecommendationStatus      @default(PENDING)
  viewedAt               DateTime?                 @map("viewed_at")
  appliedAt              DateTime?                 @map("applied_at")
  dismissedAt            DateTime?                 @map("dismissed_at")
  dismissReason          String?                   @map("dismiss_reason")

  // Validity
  validFrom              DateTime                  @map("valid_from")
  validUntil             DateTime                  @map("valid_until")

  createdAt              DateTime                  @default(now()) @map("created_at")

  user                   User                      @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([validUntil])
  @@map("pricing_recommendations")
}

model RateHistory {
  id             String     @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId         String     @map("user_id") @db.Uuid

  // Scope
  skillId        String?    @map("skill_id")
  skillName      String?    @map("skill_name")

  // Rate
  hourlyRate     Decimal    @map("hourly_rate") @db.Decimal(10, 2)
  currency       String     @default("USD")

  // Context
  source         RateSource @default(MANUAL)
  projectId      String?    @map("project_id") @db.Uuid
  contractId     String?    @map("contract_id")

  // Outcome (if from completed project)
  clientRating   Decimal?   @map("client_rating") @db.Decimal(3, 2)
  projectSuccess Boolean?   @map("project_success")
  repeatClient   Boolean?   @map("repeat_client")

  effectiveDate  DateTime   @map("effective_date") @db.Date

  createdAt      DateTime   @default(now()) @map("created_at")

  user           User       @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([skillId])
  @@index([effectiveDate])
  @@map("rate_history")
}

model RevenueProjection {
  id               String       @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId           String       @map("user_id") @db.Uuid

  // Scenario
  scenarioName     String       @map("scenario_name")
  scenarioType     ScenarioType @map("scenario_type")

  // Rate assumptions
  hourlyRate       Decimal      @map("hourly_rate") @db.Decimal(10, 2)
  hoursPerWeek     Decimal      @map("hours_per_week") @db.Decimal(5, 2)
  weeksPerYear     Decimal      @default(48) @map("weeks_per_year") @db.Decimal(5, 2)
  utilizationRate  Decimal      @default(75) @map("utilization_rate") @db.Decimal(5, 2) // % of hours that are billable

  // Projections
  weeklyRevenue    Decimal      @map("weekly_revenue") @db.Decimal(14, 2)
  monthlyRevenue   Decimal      @map("monthly_revenue") @db.Decimal(14, 2)
  yearlyRevenue    Decimal      @map("yearly_revenue") @db.Decimal(14, 2)

  // Expenses (optional)
  monthlyExpenses  Decimal?     @map("monthly_expenses") @db.Decimal(14, 2)
  yearlyExpenses   Decimal?     @map("yearly_expenses") @db.Decimal(14, 2)

  // Net
  monthlyNetIncome Decimal?     @map("monthly_net_income") @db.Decimal(14, 2)
  yearlyNetIncome  Decimal?     @map("yearly_net_income") @db.Decimal(14, 2)

  // Comparison to current
  vsCurrentMonthly Decimal?     @map("vs_current_monthly") @db.Decimal(14, 2)
  vsCurrentYearly  Decimal?     @map("vs_current_yearly") @db.Decimal(14, 2)

  isActive         Boolean      @default(false) @map("is_active")

  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")

  user             User         @relation(fields: [userId], references: [id])

  @@index([userId])
  @@map("revenue_projections")
}

// Pricing Enums
enum MarketPosition {
  BUDGET
  BELOW_AVERAGE
  AVERAGE
  ABOVE_AVERAGE
  PREMIUM
  TOP_TIER
}

enum MarketDemand {
  LOW
  MODERATE
  HIGH
  VERY_HIGH
}

enum PricingRecommendationType {
  RATE_INCREASE
  RATE_DECREASE
  SKILL_PREMIUM
  MARKET_ADJUSTMENT
  EXPERIENCE_UPGRADE
  CERTIFICATION_PREMIUM
  DEMAND_BASED
}

enum RecommendationScope {
  GLOBAL       // Overall rate
  SKILL        // Specific skill
  PROJECT_TYPE // Type of project
  CLIENT_TIER  // Client segment
}

enum RecommendationStatus {
  PENDING
  VIEWED
  APPLIED
  DISMISSED
  EXPIRED
}

enum RateSource {
  MANUAL
  PROJECT
  CONTRACT
  PROFILE
  RECOMMENDATION
}

enum ScenarioType {
  CURRENT
  CONSERVATIVE
  MODERATE
  AGGRESSIVE
  CUSTOM
}

