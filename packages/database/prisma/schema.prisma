// ============================================================================
// Skillancer Database Schema
// Multi-tenant SaaS platform for freelancers and clients
// ============================================================================

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearch", "postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [uuid_ossp(map: "uuid-ossp"), pg_trgm]
}

// ============================================================================
// USER & AUTHENTICATION
// ============================================================================

model User {
  id                String            @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  email             String            @unique @db.VarChar(255)
  passwordHash      String?           @map("password_hash") @db.VarChar(255)
  firstName         String            @map("first_name") @db.VarChar(100)
  lastName          String            @map("last_name") @db.VarChar(100)
  displayName       String?           @map("display_name") @db.VarChar(200)
  avatarUrl         String?           @map("avatar_url") @db.VarChar(500)
  bio               String?           @db.Text
  status            UserStatus        @default(PENDING_VERIFICATION)
  verificationLevel VerificationLevel @default(NONE)
  timezone          String            @default("UTC") @db.VarChar(50)
  locale            String            @default("en") @db.VarChar(10)

  // OAuth fields
  oauthProvider String? @map("oauth_provider") @db.VarChar(50)
  oauthId       String? @map("oauth_id") @db.VarChar(255)

  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")
  lastLoginAt DateTime? @map("last_login_at")

  // Relations
  tenantMemberships     TenantMember[]
  jobsPosted            Job[]                      @relation("ClientJobs")
  bids                  Bid[]
  contractsAsClient     Contract[]                 @relation("ClientContracts")
  contractsAsFreelancer Contract[]                 @relation("FreelancerContracts")
  services              Service[]
  sessions              Session[]
  messagesSent          Message[]                  @relation("SenderMessages")
  messagesReceived      Message[]                  @relation("ReceiverMessages")
  reviewsGiven          Review[]                   @relation("ReviewerReviews")
  reviewsReceived       Review[]                   @relation("RevieweeReviews")
  reviewHelpfulVotes    ReviewHelpfulVote[]
  reviewReports         ReviewReport[]
  reviewInvitations     ReviewInvitation[]
  ratingAggregation     UserRatingAggregation?
  trustScore            TrustScore?
  complianceRecords     SkillPodComplianceRecord[]
  skills                UserSkill[]
  portfolioItems        PortfolioItem[]
  paymentMethods        PaymentMethod[]
  subscriptions         Subscription[]
  stripeCustomer        StripeCustomer?
  notifications         Notification[]
  refreshTokens         RefreshToken[]
  auditLogs             AuditLog[]                 @relation("UserAuditLogs")
  mfa                   UserMfa?
  profile               UserProfile?
  UserBadge             UserBadge[]
  payoutAccount         PayoutAccount?
  paymentTransactions   PaymentTransaction[]
  phiAccessLogs         PhiAccessLog[]
  hipaaTrainings        HipaaTraining[]
  dataTransferAttempts  DataTransferAttempt[]
  screenCaptureAttempts ScreenCaptureAttempt[]
  
  // Session recording
  recordings            SessionRecording[]
  recordingAccessLogs   RecordingAccessLog[]
  
  // Environment management
  pods                  Pod[]
  templateRatings       TemplateRating[]
  
  // Project invitations
  invitationsSent       ProjectInvitation[]        @relation("InvitationsSent")
  invitationsReceived   ProjectInvitation[]        @relation("InvitationsReceived")
  
  // Project questions
  questionsAsked        ProjectQuestion[]          @relation("QuestionAsker")

  @@unique([oauthProvider, oauthId])
  @@index([email])
  @@index([status])
  @@index([deletedAt])
  @@index([createdAt])
  @@map("users")
}

enum UserStatus {
  PENDING_VERIFICATION
  ACTIVE
  INACTIVE
  SUSPENDED
  BANNED
}

enum VerificationLevel {
  NONE
  EMAIL
  BASIC
  ENHANCED
  PREMIUM
}

// ============================================================================
// MULTI-FACTOR AUTHENTICATION
// ============================================================================

enum MfaMethod {
  TOTP
  SMS
  EMAIL
  RECOVERY_CODE
}

model UserMfa {
  id            String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId        String    @unique @map("user_id") @db.Uuid
  enabled       Boolean   @default(false)
  primaryMethod MfaMethod @default(TOTP) @map("primary_method")

  // TOTP
  totpSecret   String? @map("totp_secret") @db.VarChar(500) // Encrypted
  totpVerified Boolean @default(false) @map("totp_verified")

  // SMS
  phoneNumber   String? @map("phone_number") @db.VarChar(20)
  phoneVerified Boolean @default(false) @map("phone_verified")

  // Recovery codes (hashed)
  recoveryCodes            String[]  @map("recovery_codes")
  recoveryCodesGeneratedAt DateTime? @map("recovery_codes_generated_at")
  recoveryCodesUsedCount   Int       @default(0) @map("recovery_codes_used_count")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_mfa")
}

model MfaChallenge {
  id        String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  sessionId String    @map("session_id") @db.VarChar(100)
  method    MfaMethod
  code      String?   @db.VarChar(100) // Hashed, for email/SMS codes
  attempts  Int       @default(0)
  verified  Boolean   @default(false)
  expiresAt DateTime  @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")

  @@index([userId, sessionId])
  @@index([expiresAt])
  @@map("mfa_challenges")
}

// ============================================================================
// USER PROFILE
// ============================================================================

model UserProfile {
  id       String  @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId   String  @unique @map("user_id") @db.Uuid
  username String? @unique @db.VarChar(30) // For public URL (skillancer.com/@username)

  // Professional
  title           String?  @db.VarChar(200)
  bio             String?  @db.Text
  hourlyRate      Decimal? @map("hourly_rate") @db.Decimal(10, 2)
  currency        String   @default("USD") @db.VarChar(3)
  yearsExperience Int?     @map("years_experience")

  // Avatar (multiple sizes for performance)
  avatarOriginal  String? @map("avatar_original") @db.VarChar(500)
  avatarThumbnail String? @map("avatar_thumbnail") @db.VarChar(500) // 64x64
  avatarSmall     String? @map("avatar_small") @db.VarChar(500) // 128x128
  avatarMedium    String? @map("avatar_medium") @db.VarChar(500) // 256x256
  avatarLarge     String? @map("avatar_large") @db.VarChar(500) // 512x512

  // Social Links
  linkedinUrl  String? @map("linkedin_url") @db.VarChar(500)
  githubUrl    String? @map("github_url") @db.VarChar(500)
  portfolioUrl String? @map("portfolio_url") @db.VarChar(500)
  twitterUrl   String? @map("twitter_url") @db.VarChar(500)

  // Location
  country String? @db.VarChar(2) // ISO 3166-1 alpha-2
  city    String? @db.VarChar(100)

  // Visibility Settings
  isPublic     Boolean @default(false) @map("is_public")
  showEmail    Boolean @default(false) @map("show_email")
  showRate     Boolean @default(true) @map("show_rate")
  showLocation Boolean @default(true) @map("show_location")

  // Completeness tracking
  completenessScore Int @default(0) @map("completeness_score")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([username])
  @@index([isPublic])
  @@index([country])
  @@index([hourlyRate])
  @@map("user_profiles")
}

model RefreshToken {
  id        String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  token     String    @unique @db.VarChar(500)
  userId    String    @map("user_id") @db.Uuid
  expiresAt DateTime  @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")
  revokedAt DateTime? @map("revoked_at")
  userAgent String?   @map("user_agent") @db.VarChar(500)
  ipAddress String?   @map("ip_address") @db.VarChar(45)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model UserSkill {
  id        String     @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId    String     @map("user_id") @db.Uuid
  skillId   String     @map("skill_id") @db.Uuid
  level     SkillLevel @default(INTERMEDIATE)
  yearsExp  Int?       @map("years_exp")
  verified  Boolean    @default(false)
  isPrimary Boolean    @default(false) @map("is_primary")
  sortOrder Int        @default(0) @map("sort_order")
  createdAt DateTime   @default(now()) @map("created_at")

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  skill Skill @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@unique([userId, skillId])
  @@index([userId, sortOrder])
  @@map("user_skills")
}

enum SkillLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

model Skill {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name        String   @unique @db.VarChar(100)
  slug        String   @unique @db.VarChar(100)
  category    String   @db.VarChar(100)
  description String?  @db.Text
  isCustom    Boolean  @default(false) @map("is_custom")
  createdById String?  @map("created_by_id") @db.Uuid
  isApproved  Boolean  @default(true) @map("is_approved")
  createdAt   DateTime @default(now()) @map("created_at")

  userSkills    UserSkill[]
  jobSkills     JobSkill[]
  serviceSkills ServiceSkill[]

  @@index([category])
  @@index([slug])
  @@index([isCustom])
  @@map("skills")
}

model PortfolioItem {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  title       String   @db.VarChar(200)
  description String?  @db.Text
  imageUrl    String?  @map("image_url") @db.VarChar(500)
  projectUrl  String?  @map("project_url") @db.VarChar(500)
  tags        String[] @default([])
  featured    Boolean  @default(false)
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("portfolio_items")
}

// ============================================================================
// MULTI-TENANCY
// ============================================================================

model Tenant {
  id          String     @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name        String     @db.VarChar(200)
  slug        String     @unique @db.VarChar(100)
  description String?    @db.Text
  logoUrl     String?    @map("logo_url") @db.VarChar(500)
  website     String?    @db.VarChar(500)
  plan        TenantPlan @default(FREE)
  settings    Json       @default("{}")
  metadata    Json       @default("{}")

  // Billing
  stripeCustomerId     String? @unique @map("stripe_customer_id") @db.VarChar(100)
  stripeSubscriptionId String? @map("stripe_subscription_id") @db.VarChar(100)

  // Timestamps
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  members         TenantMember[]
  jobs            Job[]
  sessions        Session[]
  invoices        Invoice[]
  subscriptions   Subscription[]
  hipaaCompliance HipaaCompliance?
  breachIncidents BreachIncident[]
  
  // Data containment relations
  podSecurityPolicies      PodSecurityPolicy[]
  securityViolations       SecurityViolation[]
  fileTransferRequests     FileTransferRequest[]
  containmentAuditLogs     ContainmentAuditLog[]
  dataTransferAttempts     DataTransferAttempt[]
  screenCaptureAttempts    ScreenCaptureAttempt[]
  transferOverrideRequests TransferOverrideRequest[]
  
  // Session recording
  recordings               SessionRecording[]
  retentionPolicies        RecordingRetentionPolicy[]
  
  // Watermarking
  watermarkConfigurations  WatermarkConfiguration[]
  
  // Environment management
  podTemplates             PodTemplate[]
  pods                     Pod[]
  resourcePools            ResourcePool[]
  resourceQuota            TenantResourceQuota?

  @@index([slug])
  @@index([plan])
  @@index([deletedAt])
  @@map("tenants")
}

model TenantMember {
  id        String     @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId  String     @map("tenant_id") @db.Uuid
  userId    String     @map("user_id") @db.Uuid
  role      TenantRole @default(MEMBER)
  invitedBy String?    @map("invited_by") @db.Uuid
  joinedAt  DateTime   @default(now()) @map("joined_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tenantId, userId])
  @@index([userId])
  @@map("tenant_members")
}

enum TenantPlan {
  FREE
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

enum TenantRole {
  OWNER
  ADMIN
  MANAGER
  MEMBER
}

// ============================================================================
// JOBS & MARKETPLACE
// ============================================================================

model Job {
  id          String        @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  clientId    String        @map("client_id") @db.Uuid
  tenantId    String?       @map("tenant_id") @db.Uuid
  title       String        @db.VarChar(200)
  description String        @db.Text
  slug        String        @unique @db.VarChar(250)
  status      JobStatus     @default(DRAFT)
  visibility  JobVisibility @default(PUBLIC)

  // Budget
  budgetType BudgetType @default(FIXED) @map("budget_type")
  budgetMin  Decimal?   @map("budget_min") @db.Decimal(12, 2)
  budgetMax  Decimal?   @map("budget_max") @db.Decimal(12, 2)
  currency   String     @default("USD") @db.VarChar(3)

  // Duration & Location
  duration        JobDuration?
  experienceLevel ExperienceLevel @default(INTERMEDIATE) @map("experience_level")
  location        String?         @db.VarChar(200)
  isRemote        Boolean         @default(true) @map("is_remote")

  // Content
  attachments Json     @default("[]")
  tags        String[] @default([])

  // Timestamps
  publishedAt DateTime? @map("published_at")
  expiresAt   DateTime? @map("expires_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  // Relations
  client      User               @relation("ClientJobs", fields: [clientId], references: [id])
  tenant      Tenant?            @relation(fields: [tenantId], references: [id])
  bids        Bid[]
  contracts   Contract[]
  skills      JobSkill[]
  messages    Message[]          @relation("JobMessages")
  invitations ProjectInvitation[]
  questions   ProjectQuestion[]

  @@index([clientId])
  @@index([tenantId])
  @@index([status])
  @@index([publishedAt])
  @@index([deletedAt])
  @@index([slug])
  @@map("jobs")
}

model JobSkill {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  jobId     String   @map("job_id") @db.Uuid
  skillId   String   @map("skill_id") @db.Uuid
  required  Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")

  job   Job   @relation(fields: [jobId], references: [id], onDelete: Cascade)
  skill Skill @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@unique([jobId, skillId])
  @@map("job_skills")
}

enum JobStatus {
  DRAFT
  PENDING_REVIEW
  PUBLISHED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  EXPIRED
}

enum JobVisibility {
  PUBLIC
  PRIVATE
  INVITE_ONLY
}

enum BudgetType {
  FIXED
  HOURLY
  MONTHLY
}

enum JobDuration {
  LESS_THAN_WEEK
  ONE_TO_TWO_WEEKS
  TWO_TO_FOUR_WEEKS
  ONE_TO_THREE_MONTHS
  THREE_TO_SIX_MONTHS
  MORE_THAN_SIX_MONTHS
}

enum ExperienceLevel {
  ENTRY
  INTERMEDIATE
  EXPERT
}

// ============================================================================
// BIDS & PROJECT BIDDING SYSTEM
// ============================================================================

model Bid {
  id           String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  jobId        String    @map("job_id") @db.Uuid
  freelancerId String    @map("freelancer_id") @db.Uuid
  status       BidStatus @default(PENDING)
  bidType      BidType   @default(STANDARD) @map("bid_type")

  // Proposal
  coverLetter  String     @map("cover_letter") @db.Text
  proposedRate Decimal    @map("proposed_rate") @db.Decimal(12, 2)
  rateType     BudgetType @default(FIXED) @map("rate_type")
  deliveryDays Int?       @map("delivery_days")
  attachments  Json       @default("[]")

  // Milestones proposal
  proposedMilestones Json? @map("proposed_milestones")
  // [{ title: string, description: string, amount: number, deliveryDays: number }]

  // Bid quality scoring (anti-spam)
  qualityScore       Int?      @map("quality_score") // 0-100
  qualityFactors     Json?     @map("quality_factors")
  // { relevance: 85, completeness: 90, uniqueness: 70, profileStrength: 95 }
  isSpam             Boolean   @default(false) @map("is_spam")
  spamReason         String?   @map("spam_reason") @db.VarChar(500)

  // Visibility & boosting
  isBoosted          Boolean   @default(false) @map("is_boosted")
  boostedAt          DateTime? @map("boosted_at")
  boostExpiresAt     DateTime? @map("boost_expires_at")

  // Client interaction tracking
  viewedByClientAt   DateTime? @map("viewed_by_client_at")
  shortlistedAt      DateTime? @map("shortlisted_at")
  interviewRequestedAt DateTime? @map("interview_requested_at")
  rejectedAt         DateTime? @map("rejected_at")
  rejectionReason    String?   @map("rejection_reason") @db.Text

  // Interview scheduling
  interviewScheduledAt DateTime? @map("interview_scheduled_at")
  interviewNotes     String?   @map("interview_notes") @db.Text

  // Timestamps
  submittedAt DateTime  @default(now()) @map("submitted_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  withdrawnAt DateTime? @map("withdrawn_at")

  // Relations
  job        Job          @relation(fields: [jobId], references: [id], onDelete: Cascade)
  freelancer User         @relation(fields: [freelancerId], references: [id])
  contract   Contract?
  messages   BidMessage[]

  @@unique([jobId, freelancerId])
  @@index([freelancerId])
  @@index([status])
  @@index([submittedAt])
  @@index([qualityScore])
  @@index([isSpam])
  @@map("bids")
}

model BidMessage {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  bidId     String   @map("bid_id") @db.Uuid
  senderId  String   @map("sender_id") @db.Uuid
  
  // Message content
  content   String   @db.Text
  attachments Json   @default("[]")
  
  // Message type
  messageType BidMessageType @default(MESSAGE) @map("message_type")
  
  // Read tracking
  readAt    DateTime? @map("read_at")
  
  createdAt DateTime @default(now()) @map("created_at")
  
  bid       Bid      @relation(fields: [bidId], references: [id], onDelete: Cascade)
  
  @@map("bid_messages")
  @@index([bidId])
  @@index([senderId])
  @@index([createdAt])
}

model ProjectInvitation {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  jobId     String   @map("job_id") @db.Uuid
  inviterId String   @map("inviter_id") @db.Uuid // Client who sent invitation
  inviteeId String   @map("invitee_id") @db.Uuid // Freelancer being invited
  
  // Invitation details
  message   String?  @db.Text
  
  // Status
  status    InvitationStatus @default(PENDING)
  
  // Response
  responseMessage String? @map("response_message") @db.Text
  respondedAt DateTime?   @map("responded_at")
  
  // Timestamps
  sentAt    DateTime @default(now()) @map("sent_at")
  expiresAt DateTime @map("expires_at")
  viewedAt  DateTime? @map("viewed_at")
  
  createdAt DateTime @default(now()) @map("created_at")
  
  job       Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  inviter   User     @relation("InvitationsSent", fields: [inviterId], references: [id])
  invitee   User     @relation("InvitationsReceived", fields: [inviteeId], references: [id])
  
  @@map("project_invitations")
  @@unique([jobId, inviteeId])
  @@index([jobId])
  @@index([inviterId])
  @@index([inviteeId])
  @@index([status])
}

model ProjectQuestion {
  id         String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  jobId      String   @map("job_id") @db.Uuid
  askerId    String   @map("asker_id") @db.Uuid
  
  // Question content
  question   String   @db.Text
  isPublic   Boolean  @default(true) @map("is_public")
  isPinned   Boolean  @default(false) @map("is_pinned")
  
  // Answer (from client)
  answer     String?  @db.Text
  answeredAt DateTime? @map("answered_at")
  answeredBy String?  @map("answered_by") @db.Uuid
  
  // Moderation
  isHidden   Boolean  @default(false) @map("is_hidden")
  hiddenReason String? @map("hidden_reason") @db.VarChar(500)
  
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")
  
  job        Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  asker      User     @relation("QuestionAsker", fields: [askerId], references: [id])
  
  @@map("project_questions")
  @@index([jobId])
  @@index([askerId])
  @@index([isPublic])
}

enum BidStatus {
  PENDING
  SHORTLISTED
  INTERVIEW_REQUESTED
  INTERVIEW_SCHEDULED
  ACCEPTED
  REJECTED
  WITHDRAWN
}

enum BidType {
  STANDARD        // Regular bid
  INVITED         // Response to project invitation
  FEATURED        // Paid featured placement
}

enum BidMessageType {
  MESSAGE          // Regular message
  INTERVIEW_REQUEST // Client requests interview
  INTERVIEW_SCHEDULED // Interview scheduled
  CLARIFICATION   // Clarification request
  COUNTER_OFFER   // Counter offer from client
  SYSTEM          // System message
}

enum InvitationStatus {
  PENDING
  VIEWED
  ACCEPTED    // Freelancer submitted bid
  DECLINED
  EXPIRED
  CANCELLED
}

// ============================================================================
// CONTRACTS
// ============================================================================

model Contract {
  id           String         @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  jobId        String         @map("job_id") @db.Uuid
  bidId        String?        @unique @map("bid_id") @db.Uuid
  clientId     String         @map("client_id") @db.Uuid
  freelancerId String         @map("freelancer_id") @db.Uuid
  status       ContractStatus @default(PENDING)

  // Terms
  title       String     @db.VarChar(200)
  description String     @db.Text
  agreedRate  Decimal    @map("agreed_rate") @db.Decimal(12, 2)
  rateType    BudgetType @default(FIXED) @map("rate_type")
  currency    String     @default("USD") @db.VarChar(3)
  totalAmount Decimal?   @map("total_amount") @db.Decimal(12, 2)

  // Escrow fees
  platformFeePercent   Decimal @default(10) @map("platform_fee_percent") @db.Decimal(5, 2)
  secureModeFeePercent Decimal? @map("secure_mode_fee_percent") @db.Decimal(5, 2)

  // SkillPod integration
  secureMode  Boolean @default(false) @map("secure_mode")
  skillpodId  String? @map("skillpod_id") @db.Uuid

  // Timeline
  startDate  DateTime? @map("start_date")
  endDate    DateTime? @map("end_date")
  deadlineAt DateTime? @map("deadline_at")

  // Contract terms and attachments
  terms       Json?    @default("{}")
  attachments String[] @default([])

  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  signedAt    DateTime? @map("signed_at")
  completedAt DateTime? @map("completed_at")
  cancelledAt DateTime? @map("cancelled_at")

  // Relations
  job                 Job                  @relation(fields: [jobId], references: [id])
  bid                 Bid?                 @relation(fields: [bidId], references: [id])
  client              User                 @relation("ClientContracts", fields: [clientId], references: [id])
  freelancer          User                 @relation("FreelancerContracts", fields: [freelancerId], references: [id])
  milestones          Milestone[]
  payments            Payment[]
  reviews             Review[]
  reviewInvitations   ReviewInvitation[]
  messages            Message[]            @relation("ContractMessages")
  escrowTransactions  EscrowTransaction[]
  escrowBalance       EscrowBalance?
  timeLogs            TimeLog[]
  disputes            Dispute[]

  @@index([clientId])
  @@index([freelancerId])
  @@index([status])
  @@index([createdAt])
  @@map("contracts")
}

enum ContractStatus {
  PENDING
  PENDING_FUNDING  // Waiting for client to fund escrow
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
  DISPUTED
}

model Milestone {
  id          String          @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  contractId  String          @map("contract_id") @db.Uuid
  title       String          @db.VarChar(200)
  description String?         @db.Text
  amount      Decimal         @db.Decimal(12, 2)
  status      MilestoneStatus @default(PENDING)
  sortOrder   Int             @default(0) @map("sort_order")

  // Deliverables
  deliverables    String?  @db.Text
  deliverableUrls String[] @default([]) @map("deliverable_urls")

  // Escrow tracking
  escrowFunded     Boolean   @default(false) @map("escrow_funded")
  escrowFundedAt   DateTime? @map("escrow_funded_at")
  escrowReleasedAt DateTime? @map("escrow_released_at")

  // Revision tracking
  revisionCount Int @default(0) @map("revision_count")
  maxRevisions  Int @default(2) @map("max_revisions")

  // Timestamps
  dueDate     DateTime? @map("due_date")
  startedAt   DateTime? @map("started_at")
  submittedAt DateTime? @map("submitted_at")
  completedAt DateTime? @map("completed_at")
  approvedAt  DateTime? @map("approved_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  contract           Contract            @relation(fields: [contractId], references: [id], onDelete: Cascade)
  payments           Payment[]
  escrowTransactions EscrowTransaction[]

  @@index([contractId])
  @@index([status])
  @@map("milestones")
}

enum MilestoneStatus {
  PENDING
  IN_PROGRESS
  SUBMITTED
  REVISION_REQUESTED
  APPROVED
  RELEASED   // Funds released
  PAID
  DISPUTED
  CANCELLED
}

// ============================================================================
// SERVICES (Productized Offerings)
// ============================================================================

model Service {
  id           String        @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  freelancerId String        @map("freelancer_id") @db.Uuid
  title        String        @db.VarChar(200)
  slug         String        @unique @db.VarChar(250)
  description  String        @db.Text
  status       ServiceStatus @default(DRAFT)

  // Pricing Tiers
  tiers Json @default("[]") // Array of ServiceTier

  // Content
  category String   @db.VarChar(100)
  tags     String[] @default([])
  images   Json     @default("[]")
  faqs     Json     @default("[]")

  // Stats
  orderCount  Int      @default(0) @map("order_count")
  rating      Decimal? @db.Decimal(3, 2)
  reviewCount Int      @default(0) @map("review_count")

  // Timestamps
  publishedAt DateTime? @map("published_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  // Relations
  freelancer User           @relation(fields: [freelancerId], references: [id])
  skills     ServiceSkill[]
  reviews    Review[]

  @@index([freelancerId])
  @@index([status])
  @@index([category])
  @@index([slug])
  @@index([deletedAt])
  @@map("services")
}

model ServiceSkill {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  serviceId String   @map("service_id") @db.Uuid
  skillId   String   @map("skill_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")

  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  skill   Skill   @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@unique([serviceId, skillId])
  @@map("service_skills")
}

enum ServiceStatus {
  DRAFT
  PENDING_REVIEW
  ACTIVE
  PAUSED
  ARCHIVED
}

// ============================================================================
// SKILLPOD SESSIONS (VDI)
// ============================================================================

model Session {
  id       String        @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId   String        @map("user_id") @db.Uuid
  tenantId String?       @map("tenant_id") @db.Uuid
  status   SessionStatus @default(PENDING)
  type     SessionType   @default(DEVELOPMENT)

  // Session Config
  instanceType String @map("instance_type") @db.VarChar(50)
  region       String @db.VarChar(50)
  image        String @db.VarChar(200)
  config       Json   @default("{}")

  // Connection
  connectionUrl String? @map("connection_url") @db.VarChar(500)
  publicIp      String? @map("public_ip") @db.VarChar(45)
  privateIp     String? @map("private_ip") @db.VarChar(45)

  // Usage
  startedAt    DateTime? @map("started_at")
  endedAt      DateTime? @map("ended_at")
  terminatedAt DateTime? @map("terminated_at")
  terminationReason String? @map("termination_reason") @db.Text
  durationMins Int       @default(0) @map("duration_mins")
  costCredits  Decimal   @default(0) @map("cost_credits") @db.Decimal(10, 2)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user   User    @relation(fields: [userId], references: [id])
  tenant Tenant? @relation(fields: [tenantId], references: [id])
  securityPolicy PodSecurityPolicy? @relation(fields: [securityPolicyId], references: [id])
  securityPolicyId String? @map("security_policy_id") @db.Uuid
  
  // Data containment relations
  securityViolations    SecurityViolation[]
  fileTransferRequests  FileTransferRequest[]
  containmentAuditLogs  ContainmentAuditLog[]
  dataTransferAttempts  DataTransferAttempt[]
  screenCaptureAttempts ScreenCaptureAttempt[]
  
  // Session recording
  recordings            SessionRecording[]
  
  // Watermarking
  watermarkInstances    WatermarkInstance[]

  @@index([userId])
  @@index([tenantId])
  @@index([status])
  @@index([startedAt])
  @@index([securityPolicyId])
  @@map("sessions")
}

enum SessionStatus {
  PENDING
  PROVISIONING
  RUNNING
  PAUSED
  STOPPING
  STOPPED
  FAILED
  TERMINATED
}

enum SessionType {
  DEVELOPMENT
  TESTING
  PRODUCTION
  TRAINING
}

// ============================================================================
// DATA CONTAINMENT & SECURITY POLICIES
// ============================================================================

model PodSecurityPolicy {
  id          String  @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId    String  @map("tenant_id") @db.Uuid
  
  // Policy identification
  name        String  @db.VarChar(100)
  description String? @db.Text
  isDefault   Boolean @default(false) @map("is_default")
  
  // Clipboard controls
  clipboardPolicy     ClipboardPolicy @default(BLOCKED) @map("clipboard_policy")
  clipboardInbound    Boolean @default(false) @map("clipboard_inbound")  // Local -> Pod
  clipboardOutbound   Boolean @default(false) @map("clipboard_outbound") // Pod -> Local
  clipboardMaxSize    Int?    @map("clipboard_max_size") // Bytes
  clipboardAllowedTypes String[] @map("clipboard_allowed_types") // ['text/plain']
  
  // File transfer controls
  fileDownloadPolicy  FileTransferPolicy @default(BLOCKED) @map("file_download_policy")
  fileUploadPolicy    FileTransferPolicy @default(ALLOWED) @map("file_upload_policy")
  allowedFileTypes    String[] @map("allowed_file_types") // ['.pdf', '.docx']
  blockedFileTypes    String[] @map("blocked_file_types") // ['.exe', '.zip']
  maxFileSize         Int?     @map("max_file_size") // Bytes
  
  // Printing controls
  printingPolicy      PrintingPolicy @default(BLOCKED) @map("printing_policy")
  allowLocalPrinting  Boolean @default(false) @map("allow_local_printing")
  allowPdfExport      Boolean @default(false) @map("allow_pdf_export")
  
  // Peripheral controls
  usbPolicy           UsbPolicy @default(BLOCKED) @map("usb_policy")
  allowedUsbDevices   String[] @map("allowed_usb_devices") // Device class IDs
  webcamPolicy        PeripheralPolicy @default(ALLOWED) @map("webcam_policy")
  microphonePolicy    PeripheralPolicy @default(ALLOWED) @map("microphone_policy")
  
  // Screen capture controls
  screenCaptureBlocking Boolean @default(true) @map("screen_capture_blocking")
  watermarkEnabled    Boolean @default(true) @map("watermark_enabled")
  watermarkConfig     Json?   @map("watermark_config")
  
  // Network controls
  networkPolicy       NetworkPolicy @default(RESTRICTED) @map("network_policy")
  allowedDomains      String[] @map("allowed_domains")
  blockedDomains      String[] @map("blocked_domains")
  allowInternet       Boolean @default(false) @map("allow_internet")
  
  // Session controls
  idleTimeout         Int     @default(15) @map("idle_timeout") // Minutes
  maxSessionDuration  Int?    @map("max_session_duration") // Minutes
  requireMfa          Boolean @default(true) @map("require_mfa")
  
  // Audit settings
  recordSession       Boolean @default(true) @map("record_session")
  logKeystrokes       Boolean @default(false) @map("log_keystrokes")
  logClipboard        Boolean @default(true) @map("log_clipboard")
  logFileAccess       Boolean @default(true) @map("log_file_access")
  
  // Status
  isActive            Boolean @default(true) @map("is_active")
  
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  
  // Relations
  tenant              Tenant    @relation(fields: [tenantId], references: [id])
  sessions            Session[]
  exceptions          PolicyException[]
  dataTransferAttempts DataTransferAttempt[]
  pods                Pod[]
  
  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([isDefault])
  @@map("pod_security_policies")
}

model SecurityViolation {
  id            String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  sessionId     String   @map("session_id") @db.Uuid
  tenantId      String   @map("tenant_id") @db.Uuid
  
  // Violation details
  violationType ViolationType @map("violation_type")
  severity      ViolationSeverity @default(MEDIUM)
  description   String   @db.Text
  details       Json     @default("{}")
  
  // Context
  sourceIp      String?  @map("source_ip") @db.VarChar(45)
  userAgent     String?  @map("user_agent") @db.Text
  
  // Response taken
  action        ViolationAction @default(LOGGED)
  actionDetails Json?    @map("action_details")
  
  // Review status
  reviewed      Boolean  @default(false)
  reviewedBy    String?  @map("reviewed_by") @db.Uuid
  reviewedAt    DateTime? @map("reviewed_at")
  reviewNotes   String?  @map("review_notes") @db.Text
  
  createdAt     DateTime @default(now()) @map("created_at")
  
  // Relations
  session       Session  @relation(fields: [sessionId], references: [id])
  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  
  @@index([sessionId])
  @@index([tenantId])
  @@index([violationType])
  @@index([severity])
  @@index([createdAt])
  @@map("security_violations")
}

model FileTransferRequest {
  id            String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  sessionId     String   @map("session_id") @db.Uuid
  tenantId      String   @map("tenant_id") @db.Uuid
  requestedBy   String   @map("requested_by") @db.Uuid
  
  // File details
  fileName      String   @map("file_name") @db.VarChar(255)
  fileType      String   @map("file_type") @db.VarChar(100)
  fileSize      Int      @map("file_size") // Bytes
  fileHash      String?  @map("file_hash") @db.VarChar(128)
  direction     TransferDirection
  
  // Request details
  purpose       String   @db.Text
  expiresAt     DateTime @map("expires_at")
  
  // Approval workflow
  status        TransferRequestStatus @default(PENDING)
  approvedBy    String?  @map("approved_by") @db.Uuid
  approvedAt    DateTime? @map("approved_at")
  rejectedBy    String?  @map("rejected_by") @db.Uuid
  rejectedAt    DateTime? @map("rejected_at")
  rejectionReason String? @map("rejection_reason") @db.Text
  
  // Transfer tracking
  transferStartedAt  DateTime? @map("transfer_started_at")
  transferCompletedAt DateTime? @map("transfer_completed_at")
  downloadCount  Int     @default(0) @map("download_count")
  maxDownloads   Int     @default(1) @map("max_downloads")
  
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  // Relations
  session       Session  @relation(fields: [sessionId], references: [id])
  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  
  @@index([sessionId])
  @@index([tenantId])
  @@index([requestedBy])
  @@index([status])
  @@index([createdAt])
  @@map("file_transfer_requests")
}

model ContainmentAuditLog {
  id            String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  sessionId     String   @map("session_id") @db.Uuid
  tenantId      String   @map("tenant_id") @db.Uuid
  userId        String   @map("user_id") @db.Uuid
  
  // Event details
  eventType     ContainmentEventType @map("event_type")
  eventCategory ContainmentEventCategory @map("event_category")
  description   String   @db.Text
  details       Json     @default("{}")
  
  // Context
  sourceIp      String?  @map("source_ip") @db.VarChar(45)
  targetResource String? @map("target_resource") @db.VarChar(500)
  
  // Outcome
  allowed       Boolean
  blockedReason String?  @map("blocked_reason") @db.Text
  policyId      String?  @map("policy_id") @db.Uuid
  
  createdAt     DateTime @default(now()) @map("created_at")
  
  // Relations
  session       Session  @relation(fields: [sessionId], references: [id])
  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  
  @@index([sessionId])
  @@index([tenantId])
  @@index([userId])
  @@index([eventType])
  @@index([eventCategory])
  @@index([createdAt])
  @@map("containment_audit_logs")
}

// Data Containment Enums
enum ClipboardPolicy {
  BLOCKED
  READ_ONLY      // Can paste into pod, not copy out
  WRITE_ONLY     // Can copy out of pod, not paste in
  BIDIRECTIONAL  // Full clipboard access
  APPROVAL_REQUIRED
}

enum FileTransferPolicy {
  BLOCKED
  ALLOWED
  APPROVAL_REQUIRED
  LOGGED_ONLY    // Allowed but heavily logged
}

enum PrintingPolicy {
  BLOCKED
  LOCAL_ONLY     // Print to local printer
  PDF_ONLY       // Export as PDF only
  ALLOWED
  APPROVAL_REQUIRED
}

enum UsbPolicy {
  BLOCKED
  STORAGE_BLOCKED // Block storage devices, allow others
  WHITELIST_ONLY
  ALLOWED
}

enum PeripheralPolicy {
  BLOCKED
  ALLOWED
  SESSION_PROMPT  // Ask user each session
}

enum NetworkPolicy {
  BLOCKED        // No network access
  RESTRICTED     // Whitelist only
  MONITORED      // Full access but logged
  UNRESTRICTED
}

enum ViolationType {
  CLIPBOARD_COPY_ATTEMPT
  CLIPBOARD_PASTE_BLOCKED
  FILE_DOWNLOAD_BLOCKED
  FILE_UPLOAD_BLOCKED
  SCREEN_CAPTURE_ATTEMPT
  USB_DEVICE_BLOCKED
  NETWORK_ACCESS_BLOCKED
  PRINT_BLOCKED
  SESSION_TIMEOUT
  IDLE_TIMEOUT
  UNAUTHORIZED_PERIPHERAL
  POLICY_BYPASS_ATTEMPT
  SUSPICIOUS_ACTIVITY
}

enum ViolationSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ViolationAction {
  LOGGED
  WARNED
  BLOCKED
  SESSION_TERMINATED
  USER_SUSPENDED
  INCIDENT_CREATED
}

enum TransferDirection {
  UPLOAD   // Local to Pod
  DOWNLOAD // Pod to Local
}

enum TransferRequestStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
  COMPLETED
  CANCELLED
}

enum ContainmentEventType {
  CLIPBOARD_COPY
  CLIPBOARD_PASTE
  FILE_DOWNLOAD
  FILE_UPLOAD
  PRINT_REQUEST
  USB_CONNECT
  USB_DISCONNECT
  NETWORK_REQUEST
  SCREEN_CAPTURE
  PERIPHERAL_ACCESS
  SESSION_START
  SESSION_END
  POLICY_CHANGE
  WATERMARK_DISPLAYED
}

enum ContainmentEventCategory {
  DATA_TRANSFER
  DEVICE_ACCESS
  NETWORK
  SESSION
  SECURITY
  CONFIGURATION
}

// ============================================================================
// DATA TRANSFER ATTEMPTS (Extended Logging)
// ============================================================================

model DataTransferAttempt {
  id            String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  sessionId     String   @map("session_id") @db.Uuid
  userId        String   @map("user_id") @db.Uuid
  tenantId      String   @map("tenant_id") @db.Uuid
  
  // Transfer details
  transferType  TransferType @map("transfer_type")
  direction     TransferAttemptDirection
  
  // Content info (no actual content stored for security)
  contentType   String?  @map("content_type") @db.VarChar(100)
  contentSize   Int?     @map("content_size") // Bytes
  contentHash   String?  @map("content_hash") @db.VarChar(128) // SHA-256 hash
  fileName      String?  @map("file_name") @db.VarChar(500)
  
  // Outcome
  action        TransferAction
  reason        String?  @db.Text
  
  // Policy reference
  policyId      String?  @map("policy_id") @db.Uuid
  policyRule    String?  @map("policy_rule") @db.VarChar(200)
  
  // Admin override workflow
  overrideApproved   Boolean  @default(false) @map("override_approved")
  overrideBy         String?  @map("override_by") @db.Uuid
  overrideReason     String?  @map("override_reason") @db.Text
  overrideRequestId  String?  @map("override_request_id") @db.Uuid
  
  // Context
  sourceApplication String?  @map("source_application") @db.VarChar(200)
  targetApplication String?  @map("target_application") @db.VarChar(200)
  ipAddress        String?  @map("ip_address") @db.VarChar(45)
  
  createdAt     DateTime @default(now()) @map("created_at")
  
  // Relations
  session       Session  @relation(fields: [sessionId], references: [id])
  user          User     @relation(fields: [userId], references: [id])
  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  policy        PodSecurityPolicy? @relation(fields: [policyId], references: [id])
  overrideRequest TransferOverrideRequest? @relation(fields: [overrideRequestId], references: [id])
  
  @@index([sessionId])
  @@index([userId])
  @@index([tenantId])
  @@index([policyId])
  @@index([createdAt])
  @@index([transferType, action])
  @@map("data_transfer_attempts")
}

model ScreenCaptureAttempt {
  id            String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  sessionId     String   @map("session_id") @db.Uuid
  userId        String   @map("user_id") @db.Uuid
  tenantId      String   @map("tenant_id") @db.Uuid
  
  // Capture details
  captureType      CaptureType @map("capture_type")
  detectionMethod  String   @map("detection_method") @db.VarChar(100)
  
  // Action taken
  blocked          Boolean
  notificationSent Boolean  @default(false) @map("notification_sent")
  
  // Context
  activeApplication String?  @map("active_application") @db.VarChar(200)
  activeWindow      String?  @map("active_window") @db.VarChar(500)
  
  // Forensics
  processName      String?  @map("process_name") @db.VarChar(200)
  processId        Int?     @map("process_id")
  
  createdAt        DateTime @default(now()) @map("created_at")
  
  // Relations
  session          Session  @relation(fields: [sessionId], references: [id])
  user             User     @relation(fields: [userId], references: [id])
  tenant           Tenant   @relation(fields: [tenantId], references: [id])
  
  @@index([sessionId])
  @@index([userId])
  @@index([tenantId])
  @@index([createdAt])
  @@index([captureType])
  @@map("screen_capture_attempts")
}

model PolicyException {
  id            String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  policyId      String   @map("policy_id") @db.Uuid
  
  // Exception identification
  name          String   @db.VarChar(100)
  description   String?  @db.Text
  
  // Exception scope
  scope         ExceptionScope
  scopeValue    String?  @map("scope_value") @db.VarChar(500) // userId, fileType, domain, etc.
  
  // Exception type
  exceptionType ExceptionType @map("exception_type")
  
  // Allowed actions
  allowedTransferTypes TransferType[] @map("allowed_transfer_types")
  allowedDirections TransferAttemptDirection[] @map("allowed_directions")
  
  // Constraints
  maxFileSize       Int?     @map("max_file_size") // Bytes
  allowedFileTypes  String[] @map("allowed_file_types")
  allowedDomains    String[] @map("allowed_domains")
  
  // Time constraints
  validFrom         DateTime? @map("valid_from")
  validUntil        DateTime? @map("valid_until")
  
  // Approval workflow
  requiresApproval  Boolean  @default(false) @map("requires_approval")
  approvalWorkflow  String?  @map("approval_workflow") @db.VarChar(100)
  
  // Status
  isActive          Boolean  @default(true) @map("is_active")
  
  // Audit
  reason            String   @db.Text
  createdBy         String   @map("created_by") @db.Uuid
  approvedBy        String?  @map("approved_by") @db.Uuid
  
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  // Relations
  policy            PodSecurityPolicy @relation(fields: [policyId], references: [id])
  
  @@index([policyId])
  @@index([scope])
  @@index([exceptionType])
  @@index([isActive])
  @@map("policy_exceptions")
}

model TransferOverrideRequest {
  id            String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId      String   @map("tenant_id") @db.Uuid
  
  // Request details
  attemptId     String?  @map("attempt_id") @db.Uuid // Original blocked attempt
  requestedBy   String   @map("requested_by") @db.Uuid
  reason        String   @db.Text
  
  // Transfer details (copy from original attempt for context)
  transferType  TransferType @map("transfer_type")
  direction     TransferAttemptDirection
  fileName      String?  @map("file_name") @db.VarChar(500)
  contentSize   Int?     @map("content_size")
  
  // Workflow
  status        OverrideRequestStatus @default(PENDING)
  
  // Approval
  approvedBy    String?  @map("approved_by") @db.Uuid
  approvalNotes String?  @map("approval_notes") @db.Text
  processedAt   DateTime? @map("processed_at")
  
  // Expiration
  expiresAt     DateTime @map("expires_at")
  
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  // Relations
  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  attempts      DataTransferAttempt[]
  
  @@index([tenantId])
  @@index([requestedBy])
  @@index([status])
  @@index([createdAt])
  @@map("transfer_override_requests")
}

// Additional Transfer Enums
enum TransferType {
  CLIPBOARD_TEXT
  CLIPBOARD_IMAGE
  CLIPBOARD_FILE
  FILE_DOWNLOAD
  FILE_UPLOAD
  USB_TRANSFER
  PRINT
  SCREEN_SHARE
}

enum TransferAttemptDirection {
  INBOUND    // Into the pod
  OUTBOUND   // Out of the pod
  INTERNAL   // Within the pod
}

enum TransferAction {
  ALLOWED
  BLOCKED
  LOGGED              // Allowed but logged
  QUARANTINED         // Held for review
  OVERRIDE_APPROVED   // Blocked but admin approved
}

enum CaptureType {
  SCREENSHOT
  SCREEN_RECORDING
  REMOTE_DESKTOP
  PRINT_SCREEN_KEY
  SNIPPING_TOOL
  THIRD_PARTY_APP
  BROWSER_EXTENSION
  OS_NATIVE
}

enum ExceptionScope {
  USER
  GROUP
  FILE_TYPE
  DOMAIN
  APPLICATION
  TIME_WINDOW
  IP_ADDRESS
}

enum ExceptionType {
  CLIPBOARD
  FILE_TRANSFER
  USB
  PRINT
  SCREEN_CAPTURE
  NETWORK
}

enum OverrideRequestStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
  CANCELLED
}

// ============================================================================
// MESSAGING
// ============================================================================

model Message {
  id         String  @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  senderId   String  @map("sender_id") @db.Uuid
  receiverId String  @map("receiver_id") @db.Uuid
  jobId      String? @map("job_id") @db.Uuid
  contractId String? @map("contract_id") @db.Uuid
  threadId   String? @map("thread_id") @db.Uuid

  content     String      @db.Text
  type        MessageType @default(TEXT)
  attachments Json        @default("[]")
  metadata    Json        @default("{}")

  // Status
  readAt    DateTime? @map("read_at")
  deletedAt DateTime? @map("deleted_at")
  createdAt DateTime  @default(now()) @map("created_at")

  // Relations
  sender   User      @relation("SenderMessages", fields: [senderId], references: [id])
  receiver User      @relation("ReceiverMessages", fields: [receiverId], references: [id])
  job      Job?      @relation("JobMessages", fields: [jobId], references: [id])
  contract Contract? @relation("ContractMessages", fields: [contractId], references: [id])
  thread   Message?  @relation("MessageThread", fields: [threadId], references: [id])
  replies  Message[] @relation("MessageThread")

  @@index([senderId])
  @@index([receiverId])
  @@index([jobId])
  @@index([contractId])
  @@index([threadId])
  @@index([createdAt])
  @@map("messages")
}

enum MessageType {
  TEXT
  FILE
  IMAGE
  SYSTEM
  OFFER
}

// ============================================================================
// PAYMENTS & BILLING
// ============================================================================

model Payment {
  id              String  @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  contractId      String  @map("contract_id") @db.Uuid
  milestoneId     String? @map("milestone_id") @db.Uuid
  payerId         String  @map("payer_id") @db.Uuid
  payeeId         String  @map("payee_id") @db.Uuid
  paymentMethodId String? @map("payment_method_id") @db.Uuid

  amount    Decimal @db.Decimal(12, 2)
  currency  String  @default("USD") @db.VarChar(3)
  fee       Decimal @default(0) @db.Decimal(12, 2)
  netAmount Decimal @map("net_amount") @db.Decimal(12, 2)

  status PaymentStatus @default(PENDING)
  type   PaymentType   @default(MILESTONE)

  // External references
  stripePaymentIntentId String? @unique @map("stripe_payment_intent_id") @db.VarChar(100)
  stripeTransferId      String? @map("stripe_transfer_id") @db.VarChar(100)

  // Escrow
  escrowedAt DateTime? @map("escrowed_at")
  releasedAt DateTime? @map("released_at")
  refundedAt DateTime? @map("refunded_at")

  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  completedAt DateTime? @map("completed_at")

  contract      Contract       @relation(fields: [contractId], references: [id])
  milestone     Milestone?     @relation(fields: [milestoneId], references: [id])
  paymentMethod PaymentMethod? @relation(fields: [paymentMethodId], references: [id])

  @@index([contractId])
  @@index([milestoneId])
  @@index([payerId])
  @@index([payeeId])
  @@index([paymentMethodId])
  @@index([status])
  @@index([createdAt])
  @@map("payments")
}

// ============================================================================
// STRIPE CUSTOMER
// ============================================================================

model StripeCustomer {
  id               String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId           String @unique @map("user_id") @db.Uuid
  stripeCustomerId String @unique @map("stripe_customer_id") @db.VarChar(100)

  // Metadata
  currency String @default("USD") @db.VarChar(3)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("stripe_customers")
}

// ============================================================================
// PAYMENT METHOD
// ============================================================================

model PaymentMethod {
  id                    String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId                String @map("user_id") @db.Uuid
  stripePaymentMethodId String @unique @map("stripe_payment_method_id") @db.VarChar(100)
  stripeCustomerId      String @map("stripe_customer_id") @db.VarChar(100)

  type      PaymentMethodType
  isDefault Boolean             @default(false) @map("is_default")
  status    PaymentMethodStatus @default(ACTIVE)

  // Card details (for display only - PCI compliant)
  cardBrand    String? @map("card_brand") @db.VarChar(20)
  cardLast4    String? @map("card_last4") @db.VarChar(4)
  cardExpMonth Int?    @map("card_exp_month")
  cardExpYear  Int?    @map("card_exp_year")
  cardFunding  String? @map("card_funding") @db.VarChar(20) // credit, debit, prepaid

  // Bank account details (for display only - PCI compliant)
  bankName         String? @map("bank_name") @db.VarChar(100)
  bankLast4        String? @map("bank_last4") @db.VarChar(4)
  bankAccountType  String? @map("bank_account_type") @db.VarChar(20) // checking, savings
  bankRoutingLast4 String? @map("bank_routing_last4") @db.VarChar(4)

  // SEPA details
  sepaCountry  String? @map("sepa_country") @db.VarChar(2)
  sepaBankCode String? @map("sepa_bank_code") @db.VarChar(20)

  // Billing address (for verification)
  billingName       String? @map("billing_name") @db.VarChar(200)
  billingEmail      String? @map("billing_email") @db.VarChar(255)
  billingCountry    String? @map("billing_country") @db.VarChar(2)
  billingPostalCode String? @map("billing_postal_code") @db.VarChar(20)

  // Expiration handling
  expirationWarningAt DateTime? @map("expiration_warning_at")

  // Metadata
  fingerprint String? @db.VarChar(100) // Stripe fingerprint for dedup

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user         User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  payments     Payment[]
  transactions PaymentTransaction[]

  @@index([userId])
  @@index([stripeCustomerId])
  @@index([status])
  @@index([cardExpYear, cardExpMonth])
  @@map("payment_methods")
}

// ============================================================================
// PAYOUT ACCOUNT (Stripe Connect)
// ============================================================================

model PayoutAccount {
  id                     String              @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId                 String              @unique @map("user_id") @db.Uuid
  stripeConnectAccountId String?             @unique @map("stripe_connect_account_id") @db.VarChar(100)

  // Account type
  accountType PayoutAccountType @default(EXPRESS) @map("account_type")

  // Status
  status PayoutAccountStatus @default(PENDING)

  // Verification
  detailsSubmitted Boolean @default(false) @map("details_submitted")
  chargesEnabled   Boolean @default(false) @map("charges_enabled")
  payoutsEnabled   Boolean @default(false) @map("payouts_enabled")

  // Requirements (JSON arrays)
  currentlyDue  String[] @default([]) @map("currently_due")
  eventuallyDue String[] @default([]) @map("eventually_due")
  pastDue       String[] @default([]) @map("past_due")

  // Payout settings
  defaultCurrency String @default("USD") @map("default_currency") @db.VarChar(3)
  payoutSchedule  Json?  @map("payout_schedule")

  // Business info
  country      String? @db.VarChar(2)
  businessType String? @map("business_type") @db.VarChar(50)

  // External account (bank) info for display
  externalAccountType   String? @map("external_account_type") @db.VarChar(20)
  externalAccountLast4  String? @map("external_account_last4") @db.VarChar(4)
  externalAccountBank   String? @map("external_account_bank") @db.VarChar(100)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  payouts Payout[]

  @@index([userId])
  @@index([status])
  @@map("payout_accounts")
}

enum PayoutAccountType {
  EXPRESS  // Stripe-hosted onboarding
  STANDARD // Full Stripe dashboard access
  CUSTOM   // Full API control
}

enum PayoutAccountStatus {
  PENDING     // Not yet onboarded
  ONBOARDING  // In progress
  ACTIVE      // Can receive payouts
  RESTRICTED  // Action required
  DISABLED    // Cannot receive payouts
}

// ============================================================================
// PAYOUT (Transfer to Connect Account)
// ============================================================================

model Payout {
  id              String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  payoutAccountId String @map("payout_account_id") @db.Uuid

  // Stripe references
  stripeTransferId String? @unique @map("stripe_transfer_id") @db.VarChar(100)
  stripePayoutId   String? @map("stripe_payout_id") @db.VarChar(100)

  // Amount
  amount   Decimal      @db.Decimal(12, 2)
  currency String       @default("USD") @db.VarChar(3)
  status   PayoutStatus @default(PENDING)

  // Reference to what this payout is for
  referenceType String? @map("reference_type") @db.VarChar(50)
  referenceId   String? @map("reference_id") @db.Uuid

  // Description
  description String? @db.VarChar(500)

  // Error info
  failureCode    String? @map("failure_code") @db.VarChar(50)
  failureMessage String? @map("failure_message") @db.VarChar(500)

  // Timestamps
  processedAt DateTime? @map("processed_at")
  arrivedAt   DateTime? @map("arrived_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  payoutAccount PayoutAccount @relation(fields: [payoutAccountId], references: [id])

  @@index([payoutAccountId])
  @@index([status])
  @@index([referenceType, referenceId])
  @@map("payouts")
}

enum PayoutStatus {
  PENDING
  IN_TRANSIT
  PAID
  FAILED
  CANCELED
}

// ============================================================================
// PAYMENT TRANSACTION
// ============================================================================

model PaymentTransaction {
  id     String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId String @map("user_id") @db.Uuid

  // Stripe references
  stripePaymentIntentId String? @unique @map("stripe_payment_intent_id") @db.VarChar(100)
  stripeChargeId        String? @map("stripe_charge_id") @db.VarChar(100)
  paymentMethodId       String? @map("payment_method_id") @db.Uuid

  // Transaction details
  type   TransactionType   @default(PAYMENT)
  status TransactionStatus @default(PENDING)

  // Amounts (in smallest currency unit stored as decimal)
  amount      Decimal  @db.Decimal(12, 2)
  currency    String   @default("USD") @db.VarChar(3)
  platformFee Decimal? @map("platform_fee") @db.Decimal(12, 2)
  stripeFee   Decimal? @map("stripe_fee") @db.Decimal(12, 2)
  netAmount   Decimal? @map("net_amount") @db.Decimal(12, 2)

  // Reference to what this payment is for
  referenceType String? @map("reference_type") @db.VarChar(50) // 'subscription', 'contract', 'escrow'
  referenceId   String? @map("reference_id") @db.Uuid

  // Description and metadata
  description String? @db.VarChar(500)
  metadata    Json?

  // Error handling
  failureCode    String? @map("failure_code") @db.VarChar(50)
  failureMessage String? @map("failure_message") @db.VarChar(500)

  // Timestamps
  processedAt DateTime? @map("processed_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  user          User           @relation(fields: [userId], references: [id])
  paymentMethod PaymentMethod? @relation(fields: [paymentMethodId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([type])
  @@index([referenceType, referenceId])
  @@map("payment_transactions")
}

enum TransactionType {
  PAYMENT
  REFUND
  ESCROW_HOLD
  ESCROW_RELEASE
  SUBSCRIPTION
  PAYOUT
}

enum TransactionStatus {
  PENDING
  PROCESSING
  REQUIRES_ACTION
  SUCCEEDED
  FAILED
  CANCELLED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum PaymentMethodStatus {
  ACTIVE
  EXPIRING_SOON
  EXPIRED
  VERIFICATION_PENDING
  VERIFICATION_FAILED
  REMOVED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  ESCROWED
  RELEASED
  COMPLETED
  FAILED
  REFUNDED
  DISPUTED
}

enum PaymentType {
  MILESTONE
  HOURLY
  BONUS
  REFUND
  SUBSCRIPTION
}

enum PaymentMethodType {
  CARD
  ACH_DEBIT
  SEPA_DEBIT
  WIRE
}

model Invoice {
  id       String        @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId String?       @map("tenant_id") @db.Uuid
  number   String        @unique @db.VarChar(50)
  status   InvoiceStatus @default(DRAFT)

  // Amounts
  subtotal Decimal @db.Decimal(12, 2)
  tax      Decimal @default(0) @db.Decimal(12, 2)
  total    Decimal @db.Decimal(12, 2)
  currency String  @default("USD") @db.VarChar(3)

  // Dates
  issuedAt DateTime? @map("issued_at")
  dueAt    DateTime? @map("due_at")
  paidAt   DateTime? @map("paid_at")

  // Line items
  lineItems Json @default("[]") @map("line_items")

  // External
  stripeInvoiceId String? @unique @map("stripe_invoice_id") @db.VarChar(100)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant Tenant? @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@index([status])
  @@index([number])
  @@map("invoices")
}

enum InvoiceStatus {
  DRAFT
  ISSUED
  PAID
  OVERDUE
  CANCELLED
  REFUNDED
}

// ============================================================================
// REVIEWS & TRUST
// ============================================================================

model Review {
  id String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid

  // Contract reference (for contract-based reviews)
  contractId String? @map("contract_id") @db.Uuid

  // Service reference (for service-based reviews)
  serviceId String? @map("service_id") @db.Uuid

  // Reviewer and reviewee
  reviewerId String @map("reviewer_id") @db.Uuid
  revieweeId String @map("reviewee_id") @db.Uuid

  // Review direction
  reviewType ReviewType @map("review_type")

  // Overall rating
  overallRating Int @map("overall_rating") @db.SmallInt // 1-5

  // Category ratings (JSON to support different categories per type)
  // Client reviewing freelancer: { quality: 5, communication: 4, expertise: 5, professionalism: 4, wouldHireAgain: true }
  // Freelancer reviewing client: { clarity: 4, responsiveness: 5, payment: 5, professionalism: 4, wouldWorkAgain: true }
  categoryRatings Json @map("category_ratings")

  // Review content
  title   String? @db.VarChar(200)
  content String? @db.Text

  // Private feedback (only visible to Skillancer)
  privateFeedback String? @map("private_feedback") @db.Text

  // Visibility
  isPublic Boolean @default(true) @map("is_public")

  // Reveal status (for simultaneous reveal)
  status     ReviewStatus @default(PENDING)
  revealedAt DateTime?    @map("revealed_at")

  // Response from reviewee
  responseId String? @unique @map("response_id") @db.Uuid

  // Moderation
  isModerated      Boolean   @default(false) @map("is_moderated")
  moderatedAt      DateTime? @map("moderated_at")
  moderatedBy      String?   @map("moderated_by") @db.Uuid
  moderationReason String?   @map("moderation_reason") @db.VarChar(500)
  originalContent  String?   @map("original_content") @db.Text

  // Helpfulness
  helpfulCount    Int @default(0) @map("helpful_count")
  notHelpfulCount Int @default(0) @map("not_helpful_count")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  contract     Contract?           @relation(fields: [contractId], references: [id])
  service      Service?            @relation(fields: [serviceId], references: [id])
  reviewer     User                @relation("ReviewerReviews", fields: [reviewerId], references: [id])
  reviewee     User                @relation("RevieweeReviews", fields: [revieweeId], references: [id])
  response     ReviewResponse?     @relation(fields: [responseId], references: [id])
  helpfulVotes ReviewHelpfulVote[]
  reports      ReviewReport[]

  @@unique([contractId, reviewType])
  @@index([reviewerId])
  @@index([revieweeId])
  @@index([serviceId])
  @@index([status])
  @@index([createdAt])
  @@index([overallRating])
  @@map("reviews")
}

model ReviewResponse {
  id String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid

  // Response content
  content String @db.Text

  // Moderation
  isModerated     Boolean   @default(false) @map("is_moderated")
  moderatedAt     DateTime? @map("moderated_at")
  originalContent String?   @map("original_content") @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  review Review?

  @@map("review_responses")
}

model ReviewHelpfulVote {
  id       String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  reviewId String @map("review_id") @db.Uuid
  userId   String @map("user_id") @db.Uuid

  isHelpful Boolean @map("is_helpful")

  createdAt DateTime @default(now()) @map("created_at")

  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([reviewId, userId])
  @@index([reviewId])
  @@index([userId])
  @@map("review_helpful_votes")
}

model ReviewReport {
  id         String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  reviewId   String @map("review_id") @db.Uuid
  reporterId String @map("reporter_id") @db.Uuid

  reason      ReviewReportReason
  description String?            @db.Text

  status ReportStatus @default(PENDING)

  // Resolution
  resolvedBy String?   @map("resolved_by") @db.Uuid
  resolvedAt DateTime? @map("resolved_at")
  resolution String?   @db.VarChar(500)

  createdAt DateTime @default(now()) @map("created_at")

  review   Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  reporter User   @relation(fields: [reporterId], references: [id])

  @@index([reviewId])
  @@index([status])
  @@index([reporterId])
  @@map("review_reports")
}

model UserRatingAggregation {
  id     String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId String @unique @map("user_id") @db.Uuid

  // As freelancer (receiving reviews from clients)
  freelancerTotalReviews    Int     @default(0) @map("freelancer_total_reviews")
  freelancerAverageRating   Decimal @default(0) @map("freelancer_average_rating") @db.Decimal(3, 2)
  freelancerRatingBreakdown Json    @default("{}") @map("freelancer_rating_breakdown") // { "5": 10, "4": 5, "3": 2, "2": 0, "1": 1 }

  // Category averages (freelancer)
  freelancerQualityAvg         Decimal? @map("freelancer_quality_avg") @db.Decimal(3, 2)
  freelancerCommunicationAvg   Decimal? @map("freelancer_communication_avg") @db.Decimal(3, 2)
  freelancerExpertiseAvg       Decimal? @map("freelancer_expertise_avg") @db.Decimal(3, 2)
  freelancerProfessionalismAvg Decimal? @map("freelancer_professionalism_avg") @db.Decimal(3, 2)
  freelancerRepeatRate         Decimal? @map("freelancer_repeat_rate") @db.Decimal(5, 2) // % of clients who would hire again

  // As client (receiving reviews from freelancers)
  clientTotalReviews    Int     @default(0) @map("client_total_reviews")
  clientAverageRating   Decimal @default(0) @map("client_average_rating") @db.Decimal(3, 2)
  clientRatingBreakdown Json    @default("{}") @map("client_rating_breakdown")

  // Category averages (client)
  clientClarityAvg         Decimal? @map("client_clarity_avg") @db.Decimal(3, 2)
  clientResponsivenessAvg  Decimal? @map("client_responsiveness_avg") @db.Decimal(3, 2)
  clientPaymentAvg         Decimal? @map("client_payment_avg") @db.Decimal(3, 2)
  clientProfessionalismAvg Decimal? @map("client_professionalism_avg") @db.Decimal(3, 2)
  clientRepeatRate         Decimal? @map("client_repeat_rate") @db.Decimal(5, 2)

  // Last calculation
  lastCalculatedAt DateTime @default(now()) @map("last_calculated_at")

  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_rating_aggregations")
}

model ReviewInvitation {
  id         String     @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  contractId String     @map("contract_id") @db.Uuid
  userId     String     @map("user_id") @db.Uuid
  reviewType ReviewType @map("review_type")

  // Status
  status ReviewInvitationStatus @default(PENDING)

  // Timing
  sentAt      DateTime  @default(now()) @map("sent_at")
  expiresAt   DateTime  @map("expires_at")
  completedAt DateTime? @map("completed_at")

  // Reminders
  reminderCount  Int       @default(0) @map("reminder_count")
  lastReminderAt DateTime? @map("last_reminder_at")

  createdAt DateTime @default(now()) @map("created_at")

  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id])

  @@unique([contractId, reviewType])
  @@index([userId])
  @@index([status])
  @@index([expiresAt])
  @@map("review_invitations")
}

enum ReviewType {
  CLIENT_TO_FREELANCER
  FREELANCER_TO_CLIENT
}

enum ReviewStatus {
  PENDING // Submitted but not yet revealed
  REVEALED // Both parties submitted or window closed
  HIDDEN // Hidden due to moderation
}

enum ReviewReportReason {
  INAPPROPRIATE_CONTENT
  FALSE_INFORMATION
  HARASSMENT
  SPAM
  CONFLICT_OF_INTEREST
  OTHER
}

enum ReportStatus {
  PENDING
  UNDER_REVIEW
  RESOLVED
  DISMISSED
}

enum ReviewInvitationStatus {
  PENDING
  COMPLETED
  EXPIRED
  SKIPPED
}

model TrustScore {
  id     String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId String @unique @map("user_id") @db.Uuid

  // Overall score (0-100)
  overallScore Int @default(50) @map("overall_score")

  // Component scores (0-100 each)
  reviewScore       Int @default(50) @map("review_score")
  complianceScore   Int @default(70) @map("compliance_score")
  verificationScore Int @default(0) @map("verification_score")
  tenureScore       Int @default(20) @map("tenure_score")
  activityScore     Int @default(50) @map("activity_score")

  // Component weights (should sum to 100)
  reviewWeight       Int @default(40) @map("review_weight")
  complianceWeight   Int @default(25) @map("compliance_weight")
  verificationWeight Int @default(20) @map("verification_weight")
  tenureWeight       Int @default(10) @map("tenure_weight")
  activityWeight     Int @default(5) @map("activity_weight")

  // Trust tier
  tier TrustTier @default(EMERGING)

  // Trend
  trend             TrustTrend @default(STABLE)
  previousScore     Int?       @map("previous_score")
  scoreChangeAmount Int?       @map("score_change_amount")

  // Calculation metadata
  lastCalculatedAt   DateTime @default(now()) @map("last_calculated_at")
  calculationVersion Int      @default(1) @map("calculation_version")

  // Factors contributing to score (detailed breakdown)
  factors Json @default("{}") @map("factors")

  // Legacy fields (for backward compatibility)
  totalJobs     Int     @default(0) @map("total_jobs")
  completedJobs Int     @default(0) @map("completed_jobs")
  totalEarnings Decimal @default(0) @map("total_earnings") @db.Decimal(12, 2)
  repeatClients Int     @default(0) @map("repeat_clients")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user    User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  history TrustScoreHistory[]

  @@map("trust_scores")
}

model TrustScoreHistory {
  id           String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  trustScoreId String @map("trust_score_id") @db.Uuid

  // Snapshot
  overallScore      Int @map("overall_score")
  reviewScore       Int @map("review_score")
  complianceScore   Int @map("compliance_score")
  verificationScore Int @map("verification_score")
  tenureScore       Int @map("tenure_score")
  activityScore     Int @map("activity_score")

  tier TrustTier

  // What triggered the recalculation
  triggerEvent String @map("trigger_event") @db.VarChar(100)

  createdAt DateTime @default(now()) @map("created_at")

  trustScore TrustScore @relation(fields: [trustScoreId], references: [id], onDelete: Cascade)

  @@index([trustScoreId])
  @@index([createdAt])
  @@map("trust_score_history")
}

model SkillPodComplianceRecord {
  id     String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId String @map("user_id") @db.Uuid

  // Session reference
  sessionId String @map("session_id") @db.Uuid

  // Compliance event
  eventType ComplianceEventType @map("event_type")
  severity  ComplianceSeverity

  // Details
  description String @db.Text
  metadata    Json   @default("{}")

  // Resolution
  isResolved      Boolean   @default(false) @map("is_resolved")
  resolvedAt      DateTime? @map("resolved_at")
  resolvedBy      String?   @map("resolved_by") @db.Uuid
  resolutionNotes String?   @map("resolution_notes") @db.Text

  // Impact on score
  scoreImpact Int @map("score_impact") // Negative value

  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([eventType])
  @@index([createdAt])
  @@map("skillpod_compliance_records")
}

model TrustScoreThreshold {
  id String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid

  // Context
  contextType ThresholdContextType @map("context_type")
  contextId   String?              @map("context_id") @db.Uuid // Job ID, Tenant ID, etc.

  // Threshold
  minimumScore Int        @map("minimum_score")
  minimumTier  TrustTier? @map("minimum_tier")

  // Required verifications
  requireVerification      Boolean            @default(false) @map("require_verification")
  minimumVerificationLevel VerificationLevel? @map("minimum_verification_level")

  // Additional requirements
  requireMfa           Boolean @default(false) @map("require_mfa")
  minimumReviews       Int?    @map("minimum_reviews")
  minimumCompletedJobs Int?    @map("minimum_completed_jobs")

  // Metadata
  createdBy String @map("created_by") @db.Uuid

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([contextType, contextId])
  @@map("trust_score_thresholds")
}

model UserBadge {
  id        String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  badgeId   String    @map("badge_id") @db.VarChar(50)
  earnedAt  DateTime  @default(now()) @map("earned_at")
  revokedAt DateTime? @map("revoked_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
  @@index([userId])
  @@index([badgeId])
  @@map("user_badges")
}

enum TrustTier {
  EMERGING // 0-39:  New or low activity
  ESTABLISHED // 40-59: Building reputation
  TRUSTED // 60-79: Solid track record
  HIGHLY_TRUSTED // 80-94: Excellent reputation
  ELITE // 95-100: Top performers
}

enum TrustTrend {
  RISING
  STABLE
  DECLINING
}

enum ComplianceEventType {
  DATA_TRANSFER_ATTEMPT // Tried to copy data
  UNAUTHORIZED_APP // Ran unauthorized application
  POLICY_VIOLATION // General policy violation
  SESSION_ANOMALY // Unusual session behavior
  SCREENSHOT_ATTEMPT // Screenshot blocked
  SCREEN_SHARE_ATTEMPT // Unauthorized screen share
}

enum ComplianceSeverity {
  LOW // Minor, educational
  MEDIUM // Concerning, warning
  HIGH // Serious, investigation needed
  CRITICAL // Immediate action required
}

enum ThresholdContextType {
  JOB // Specific job requirement
  TENANT // Tenant-wide requirement
  POD_TEMPLATE // SkillPod template requirement
  GLOBAL // Platform-wide minimum
}

// ============================================================================
// NOTIFICATIONS
// ============================================================================

model Notification {
  id      String              @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId  String              @map("user_id") @db.Uuid
  type    NotificationType
  title   String              @db.VarChar(200)
  message String              @db.Text
  data    Json                @default("{}")
  channel NotificationChannel @default(IN_APP)

  readAt    DateTime? @map("read_at")
  sentAt    DateTime? @map("sent_at")
  createdAt DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([readAt])
  @@index([createdAt])
  @@map("notifications")
}

enum NotificationType {
  JOB_POSTED
  BID_RECEIVED
  BID_ACCEPTED
  BID_REJECTED
  CONTRACT_STARTED
  CONTRACT_COMPLETED
  MILESTONE_COMPLETED
  PAYMENT_RECEIVED
  PAYMENT_SENT
  MESSAGE_RECEIVED
  REVIEW_RECEIVED
  SYSTEM
  // Security/Kill Switch notifications
  ACCESS_REVOKED
  ACCESS_REINSTATED
  KILL_SWITCH_EXECUTED
  SECURITY_ALERT
}

enum NotificationChannel {
  IN_APP
  EMAIL
  PUSH
  SMS
}

// ============================================================================
// AUDIT LOG
// ============================================================================

model AuditLog {
  id         String  @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId     String? @map("user_id") @db.Uuid
  action     String  @db.VarChar(100)
  entityType String  @map("entity_type") @db.VarChar(100)
  entityId   String? @map("entity_id") @db.Uuid

  // Change data
  oldValues Json? @map("old_values")
  newValues Json? @map("new_values")

  // Context
  ipAddress String? @map("ip_address") @db.VarChar(45)
  userAgent String? @map("user_agent") @db.VarChar(500)
  metadata  Json    @default("{}")

  createdAt DateTime @default(now()) @map("created_at")

  user User? @relation("UserAuditLogs", fields: [userId], references: [id])

  @@index([userId])
  @@index([entityType, entityId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================================================
// PRODUCTS & PRICING
// ============================================================================

model Product {
  id              String      @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  stripeProductId String      @unique @map("stripe_product_id") @db.VarChar(100)

  // Product details
  name        String      @db.VarChar(200)
  slug        String      @unique @db.VarChar(100)
  description String?     @db.Text
  productType ProductType @map("product_type")

  // Features (list of features for display)
  features Json? @default("[]")

  // Limits (plan-specific limits like hours, clients, etc.)
  limits Json? @default("{}")

  // Status
  isActive Boolean @default(true) @map("is_active")
  sortOrder Int     @default(0) @map("sort_order")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  prices        Price[]
  subscriptions Subscription[]

  @@index([productType])
  @@index([isActive])
  @@index([slug])
  @@map("products")
}

model Price {
  id            String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  productId     String @map("product_id") @db.Uuid
  stripePriceId String @unique @map("stripe_price_id") @db.VarChar(100)

  // Pricing details
  nickname   String?           @db.VarChar(100) // "Pro Monthly", "Enterprise Annual"
  unitAmount Decimal           @map("unit_amount") @db.Decimal(10, 2)
  currency   String            @default("USD") @db.VarChar(3)

  // Billing cycle
  billingInterval     PriceBillingInterval @map("billing_interval")
  intervalCount       Int                  @default(1) @map("interval_count")

  // Tier information
  tier PriceTier

  // Trial
  trialPeriodDays Int? @map("trial_period_days")

  // Usage-based pricing
  usageType     PriceUsageType? @map("usage_type")
  tieredPricing Json?           @map("tiered_pricing") // For usage tiers

  // Seat-based pricing
  isPerSeat           Boolean  @default(false) @map("is_per_seat")
  includedSeats       Int?     @map("included_seats")
  maxSeats            Int?     @map("max_seats")
  additionalSeatPrice Decimal? @map("additional_seat_price") @db.Decimal(10, 2)

  // Features specific to this price tier
  features Json? @default("[]")

  // Limits specific to this price tier
  limits Json? @default("{}")

  // Display
  isPopular     Boolean @default(false) @map("is_popular")
  isRecommended Boolean @default(false) @map("is_recommended")

  // Status
  isActive  Boolean @default(true) @map("is_active")
  sortOrder Int     @default(0) @map("sort_order")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  product       Product        @relation(fields: [productId], references: [id])
  subscriptions Subscription[]

  @@index([productId])
  @@index([tier])
  @@index([isActive])
  @@map("prices")
}

enum ProductType {
  SKILLPOD
  COCKPIT
  MARKET_PREMIUM
}

enum PriceBillingInterval {
  MONTH
  YEAR
}

enum PriceTier {
  FREE
  STARTER
  BASIC
  PRO
  PROFESSIONAL
  ENTERPRISE
}

enum PriceUsageType {
  METERED    // Pay for what you use
  LICENSED   // Fixed quantity
}

// ============================================================================
// COUPONS & DISCOUNTS
// ============================================================================

model Coupon {
  id             String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  stripeCouponId String @unique @map("stripe_coupon_id") @db.VarChar(100)

  // Coupon details
  code        String     @unique @db.VarChar(50)
  name        String     @db.VarChar(200)
  description String?    @db.Text

  // Discount type
  discountType CouponDiscountType @map("discount_type")
  amountOff    Decimal?           @map("amount_off") @db.Decimal(10, 2)
  percentOff   Decimal?           @map("percent_off") @db.Decimal(5, 2)
  currency     String?            @db.VarChar(3)

  // Duration
  duration       CouponDuration
  durationMonths Int?           @map("duration_months")

  // Restrictions
  maxRedemptions    Int?      @map("max_redemptions")
  currentRedemptions Int      @default(0) @map("current_redemptions")
  validProductTypes  String[] @default([]) @map("valid_product_types") // Restrict to specific products
  minimumAmount     Decimal?  @map("minimum_amount") @db.Decimal(10, 2)

  // Validity
  validFrom DateTime  @default(now()) @map("valid_from")
  validUntil DateTime? @map("valid_until")
  isActive  Boolean   @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  redemptions CouponRedemption[]

  @@index([code])
  @@index([isActive])
  @@index([validUntil])
  @@map("coupons")
}

model CouponRedemption {
  id       String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  couponId String @map("coupon_id") @db.Uuid
  userId   String @map("user_id") @db.Uuid

  // Redemption context
  subscriptionId String? @map("subscription_id") @db.Uuid

  // Discount applied
  discountAmount Decimal @map("discount_amount") @db.Decimal(10, 2)
  currency       String  @db.VarChar(3)

  redeemedAt DateTime @default(now()) @map("redeemed_at")

  coupon Coupon @relation(fields: [couponId], references: [id])

  @@unique([couponId, userId, subscriptionId])
  @@index([userId])
  @@index([subscriptionId])
  @@map("coupon_redemptions")
}

enum CouponDiscountType {
  PERCENT
  AMOUNT
}

enum CouponDuration {
  ONCE
  REPEATING
  FOREVER
}

// ============================================================================
// SUBSCRIPTIONS
// ============================================================================

model Subscription {
  id       String  @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId   String  @map("user_id") @db.Uuid
  tenantId String? @map("tenant_id") @db.Uuid

  // Product reference (new - links to Product/Price catalog)
  productId String? @map("product_id") @db.Uuid
  priceId   String? @map("price_id") @db.Uuid

  // Stripe references
  stripeSubscriptionId String  @unique @map("stripe_subscription_id") @db.VarChar(100)
  stripeCustomerId     String  @map("stripe_customer_id") @db.VarChar(100)
  stripePriceId        String  @map("stripe_price_id") @db.VarChar(100)
  stripeProductId      String? @map("stripe_product_id") @db.VarChar(100)

  // Plan details
  product         SubscriptionProduct
  plan            String              @db.VarChar(50) // 'starter', 'professional', 'enterprise'
  billingInterval BillingInterval     @map("billing_interval")

  // Status
  status             SubscriptionStatus
  trialStart         DateTime?          @map("trial_start")
  trialEndsAt        DateTime?          @map("trial_ends_at")
  currentPeriodStart DateTime           @map("current_period_start")
  currentPeriodEnd   DateTime           @map("current_period_end")
  cancelAt           DateTime?          @map("cancel_at")
  canceledAt         DateTime?          @map("canceled_at")
  cancellationReason String?            @map("cancellation_reason") @db.VarChar(500)
  endedAt            DateTime?          @map("ended_at")

  // Seats (for team subscriptions)
  quantity Int @default(1)

  // Pause support
  pausedAt DateTime? @map("paused_at")
  resumeAt DateTime? @map("resume_at")

  // Pending changes (for scheduled downgrades)
  pendingPlan     String?   @map("pending_plan") @db.VarChar(50)
  pendingPriceId  String?   @map("pending_price_id") @db.VarChar(100)
  pendingChangeAt DateTime? @map("pending_change_at")

  // Usage tracking (for SkillPod)
  usageThisPeriod Int  @default(0) @map("usage_this_period") // minutes
  usageLimit      Int? @map("usage_limit") // minutes per period, null = unlimited

  // Pricing info (for display/history)
  unitAmount Int?   @map("unit_amount") // cents
  currency   String @default("usd") @db.VarChar(3)

  // Metadata
  metadata Json @default("{}")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user                 User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant               Tenant?               @relation(fields: [tenantId], references: [id])
  productRef           Product?              @relation(fields: [productId], references: [id])
  priceRef             Price?                @relation(fields: [priceId], references: [id])
  subscriptionInvoices SubscriptionInvoice[]
  usageRecords         UsageRecord[]

  @@index([userId])
  @@index([tenantId])
  @@index([productId])
  @@index([priceId])
  @@index([stripeSubscriptionId])
  @@index([stripeCustomerId])
  @@index([status])
  @@index([product])
  @@index([currentPeriodEnd])
  @@map("subscriptions")
}

model SubscriptionInvoice {
  id              String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  subscriptionId  String @map("subscription_id") @db.Uuid
  stripeInvoiceId String @unique @map("stripe_invoice_id") @db.VarChar(100)

  // Invoice details
  number          String?                   @db.VarChar(100)
  amountDue       Int                       @map("amount_due") // cents
  amountPaid      Int                       @default(0) @map("amount_paid") // cents
  amountRemaining Int                       @default(0) @map("amount_remaining") // cents
  subtotal        Int                       @default(0) // cents
  tax             Int                       @default(0) // cents
  total           Int                       @default(0) // cents
  currency        String                    @default("usd") @db.VarChar(3)
  status          SubscriptionInvoiceStatus

  // Billing period
  periodStart DateTime @map("period_start")
  periodEnd   DateTime @map("period_end")

  // URLs for customer access
  pdfUrl           String? @map("pdf_url") @db.VarChar(500)
  hostedInvoiceUrl String? @map("hosted_invoice_url") @db.VarChar(500)

  // Line items (for detailed breakdown)
  lineItems Json @default("[]") @map("line_items")

  // Payment info
  attemptCount       Int       @default(0) @map("attempt_count")
  nextPaymentAttempt DateTime? @map("next_payment_attempt")

  // Timestamps
  paidAt    DateTime? @map("paid_at")
  voidedAt  DateTime? @map("voided_at")
  dueDate   DateTime? @map("due_date")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([stripeInvoiceId])
  @@index([status])
  @@index([paidAt])
  @@map("subscription_invoices")
}

model UsageRecord {
  id             String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  subscriptionId String @map("subscription_id") @db.Uuid

  // Usage details
  quantity  Int // minutes used
  action    UsageAction // 'increment' or 'set'
  timestamp DateTime

  // Metadata for tracking source
  sessionId   String? @map("session_id") @db.VarChar(100)
  podId       String? @map("pod_id") @db.VarChar(100)
  description String? @db.VarChar(500)

  // Stripe metered billing reference
  stripeUsageRecordId String? @map("stripe_usage_record_id") @db.VarChar(100)

  createdAt DateTime @default(now()) @map("created_at")

  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([subscriptionId, timestamp])
  @@index([timestamp])
  @@map("usage_records")
}

enum SubscriptionProduct {
  SKILLPOD
  COCKPIT
}

enum BillingInterval {
  MONTHLY
  ANNUAL
}

enum SubscriptionStatus {
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
  UNPAID
  INCOMPLETE
  INCOMPLETE_EXPIRED
  PAUSED
}

enum SubscriptionInvoiceStatus {
  DRAFT
  OPEN
  PAID
  VOID
  UNCOLLECTIBLE
}

enum UsageAction {
  INCREMENT
  SET
}

// ============================================================================
// AUDIT LOGGING (Analytics & Export tracked in PostgreSQL)
// ============================================================================

model AuditAnalytics {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  periodStart DateTime @map("period_start")
  periodEnd   DateTime @map("period_end")
  metricType  String   @map("metric_type") @db.VarChar(100)
  dimensions  Json     @default("{}")
  value       Decimal  @db.Decimal(20, 4)
  metadata    Json     @default("{}")
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([metricType])
  @@index([periodStart, periodEnd])
  @@index([metricType, periodStart])
  @@map("audit_analytics")
}

model AuditExport {
  id            String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  status        String    @db.VarChar(50)
  requestedBy   String    @map("requested_by") @db.VarChar(100)
  filters       Json      @default("{}")
  format        String    @db.VarChar(20)
  includeFields String[]  @map("include_fields")
  fileUrl       String?   @map("file_url") @db.VarChar(500)
  fileSize      Int?      @map("file_size")
  recordCount   Int?      @map("record_count")
  errorMessage  String?   @map("error_message") @db.Text
  startedAt     DateTime? @map("started_at")
  completedAt   DateTime? @map("completed_at")
  expiresAt     DateTime? @map("expires_at")
  createdAt     DateTime  @default(now()) @map("created_at")

  @@index([status])
  @@index([requestedBy])
  @@index([createdAt])
  @@map("audit_exports")
}

model AuditBaseline {
  id           String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  actorId      String   @map("actor_id") @db.VarChar(100)
  eventType    String   @map("event_type") @db.VarChar(100)
  avgCount     Decimal  @map("avg_count") @db.Decimal(10, 2)
  stdDev       Decimal  @map("std_dev") @db.Decimal(10, 2)
  minCount     Int      @map("min_count")
  maxCount     Int      @map("max_count")
  sampleSize   Int      @map("sample_size")
  calculatedAt DateTime @default(now()) @map("calculated_at")

  @@unique([actorId, eventType])
  @@index([actorId])
  @@index([eventType])
  @@map("audit_baselines")
}

// ============================================================================
// ESCROW SYSTEM
// ============================================================================

model EscrowTransaction {
  id          String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  contractId  String @map("contract_id") @db.Uuid
  milestoneId String? @map("milestone_id") @db.Uuid

  // Transaction type
  type   EscrowTransactionType
  status EscrowTransactionStatus @default(PENDING)

  // Amounts
  grossAmount   Decimal @map("gross_amount") @db.Decimal(12, 2)
  platformFee   Decimal @map("platform_fee") @db.Decimal(12, 2)
  processingFee Decimal @map("processing_fee") @db.Decimal(12, 2)
  netAmount     Decimal @map("net_amount") @db.Decimal(12, 2)
  currency      String  @default("USD") @db.VarChar(3)

  // Stripe references
  stripePaymentIntentId String? @map("stripe_payment_intent_id") @db.VarChar(100)
  stripeTransferId      String? @map("stripe_transfer_id") @db.VarChar(100)
  stripeChargeId        String? @map("stripe_charge_id") @db.VarChar(100)
  stripeRefundId        String? @map("stripe_refund_id") @db.VarChar(100)

  // User references
  fromUserId String  @map("from_user_id") @db.Uuid
  toUserId   String? @map("to_user_id") @db.Uuid

  // Metadata
  description    String? @db.VarChar(500)
  metadata       Json?
  failureCode    String? @map("failure_code") @db.VarChar(50)
  failureMessage String? @map("failure_message") @db.Text

  // Timestamps
  processedAt DateTime? @map("processed_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  contract  Contract   @relation(fields: [contractId], references: [id])
  milestone Milestone? @relation(fields: [milestoneId], references: [id])

  @@index([contractId])
  @@index([milestoneId])
  @@index([status])
  @@index([type])
  @@index([fromUserId])
  @@index([toUserId])
  @@map("escrow_transactions")
}

model EscrowBalance {
  id         String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  contractId String @unique @map("contract_id") @db.Uuid

  // Balance tracking
  totalFunded    Decimal @default(0) @map("total_funded") @db.Decimal(12, 2)
  totalReleased  Decimal @default(0) @map("total_released") @db.Decimal(12, 2)
  totalRefunded  Decimal @default(0) @map("total_refunded") @db.Decimal(12, 2)
  currentBalance Decimal @default(0) @map("current_balance") @db.Decimal(12, 2)
  frozenAmount   Decimal @default(0) @map("frozen_amount") @db.Decimal(12, 2)
  currency       String  @default("USD") @db.VarChar(3)

  // Status
  status EscrowBalanceStatus @default(ACTIVE)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  contract Contract @relation(fields: [contractId], references: [id])

  @@map("escrow_balances")
}

model TimeLog {
  id         String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  contractId String @map("contract_id") @db.Uuid

  // Time entry
  description String?  @db.VarChar(500)
  startTime   DateTime @map("start_time")
  endTime     DateTime? @map("end_time")
  duration    Int?     // Minutes

  // Billing
  hourlyRate Decimal  @map("hourly_rate") @db.Decimal(10, 2)
  amount     Decimal? @db.Decimal(10, 2)

  // Status
  status TimeLogStatus @default(PENDING)

  // Approval
  approvedAt DateTime? @map("approved_at")
  approvedBy String?   @map("approved_by") @db.Uuid
  rejectedAt DateTime? @map("rejected_at")
  rejectionReason String? @map("rejection_reason") @db.VarChar(500)

  // SkillPod tracking
  skillpodSessionId String?  @map("skillpod_session_id") @db.Uuid
  isVerified        Boolean  @default(false) @map("is_verified")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  contract Contract @relation(fields: [contractId], references: [id])

  @@index([contractId])
  @@index([status])
  @@index([startTime])
  @@map("time_logs")
}

model Dispute {
  id          String  @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  contractId  String  @map("contract_id") @db.Uuid
  milestoneId String? @map("milestone_id") @db.Uuid

  // Dispute details
  raisedBy     String        @map("raised_by") @db.Uuid
  reason       DisputeReason
  description  String        @db.Text
  evidenceUrls String[]      @default([]) @map("evidence_urls")

  // Amounts in dispute
  disputedAmount Decimal @map("disputed_amount") @db.Decimal(12, 2)
  currency       String  @default("USD") @db.VarChar(3)

  // Status
  status DisputeStatus @default(OPEN)

  // Resolution
  resolvedBy             String?            @map("resolved_by") @db.Uuid
  resolution             DisputeResolution?
  resolutionNotes        String?            @map("resolution_notes") @db.Text
  clientRefundAmount     Decimal?           @map("client_refund_amount") @db.Decimal(12, 2)
  freelancerPayoutAmount Decimal?           @map("freelancer_payout_amount") @db.Decimal(12, 2)

  // Timeline
  respondBy   DateTime? @map("respond_by")
  respondedAt DateTime? @map("responded_at")
  escalatedAt DateTime? @map("escalated_at")
  resolvedAt  DateTime? @map("resolved_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  contract Contract         @relation(fields: [contractId], references: [id])
  messages DisputeMessage[]

  @@index([contractId])
  @@index([milestoneId])
  @@index([status])
  @@index([raisedBy])
  @@map("disputes")
}

model DisputeMessage {
  id        String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  disputeId String @map("dispute_id") @db.Uuid

  senderId   String      @map("sender_id") @db.Uuid
  senderRole DisputeRole @map("sender_role")

  message        String   @db.Text
  attachmentUrls String[] @default([]) @map("attachment_urls")

  // Proposed resolution (optional)
  proposedResolution     DisputeResolution? @map("proposed_resolution")
  proposedClientAmount   Decimal?           @map("proposed_client_amount") @db.Decimal(12, 2)
  proposedFreelancerAmount Decimal?         @map("proposed_freelancer_amount") @db.Decimal(12, 2)

  createdAt DateTime @default(now()) @map("created_at")

  dispute Dispute @relation(fields: [disputeId], references: [id])

  @@index([disputeId])
  @@index([senderId])
  @@map("dispute_messages")
}

enum EscrowTransactionType {
  FUND            // Client funds escrow
  RELEASE         // Release to freelancer
  REFUND          // Refund to client
  PARTIAL_RELEASE // Partial release (dispute resolution)
  PARTIAL_REFUND  // Partial refund (dispute resolution)
  FEE_DEDUCTION   // Platform fee deduction
}

enum EscrowTransactionStatus {
  PENDING
  PROCESSING
  REQUIRES_CAPTURE
  COMPLETED
  FAILED
  CANCELLED
}

enum EscrowBalanceStatus {
  ACTIVE
  FROZEN   // Dispute in progress
  CLOSED
}

enum TimeLogStatus {
  PENDING
  APPROVED
  REJECTED
  BILLED
  DISPUTED
}

enum DisputeReason {
  QUALITY_ISSUES
  MISSED_DEADLINE
  SCOPE_DISAGREEMENT
  COMMUNICATION_ISSUES
  NON_DELIVERY
  PAYMENT_ISSUE
  WORK_NOT_AS_DESCRIBED
  OTHER
}

enum DisputeStatus {
  OPEN
  RESPONDED
  UNDER_REVIEW
  ESCALATED
  RESOLVED
  CLOSED
}

enum DisputeResolution {
  FULL_REFUND
  PARTIAL_REFUND
  FULL_RELEASE
  PARTIAL_RELEASE
  SPLIT
  CANCELLED
}

enum DisputeRole {
  CLIENT
  FREELANCER
  MEDIATOR
  SYSTEM
}

// ============================================================================
// HIPAA COMPLIANCE
// ============================================================================

model HipaaCompliance {
  id       String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId String @unique @map("tenant_id") @db.Uuid

  // Compliance status
  hipaaEnabled    Boolean              @default(false) @map("hipaa_enabled")
  complianceLevel HipaaComplianceLevel @default(NONE) @map("compliance_level")

  // BAA (Business Associate Agreement)
  baaStatus      BaaStatus @default(NOT_REQUESTED) @map("baa_status")
  baaSignedAt    DateTime? @map("baa_signed_at")
  baaExpiresAt   DateTime? @map("baa_expires_at")
  baaDocumentUrl String?   @map("baa_document_url")

  // Security controls
  encryptionEnabled Boolean @default(true) @map("encryption_enabled")
  encryptionKeyId   String? @map("encryption_key_id")

  // Access controls
  mfaRequired    Boolean  @default(true) @map("mfa_required")
  sessionTimeout Int      @default(15) @map("session_timeout") // Minutes
  ipWhitelist    String[] @map("ip_whitelist")

  // Audit settings
  enhancedAuditEnabled Boolean @default(true) @map("enhanced_audit_enabled")
  auditRetentionYears  Int     @default(6) @map("audit_retention_years")

  // Training
  trainingRequired Boolean @default(true) @map("training_required")

  // Assessment
  lastAssessmentAt  DateTime? @map("last_assessment_at")
  nextAssessmentDue DateTime? @map("next_assessment_due")
  assessmentScore   Int?      @map("assessment_score")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant        Tenant         @relation(fields: [tenantId], references: [id])
  phiAccessLogs PhiAccessLog[]

  @@map("hipaa_compliance")
}

model PhiAccessLog {
  id                String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  hipaaComplianceId String @map("hipaa_compliance_id") @db.Uuid

  // Access details
  userId     String        @map("user_id") @db.Uuid
  accessType PhiAccessType @map("access_type")

  // PHI details (no actual PHI stored)
  phiCategory PhiCategory @map("phi_category")
  recordCount Int         @map("record_count")
  purpose     String      // Business justification

  // Context
  resourceType String  @map("resource_type")
  resourceId   String? @map("resource_id")

  // Location
  ipAddress String? @map("ip_address")
  location  String?

  // SkillPod context
  skillpodSessionId String? @map("skillpod_session_id") @db.Uuid

  timestamp DateTime @default(now())

  hipaaCompliance HipaaCompliance @relation(fields: [hipaaComplianceId], references: [id])
  user            User            @relation(fields: [userId], references: [id])

  @@index([hipaaComplianceId])
  @@index([userId])
  @@index([timestamp])
  @@map("phi_access_logs")
}

model HipaaTraining {
  id       String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId   String @map("user_id") @db.Uuid
  tenantId String @map("tenant_id") @db.Uuid

  // Training details
  trainingType    HipaaTrainingType @map("training_type")
  trainingVersion String            @map("training_version")

  // Completion
  status      TrainingStatus @default(NOT_STARTED)
  startedAt   DateTime?      @map("started_at")
  completedAt DateTime?      @map("completed_at")

  // Assessment
  quizScore    Int?    @map("quiz_score")
  passingScore Int     @default(80) @map("passing_score")
  passed       Boolean @default(false)

  // Certificate
  certificateUrl String?   @map("certificate_url")
  expiresAt      DateTime? @map("expires_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, tenantId, trainingType])
  @@index([userId])
  @@index([tenantId])
  @@map("hipaa_training")
}

model BreachIncident {
  id       String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId String @map("tenant_id") @db.Uuid

  // Incident details
  incidentType BreachIncidentType @map("incident_type")
  severity     BreachSeverity
  description  String             @db.Text

  // Discovery
  discoveredAt DateTime @map("discovered_at")
  discoveredBy String   @map("discovered_by") @db.Uuid

  // Scope
  affectedRecords Int?          @map("affected_records")
  affectedUsers   Int?          @map("affected_users")
  phiInvolved     Boolean       @default(false) @map("phi_involved")
  phiCategories   PhiCategory[] @map("phi_categories")

  // Response
  status      BreachStatus @default(INVESTIGATING)
  containedAt DateTime?    @map("contained_at")
  resolvedAt  DateTime?    @map("resolved_at")

  // Notifications
  hhsNotified        Boolean   @default(false) @map("hhs_notified")
  hhsNotifiedAt      DateTime? @map("hhs_notified_at")
  affectedNotified   Boolean   @default(false) @map("affected_notified")
  affectedNotifiedAt DateTime? @map("affected_notified_at")

  // Investigation
  rootCause          String? @map("root_cause") @db.Text
  remediation        String? @db.Text
  preventiveMeasures String? @map("preventive_measures") @db.Text

  // Documentation
  reportUrl String? @map("report_url")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant   Tenant            @relation(fields: [tenantId], references: [id])
  timeline BreachTimeline[]

  @@index([tenantId])
  @@index([status])
  @@map("breach_incidents")
}

model BreachTimeline {
  id               String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  breachIncidentId String @map("breach_incident_id") @db.Uuid

  action      String
  description String?  @db.Text
  performedBy String   @map("performed_by") @db.Uuid
  timestamp   DateTime @default(now())

  breachIncident BreachIncident @relation(fields: [breachIncidentId], references: [id])

  @@index([breachIncidentId])
  @@map("breach_timeline")
}

model PhiToken {
  id       String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId String @map("tenant_id") @db.Uuid

  token          String       @unique
  valueHash      String       @map("value_hash")
  encryptedValue Json         @map("encrypted_value")
  type           PhiFieldType
  resourceType   String?      @map("resource_type")
  resourceId     String?      @map("resource_id")

  createdAt DateTime @default(now()) @map("created_at")
  expiresAt DateTime? @map("expires_at")

  @@index([tenantId])
  @@index([valueHash])
  @@map("phi_tokens")
}

enum HipaaComplianceLevel {
  NONE
  BASIC // Awareness training completed
  STANDARD // BAA signed, controls implemented
  ENHANCED // Full compliance, audited
}

enum BaaStatus {
  NOT_REQUESTED
  REQUESTED
  UNDER_REVIEW
  SIGNED
  EXPIRED
  TERMINATED
}

enum PhiAccessType {
  VIEW
  CREATE
  UPDATE
  DELETE
  EXPORT
  SHARE
}

enum PhiCategory {
  DEMOGRAPHIC // Name, address, DOB
  MEDICAL_RECORD // Diagnoses, treatments
  BILLING // Insurance, payment info
  GENETIC // Genetic test results
  MENTAL_HEALTH // Mental health records
  SUBSTANCE_ABUSE // Substance abuse records
  HIV_AIDS // HIV/AIDS information
  OTHER
}

enum HipaaTrainingType {
  AWARENESS // Basic HIPAA awareness
  SECURITY // Security rule training
  PRIVACY // Privacy rule training
  BREACH // Breach notification
  ANNUAL_REFRESH // Annual refresher
}

enum TrainingStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  EXPIRED
}

enum BreachIncidentType {
  UNAUTHORIZED_ACCESS
  DATA_THEFT
  LOST_DEVICE
  HACKING
  IMPROPER_DISPOSAL
  UNAUTHORIZED_DISCLOSURE
  OTHER
}

enum BreachSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum BreachStatus {
  INVESTIGATING
  CONTAINED
  NOTIFYING
  RESOLVED
  CLOSED
}

enum PhiFieldType {
  SSN
  DOB
  PHONE
  EMAIL
  NAME
  ADDRESS
  MEDICAL_RECORD
  INSURANCE_ID
  OTHER
}

// ============================================================================
// KILL SWITCH SYSTEM
// ============================================================================

model KillSwitchEvent {
  id String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid

  // Scope
  scope     KillSwitchScope
  tenantId  String?         @map("tenant_id") @db.Uuid
  userId    String?         @map("user_id") @db.Uuid
  podId     String?         @map("pod_id") @db.Uuid
  sessionId String?         @map("session_id") @db.Uuid

  // Trigger info
  triggeredBy    String           @map("triggered_by") @db.Uuid
  triggerReason  KillSwitchReason @map("trigger_reason")
  triggerDetails String?          @map("trigger_details") @db.Text

  // Execution status
  status KillSwitchStatus @default(PENDING)

  // Timing
  initiatedAt     DateTime  @default(now()) @map("initiated_at")
  completedAt     DateTime? @map("completed_at")
  executionTimeMs Int?      @map("execution_time_ms")

  // Results
  sessionsTerminated  Int     @default(0) @map("sessions_terminated")
  tokensRevoked       Int     @default(0) @map("tokens_revoked")
  cachePurged         Boolean @default(false) @map("cache_purged")
  recordingsPreserved Boolean @default(false) @map("recordings_preserved")

  // Error tracking
  errors Json?

  // Metadata
  metadata Json?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  actions     KillSwitchAction[]
  revocations AccessRevocation[]

  @@index([tenantId])
  @@index([userId])
  @@index([status])
  @@index([initiatedAt])
  @@map("kill_switch_events")
}

model KillSwitchAction {
  id                String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  killSwitchEventId String @map("kill_switch_event_id") @db.Uuid

  // Action details
  actionType KillSwitchActionType @map("action_type")
  target     String // Session ID, Pod ID, etc.
  targetType String               @map("target_type")

  // Status
  status KillSwitchActionStatus @default(PENDING)

  // Timing
  startedAt   DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")

  // Error handling
  errorMessage String? @map("error_message")
  retryCount   Int     @default(0) @map("retry_count")

  createdAt DateTime @default(now()) @map("created_at")

  killSwitchEvent KillSwitchEvent @relation(fields: [killSwitchEventId], references: [id])

  @@index([killSwitchEventId])
  @@map("kill_switch_actions")
}

model AccessRevocation {
  id String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid

  // Target
  tenantId String? @map("tenant_id") @db.Uuid
  userId   String  @map("user_id") @db.Uuid

  // Revocation details
  revokedBy String @map("revoked_by") @db.Uuid
  reason    String

  // Scope
  scope RevocationScope

  // Status
  isActive  Boolean   @default(true) @map("is_active")
  expiresAt DateTime? @map("expires_at")

  // Reinstatement
  reinstatedBy    String?   @map("reinstated_by") @db.Uuid
  reinstatedAt    DateTime? @map("reinstated_at")
  reinstateReason String?   @map("reinstate_reason")

  // Related kill switch
  killSwitchEventId String? @map("kill_switch_event_id") @db.Uuid

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  killSwitchEvent KillSwitchEvent? @relation(fields: [killSwitchEventId], references: [id])

  @@index([userId])
  @@index([tenantId])
  @@index([isActive])
  @@map("access_revocations")
}

enum KillSwitchScope {
  TENANT // All users in a tenant
  USER // Specific user across all pods
  POD // Specific pod
  SESSION // Specific session
}

enum KillSwitchReason {
  CONTRACT_TERMINATION
  SECURITY_INCIDENT
  POLICY_VIOLATION
  DATA_BREACH_SUSPECTED
  UNAUTHORIZED_ACCESS
  MANUAL_TERMINATION
  SCHEDULED_END
  COMPLIANCE_REQUIREMENT
}

enum KillSwitchStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  PARTIAL_FAILURE
  FAILED
}

enum KillSwitchActionType {
  TERMINATE_SESSION
  TERMINATE_POD
  REVOKE_TOKENS
  PURGE_CACHE
  PRESERVE_RECORDINGS
  NOTIFY_USER
  NOTIFY_ADMIN
  BLOCK_RECONNECTION
}

enum KillSwitchActionStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
  SKIPPED
}

enum RevocationScope {
  SKILLPOD_ONLY
  ALL_PRODUCTS
  TENANT_WIDE
}

// ============================================================================
// SESSION RECORDING SYSTEM
// ============================================================================

model SessionRecording {
  id                String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  sessionId         String   @map("session_id") @db.Uuid
  tenantId          String   @map("tenant_id") @db.Uuid
  userId            String   @map("user_id") @db.Uuid
  
  // Recording status
  status            RecordingStatus @default(RECORDING)
  
  // Storage
  storageLocation   String?  @map("storage_location") // S3 URI
  storageBucket     String?  @map("storage_bucket")
  storageKey        String?  @map("storage_key")
  encryptionKeyId   String?  @map("encryption_key_id") // KMS key ID
  
  // Recording details
  format            String   @default("webm")
  codec             String   @default("vp9")
  resolution        String?  // "1920x1080"
  frameRate         Int?     @map("frame_rate") // fps
  
  // Duration and size
  durationSeconds   Int?     @map("duration_seconds")
  fileSizeBytes     BigInt?  @map("file_size_bytes")
  
  // Timeline markers
  startedAt         DateTime @map("started_at")
  endedAt           DateTime? @map("ended_at")
  
  // Processing
  processingStatus  ProcessingStatus @default(PENDING) @map("processing_status")
  processedAt       DateTime? @map("processed_at")
  thumbnailUrl      String?  @map("thumbnail_url")
  
  // OCR/Search
  ocrStatus         OcrStatus @default(PENDING) @map("ocr_status")
  ocrCompletedAt    DateTime? @map("ocr_completed_at")
  
  // Retention
  retentionPolicy   String?  @map("retention_policy")
  expiresAt         DateTime? @map("expires_at")
  deletedAt         DateTime? @map("deleted_at")
  
  // Access tracking
  viewCount         Int      @default(0) @map("view_count")
  lastViewedAt      DateTime? @map("last_viewed_at")
  lastViewedBy      String?  @map("last_viewed_by") @db.Uuid
  
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  // Relations
  session           Session  @relation(fields: [sessionId], references: [id])
  tenant            Tenant   @relation(fields: [tenantId], references: [id])
  user              User     @relation(fields: [userId], references: [id])
  chunks            RecordingChunk[]
  markers           RecordingMarker[]
  accessLogs        RecordingAccessLog[]
  ocrFrames         RecordingOcrFrame[]
  
  @@map("session_recordings")
  @@index([sessionId])
  @@index([tenantId])
  @@index([userId])
  @@index([status])
  @@index([expiresAt])
}

model RecordingChunk {
  id                String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  recordingId       String   @map("recording_id") @db.Uuid
  
  // Chunk details
  chunkIndex        Int      @map("chunk_index")
  startOffset       Int      @map("start_offset") // seconds from recording start
  durationSeconds   Int      @map("duration_seconds")
  
  // Storage
  storageKey        String   @map("storage_key")
  fileSizeBytes     Int      @map("file_size_bytes")
  
  // Status
  uploadedAt        DateTime @map("uploaded_at")
  
  createdAt         DateTime @default(now()) @map("created_at")
  
  recording         SessionRecording @relation(fields: [recordingId], references: [id])
  
  @@map("recording_chunks")
  @@unique([recordingId, chunkIndex])
  @@index([recordingId])
}

model RecordingMarker {
  id                String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  recordingId       String   @map("recording_id") @db.Uuid
  
  // Marker details
  markerType        MarkerType @map("marker_type")
  timestamp         Int      // seconds from recording start
  
  // Metadata
  label             String? 
  description       String?
  metadata          Json?
  
  // Auto-detected markers
  isAutoDetected    Boolean  @default(false) @map("is_auto_detected")
  detectionSource   String?  @map("detection_source")
  confidence        Decimal? @db.Decimal(3, 2)
  
  // User-added markers
  createdBy         String?  @map("created_by") @db.Uuid
  
  createdAt         DateTime @default(now()) @map("created_at")
  
  recording         SessionRecording @relation(fields: [recordingId], references: [id])
  
  @@map("recording_markers")
  @@index([recordingId])
  @@index([markerType])
  @@index([timestamp])
}

model RecordingOcrFrame {
  id                String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  recordingId       String   @map("recording_id") @db.Uuid
  
  // Frame details
  timestamp         Int      // seconds from recording start
  frameNumber       Int      @map("frame_number")
  
  // OCR results
  extractedText     String   @map("extracted_text") @db.Text
  textConfidence    Decimal  @map("text_confidence") @db.Decimal(3, 2)
  
  // Regions of interest
  textRegions       Json?    @map("text_regions") // [{x, y, width, height, text}]
  
  // Indexing
  elasticsearchId   String?  @map("elasticsearch_id")
  indexedAt         DateTime? @map("indexed_at")
  
  createdAt         DateTime @default(now()) @map("created_at")
  
  recording         SessionRecording @relation(fields: [recordingId], references: [id])
  
  @@map("recording_ocr_frames")
  @@index([recordingId])
  @@index([timestamp])
}

model RecordingAccessLog {
  id                String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  recordingId       String   @map("recording_id") @db.Uuid
  
  // Access details
  accessType        RecordingAccessType @map("access_type")
  accessedBy        String   @map("accessed_by") @db.Uuid
  
  // Context
  ipAddress         String?  @map("ip_address")
  userAgent         String?  @map("user_agent")
  
  // Playback details
  playbackStartTime Int?     @map("playback_start_time") // seconds
  playbackEndTime   Int?     @map("playback_end_time")
  playbackDuration  Int?     @map("playback_duration")
  
  // Purpose
  accessReason      String?  @map("access_reason")
  
  createdAt         DateTime @default(now()) @map("created_at")
  
  recording         SessionRecording @relation(fields: [recordingId], references: [id])
  accessedByUser    User     @relation(fields: [accessedBy], references: [id])
  
  @@map("recording_access_logs")
  @@index([recordingId])
  @@index([accessedBy])
  @@index([createdAt])
}

model RecordingRetentionPolicy {
  id                String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId          String   @map("tenant_id") @db.Uuid
  
  // Policy details
  name              String
  description       String?
  isDefault         Boolean  @default(false) @map("is_default")
  
  // Retention settings
  retentionDays     Int      @map("retention_days")
  
  // Compliance tags
  complianceTags    String[] @map("compliance_tags") // ['SOC2', 'HIPAA']
  
  // Auto-delete
  autoDeleteEnabled Boolean  @default(true) @map("auto_delete_enabled")
  
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  tenant            Tenant   @relation(fields: [tenantId], references: [id])
  
  @@map("recording_retention_policies")
  @@unique([tenantId, name])
  @@index([tenantId])
}

enum RecordingStatus {
  RECORDING
  STOPPED
  PROCESSING
  COMPLETED
  FAILED
  DELETED
}

enum ProcessingStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum OcrStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  SKIPPED
}

enum MarkerType {
  SESSION_START
  SESSION_END
  APPLICATION_OPEN
  APPLICATION_CLOSE
  FILE_ACCESS
  CLIPBOARD_ACTIVITY
  IDLE_START
  IDLE_END
  SECURITY_EVENT
  USER_ADDED
  ERROR
}

enum RecordingAccessType {
  VIEW
  DOWNLOAD
  SHARE
  EXPORT
  DELETE
}

// ============================================================================
// DYNAMIC WATERMARKING SYSTEM
// ============================================================================

model WatermarkConfiguration {
  id                   String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId             String   @map("tenant_id") @db.Uuid
  
  // Configuration name
  name                 String   @db.VarChar(100)
  description          String?  @db.Text
  isDefault            Boolean  @default(false) @map("is_default")
  
  // Visible watermark settings
  visibleEnabled       Boolean  @default(true) @map("visible_enabled")
  visibleConfig        Json     @map("visible_config")
  // {
  //   pattern: 'TILED' | 'CORNER' | 'CENTER' | 'BORDER',
  //   content: ['USER_EMAIL', 'SESSION_ID', 'TIMESTAMP', 'CUSTOM_TEXT'],
  //   customText?: string,
  //   opacity: 0.15,
  //   fontSize: 14,
  //   fontFamily: 'Arial',
  //   fontColor: '#000000',
  //   backgroundColor?: string,
  //   rotation: -30,
  //   spacing: 200,
  //   margin: 20,
  //   includeCompanyLogo: boolean,
  //   logoUrl?: string
  // }
  
  // Invisible watermark settings
  invisibleEnabled     Boolean  @default(true) @map("invisible_enabled")
  invisibleConfig      Json     @map("invisible_config")
  // {
  //   method: 'LSB' | 'DCT' | 'DWT',
  //   strength: 'LOW' | 'MEDIUM' | 'HIGH',
  //   redundancy: 3,
  //   encodeFields: ['USER_ID', 'SESSION_ID', 'TENANT_ID', 'TIMESTAMP']
  // }
  
  // Application settings
  applyToScreenShare   Boolean  @default(true) @map("apply_to_screen_share")
  applyToRecordings    Boolean  @default(true) @map("apply_to_recordings")
  applyToExports       Boolean  @default(true) @map("apply_to_exports")
  
  // Exclusions
  excludedApplications String[] @map("excluded_applications")
  excludedUrls         String[] @map("excluded_urls")
  
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")
  
  // Relations
  tenant               Tenant   @relation(fields: [tenantId], references: [id])
  instances            WatermarkInstance[]
  
  @@map("watermark_configurations")
  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([isDefault])
}

model WatermarkInstance {
  id                String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  configurationId   String   @map("configuration_id") @db.Uuid
  sessionId         String   @map("session_id") @db.Uuid
  
  // Watermark payload
  payload           Json     // The actual data encoded in watermark
  // {
  //   userId: string,
  //   userEmail: string,
  //   sessionId: string,
  //   tenantId: string,
  //   podId: string,
  //   timestamp: string,
  //   sequenceNumber: number,
  //   ipAddress?: string
  // }
  
  // Encoding details
  visibleHash       String?  @map("visible_hash") @db.VarChar(64) // SHA-256 hash
  invisibleKey      String   @map("invisible_key") @db.VarChar(64) // Encryption key
  
  // Timestamps
  generatedAt       DateTime @map("generated_at")
  expiresAt         DateTime? @map("expires_at")
  
  // Status
  isActive          Boolean  @default(true) @map("is_active")
  
  createdAt         DateTime @default(now()) @map("created_at")
  
  // Relations
  configuration     WatermarkConfiguration @relation(fields: [configurationId], references: [id])
  session           Session @relation(fields: [sessionId], references: [id])
  detections        WatermarkDetection[]
  
  @@map("watermark_instances")
  @@index([sessionId])
  @@index([configurationId])
  @@index([invisibleKey])
  @@index([isActive])
}

model WatermarkDetection {
  id                   String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  
  // Detection source
  sourceType           DetectionSourceType @map("source_type")
  sourceUrl            String?  @map("source_url") @db.VarChar(2000)
  sourceDescription    String?  @map("source_description") @db.Text
  
  // Detected watermark
  watermarkInstanceId  String?  @map("watermark_instance_id") @db.Uuid
  detectedPayload      Json?    @map("detected_payload")
  
  // Detection confidence
  confidence           Decimal  @db.Decimal(5, 4) // 0.0000 to 1.0000
  detectionMethod      String   @map("detection_method") @db.VarChar(50)
  
  // Extracted information
  extractedUserId      String?  @map("extracted_user_id") @db.Uuid
  extractedSessionId   String?  @map("extracted_session_id") @db.Uuid
  extractedTimestamp   DateTime? @map("extracted_timestamp")
  
  // Image analysis
  imageHash            String?  @map("image_hash") @db.VarChar(64)
  imageDimensions      String?  @map("image_dimensions") @db.VarChar(20)
  manipulationDetected Boolean  @default(false) @map("manipulation_detected")
  manipulationTypes    String[] @map("manipulation_types")
  
  // Investigation
  investigationStatus  InvestigationStatus @default(PENDING) @map("investigation_status")
  investigatedBy       String?  @map("investigated_by") @db.Uuid
  investigationNotes   String?  @map("investigation_notes") @db.Text
  
  // Reporting
  reportedBy           String?  @map("reported_by") @db.Uuid
  reportedAt           DateTime? @map("reported_at")
  
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")
  
  // Relations
  watermarkInstance    WatermarkInstance? @relation(fields: [watermarkInstanceId], references: [id])
  
  @@map("watermark_detections")
  @@index([watermarkInstanceId])
  @@index([extractedUserId])
  @@index([extractedSessionId])
  @@index([investigationStatus])
  @@index([createdAt])
  @@index([sourceType])
}

enum DetectionSourceType {
  UPLOADED_IMAGE
  WEB_CRAWL
  MANUAL_REPORT
  AUTOMATED_SCAN
  THIRD_PARTY
}

enum InvestigationStatus {
  PENDING
  IN_PROGRESS
  CONFIRMED_LEAK
  FALSE_POSITIVE
  INCONCLUSIVE
  RESOLVED
}

// ============================================================================
// ENVIRONMENT MANAGEMENT - POD TEMPLATES & RESOURCE POOLS
// ============================================================================

model PodTemplate {
  id                     String           @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId               String?          @map("tenant_id") @db.Uuid // null = global template

  // Template identification
  name                   String           @db.VarChar(200)
  slug                   String           @db.VarChar(100)
  description            String?          @db.Text
  shortDescription       String?          @map("short_description") @db.VarChar(500)

  // Categorization
  category               TemplateCategory
  tags                   String[]

  // Base image
  baseImageId            String           @map("base_image_id") @db.Uuid
  kasmImageId            String?          @map("kasm_image_id") @db.VarChar(100) // Kasm registry ID
  ecrImageUri            String?          @map("ecr_image_uri") @db.VarChar(500) // ECR URI

  // Tools and software
  installedTools         Json             @map("installed_tools")
  // [{ name: 'VS Code', version: '1.85', category: 'IDE' }]

  // Configuration
  defaultConfig          Json             @default("{}") @map("default_config")
  // { theme: 'dark', extensions: [], settings: {} }

  // Resource defaults
  defaultResources       Json             @map("default_resources")
  // { cpu: 2, memory: 4096, storage: 50, gpu: false }

  // Constraints
  minResources           Json             @map("min_resources")
  maxResources           Json             @map("max_resources")

  // Startup configuration
  startupScript          String?          @map("startup_script") @db.Text
  environmentVars        Json?            @map("environment_vars")

  // Display
  iconUrl                String?          @map("icon_url") @db.VarChar(500)
  screenshotUrls         String[]         @map("screenshot_urls")
  documentationUrl       String?          @map("documentation_url") @db.VarChar(500)

  // Availability
  isPublic               Boolean          @default(false) @map("is_public")
  isActive               Boolean          @default(true) @map("is_active")
  isFeatured             Boolean          @default(false) @map("is_featured")

  // Versioning
  version                String           @default("1.0.0") @db.VarChar(20)
  changelog              String?          @db.Text

  // Usage tracking
  usageCount             Int              @default(0) @map("usage_count")
  avgRating              Decimal?         @map("avg_rating") @db.Decimal(3, 2)
  ratingCount            Int              @default(0) @map("rating_count")

  // Estimated launch time
  estimatedLaunchSeconds Int              @default(120) @map("estimated_launch_seconds")

  createdAt              DateTime         @default(now()) @map("created_at")
  updatedAt              DateTime         @updatedAt @map("updated_at")

  tenant                 Tenant?          @relation(fields: [tenantId], references: [id])
  baseImage              BaseImage        @relation(fields: [baseImageId], references: [id])
  pods                   Pod[]
  ratings                TemplateRating[]

  @@map("pod_templates")
  @@unique([tenantId, slug])
  @@index([tenantId])
  @@index([category])
  @@index([isPublic, isActive])
  @@index([isFeatured])
}

model BaseImage {
  id                String       @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid

  // Image identification
  name              String       @db.VarChar(200)
  osType            OsType       @map("os_type")
  osVersion         String       @map("os_version") @db.VarChar(50)

  // Registry information
  registryType      RegistryType @map("registry_type")
  registryUri       String       @map("registry_uri") @db.VarChar(500)
  imageTag          String       @map("image_tag") @db.VarChar(100)
  imageDigest       String?      @map("image_digest") @db.VarChar(100)

  // Image details
  sizeBytes         BigInt       @map("size_bytes")
  architecture      String       @default("amd64") @db.VarChar(20)

  // Kasm compatibility
  kasmCompatible    Boolean      @default(true) @map("kasm_compatible")
  kasmImageId       String?      @map("kasm_image_id") @db.VarChar(100)

  // Pre-installed software
  preInstalledTools Json         @map("pre_installed_tools")

  // Status
  isActive          Boolean      @default(true) @map("is_active")
  lastPulledAt      DateTime?    @map("last_pulled_at")
  lastVerifiedAt    DateTime?    @map("last_verified_at")

  createdAt         DateTime     @default(now()) @map("created_at")
  updatedAt         DateTime     @updatedAt @map("updated_at")

  templates         PodTemplate[]

  @@map("base_images")
  @@index([osType])
  @@index([isActive])
}

model Pod {
  id                 String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId           String    @map("tenant_id") @db.Uuid
  ownerId            String    @map("owner_id") @db.Uuid
  templateId         String?   @map("template_id") @db.Uuid

  // Pod identification
  name               String    @db.VarChar(200)
  description        String?   @db.Text

  // Kasm workspace
  kasmId             String?   @unique @map("kasm_id") @db.VarChar(100)
  kasmStatus         String?   @map("kasm_status") @db.VarChar(50)

  // Status
  status             PodStatus @default(PENDING)

  // Resources (current allocation)
  currentResources   Json      @map("current_resources")
  // { cpu: 2, memory: 4096, storage: 50, gpu: false }

  // Resource limits
  resourceLimits     Json      @map("resource_limits")

  // Auto-scaling configuration
  autoScalingEnabled Boolean   @default(false) @map("auto_scaling_enabled")
  autoScalingConfig  Json?     @map("auto_scaling_config")

  // Security
  securityPolicyId   String?   @map("security_policy_id") @db.Uuid
  watermarkConfigId  String?   @map("watermark_config_id") @db.Uuid

  // Persistence
  persistentStorage  Boolean   @default(true) @map("persistent_storage")
  storageVolumeId    String?   @map("storage_volume_id") @db.VarChar(100)

  // Connection
  connectionUrl      String?   @map("connection_url") @db.VarChar(500)
  connectionToken    String?   @map("connection_token") @db.VarChar(1000)

  // Lifecycle
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")
  lastAccessedAt     DateTime? @map("last_accessed_at")
  expiresAt          DateTime? @map("expires_at")
  terminatedAt       DateTime? @map("terminated_at")

  // Cost tracking
  totalCostCents     Int       @default(0) @map("total_cost_cents")

  tenant             Tenant    @relation(fields: [tenantId], references: [id])
  owner              User      @relation(fields: [ownerId], references: [id])
  template           PodTemplate? @relation(fields: [templateId], references: [id])
  securityPolicy     PodSecurityPolicy? @relation(fields: [securityPolicyId], references: [id])
  podSessions        PodSession[]
  resourceHistory    PodResourceHistory[]

  @@map("pods")
  @@index([tenantId])
  @@index([ownerId])
  @@index([status])
  @@index([kasmId])
}

model PodSession {
  id            String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  podId         String    @map("pod_id") @db.Uuid
  userId        String    @map("user_id") @db.Uuid

  // Session details
  startedAt     DateTime  @map("started_at")
  endedAt       DateTime? @map("ended_at")
  durationMins  Int       @default(0) @map("duration_mins")

  // Connection info
  ipAddress     String?   @map("ip_address") @db.VarChar(45)
  userAgent     String?   @map("user_agent") @db.Text

  // Cost
  costCents     Int       @default(0) @map("cost_cents")

  createdAt     DateTime  @default(now()) @map("created_at")

  pod           Pod       @relation(fields: [podId], references: [id])

  @@map("pod_sessions")
  @@index([podId])
  @@index([userId])
  @@index([startedAt])
}

model PodResourceHistory {
  id              String            @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  podId           String            @map("pod_id") @db.Uuid

  // Resource snapshot
  resources       Json
  // { cpu: 2, memory: 4096, storage: 50, gpu: false }

  // Utilization at time of snapshot
  utilization     Json?
  // { cpuPercent: 75, memoryPercent: 60, storagePercent: 40 }

  // Scaling event
  scalingEvent    ScalingEventType? @map("scaling_event")
  scalingReason   String?           @map("scaling_reason") @db.Text

  // Cost
  hourlyRateCents Int               @map("hourly_rate_cents")

  recordedAt      DateTime          @default(now()) @map("recorded_at")

  pod             Pod               @relation(fields: [podId], references: [id])

  @@map("pod_resource_history")
  @@index([podId])
  @@index([recordedAt])
}

model TemplateRating {
  id         String      @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  templateId String      @map("template_id") @db.Uuid
  userId     String      @map("user_id") @db.Uuid

  rating     Int         // 1-5
  review     String?     @db.Text

  createdAt  DateTime    @default(now()) @map("created_at")
  updatedAt  DateTime    @updatedAt @map("updated_at")

  template   PodTemplate @relation(fields: [templateId], references: [id])
  user       User        @relation(fields: [userId], references: [id])

  @@map("template_ratings")
  @@unique([templateId, userId])
  @@index([templateId])
}

model ResourcePool {
  id                 String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId           String?  @map("tenant_id") @db.Uuid // null = shared pool

  // Pool configuration
  name               String   @db.VarChar(200)
  description        String?  @db.Text

  // Instance type
  instanceType       String   @map("instance_type") @db.VarChar(50) // e.g., 'c5.xlarge'

  // Capacity
  minInstances       Int      @map("min_instances")
  maxInstances       Int      @map("max_instances")
  currentInstances   Int      @default(0) @map("current_instances")

  // Warm pool (pre-provisioned instances)
  warmPoolSize       Int      @default(0) @map("warm_pool_size")
  warmInstances      Int      @default(0) @map("warm_instances")

  // Auto-scaling
  scaleUpThreshold   Int      @default(70) @map("scale_up_threshold") // CPU %
  scaleDownThreshold Int      @default(30) @map("scale_down_threshold")
  scaleUpCooldown    Int      @default(300) @map("scale_up_cooldown") // seconds
  scaleDownCooldown  Int      @default(600) @map("scale_down_cooldown")

  // Cost
  hourlyRateCents    Int      @map("hourly_rate_cents")

  // Status
  isActive           Boolean  @default(true) @map("is_active")

  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  tenant             Tenant?  @relation(fields: [tenantId], references: [id])

  @@map("resource_pools")
  @@index([tenantId])
  @@index([isActive])
}

model TenantResourceQuota {
  id           String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId     String   @unique @map("tenant_id") @db.Uuid

  // Relation to Tenant
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // CPU quota
  maxCpu       Int      @map("max_cpu") // Total vCPUs allowed
  usedCpu      Int      @default(0) @map("used_cpu")

  // Memory quota
  maxMemory    Int      @map("max_memory") // Total MB allowed
  usedMemory   Int      @default(0) @map("used_memory")

  // Storage quota
  maxStorage   Int      @map("max_storage") // Total GB allowed
  usedStorage  Int      @default(0) @map("used_storage")

  // Pod count quota
  maxPods      Int      @map("max_pods")
  activePods   Int      @default(0) @map("active_pods")

  // GPU quota
  maxGpus      Int      @default(0) @map("max_gpus")
  usedGpus     Int      @default(0) @map("used_gpus")

  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("tenant_resource_quotas")
  @@index([tenantId])
}

enum TemplateCategory {
  DEVELOPMENT
  FINANCE
  DESIGN
  DATA_SCIENCE
  GENERAL
  SECURITY
  DEVOPS
  CUSTOM
}

enum OsType {
  UBUNTU
  DEBIAN
  CENTOS
  AMAZON_LINUX
  WINDOWS_SERVER
  WINDOWS_DESKTOP
}

enum RegistryType {
  ECR
  DOCKER_HUB
  KASM
  CUSTOM
}

enum PodStatus {
  PENDING
  PROVISIONING
  STARTING
  RUNNING
  STOPPING
  STOPPED
  HIBERNATING
  TERMINATED
  ERROR
}

enum ScalingEventType {
  SCALE_UP
  SCALE_DOWN
  MANUAL_CHANGE
  AUTO_SCALE
  INITIAL_PROVISION
}
