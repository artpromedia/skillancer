// =============================================================================
// Financial Services Prisma Schema
// Sprint M5: Freelancer Financial Services
// =============================================================================

// =============================================================================
// TREASURY ACCOUNTS
// =============================================================================

model TreasuryAccount {
  id                        String   @id @default(cuid())
  userId                    String   @unique
  stripeFinancialAccountId  String   @unique
  stripeConnectAccountId    String
  
  status                    String   @default("pending") // pending, active, restricted, closed
  features                  Json?    // Stripe feature flags
  
  // Balance data (cached, source of truth is Stripe)
  balancesData              Json?    // { available, pending, reserved }
  lastBalanceSync           DateTime?
  
  // Account details
  accountNumber             String?  // Encrypted
  routingNumber             String?
  
  // Terms acceptance
  termsAcceptedAt           DateTime?
  termsVersion              String?
  
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt
  closedAt                  DateTime?
  closureReason             String?
  
  user                      User     @relation(fields: [userId], references: [id])
  transactions              TreasuryTransaction[]
  payouts                   FinancialPayout[]
  
  @@index([stripeFinancialAccountId])
  @@index([status])
}

model TreasuryTransaction {
  id                   String   @id @default(cuid())
  userId               String
  stripeTransactionId  String   @unique
  
  type                 String   // inbound, outbound, fee, interest
  amount               Decimal  @db.Decimal(12, 2)
  currency             String   @default("usd")
  status               String   // pending, completed, failed, reversed
  
  description          String?
  metadata             Json?
  
  completedAt          DateTime?
  createdAt            DateTime @default(now())
  
  account              TreasuryAccount @relation(fields: [userId], references: [userId])
  
  @@index([userId, createdAt])
  @@index([status])
}

// =============================================================================
// PAYOUTS (renamed from Payout to avoid conflict with existing model)
// =============================================================================

model FinancialPayout {
  id               String   @id @default(cuid())
  userId           String
  stripePayoutId   String   @unique
  
  amount           Decimal  @db.Decimal(12, 2)
  feeAmount        Decimal  @db.Decimal(12, 2) @default(0)
  netAmount        Decimal  @db.Decimal(12, 2)
  currency         String   @default("usd")
  
  speed            String   // standard, instant
  destination      String   // skillancer_card, external_debit, bank_account
  destinationId    String?
  
  status           String   // pending, processing, completed, failed, canceled
  failureReason    String?
  
  estimatedArrival DateTime?
  completedAt      DateTime?
  canceledAt       DateTime?
  
  description      String?
  metadata         Json?
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  account          TreasuryAccount @relation(fields: [userId], references: [userId])
  
  @@index([userId, createdAt])
  @@index([status])
}

// =============================================================================
// BALANCE MANAGEMENT
// =============================================================================

model BalanceSnapshot {
  id        String   @id @default(cuid())
  userId    String
  
  available Decimal  @db.Decimal(12, 2)
  pending   Decimal  @db.Decimal(12, 2)
  reserved  Decimal  @db.Decimal(12, 2)
  taxVault  Decimal  @db.Decimal(12, 2)
  total     Decimal  @db.Decimal(12, 2)
  
  createdAt DateTime @default(now())
  
  @@index([userId, createdAt])
}

model BalanceOperation {
  id          String   @id @default(cuid())
  userId      String
  
  type        String   // escrow_hold, escrow_release, tax_reserve, tax_release, deposit, withdrawal
  amount      Decimal  @db.Decimal(12, 2)
  fromBalance String   // available, pending, reserved, taxVault
  toBalance   String
  
  description String?
  referenceId String?  // Contract ID, payout ID, etc.
  
  createdAt   DateTime @default(now())
  
  @@index([userId, createdAt])
  @@index([referenceId])
}

model BalanceAlert {
  id        String    @id @default(cuid())
  userId    String
  
  type      String    // low_balance, large_deposit, unusual_activity, pending_cleared
  message   String
  amount    Decimal?  @db.Decimal(12, 2)
  threshold Decimal?  @db.Decimal(12, 2)
  
  readAt    DateTime?
  createdAt DateTime  @default(now())
  
  @@index([userId, readAt])
}

// =============================================================================
// ISSUED CARDS (STRIPE ISSUING)
// =============================================================================

model Cardholder {
  id                  String   @id @default(cuid())
  userId              String   @unique
  stripeCardholderId  String   @unique
  
  status              String   @default("active") // active, inactive, blocked
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  user                User     @relation(fields: [userId], references: [id])
  cards               IssuedCard[]
  
  @@index([stripeCardholderId])
}

model IssuedCard {
  id             String   @id @default(cuid())
  userId         String
  stripeCardId   String   @unique
  cardholderId   String?
  
  type           String   // virtual, physical
  status         String   @default("inactive") // inactive, active, frozen, canceled, lost, stolen
  
  last4          String
  expMonth       Int
  expYear        Int
  brand          String   @default("Visa")
  
  nickname       String?
  spendingLimits Json     // { perTransaction, daily, weekly, monthly }
  
  // Physical card shipping
  shippingAddress        Json?
  shippingStatus         String?  // pending, shipped, delivered, returned, failure
  shippingCarrier        String?
  shippingTrackingNumber String?
  
  // Digital wallet
  walletEnabled  Boolean  @default(false)
  
  // Replacement tracking
  replacementFor String?  // ID of card this replaces
  
  activatedAt    DateTime?
  canceledAt     DateTime?
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  user           User     @relation(fields: [userId], references: [id])
  cardholder     Cardholder? @relation(fields: [cardholderId], references: [id])
  transactions   CardTransaction[]
  
  @@index([userId])
  @@index([stripeCardId])
  @@index([status])
}

model CardTransaction {
  id                    String   @id @default(cuid())
  userId                String
  cardId                String
  
  stripeAuthorizationId String?
  stripeTransactionId   String?
  
  amount                Int      // In cents
  currency              String   @default("usd")
  
  status                String   // pending, authorized, captured, declined, refunded, reversed
  type                  String   // purchase, refund, atm_withdrawal, transfer
  
  merchantName          String
  merchantCategory      String
  merchantCategoryCode  String
  merchantCity          String?
  merchantCountry       String?
  
  description           String?
  receiptUrl            String?
  
  // Categorization
  category              String   // software_subscriptions, office_supplies, etc.
  isBusinessExpense     Boolean  @default(false)
  notes                 String?
  
  settledAt             DateTime?
  createdAt             DateTime @default(now())
  
  card                  IssuedCard @relation(fields: [cardId], references: [id])
  receipts              TransactionReceipt[]
  
  @@index([userId, createdAt])
  @@index([cardId])
  @@index([stripeAuthorizationId])
  @@index([stripeTransactionId])
  @@index([category])
}

model TransactionReceipt {
  id            String   @id @default(cuid())
  transactionId String
  
  imageUrl      String?
  merchantReceipt String?
  parsedData    Json?    // { items, subtotal, tax, total }
  
  uploadedAt    DateTime @default(now())
  
  transaction   CardTransaction @relation(fields: [transactionId], references: [id])
  
  @@index([transactionId])
}

// =============================================================================
// SPENDING CONTROLS
// =============================================================================

model SpendingControl {
  id      String   @id @default(cuid())
  userId  String
  cardId  String?  // null = applies to all cards
  
  type    String   // transaction_limit, daily_limit, category_block, etc.
  config  Json     // Control-specific configuration
  enabled Boolean  @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
  @@index([cardId])
}

model MerchantRestriction {
  id                   String   @id @default(cuid())
  userId               String
  merchantCategoryCode String
  
  allowed              Boolean  @default(true)
  limit                Decimal? @db.Decimal(12, 2)
  reason               String?
  
  createdAt            DateTime @default(now())
  
  @@unique([userId, merchantCategoryCode])
}

model SpendingAlert {
  id            String   @id @default(cuid())
  userId        String
  
  type          String   // approaching_limit, limit_exceeded, unusual_spending, blocked_attempt
  threshold     Decimal? @db.Decimal(12, 2)
  currentAmount Decimal? @db.Decimal(12, 2)
  message       String
  
  acknowledged  Boolean  @default(false)
  
  createdAt     DateTime @default(now())
  
  @@index([userId, acknowledged])
}

// =============================================================================
// TAX VAULT
// =============================================================================

model TaxVault {
  id              String   @id @default(cuid())
  userId          String   @unique
  
  balance         Decimal  @db.Decimal(12, 2) @default(0)
  savingsRate     Int      @default(25)       // Percentage
  autoSaveEnabled Boolean  @default(true)
  targetQuarterly Decimal  @db.Decimal(12, 2) @default(0)
  
  settings        Json     // TaxVaultSettings
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  transactions    TaxVaultTransaction[]
  
  @@index([userId])
}

model TaxVaultTransaction {
  id           String   @id @default(cuid())
  userId       String
  
  type         String   // auto_save, manual_deposit, quarterly_payment, withdrawal, adjustment
  amount       Decimal  @db.Decimal(12, 2)
  
  sourceId     String?  // Reference to original earning
  sourceName   String?
  balanceAfter Decimal  @db.Decimal(12, 2)
  
  createdAt    DateTime @default(now())
  
  vault        TaxVault @relation(fields: [userId], references: [userId])
  
  @@index([userId, createdAt])
  @@index([type])
}

model QuarterlyTaxPayment {
  id       String   @id @default(cuid())
  userId   String
  
  quarter  Int      // 1-4
  year     Int
  amount   Decimal  @db.Decimal(12, 2)
  
  paidAt   DateTime
  
  @@unique([userId, quarter, year])
  @@index([userId, year])
}

model TaxEstimate {
  id                String   @id @default(cuid())
  userId            String
  year              Int
  
  grossIncome       Decimal  @db.Decimal(12, 2)
  totalDeductions   Decimal  @db.Decimal(12, 2)
  federalTax        Decimal  @db.Decimal(12, 2)
  selfEmploymentTax Decimal  @db.Decimal(12, 2)
  stateTax          Decimal  @db.Decimal(12, 2)
  totalTax          Decimal  @db.Decimal(12, 2)
  effectiveRate     Decimal  @db.Decimal(5, 2)
  
  calculatedAt      DateTime @default(now())
  
  @@unique([userId, year])
  @@index([userId])
}

// =============================================================================
// QUARTERLY REMINDERS
// =============================================================================

model QuarterlyReminderPrefs {
  id                  String   @id @default(cuid())
  userId              String   @unique
  
  enabled             Boolean  @default(true)
  daysBeforeDue       Json     // [30, 14, 7, 1]
  channels            Json     // ['email', 'in_app']
  includePaymentLink  Boolean  @default(true)
  customMessage       String?
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

model QuarterlyReminder {
  id              String    @id @default(cuid())
  userId          String
  
  quarter         Int
  year            Int
  dueDate         DateTime
  estimatedAmount Decimal   @db.Decimal(12, 2)
  reminderDate    DateTime
  
  status          String    @default("scheduled") // scheduled, sent, acknowledged, paid
  channels        Json      // ['email', 'push']
  
  sentAt          DateTime?
  acknowledgedAt  DateTime?
  
  createdAt       DateTime  @default(now())
  
  user            User      @relation(fields: [userId], references: [id])
  
  @@index([userId])
  @@index([status, reminderDate])
}

// =============================================================================
// COMPLIANCE & KYC
// =============================================================================

model KycVerification {
  id               String   @id @default(cuid())
  userId           String   @unique
  
  status           String   @default("pending") // pending, verified, failed, expired
  level            String   @default("basic")   // basic, enhanced, full
  
  // Identity verification
  identityStatus   String   @default("pending")
  documentType     String?  // passport, drivers_license, national_id
  documentNumber   String?  // Encrypted
  
  // Address verification
  addressStatus    String   @default("pending")
  
  // Tax information
  taxIdType        String?  // ssn, ein, itin
  taxIdLast4       String?
  taxIdVerified    Boolean  @default(false)
  
  // Stripe Identity verification ID
  stripeVerificationId String?
  
  verifiedAt       DateTime?
  expiresAt        DateTime?
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  @@index([status])
}

model ComplianceDocument {
  id        String   @id @default(cuid())
  userId    String
  
  type      String   // id_front, id_back, proof_of_address, w9, tax_return
  status    String   @default("pending") // pending, approved, rejected
  
  fileUrl   String
  fileName  String
  mimeType  String
  
  reviewedBy String?
  reviewNotes String?
  reviewedAt DateTime?
  
  createdAt DateTime @default(now())
  
  @@index([userId, type])
}

// =============================================================================
// FINANCIAL NOTIFICATIONS
// =============================================================================

model FinancialNotification {
  id        String   @id @default(cuid())
  userId    String
  
  type      String   // deposit, payout, card_transaction, tax_reminder, etc.
  title     String
  message   String
  data      Json?
  
  channel   String   // email, push, sms, in_app
  
  readAt    DateTime?
  
  createdAt DateTime @default(now())
  
  @@index([userId, readAt])
  @@index([type])
}

// =============================================================================
// AUDIT LOG
// =============================================================================

model FinancialAuditLog {
  id         String   @id @default(cuid())
  userId     String
  
  action     String   // card_details_viewed, payout_initiated, etc.
  resource   String   // card, payout, tax_vault, etc.
  resourceId String?
  
  ipAddress  String?
  userAgent  String?
  
  metadata   Json?
  
  createdAt  DateTime @default(now())
  
  @@index([userId, createdAt])
  @@index([action])
}
