#cloud-config
# =============================================================================
# K3s Control Plane â€” Cloud-Init
# =============================================================================

package_update: true
package_upgrade: true

packages:
  - curl
  - wget
  - apt-transport-https
  - ca-certificates
  - gnupg
  - ufw
  - fail2ban
  - unattended-upgrades

write_files:
  - path: /etc/rancher/k3s/config.yaml
    content: |
      node-ip: "${private_ip}"
      advertise-address: "${private_ip}"
      flannel-iface: ens10
      tls-san:
        - "${private_ip}"
      disable:
        - traefik
        - servicelb
      write-kubeconfig-mode: "644"
      cluster-cidr: "10.42.0.0/16"
      service-cidr: "10.43.0.0/16"
      kube-controller-manager-arg:
        - "bind-address=0.0.0.0"
      kube-scheduler-arg:
        - "bind-address=0.0.0.0"
      etcd-expose-metrics: true

runcmd:
  # Install cloudflared (Cloudflare Tunnel connector)
  - |
    curl -fsSL https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb -o /tmp/cloudflared.deb
    dpkg -i /tmp/cloudflared.deb
    rm /tmp/cloudflared.deb

  # Install K3s
  - curl -sfL https://get.k3s.io | K3S_TOKEN="${k3s_token}" sh -s - server

  # Wait for K3s to be ready
  - |
    for i in $(seq 1 60); do
      if kubectl get nodes &>/dev/null; then
        echo "K3s is ready"
        break
      fi
      echo "Waiting for K3s... ($i/60)"
      sleep 5
    done

  # Install Helm
  - curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

  # Install nginx ingress controller
  - |
    helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
    helm repo update
    helm install ingress-nginx ingress-nginx/ingress-nginx \
      --namespace ingress-nginx --create-namespace \
      --set controller.kind=DaemonSet \
      --set controller.hostPort.enabled=true \
      --set controller.service.type=ClusterIP \
      --set controller.metrics.enabled=true \
      --set controller.config.use-forwarded-headers=true \
      --set controller.config.compute-full-forwarded-for=true

  # Install cert-manager
  - |
    helm repo add jetstack https://charts.jetstack.io
    helm repo update
    helm install cert-manager jetstack/cert-manager \
      --namespace cert-manager --create-namespace \
      --set installCRDs=true

  # Create Let's Encrypt ClusterIssuer
  - |
    cat <<'ISSUER' | kubectl apply -f -
    apiVersion: cert-manager.io/v1
    kind: ClusterIssuer
    metadata:
      name: letsencrypt-prod
    spec:
      acme:
        server: https://acme-v02.api.letsencrypt.org/directory
        email: devops@skillancer.com
        privateKeySecretRef:
          name: letsencrypt-prod
        solvers:
          - http01:
              ingress:
                class: nginx
    ISSUER

  # Install Prometheus + Grafana
  - |
    helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
    helm repo update
    helm install monitoring prometheus-community/kube-prometheus-stack \
      --namespace monitoring --create-namespace \
      --set grafana.adminPassword=changeme \
      --set prometheus.prometheusSpec.retention=30d \
      --set prometheus.prometheusSpec.storageSpec.volumeClaimTemplate.spec.resources.requests.storage=50Gi

  # Label node
  - kubectl label node $(hostname) node-role.kubernetes.io/control-plane=true --overwrite

  # Enable automatic security updates
  - systemctl enable unattended-upgrades
  - systemctl start unattended-upgrades
