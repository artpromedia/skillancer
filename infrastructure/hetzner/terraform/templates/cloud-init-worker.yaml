#cloud-config
# =============================================================================
# K3s Worker Node â€” Cloud-Init
# =============================================================================

package_update: true
package_upgrade: true

packages:
  - curl
  - wget
  - ca-certificates
  - ufw
  - fail2ban
  - unattended-upgrades

runcmd:
  # Wait for control plane to be ready
  - |
    echo "Waiting for K3s control plane at ${control_plane_ip}..."
    for i in $(seq 1 120); do
      if curl -sk https://${control_plane_ip}:6443/ping 2>/dev/null; then
        echo "Control plane is reachable"
        break
      fi
      echo "Waiting... ($i/120)"
      sleep 5
    done

  # Install K3s agent
  - |
    curl -sfL https://get.k3s.io | K3S_URL="https://${control_plane_ip}:6443" K3S_TOKEN="${k3s_token}" sh -s - agent \
      --node-ip="${private_ip}" \
      --flannel-iface=ens10

  # Label this worker node
  - |
    for i in $(seq 1 30); do
      if kubectl --kubeconfig=/dev/null label node $(hostname) \
        node-role.kubernetes.io/worker=true \
        worker-index="${worker_index}" \
        --overwrite 2>/dev/null; then
        break
      fi
      sleep 5
    done

  # Enable automatic security updates
  - systemctl enable unattended-upgrades
  - systemctl start unattended-upgrades
