# =============================================================================
# Example: ECS Cluster and Services Configuration
# =============================================================================
# This file demonstrates how to use the ecs-cluster and ecs-service modules
# to deploy Skillancer microservices on AWS ECS Fargate
# =============================================================================

# -----------------------------------------------------------------------------
# ECS Cluster
# -----------------------------------------------------------------------------

module "ecs_cluster" {
  source = "../../modules/ecs-cluster"

  project     = var.project
  environment = var.environment
  vpc_id      = module.networking.vpc_id

  # Container Insights for enhanced monitoring
  enable_container_insights = true

  # Capacity provider strategy
  # Production: 50% Fargate, 50% Fargate Spot
  # Non-prod: 100% Fargate Spot for cost savings
  fargate_base_weight = var.environment == "prod" ? 50 : 0
  fargate_spot_weight = var.environment == "prod" ? 50 : 100

  # Service discovery for inter-service communication
  enable_service_discovery = true

  # Logging
  log_retention_days = var.environment == "prod" ? 90 : 30
  kms_key_arn        = var.environment == "prod" ? module.kms.key_arn : null

  # X-Ray tracing
  enable_xray = var.environment == "prod"

  # Cluster alarms
  enable_cluster_alarms          = true
  cluster_cpu_alarm_threshold    = 80
  cluster_memory_alarm_threshold = 80
  alarm_sns_topic_arns           = [module.monitoring.alerts_sns_topic_arn]

  tags = local.common_tags
}

# -----------------------------------------------------------------------------
# API Gateway Service
# -----------------------------------------------------------------------------

module "api_gateway_service" {
  source = "../../modules/ecs-service"

  project      = var.project
  environment  = var.environment
  service_name = "api-gateway"

  # Cluster configuration
  cluster_arn  = module.ecs_cluster.cluster_arn
  cluster_name = module.ecs_cluster.cluster_name

  # Network configuration
  vpc_id     = module.networking.vpc_id
  vpc_cidr   = module.networking.vpc_cidr_block
  subnet_ids = module.networking.private_subnet_ids

  # Container configuration
  ecr_repository_url = module.ecr["api-gateway"].repository_url
  image_tag          = var.api_gateway_image_tag
  container_port     = 3000
  cpu                = var.environment == "prod" ? 512 : 256
  memory             = var.environment == "prod" ? 1024 : 512

  # IAM roles from cluster module
  execution_role_arn = module.ecs_cluster.task_execution_role_arn
  task_role_arn      = module.ecs_cluster.task_role_arn

  # Environment variables
  environment_variables = {
    NODE_ENV           = var.environment
    PORT               = "3000"
    LOG_LEVEL          = var.environment == "prod" ? "info" : "debug"
    AUTH_SERVICE_URL   = "http://auth-service.${var.environment}.skillancer.local:3000"
    MARKET_SERVICE_URL = "http://market-service.${var.environment}.skillancer.local:3000"
  }

  # Secrets from AWS Secrets Manager
  secrets = {
    DATABASE_URL = "${module.secrets.secret_arn}:DATABASE_URL::"
    JWT_SECRET   = "${module.secrets.secret_arn}:JWT_SECRET::"
    REDIS_URL    = "${module.secrets.secret_arn}:REDIS_URL::"
  }

  # Health check
  container_health_check = {
    command      = ["CMD-SHELL", "curl -f http://localhost:3000/health || exit 1"]
    interval     = 30
    timeout      = 5
    retries      = 3
    start_period = 60
  }

  # Load balancer configuration
  alb_security_group_ids = [module.alb.security_group_id]
  alb_listener_arn       = module.alb.https_listener_arn
  alb_priority           = 100
  host_headers           = ["api.${var.domain_name}"]
  health_check_path      = "/health"

  # Service discovery
  enable_service_discovery       = true
  service_discovery_namespace_id = module.ecs_cluster.service_discovery_namespace_id

  # Auto scaling
  enable_auto_scaling = true
  min_capacity        = var.environment == "prod" ? 2 : 1
  max_capacity        = var.environment == "prod" ? 10 : 3
  cpu_scale_target    = 70
  memory_scale_target = 80

  # Deployment strategy
  enable_blue_green            = var.environment == "prod"
  codedeploy_role_arn          = var.environment == "prod" ? module.iam.codedeploy_role_arn : null
  codedeploy_deployment_config = "CodeDeployDefault.ECSLinear10PercentEvery1Minutes"

  # Fargate Spot for non-production
  use_fargate_spot = var.environment != "prod"

  # Monitoring
  enable_service_alarms = true
  alarm_sns_topic_arns  = [module.monitoring.alerts_sns_topic_arn]

  tags = local.common_tags
}

# -----------------------------------------------------------------------------
# Auth Service
# -----------------------------------------------------------------------------

module "auth_service" {
  source = "../../modules/ecs-service"

  project      = var.project
  environment  = var.environment
  service_name = "auth-service"

  cluster_arn  = module.ecs_cluster.cluster_arn
  cluster_name = module.ecs_cluster.cluster_name

  vpc_id     = module.networking.vpc_id
  vpc_cidr   = module.networking.vpc_cidr_block
  subnet_ids = module.networking.private_subnet_ids

  ecr_repository_url = module.ecr["auth-service"].repository_url
  image_tag          = var.auth_service_image_tag
  container_port     = 3000
  cpu                = var.environment == "prod" ? 512 : 256
  memory             = var.environment == "prod" ? 1024 : 512

  execution_role_arn = module.ecs_cluster.task_execution_role_arn
  task_role_arn      = module.ecs_cluster.task_role_arn

  environment_variables = {
    NODE_ENV  = var.environment
    PORT      = "3000"
    LOG_LEVEL = var.environment == "prod" ? "info" : "debug"
  }

  secrets = {
    DATABASE_URL    = "${module.secrets.secret_arn}:DATABASE_URL::"
    JWT_SECRET      = "${module.secrets.secret_arn}:JWT_SECRET::"
    JWT_EXPIRY      = "${module.secrets.secret_arn}:JWT_EXPIRY::"
    REDIS_URL       = "${module.secrets.secret_arn}:REDIS_URL::"
    OAUTH_CLIENT_ID = "${module.secrets.secret_arn}:OAUTH_CLIENT_ID::"
  }

  # Internal service - no ALB, only service discovery
  create_target_group             = false
  alb_security_group_ids          = [module.ecs_cluster.task_execution_role_arn] # Allow from other ECS tasks
  enable_service_discovery        = true
  service_discovery_namespace_id  = module.ecs_cluster.service_discovery_namespace_id

  enable_auto_scaling = true
  min_capacity        = var.environment == "prod" ? 2 : 1
  max_capacity        = var.environment == "prod" ? 6 : 2
  cpu_scale_target    = 70

  use_fargate_spot      = var.environment != "prod"
  enable_service_alarms = true
  alarm_sns_topic_arns  = [module.monitoring.alerts_sns_topic_arn]

  tags = local.common_tags
}

# -----------------------------------------------------------------------------
# Market Service
# -----------------------------------------------------------------------------

module "market_service" {
  source = "../../modules/ecs-service"

  project      = var.project
  environment  = var.environment
  service_name = "market-service"

  cluster_arn  = module.ecs_cluster.cluster_arn
  cluster_name = module.ecs_cluster.cluster_name

  vpc_id     = module.networking.vpc_id
  vpc_cidr   = module.networking.vpc_cidr_block
  subnet_ids = module.networking.private_subnet_ids

  ecr_repository_url = module.ecr["market-service"].repository_url
  image_tag          = var.market_service_image_tag
  container_port     = 3000
  cpu                = var.environment == "prod" ? 1024 : 256
  memory             = var.environment == "prod" ? 2048 : 512

  execution_role_arn = module.ecs_cluster.task_execution_role_arn
  task_role_arn      = module.ecs_cluster.task_role_arn

  environment_variables = {
    NODE_ENV           = var.environment
    PORT               = "3000"
    LOG_LEVEL          = var.environment == "prod" ? "info" : "debug"
    AUTH_SERVICE_URL   = "http://auth-service.${var.environment}.skillancer.local:3000"
    SEARCH_INDEX_NAME  = "skillancer-${var.environment}"
  }

  secrets = {
    DATABASE_URL       = "${module.secrets.secret_arn}:DATABASE_URL::"
    REDIS_URL          = "${module.secrets.secret_arn}:REDIS_URL::"
    ELASTICSEARCH_URL  = "${module.secrets.secret_arn}:ELASTICSEARCH_URL::"
    STRIPE_SECRET_KEY  = "${module.secrets.secret_arn}:STRIPE_SECRET_KEY::"
  }

  # Internal service with service discovery
  create_target_group            = false
  enable_service_discovery       = true
  service_discovery_namespace_id = module.ecs_cluster.service_discovery_namespace_id

  enable_auto_scaling = true
  min_capacity        = var.environment == "prod" ? 2 : 1
  max_capacity        = var.environment == "prod" ? 8 : 2
  cpu_scale_target    = 70

  use_fargate_spot      = var.environment != "prod"
  enable_service_alarms = true
  alarm_sns_topic_arns  = [module.monitoring.alerts_sns_topic_arn]

  tags = local.common_tags
}

# -----------------------------------------------------------------------------
# Notification Service (Worker)
# -----------------------------------------------------------------------------

module "notification_service" {
  source = "../../modules/ecs-service"

  project      = var.project
  environment  = var.environment
  service_name = "notification-service"

  cluster_arn  = module.ecs_cluster.cluster_arn
  cluster_name = module.ecs_cluster.cluster_name

  vpc_id     = module.networking.vpc_id
  vpc_cidr   = module.networking.vpc_cidr_block
  subnet_ids = module.networking.private_subnet_ids

  ecr_repository_url = module.ecr["notification-service"].repository_url
  image_tag          = var.notification_service_image_tag
  container_port     = 3000
  cpu                = 256
  memory             = 512

  execution_role_arn = module.ecs_cluster.task_execution_role_arn
  task_role_arn      = module.ecs_cluster.task_role_arn

  environment_variables = {
    NODE_ENV  = var.environment
    PORT      = "3000"
    LOG_LEVEL = var.environment == "prod" ? "info" : "debug"
  }

  secrets = {
    DATABASE_URL     = "${module.secrets.secret_arn}:DATABASE_URL::"
    REDIS_URL        = "${module.secrets.secret_arn}:REDIS_URL::"
    SENDGRID_API_KEY = "${module.secrets.secret_arn}:SENDGRID_API_KEY::"
    TWILIO_SID       = "${module.secrets.secret_arn}:TWILIO_SID::"
    TWILIO_TOKEN     = "${module.secrets.secret_arn}:TWILIO_TOKEN::"
  }

  # Worker service - no load balancer needed
  create_target_group            = false
  enable_service_discovery       = true
  service_discovery_namespace_id = module.ecs_cluster.service_discovery_namespace_id

  # Scale based on queue depth (configured separately)
  enable_auto_scaling = true
  min_capacity        = 1
  max_capacity        = var.environment == "prod" ? 5 : 2
  cpu_scale_target    = 70

  use_fargate_spot      = true # Worker can use Spot instances
  enable_service_alarms = true
  alarm_sns_topic_arns  = [module.monitoring.alerts_sns_topic_arn]

  tags = local.common_tags
}

# -----------------------------------------------------------------------------
# Web Frontend Service
# -----------------------------------------------------------------------------

module "web_frontend" {
  source = "../../modules/ecs-service"

  project      = var.project
  environment  = var.environment
  service_name = "web-frontend"

  cluster_arn  = module.ecs_cluster.cluster_arn
  cluster_name = module.ecs_cluster.cluster_name

  vpc_id     = module.networking.vpc_id
  vpc_cidr   = module.networking.vpc_cidr_block
  subnet_ids = module.networking.private_subnet_ids

  ecr_repository_url = module.ecr["web-frontend"].repository_url
  image_tag          = var.web_frontend_image_tag
  container_port     = 3000
  cpu                = var.environment == "prod" ? 512 : 256
  memory             = var.environment == "prod" ? 1024 : 512

  execution_role_arn = module.ecs_cluster.task_execution_role_arn
  task_role_arn      = module.ecs_cluster.task_role_arn

  environment_variables = {
    NODE_ENV            = var.environment
    PORT                = "3000"
    NEXT_PUBLIC_API_URL = "https://api.${var.domain_name}"
  }

  # Public-facing service via ALB
  alb_security_group_ids = [module.alb.security_group_id]
  alb_listener_arn       = module.alb.https_listener_arn
  alb_priority           = 200
  host_headers           = [var.domain_name, "www.${var.domain_name}"]
  health_check_path      = "/api/health"

  enable_auto_scaling = true
  min_capacity        = var.environment == "prod" ? 2 : 1
  max_capacity        = var.environment == "prod" ? 10 : 3
  cpu_scale_target    = 70

  # Blue-green for production
  enable_blue_green            = var.environment == "prod"
  codedeploy_role_arn          = var.environment == "prod" ? module.iam.codedeploy_role_arn : null
  codedeploy_deployment_config = "CodeDeployDefault.ECSLinear10PercentEvery1Minutes"

  use_fargate_spot      = var.environment != "prod"
  enable_service_alarms = true
  alarm_sns_topic_arns  = [module.monitoring.alerts_sns_topic_arn]

  tags = local.common_tags
}
