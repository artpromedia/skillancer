# Alertmanager Configuration for Skillancer Platform
# Handles alert routing, grouping, and notifications

global:
  # How long to wait before sending notification
  resolve_timeout: 5m

  # Slack webhook URL (set via environment variable)
  slack_api_url: '${SLACK_WEBHOOK_URL}'

# Alert routing tree
route:
  # Default receiver
  receiver: 'slack-notifications'

  # Group alerts by these labels
  group_by: ['alertname', 'service', 'severity']

  # How long to wait before sending grouped alerts
  group_wait: 30s

  # How long to wait before sending new alerts in same group
  group_interval: 5m

  # How long to wait before resending alert
  repeat_interval: 4h

  # Child routes for specific alert handling
  routes:
    # Critical alerts go to PagerDuty
    - match:
        severity: critical
      receiver: 'pagerduty-critical'
      continue: true

    - match:
        severity: critical
      receiver: 'slack-critical'
      group_wait: 10s
      repeat_interval: 1h

    # Warning alerts to Slack
    - match:
        severity: warning
      receiver: 'slack-warnings'
      group_wait: 1m
      repeat_interval: 4h

    # Database alerts
    - match:
        category: database
      receiver: 'slack-database'
      group_by: ['alertname', 'database']

    # Security alerts - immediate notification
    - match:
        category: security
      receiver: 'pagerduty-security'
      group_wait: 0s
      repeat_interval: 15m

    # Business alerts
    - match:
        category: business
      receiver: 'slack-business'
      group_wait: 5m

# Inhibition rules - suppress less severe alerts when critical exists
inhibit_rules:
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'service']

  - source_match:
      severity: 'critical'
    target_match:
      severity: 'info'
    equal: ['alertname', 'service']

# Receivers define notification channels
receivers:
  # Default Slack channel
  - name: 'slack-notifications'
    slack_configs:
      - channel: '#alerts'
        send_resolved: true
        title: '{{ .Status | toUpper }}{{ if eq .Status "firing" }}üî•{{ else }}‚úÖ{{ end }} {{ .CommonLabels.alertname }}'
        text: |
          *Service:* {{ .CommonLabels.service }}
          *Severity:* {{ .CommonLabels.severity }}
          *Environment:* {{ .CommonLabels.environment }}

          {{ range .Alerts }}
          *Alert:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Started:* {{ .StartsAt | humanize }}
          {{ end }}
        actions:
          - type: button
            text: 'View in Grafana üìä'
            url: '{{ .CommonAnnotations.grafana_url }}'
          - type: button
            text: 'Runbook üìñ'
            url: '{{ .CommonAnnotations.runbook_url }}'

  # Critical alerts - Slack
  - name: 'slack-critical'
    slack_configs:
      - channel: '#alerts-critical'
        send_resolved: true
        color: '{{ if eq .Status "firing" }}danger{{ else }}good{{ end }}'
        title: 'üö® CRITICAL: {{ .CommonLabels.alertname }}'
        text: |
          *Immediate attention required!*

          *Service:* {{ .CommonLabels.service }}
          *Environment:* {{ .CommonLabels.environment }}

          {{ range .Alerts }}
          *Summary:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          {{ end }}
        actions:
          - type: button
            text: 'Acknowledge'
            url: '{{ .CommonAnnotations.ack_url }}'

  # Warning alerts
  - name: 'slack-warnings'
    slack_configs:
      - channel: '#alerts-warnings'
        send_resolved: true
        color: 'warning'
        title: '‚ö†Ô∏è WARNING: {{ .CommonLabels.alertname }}'
        text: |
          *Service:* {{ .CommonLabels.service }}
          *Severity:* {{ .CommonLabels.severity }}

          {{ range .Alerts }}
          {{ .Annotations.summary }}
          {{ end }}

  # Database alerts
  - name: 'slack-database'
    slack_configs:
      - channel: '#alerts-database'
        send_resolved: true
        title: 'üóÑÔ∏è Database Alert: {{ .CommonLabels.alertname }}'
        text: |
          *Database:* {{ .CommonLabels.database }}
          *Service:* {{ .CommonLabels.service }}

          {{ range .Alerts }}
          {{ .Annotations.description }}
          {{ end }}

  # Business alerts
  - name: 'slack-business'
    slack_configs:
      - channel: '#alerts-business'
        send_resolved: true
        title: 'üìà Business Alert: {{ .CommonLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          {{ .Annotations.summary }}
          {{ end }}

  # PagerDuty for critical issues
  - name: 'pagerduty-critical'
    pagerduty_configs:
      - service_key: '${PAGERDUTY_SERVICE_KEY}'
        severity: critical
        description: '{{ .CommonAnnotations.summary }}'
        details:
          service: '{{ .CommonLabels.service }}'
          environment: '{{ .CommonLabels.environment }}'
          alertname: '{{ .CommonLabels.alertname }}'

  # PagerDuty for security issues
  - name: 'pagerduty-security'
    pagerduty_configs:
      - service_key: '${PAGERDUTY_SECURITY_KEY}'
        severity: critical
        description: 'SECURITY: {{ .CommonAnnotations.summary }}'
        details:
          service: '{{ .CommonLabels.service }}'
          environment: '{{ .CommonLabels.environment }}'
          category: 'security'

# Templates for notification formatting
templates:
  - '/etc/alertmanager/templates/*.tmpl'
